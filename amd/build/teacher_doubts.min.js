define(["jquery","core/notification","core/templates"],function($,Notification,Templates){"use strict";const SELECTORS={workspace:"[data-region=\"doubts-workspace\"]",listPane:"[data-region=\"doubt-list\"]",detailPane:"[data-region=\"doubt-detail\"]",filters:"[data-filter]"},ACTIONS={refresh:"[data-action=\"refresh\"]",reset:"[data-action=\"reset-filters\"]",assignMe:"[data-action=\"assign-me\"]",unassign:"[data-action=\"unassign\"]",changeStatus:"[data-action=\"change-status\"]",addFiles:"[data-action=\"add-files\"]",clearFiles:"[data-action=\"clear-files\"]"};let config,root,searchTimer;const state={filters:{},selectedId:null,files:[]},init=function(initialConfig){config=initialConfig||{},root=$(SELECTORS.workspace),root.length&&(state.filters=$.extend({},config.initialFilters||{}),state.selectedId=config.initialDetailId||null,state.files=[],bindEvents())},bindEvents=function(){root.on("click",ACTIONS.refresh,function(){fetchList()}),root.on("click",ACTIONS.reset,function(){resetFilters()}),root.on("change",SELECTORS.filters,function(){const filter=$(this).data("filter"),value=$(this).val();"search"===filter?state.filters[filter]=value:(updateFilter(filter,value),fetchList())}),root.on("keyup","[data-filter=\"search\"]",function(){const value=$(this).val();state.filters.search=value,window.clearTimeout(searchTimer),searchTimer=window.setTimeout(fetchList,350)}),root.on("click",".doubt-list-item",function(){const id=$(this).data("doubtid");id&&id!==state.selectedId&&(state.selectedId=id,highlightSelection(),fetchDetail(id))}),root.on("submit","[data-region=\"reply-form\"]",function(e){e.preventDefault(),submitReply($(this))}),root.on("click",ACTIONS.assignMe,function(){state.selectedId&&assign(state.selectedId,config.userid)}),root.on("click",ACTIONS.unassign,function(){state.selectedId&&assign(state.selectedId,0)}),root.on("change",ACTIONS.changeStatus,function(){if(!state.selectedId)return;const status=$(this).val();status&&changeStatus(state.selectedId,status)}),root.on("click",ACTIONS.addFiles,function(){const input=currentDetail().find('[data-region="file-input"]');input.length&&input.trigger("click")}),root.on("click",ACTIONS.clearFiles,function(){clearFiles()}),root.on("change","[data-region=\"file-input\"]",function(){const files=Array.from(this.files||[]);state.files=files,updateAttachmentsPreview()})},updateFilter=function(filter,value){value?state.filters[filter]=value:delete state.filters[filter]},resetFilters=function(){state.filters={},root.find(SELECTORS.filters).each(function(){const element=$(this);element.is("select")?element.val(""):element.is('[data-filter="search"]')&&element.val("")}),fetchList()},fetchList=function(){callAjax("list",{page:0,perpage:config.perpage||20,filters:state.filters}).done(function(response){if(!response||!response.success)return;const data=response.data||{};renderList(data),updateSummary(data.summary)})},renderList=function(data){const records=Array.isArray(data.records)?data.records:[];let hasSelection=!1;records.forEach(function(record){record&&(record.iscurrent=state.selectedId&&record.id===state.selectedId,record.iscurrent&&(hasSelection=!0))});const context={records:records,unassignedlabel:config.strings.unassigned,noresults:config.strings.noResults},listNode=root.find(SELECTORS.listPane).get(0);Templates.render("theme_remui_kids/teacher_doubts_list",context).then(function(html,js){Templates.replaceNodeContents(listNode,html,js)}).then(function(){records.length?hasSelection||(state.selectedId=records[0].id,highlightSelection(),fetchDetail(state.selectedId)):(state.selectedId=null,renderDetailPlaceholder())}).fail(Notification.exception)},fetchDetail=function(id){callAjax("detail",{doubtid:id}).done(function(response){response&&response.success&&renderDetail(response.data||{})})},submitReply=function(form){if(!state.selectedId)return;const message=form.find('textarea[name="message"]').val().trim(),visibility=form.find('input[name="visibility"]:checked').val()||"public",resolution=form.find('input[name="resolution"]').is(":checked")?1:0;if(!message&&!state.files.length){Notification.alert("",config.strings.replyPlaceholder);return}const formData=new FormData;formData.append("action","reply"),formData.append("sesskey",config.sesskey),formData.append("doubtid",state.selectedId),formData.append("message",message),formData.append("visibility",visibility),formData.append("resolution",resolution),formData.append("format",1),state.files.forEach(function(file){formData.append("attachments[]",file,file.name)}),$.ajax({url:config.ajaxurl,method:"POST",data:formData,processData:!1,contentType:!1,dataType:"json"}).done(function(response){response&&response.success&&(renderDetail(response.data||{}),form.get(0).reset(),state.files=[],updateAttachmentsPreview(),fetchList())}).fail(handleAjaxFailure)},assign=function(doubtid,assigneeid){callAjax("assign",{doubtid:doubtid,assigneeid:assigneeid}).done(function(response){response&&response.success&&(renderDetail(response.data||{}),fetchList())})},changeStatus=function(doubtid,status){callAjax("status",{doubtid:doubtid,status:status}).done(function(response){response&&response.success&&(renderDetail(response.data||{}),fetchList())})},renderDetail=function(detail){if(!detail||!detail.doubt){renderDetailPlaceholder();return}const context=$.extend(!0,{},detail,config.strings),detailNode=root.find(SELECTORS.detailPane).get(0);Templates.render("theme_remui_kids/teacher_doubt_detail",context).then(function(html,js){Templates.replaceNodeContents(detailNode,html,js)}).then(function(){state.files=[],highlightSelection()}).fail(Notification.exception)},renderDetailPlaceholder=function(){const detailNode=currentDetail();detailNode.html('<div class="doubt-empty"><i class="fa fa-question-circle"></i><p>'+config.strings.selectPrompt+"</p></div>")},updateSummary=function(summary){summary&&Object.keys(summary).forEach(function(key){const card=root.find('[data-summary="'+key+'"] [data-summary-value]');card.length&&card.text(summary[key])})},highlightSelection=function(){root.find(".doubt-list-item").removeClass("active"),state.selectedId&&root.find('.doubt-list-item[data-doubtid="'+state.selectedId+'"]').addClass("active")},currentDetail=function(){return root.find(SELECTORS.detailPane)},updateAttachmentsPreview=function(){const preview=currentDetail().find('[data-region="attachments-preview"]');if(!preview.length)return;preview.empty(),state.files.length&&state.files.forEach(function(file){$("<span/>",{text:file.name,"class":"attachment-chip"}).appendTo(preview)})},clearFiles=function(){state.files=[];const input=currentDetail().find('[data-region="file-input"]');input.length&&input.val(""),updateAttachmentsPreview()},callAjax=function(action,data){const payload=$.extend({action:action,sesskey:config.sesskey},data||{});return $.ajax({url:config.ajaxurl,method:"POST",dataType:"json",data:payload}).fail(handleAjaxFailure)},handleAjaxFailure=function(jqXHR){let message=jqXHR.statusText;jqXHR.responseJSON&&jqXHR.responseJSON.error&&(message=jqXHR.responseJSON.error),Notification.alert("",message)};return{init:init}});

