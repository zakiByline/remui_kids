<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Editor</title>
    <!-- Monaco Editor -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/editor/editor.main.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: #2d2d30;
            padding: 12px 20px;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo {
            font-size: 18px;
            font-weight: 600;
            color: #007acc;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .language-selector {
            background: #3c3c3c;
            color: #cccccc;
            border: 1px solid #555;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            outline: none;
        }
        
        .language-selector:hover {
            background: #454545;
        }
        
        .header-right {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-run {
            background: #16c60c;
            color: white;
        }
        
        .btn-run:hover {
            background: #13a10e;
        }
        
        .btn-run:disabled {
            background: #555;
            cursor: not-allowed;
        }
        
        .btn-clear {
            background: #f48771;
            color: white;
        }
        
        .btn-clear:hover {
            background: #d16d5a;
        }
        
        .btn-theme {
            background: #3c3c3c;
            color: #cccccc;
            border: 1px solid #555;
        }
        
        .btn-theme:hover {
            background: #454545;
        }
        
        /* Theme Toggle Icon Only */
        .btn-theme-icon {
            background: #3c3c3c;
            color: #cccccc;
            border: 1px solid #555;
            width: 40px;
            height: 36px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .btn-theme-icon:hover {
            background: #454545;
            transform: scale(1.1);
        }
        
        body.light-theme .btn-theme-icon {
            background: #e5e5e5;
            border-color: #ccc;
        }
        
        /* Fullscreen button */
        .btn-fullscreen {
            background: #3c3c3c;
            color: #cccccc;
            border: 1px solid #555;
            width: 40px;
            height: 36px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .btn-fullscreen:hover {
            background: #454545;
            transform: scale(1.1);
        }
        
        body.light-theme .btn-fullscreen {
            background: #e5e5e5;
            border-color: #ccc;
        }
        
        /* Fullscreen mode */
        body.fullscreen-mode {
            overflow: hidden;
        }
        
        body.fullscreen-mode .header,
        body.fullscreen-mode .status-bar {
            display: none;
        }
        
        body.fullscreen-mode .main-content {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 99999;
            margin: 0;
        }
        
        body.fullscreen-mode .editor-panel {
            height: 100%;
        }
        
        body.fullscreen-mode .io-panel {
            height: 100%;
        }
        
        /* Fullscreen exit button */
        .fullscreen-exit-btn {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 100000;
            background: rgba(102, 126, 234, 0.9);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            display: none;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.2s;
        }
        
        .fullscreen-exit-btn:hover {
            background: rgba(102, 126, 234, 1);
            transform: scale(1.05);
        }
        
        body.fullscreen-mode .fullscreen-exit-btn {
            display: flex;
        }
        
        /* Enhanced professional styling */
        .header {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        
        .panel-header {
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            font-size: 11px;
        }
        
        .btn {
            font-weight: 600;
            letter-spacing: 0.3px;
        }
        
        .btn-ai {
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
        }
        
        .btn-run {
            box-shadow: 0 2px 6px rgba(22, 198, 12, 0.3);
        }
        
        .btn-clear {
            box-shadow: 0 2px 6px rgba(244, 135, 113, 0.3);
        }
        
        .logo {
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        
        /* AI Assistant Button */
        .btn-ai {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: relative;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        .btn-ai:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .ai-pulse {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 8px;
            height: 8px;
            background: #4ade80;
            border-radius: 50%;
            animation: pulse-ai 2s infinite;
        }
        
        @keyframes pulse-ai {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.5;
                transform: scale(1.2);
            }
        }
        
        /* AI Assistant Panel */
        .ai-panel {
            display: none;
            position: fixed;
            right: 20px;
            bottom: 20px;
            width: 420px;
            max-height: 650px;
            background: #2d2d30;
            border: 1px solid #3e3e42;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            z-index: 10000;
            flex-direction: column;
            animation: slideIn 0.3s ease;
        }
        
        /* AI Panel Light Theme */
        body.light-theme .ai-panel {
            background: white;
            border-color: #e5e5e5;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        }
        
        body.light-theme .ai-quick-actions {
            background: #f9f9f9;
            border-bottom-color: #e5e5e5;
        }
        
        body.light-theme .ai-action-btn {
            background: white;
            border-color: #ddd;
            color: #383a42;
        }
        
        body.light-theme .ai-action-btn:hover {
            background: #667eea;
            color: white;
        }
        
        body.light-theme .ai-message-text {
            background: #f3f4f6;
            color: #383a42;
        }
        
        body.light-theme .ai-message.user .ai-message-text {
            background: #007acc;
            color: white;
        }
        
        body.light-theme .ai-input {
            background: white;
            border-color: #ddd;
            color: #383a42;
        }
        
        body.light-theme .ai-input-container {
            background: #f9f9f9;
            border-top-color: #e5e5e5;
        }
        
        .ai-panel.active {
            display: flex;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .ai-panel-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 16px 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }
        
        .ai-panel-title {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .ai-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 24px;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .ai-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .ai-fullscreen-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            padding: 0;
        }
        
        .ai-fullscreen-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        /* AI Panel Fullscreen Mode */
        .ai-panel.ai-fullscreen {
            width: 100vw !important;
            height: 100vh !important;
            top: 0 !important;
            right: 0 !important;
            max-width: 100vw !important;
            border-radius: 0 !important;
            z-index: 10000 !important;
        }
        
        .ai-panel.ai-fullscreen .ai-messages {
            max-height: calc(100vh - 280px) !important;
        }
        
        .ai-panel.ai-fullscreen .ai-panel-header {
            border-radius: 0 !important;
        }
        
        /* Change fullscreen icon when in fullscreen mode */
        .ai-panel.ai-fullscreen .ai-fullscreen-btn svg {
            transform: rotate(180deg);
        }
        
        .ai-quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            padding: 15px;
            background: #252526;
            border-bottom: 1px solid #3e3e42;
        }
        
        .ai-action-btn {
            padding: 10px;
            background: #3c3c3c;
            border: 1px solid #555;
            border-radius: 6px;
            color: #cccccc;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
        }
        
        .ai-action-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }
        
        .ai-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .ai-message {
            display: flex;
            gap: 10px;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .ai-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }
        
        .ai-message.user .ai-avatar {
            background: #007acc;
        }
        
        .ai-message.assistant .ai-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .ai-message-content {
            flex: 1;
        }
        
        .ai-message-text {
            background: #3c3c3c;
            padding: 12px;
            border-radius: 8px;
            color: #d4d4d4;
            line-height: 1.5;
        }
        
        .ai-message.user .ai-message-text {
            background: #007acc;
            color: white;
        }
        
        .ai-input-container {
            padding: 15px;
            background: #252526;
            border-top: 1px solid #3e3e42;
            display: flex;
            gap: 10px;
        }
        
        .ai-input {
            flex: 1;
            background: #3c3c3c;
            border: 1px solid #555;
            color: #d4d4d4;
            padding: 10px;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
        }
        
        .ai-input:focus {
            border-color: #667eea;
        }
        
        .ai-send-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .ai-send-btn:hover {
            transform: scale(1.05);
        }
        
        .ai-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .ai-typing {
            display: flex;
            gap: 4px;
            padding: 12px;
        }
        
        .ai-typing span {
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }
        
        .ai-typing span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .ai-typing span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-8px);
            }
        }
        
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .editor-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #3e3e42;
        }
        
        .panel-header {
            background: #333333;
            padding: 10px 15px;
            border-bottom: 1px solid #3e3e42;
            font-size: 13px;
            font-weight: 500;
            color: #cccccc;
        }
        
        #editor {
            flex: 1;
            width: 100%;
        }
        
        .io-panel {
            width: 400px;
            display: flex;
            flex-direction: column;
            background: #252526;
        }
        
        .input-section, .output-section {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .input-section {
            display: none !important;
        }
        
        .output-section {
            flex: 1;
            min-height: 600px;
        }
        
        #input-editor, #output-content {
            flex: 1;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 14px;
            padding: 12px;
            background: #1e1e1e;
            color: #d4d4d4;
            border: none;
            resize: none;
            outline: none;
        }
        
        #output-content {
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            position: relative;
        }
        
        /* Interactive terminal input */
        .terminal-input-line {
            display: flex;
            align-items: center;
            margin-top: 8px;
            animation: fadeIn 0.3s;
        }
        
        .terminal-prompt {
            color: #4ade80;
            font-weight: 600;
            margin-right: 8px;
        }
        
        .terminal-input-field {
            flex: 1;
            background: transparent;
            border: none;
            border-bottom: 2px solid #667eea;
            color: #ffd700;
            font-family: 'Consolas', monospace;
            font-size: 14px;
            padding: 4px 8px;
            outline: none;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { border-bottom-color: #667eea; }
            50% { border-bottom-color: #764ba2; }
        }
        
        .terminal-input-field:focus {
            border-bottom-color: #4ade80;
            animation: none;
        }
        
        .terminal-user-input {
            color: #ffd700;
            font-weight: 500;
        }
        
        .terminal-output-line {
            margin: 4px 0;
        }
        
        .terminal-prompt-text {
            color: #667eea;
        }
        
        .output-content.error {
            color: #f48771;
        }
        
        .output-content.success {
            color: #4ec9b0;
        }
        
        /* AI Error Analysis */
        .ai-error-banner {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(245, 87, 108, 0.3);
        }
        
        .ai-error-text {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
        }
        
        .ai-analyze-btn {
            background: white;
            color: #f5576c;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.2s;
        }
        
        .ai-analyze-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }
        
        .ai-error-solution {
            background: #2d2d30;
            border: 1px solid #667eea;
            border-radius: 8px;
            padding: 16px;
            margin-top: 12px;
            animation: slideDown 0.3s ease;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .ai-error-solution::-webkit-scrollbar {
            width: 8px;
        }
        
        .ai-error-solution::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }
        
        .ai-error-solution::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
        }
        
        .ai-error-solution::-webkit-scrollbar-thumb:hover {
            background: #5568d3;
        }
        
        body.light-theme .ai-error-solution {
            background: #f0f4ff;
            border-color: #667eea;
        }
        
        body.light-theme .ai-error-solution::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
        }
        
        body.light-theme .ai-error-solution::-webkit-scrollbar-thumb {
            background: #667eea;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .ai-solution-header {
            color: #667eea;
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .ai-solution-content {
            color: #d4d4d4;
            line-height: 1.6;
        }
        
        body.light-theme .ai-solution-content {
            color: #383a42;
        }
        
        .ai-solution-fix {
            background: #3c3c3c;
            border-left: 3px solid #4ade80;
            padding: 12px;
            margin-top: 12px;
            border-radius: 4px;
            font-family: 'Consolas', monospace;
            font-size: 13px;
        }
        
        body.light-theme .ai-solution-fix {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .ai-analyzing {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 6px;
            margin-top: 10px;
        }
        
        .ai-analyzing-spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .status-bar {
            background: #007acc;
            color: white;
            padding: 6px 15px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-bar.error {
            background: #f48771;
        }
        
        .status-bar.success {
            background: #16c60c;
        }
        
        .spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Light theme */
        body.light-theme {
            background: #ffffff;
            color: #383a42;
        }
        
        body.light-theme .header {
            background: #f3f3f3;
            border-bottom-color: #e5e5e5;
        }
        
        body.light-theme .panel-header {
            background: #f3f3f3;
            border-bottom-color: #e5e5e5;
            color: #383a42;
        }
        
        body.light-theme .language-selector,
        body.light-theme .btn-theme {
            background: #e5e5e5;
            color: #383a42;
            border-color: #ccc;
        }
        
        body.light-theme .io-panel {
            background: #f9f9f9;
        }
        
        body.light-theme #input-editor,
        body.light-theme #output-content {
            background: #ffffff;
            color: #383a42;
        }
        
        body.light-theme .editor-panel {
            border-right-color: #e5e5e5;
        }
        
        body.light-theme .input-section {
            border-bottom-color: #e5e5e5;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <div class="logo">
                <span>Code Editor</span>
            </div>
            <select class="language-selector" id="languageSelect">
                <option value="javascript" data-id="63">JavaScript (Node.js)</option>
                <option value="php" data-id="68">PHP</option>
                <option value="python" data-id="71">Python 3</option>
                <option value="htmlcss" data-id="htmlcss">HTML & CSS</option>
            </select>
        </div>
        <div class="header-right">
            <button class="btn btn-ai" id="aiBtn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                    <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                </svg>
                <span>AI Assistant</span>
                <span class="ai-pulse"></span>
            </button>
            <button class="btn btn-run" id="runBtn">
                <span>â–¶</span>
                <span>Run Code</span>
            </button>
            <button class="btn btn-clear" id="clearBtn">Clear Output</button>
            <button class="btn btn-fullscreen" id="fullscreenBtn" title="Toggle Fullscreen">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
                </svg>
            </button>
            <button class="btn btn-theme-icon" id="themeBtn" title="Toggle Dark/Light Mode">
                <svg id="themeIcon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                </svg>
            </button>
        </div>
    </div>
    
    <!-- Fullscreen Exit Button -->
    <button class="fullscreen-exit-btn" id="fullscreenExitBtn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"></path>
        </svg>
        Exit Fullscreen (ESC)
    </button>
    
    <!-- AI Assistant Panel -->
    <div class="ai-panel" id="aiPanel">
        <div class="ai-panel-header">
            <div class="ai-panel-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                </svg>
                <span>AI Coding Assistant</span>
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <button class="ai-fullscreen-btn" id="aiFullscreenBtn" title="Fullscreen">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M8 3H5a2 2 0 00-2 2v3m18 0V5a2 2 0 00-2-2h-3m0 18h3a2 2 0 002-2v-3M3 16v3a2 2 0 002 2h3"></path>
                    </svg>
                </button>
                <button class="ai-close" id="aiCloseBtn">Ã—</button>
            </div>
        </div>
        
        <div class="ai-quick-actions">
            <button class="ai-action-btn" data-action="explain">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                    <path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                </svg>
                Explain Code
            </button>
            <button class="ai-action-btn" data-action="bugs">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                    <path d="M12 9v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Find Bugs
            </button>
            <button class="ai-action-btn" data-action="optimize">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                    <path d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
                Optimize
            </button>
            <button class="ai-action-btn" data-action="document">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                    <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                Add Docs
            </button>
        </div>
        
        <div class="ai-messages" id="aiMessages">
            <div class="ai-message assistant">
                <div class="ai-avatar">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                </div>
                <div class="ai-message-content">
                    <div class="ai-message-text">
                        Hi! I'm your AI coding assistant. I can help you:
                        <br>â€¢ Explain code step by step
                        <br>â€¢ Find and fix bugs
                        <br>â€¢ Optimize performance
                        <br>â€¢ Add documentation
                        <br>â€¢ Answer coding questions
                        <br><br>Click a quick action or type your question below!
                    </div>
                </div>
            </div>
        </div>
        
        <div class="ai-input-container">
            <input type="text" class="ai-input" id="aiInput" placeholder="Ask me anything about your code...">
            <button class="ai-send-btn" id="aiSendBtn">Send</button>
        </div>
    </div>
    
    <div class="main-content">
        <div class="editor-panel">
            <div class="panel-header">Code Editor</div>
            <div id="editor"></div>
        </div>
        
        <div class="io-panel">
            <div class="output-section">
                <div class="panel-header">Interactive Terminal</div>
                <div id="ai-error-container" style="padding: 12px; display: none; max-height: 500px; overflow-y: auto;"></div>
                <div id="output-content" contenteditable="false">Ready to execute code...</div>
            </div>
        </div>
    </div>
    
    <div class="status-bar" id="statusBar">
        <span id="statusText">Ready</span>
    </div>

    <!-- Monaco Editor -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
    <script>
        let editor;
        let isDarkTheme = true;
        
        // Sample code templates
        const sampleCode = {
            javascript: `// JavaScript Code Editor
console.log("Hello, World!");

// Read input (use readline in Node.js)
const readline = require('readline');
const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout
});

rl.question('', (name) => {
    console.log(\`Hello, \${name}!\`);
    rl.close();
});`,
            
            php: `<?php
// PHP Code Editor
echo "Hello, World!\\n";

$name = trim(fgets(STDIN));
echo "Hello, " . $name . "!\\n";
?>`,
            
            python: `# Python Code Editor
print("Hello, World!")

# Read input
name = input()
print(f"Hello, {name}!")

# Example calculation
numbers = [1, 2, 3, 4, 5]
total = sum(numbers)
print(f"Sum: {total}")`,
            
            htmlcss: `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Web Page</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 50px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            text-align: center;
        }
        
        h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        p {
            color: #333;
            font-size: 1.2em;
            line-height: 1.6;
            margin-bottom: 30px;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1em;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        button:active {
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸš€ Hello, World!</h1>
        <p>Welcome to HTML & CSS Web Page Creator!</p>
        <p>Create beautiful, responsive web pages with modern styling.</p>
        <button onclick="alert('ðŸŽ‰ Button clicked! You can add JavaScript here.')">Click Me!</button>
    </div>
</body>
</html>`
        };
        
        // Language mode mapping
        const languageModes = {
            javascript: 'javascript',
            php: 'php',
            python: 'python',
            htmlcss: 'html'
        };
        
        // Initialize Monaco Editor
        require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' } });
        
        require(['vs/editor/editor.main'], function () {
            editor = monaco.editor.create(document.getElementById('editor'), {
                value: sampleCode.javascript,
                language: 'javascript',
                theme: 'vs-dark',
                fontSize: 14,
                minimap: { enabled: true },
                automaticLayout: true,
                scrollBeyondLastLine: false,
                wordWrap: 'on'
            });
            
            // Load saved code
            const savedLang = localStorage.getItem('selectedLanguage') || 'javascript';
            const savedCode = localStorage.getItem(`code_${savedLang}`);
            if (savedCode) {
                editor.setValue(savedCode);
            }
            document.getElementById('languageSelect').value = savedLang;
            
            // Save code on change
            editor.onDidChangeModelContent(() => {
                const lang = document.getElementById('languageSelect').value;
                localStorage.setItem(`code_${lang}`, editor.getValue());
            });
            
            // Set initial button text
            updateRunButtonText(savedLang);
        });
        
        // Update button text based on language
        function updateRunButtonText(lang) {
            const runBtn = document.getElementById('runBtn');
            const btnText = runBtn.querySelector('span:last-child');
            
            if (lang === 'htmlcss') {
                btnText.textContent = 'Preview Web Page';
            } else {
                btnText.textContent = 'Run Code';
            }
        }
        
        // Event Listeners
        document.getElementById('languageSelect').addEventListener('change', function() {
            const lang = this.value;
            const mode = languageModes[lang];
            
            localStorage.setItem('selectedLanguage', lang);
            
            const savedCode = localStorage.getItem(`code_${lang}`);
            if (savedCode) {
                editor.setValue(savedCode);
            } else {
                editor.setValue(sampleCode[lang] || '');
            }
            
            monaco.editor.setModelLanguage(editor.getModel(), mode);
            updateRunButtonText(lang);
        });
        
        document.getElementById('runBtn').addEventListener('click', runCode);
        document.getElementById('clearBtn').addEventListener('click', () => {
            document.getElementById('output-content').textContent = 'Output cleared.';
            document.getElementById('output-content').className = '';
        });
        
        // Theme toggle
        document.getElementById('themeBtn').addEventListener('click', toggleTheme);
        
        // Fullscreen toggle
        document.getElementById('fullscreenBtn').addEventListener('click', toggleFullscreen);
        document.getElementById('fullscreenExitBtn').addEventListener('click', toggleFullscreen);
        
        // AI Assistant Event Listeners
        document.getElementById('aiBtn').addEventListener('click', () => {
            document.getElementById('aiPanel').classList.toggle('active');
        });
        
        document.getElementById('aiCloseBtn').addEventListener('click', () => {
            const aiPanel = document.getElementById('aiPanel');
            aiPanel.classList.remove('active');
            aiPanel.classList.remove('ai-fullscreen');
        });
        
        document.getElementById('aiFullscreenBtn').addEventListener('click', () => {
            document.getElementById('aiPanel').classList.toggle('ai-fullscreen');
        });
        
        document.getElementById('aiSendBtn').addEventListener('click', sendAIMessage);
        document.getElementById('aiInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendAIMessage();
        });
        
        // Quick action buttons
        document.querySelectorAll('.ai-action-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const action = btn.dataset.action;
                handleQuickAction(action);
            });
        });
        
        // Interactive terminal execution
        let terminalInputBuffer = [];
        let currentInputResolver = null;
        
        // Run code function with interactive terminal
        async function runCode() {
            const runBtn = document.getElementById('runBtn');
            const outputDiv = document.getElementById('output-content');
            const statusBar = document.getElementById('statusBar');
            const statusText = document.getElementById('statusText');
            const languageSelect = document.getElementById('languageSelect');
            
            const code = editor.getValue();
            const language = languageSelect.value;
            const languageId = languageSelect.selectedOptions[0].dataset.id;
            
            if (!code.trim()) {
                outputDiv.textContent = 'Error: No code to execute!';
                outputDiv.className = 'error';
                return;
            }
            
            // Handle HTML & CSS preview
            if (language === 'htmlcss') {
                const previewWindow = window.open('', '_blank');
                previewWindow.document.write(code);
                previewWindow.document.close();
                
                outputDiv.textContent = 'âœ“ Web page preview opened in a new window!\n\nYou can now see your HTML & CSS rendered together.';
                outputDiv.className = 'success';
                statusBar.className = 'status-bar success';
                statusText.textContent = 'Preview opened successfully!';
                return;
            }
            
            // Clear output and prepare for interactive execution
            outputDiv.innerHTML = '';
            outputDiv.className = '';
            hideAIErrorAnalysis();
            
            // Check if code needs input
            const needsInput = code.includes('input(') || code.includes('readline') || code.includes('fgets') || code.includes('Scanner');
            
            if (needsInput) {
                // Interactive mode
                await runCodeInteractive(code, language, languageId);
            } else {
                // Regular execution
                await runCodeDirect(code, language, languageId, '');
            }
        }
        
        // Interactive execution with terminal-style input
        async function runCodeInteractive(code, language, languageId) {
            const runBtn = document.getElementById('runBtn');
            const outputDiv = document.getElementById('output-content');
            const statusBar = document.getElementById('statusBar');
            const statusText = document.getElementById('statusText');
            
            runBtn.disabled = true;
            statusBar.className = 'status-bar';
            statusText.innerHTML = '<span class="spinner"></span> Running...';
            
            // Show initial output
            addTerminalOutput('Program started...\n', '#4ec9b0');
            
            // Detect input prompts in the code
            const inputPrompts = extractInputPrompts(code, language);
            
            // Store prompts to filter them from output later
            window.executedPrompts = inputPrompts;
            
            if (inputPrompts.length > 0) {
                // Show prompt and wait for user input
                const userInputs = [];
                
                for (let i = 0; i < inputPrompts.length; i++) {
                    const prompt = inputPrompts[i] || `Input required:`;
                    const userInput = await getTerminalInput(prompt);
                    userInputs.push(userInput);
                }
                
                // Execute with collected inputs
                const combinedInput = userInputs.join('\n');
                await runCodeDirect(code, language, languageId, combinedInput, true);
            } else {
                // Assume one input needed
                const userInput = await getTerminalInput('Enter input:');
                await runCodeDirect(code, language, languageId, userInput, true);
            }
        }
        
        // Direct code execution
        async function runCodeDirect(code, language, languageId, input, isInteractive = false) {
            const runBtn = document.getElementById('runBtn');
            const outputDiv = document.getElementById('output-content');
            const statusBar = document.getElementById('statusBar');
            const statusText = document.getElementById('statusText');
            
            // Disable run button
            runBtn.disabled = true;
            statusBar.className = 'status-bar';
            
            if (!isInteractive) {
                outputDiv.innerHTML = '';
                statusText.innerHTML = '<span class="spinner"></span> Executing code...';
            }
            
            try {
                // Using Piston API (free code execution API)
                const response = await fetch('https://emkc.org/api/v2/piston/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        language: language,
                        version: '*',
                        files: [{
                            content: code
                        }],
                        stdin: input
                    })
                });
                
                const result = await response.json();
                
                if (result.run) {
                    let output = '';
                    let hasError = false;
                    let errorMessage = '';
                    
                    if (result.run.stdout) {
                        output += result.run.stdout;
                    }
                    
                    if (result.run.stderr) {
                        hasError = true;
                        errorMessage = result.run.stderr;
                        output += '\n--- Errors/Warnings ---\n' + result.run.stderr;
                    }
                    
                    if (result.run.code !== 0) {
                        hasError = true;
                        outputDiv.className = 'error';
                        statusBar.className = 'status-bar error';
                        statusText.textContent = `Execution completed with errors (Exit code: ${result.run.code})`;
                    } else {
                        outputDiv.className = 'success';
                        statusBar.className = 'status-bar success';
                        statusText.textContent = 'Execution completed successfully!';
                    }
                    
                    // Display output in terminal style
                    if (output) {
                        // Filter out prompt lines if interactive mode
                        let cleanOutput = output;
                        
                        if (isInteractive && window.executedPrompts) {
                            // Remove all prompt text from output
                            cleanOutput = output;
                            
                            // Remove each prompt from the output
                            window.executedPrompts.forEach(prompt => {
                                // Remove the prompt text wherever it appears
                                const promptRegex = new RegExp(prompt.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
                                cleanOutput = cleanOutput.replace(promptRegex, '');
                            });
                            
                            // Clean up: remove lines that are now empty or just whitespace
                            const lines = cleanOutput.split('\n');
                            const filteredLines = lines.filter(line => {
                                const trimmed = line.trim();
                                return trimmed.length > 0;
                            });
                            
                            cleanOutput = filteredLines.join('\n');
                        }
                        
                        if (cleanOutput.trim()) {
                            addTerminalOutput('\n' + cleanOutput);
                        }
                    } else if (!isInteractive) {
                        addTerminalOutput('(No output)', '#888');
                    }
                    
                    // Show AI Error Analysis if there's an error
                    if (hasError) {
                        showAIErrorAnalysis(errorMessage, code, language);
                    } else {
                        hideAIErrorAnalysis();
                    }
                } else if (result.message) {
                    outputDiv.textContent = 'Error: ' + result.message;
                    outputDiv.className = 'error';
                    statusBar.className = 'status-bar error';
                    statusText.textContent = 'Execution failed';
                    showAIErrorAnalysis(result.message, code, language);
                }
            } catch (error) {
                outputDiv.textContent = 'Error: Failed to execute code.\n\n' + error.message;
                outputDiv.className = 'error';
                statusBar.className = 'status-bar error';
                statusText.textContent = 'Execution failed';
            } finally {
                runBtn.disabled = false;
            }
        }
        
        // Toggle theme (affects both editor and AI panel)
        function toggleTheme() {
            isDarkTheme = !isDarkTheme;
            const themeIcon = document.getElementById('themeIcon');
            
            if (isDarkTheme) {
                // Switch to Dark Mode - Show Moon Icon
                document.body.classList.remove('light-theme');
                monaco.editor.setTheme('vs-dark');
                // Moon icon (dark mode)
                themeIcon.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>';
                console.log('âœ… Dark theme activated (Editor + AI Panel)');
            } else {
                // Switch to Light Mode - Show Sun Icon
                document.body.classList.add('light-theme');
                monaco.editor.setTheme('vs-light');
                // Sun icon (light mode)
                themeIcon.innerHTML = '<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>';
                console.log('âœ… Light theme activated (Editor + AI Panel)');
            }
            
            localStorage.setItem('theme', isDarkTheme ? 'dark' : 'light');
        }
        
        // Load theme preference
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'light') {
            toggleTheme();
        }
        
        // AI Assistant Functions
        async function sendAIMessage() {
            const aiInput = document.getElementById('aiInput');
            const message = aiInput.value.trim();
            
            if (!message) return;
            
            // Add user message to chat
            addAIMessage('user', message);
            aiInput.value = '';
            
            // Show typing indicator
            addTypingIndicator();
            
            // Get current code and language from the ACTUAL editor
            const code = editor.getValue();
            const language = document.getElementById('languageSelect').value;
            
            try {
                // Get AI response analyzing the ACTUAL code
                const response = await getAIResponse(message, code, language);
                removeTypingIndicator();
                addAIMessage('assistant', response);
            } catch (error) {
                removeTypingIndicator();
                addAIMessage('assistant', `<strong>Error:</strong> Could not analyze code. Please try again.`);
                console.error('AI Assistant error:', error);
            }
        }
        
        function handleQuickAction(action) {
            const code = editor.getValue();
            const language = document.getElementById('languageSelect').value;
            
            let message = '';
            switch(action) {
                case 'explain':
                    message = 'Explain this code step by step';
                    break;
                case 'bugs':
                    message = 'Find bugs and potential issues in this code';
                    break;
                case 'optimize':
                    message = 'How can I optimize this code for better performance?';
                    break;
                case 'document':
                    message = 'Add helpful comments and documentation to this code';
                    break;
            }
            
            document.getElementById('aiInput').value = message;
            sendAIMessage();
        }
        
        function addAIMessage(role, content) {
            const messagesDiv = document.getElementById('aiMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `ai-message ${role}`;
            
            const avatarIcon = role === 'user' 
                ? '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>'
                : '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>';
            
            messageDiv.innerHTML = `
                <div class="ai-avatar">${avatarIcon}</div>
                <div class="ai-message-content">
                    <div class="ai-message-text">${content.replace(/\n/g, '<br>')}</div>
                </div>
            `;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function addTypingIndicator() {
            const messagesDiv = document.getElementById('aiMessages');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'ai-typing-indicator';
            typingDiv.className = 'ai-message assistant';
            typingDiv.innerHTML = `
                <div class="ai-avatar">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                </div>
                <div class="ai-message-content">
                    <div class="ai-typing">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            `;
            messagesDiv.appendChild(typingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function removeTypingIndicator() {
            const indicator = document.getElementById('ai-typing-indicator');
            if (indicator) indicator.remove();
        }
        
        async function getAIResponse(message, code, language) {
            // Analyze the ACTUAL code from the editor
            const lowerMsg = message.toLowerCase();
            const codeLines = code.split('\n').filter(line => line.trim().length > 0);
            const totalLines = code.split('\n').length;
            
            // Extract code structure
            const functions = extractFunctions(code, language);
            const variables = extractVariables(code, language);
            const imports = extractImports(code, language);
            const comments = extractComments(code, language);
            
            // Try to call backend API first (if configured)
            const AI_API_URL = window.AI_ASSISTANT_API_URL || 'http://localhost:5001/api/ai-assistant';
            
            try {
                const response = await fetch(AI_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        code: code,
                        language: language,
                        functions: functions,
                        variables: variables
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return data.response || data.message || analyzeCodeLocally(message, code, language, functions, variables, imports, comments);
                }
            } catch (err) {
                // Backend not available, use local analysis
                console.log('AI Backend not available, using local analysis');
            }
            
            // Local code analysis (fallback)
            return analyzeCodeLocally(message, code, language, functions, variables, imports, comments);
        }
        
        function analyzeCodeLocally(message, code, language, functions, variables, imports, comments) {
            const lowerMsg = message.toLowerCase();
            const codeLines = code.split('\n').filter(line => line.trim().length > 0);
            const totalLines = code.split('\n').length;
            
            if (lowerMsg.includes('explain')) {
                return generateExplanation(code, language, functions, variables, imports);
            }
            
            if (lowerMsg.includes('bug') || lowerMsg.includes('error') || lowerMsg.includes('issue')) {
                return findBugs(code, language, functions, variables);
            }
            
            if (lowerMsg.includes('optim') || lowerMsg.includes('improve') || lowerMsg.includes('performance')) {
                return suggestOptimizations(code, language, functions, variables);
            }
            
            if (lowerMsg.includes('document') || lowerMsg.includes('comment') || lowerMsg.includes('doc')) {
                return addDocumentation(code, language, functions);
            }
            
            // General response analyzing the actual code
            return generateGeneralAnalysis(message, code, language, functions, variables, imports, totalLines);
        }
        
        function extractFunctions(code, language) {
            const functions = [];
            const lines = code.split('\n');
            
            if (language === 'python') {
                const funcRegex = /^\s*(def|async def)\s+(\w+)\s*\([^)]*\)/g;
                lines.forEach((line, index) => {
                    const match = line.match(funcRegex);
                    if (match) {
                        functions.push({
                            name: match[0].match(/(\w+)\s*\(/)[1],
                            line: index + 1,
                            signature: line.trim()
                        });
                    }
                });
            } else if (language === 'javascript') {
                const funcRegex = /(function\s+\w+|const\s+\w+\s*=\s*(?:async\s+)?\(|let\s+\w+\s*=\s*(?:async\s+)?\(|\w+\s*:\s*(?:async\s+)?\([^)]*\)\s*=>)/g;
                lines.forEach((line, index) => {
                    const match = line.match(funcRegex);
                    if (match) {
                        const nameMatch = line.match(/(?:function\s+|const\s+|let\s+)(\w+)/);
                        functions.push({
                            name: nameMatch ? nameMatch[1] : 'anonymous',
                            line: index + 1,
                            signature: line.trim()
                        });
                    }
                });
            } else if (language === 'java') {
                const funcRegex = /(public|private|protected)?\s*(static)?\s*\w+\s+(\w+)\s*\(/g;
                lines.forEach((line, index) => {
                    const match = line.match(funcRegex);
                    if (match) {
                        const nameMatch = line.match(/(\w+)\s*\(/);
                        functions.push({
                            name: nameMatch ? nameMatch[1] : 'unknown',
                            line: index + 1,
                            signature: line.trim()
                        });
                    }
                });
            }
            
            return functions;
        }
        
        function extractVariables(code, language) {
            const variables = [];
            const lines = code.split('\n');
            
            if (language === 'python') {
                lines.forEach((line, index) => {
                    // Match variable assignments
                    const varMatch = line.match(/^\s*(\w+)\s*=\s*.+/);
                    if (varMatch && !line.includes('def ') && !line.includes('class ')) {
                        variables.push({
                            name: varMatch[1],
                            line: index + 1,
                            value: line.split('=')[1]?.trim().substring(0, 50) || ''
                        });
                    }
                });
            } else if (language === 'javascript') {
                lines.forEach((line, index) => {
                    const varMatch = line.match(/(?:const|let|var)\s+(\w+)\s*=/);
                    if (varMatch) {
                        variables.push({
                            name: varMatch[1],
                            line: index + 1,
                            value: line.split('=')[1]?.trim().substring(0, 50) || ''
                        });
                    }
                });
            }
            
            return variables;
        }
        
        function extractImports(code, language) {
            const imports = [];
            const lines = code.split('\n');
            
            lines.forEach((line, index) => {
                if (language === 'python' && (line.includes('import ') || line.includes('from '))) {
                    imports.push({ line: index + 1, statement: line.trim() });
                } else if (language === 'javascript' && line.includes('import ')) {
                    imports.push({ line: index + 1, statement: line.trim() });
                } else if (language === 'java' && line.includes('import ')) {
                    imports.push({ line: index + 1, statement: line.trim() });
                }
            });
            
            return imports;
        }
        
        function extractComments(code, language) {
            const comments = [];
            const lines = code.split('\n');
            
            lines.forEach((line, index) => {
                const trimmed = line.trim();
                if (trimmed.startsWith('//') || trimmed.startsWith('#') || trimmed.startsWith('/*')) {
                    comments.push({ line: index + 1, text: trimmed.substring(0, 100) });
                }
            });
            
            return comments;
        }
        
        function generateExplanation(code, language, functions, variables, imports) {
            const lines = code.split('\n');
            const nonEmptyLines = lines.filter(l => l.trim().length > 0);
            
            // Single unified block - Simple design
            let explanation = `<div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border-left: 4px solid #667eea; margin-bottom: 16px;">`;
            
            // Header
            explanation += `<div style="margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid #e0e0e0;">`;
            explanation += `<strong style="font-size: 18px; color: #333;">ðŸ“– Code Explanation</strong><br>`;
            explanation += `<span style="color: #666; font-size: 13px;">${language.toUpperCase()} â€¢ ${lines.length} lines â€¢ ${nonEmptyLines.length} code lines</span>`;
            explanation += `</div>`;
            
            // 1. IMPORTS/DEPENDENCIES SECTION
            if (imports.length > 0) {
                explanation += `<div style="margin-bottom: 16px;">`;
                explanation += `<strong style="color: #333; font-size: 14px;">ðŸ“¦ Imports & Dependencies</strong><br>`;
                imports.forEach((imp, index) => {
                    explanation += `<div style="margin: 8px 0 8px 20px; padding: 8px; background: white; border-radius: 4px; border-left: 3px solid #667eea;">`;
                    explanation += `<code style="color: #333; font-size: 13px;">${imp.statement}</code><br>`;
                    const importExplanation = explainImport(imp.statement, language);
                    explanation += `<span style="color: #666; font-size: 12px;">â†’ ${importExplanation}</span>`;
                    explanation += `</div>`;
                });
                explanation += `</div>`;
            }
            
            // 2. VARIABLES INITIALIZATION
            if (variables.length > 0) {
                explanation += `<div style="margin-bottom: 16px;">`;
                explanation += `<strong style="color: #333; font-size: 14px;">ðŸ“ Variables</strong><br>`;
                variables.slice(0, 15).forEach(v => {
                    const varLine = lines[v.line - 1];
                    explanation += `<div style="margin: 8px 0 8px 20px; padding: 8px; background: white; border-radius: 4px; border-left: 3px solid #667eea;">`;
                    explanation += `<code style="color: #333; font-size: 13px; font-weight: 600;">${v.name}</code>`;
                    explanation += `<span style="color: #999; font-size: 11px; margin-left: 8px;">(Line ${v.line})</span><br>`;
                    const varExplanation = explainVariable(varLine, v.name, language);
                    explanation += `<span style="color: #666; font-size: 12px;">â†’ ${varExplanation}</span>`;
                    explanation += `</div>`;
                });
                if (variables.length > 15) {
                    explanation += `<div style="margin-left: 20px; color: #999; font-size: 12px;">...and ${variables.length - 15} more variables</div>`;
                }
                explanation += `</div>`;
            }
            
            // 3. FUNCTIONS DEFINITION
            if (functions.length > 0) {
                explanation += `<div style="margin-bottom: 16px;">`;
                explanation += `<strong style="color: #333; font-size: 14px;">ðŸ”§ Functions</strong><br>`;
                functions.forEach(func => {
                    explanation += `<div style="margin: 8px 0 8px 20px; padding: 8px; background: white; border-radius: 4px; border-left: 3px solid #667eea;">`;
                    explanation += `<code style="color: #333; font-size: 13px; font-weight: 600;">${func.name}()</code>`;
                    explanation += `<span style="color: #999; font-size: 11px; margin-left: 8px;">(Line ${func.line})</span><br>`;
                    explanation += `<code style="color: #666; font-size: 11px; display: block; margin: 4px 0; background: #f5f5f5; padding: 4px; border-radius: 3px;">${func.signature}</code>`;
                    const funcExplanation = explainFunction(func.name, lines, func.line - 1, language);
                    explanation += `<span style="color: #666; font-size: 12px;">â†’ ${funcExplanation}</span>`;
                    explanation += `</div>`;
                });
                explanation += `</div>`;
            }
            
            // 4. MAIN LOGIC/EXECUTION FLOW
            explanation += `<div style="margin-bottom: 16px;">`;
            explanation += `<strong style="color: #333; font-size: 14px;">ðŸ”„ Execution Flow</strong><br>`;
            
            const mainLogic = analyzeMainLogic(code, lines, language, functions);
            explanation += mainLogic;
            
            explanation += `</div>`;
            
            // 5. INPUT/OUTPUT OPERATIONS
            const ioOperations = analyzeIOOperations(code, language);
            if (ioOperations.hasInput || ioOperations.hasOutput) {
                explanation += `<div style="margin-bottom: 16px;">`;
                explanation += `<strong style="color: #333; font-size: 14px;">ðŸ’¬ Input/Output</strong><br>`;
                
                if (ioOperations.hasInput) {
                    explanation += `<div style="margin: 8px 0 8px 20px;">`;
                    explanation += `<strong style="color: #666; font-size: 13px;">ðŸ“¥ Input:</strong> <span style="color: #666; font-size: 12px;">Reads data from user</span><br>`;
                    ioOperations.inputLines.forEach(line => {
                        explanation += `<span style="color: #999; font-size: 11px; margin-left: 10px;">â€¢ Line ${line.lineNum}</span><br>`;
                    });
                    explanation += `</div>`;
                }
                
                if (ioOperations.hasOutput) {
                    explanation += `<div style="margin: 8px 0 8px 20px;">`;
                    explanation += `<strong style="color: #666; font-size: 13px;">ðŸ“¤ Output:</strong> <span style="color: #666; font-size: 12px;">Displays results</span><br>`;
                    ioOperations.outputLines.forEach(line => {
                        explanation += `<span style="color: #999; font-size: 11px; margin-left: 10px;">â€¢ Line ${line.lineNum}</span><br>`;
                    });
                    explanation += `</div>`;
                }
                
                explanation += `</div>`;
            }
            
            // 6. CONTROL FLOW (IF/LOOPS)
            const controlFlow = analyzeControlFlow(code, lines, language);
            if (controlFlow.hasControl) {
                explanation += `<div style="margin-bottom: 16px;">`;
                explanation += `<strong style="color: #333; font-size: 14px;">ðŸ”€ Control Flow</strong><br>`;
                explanation += `<div style="margin-left: 20px; color: #666; font-size: 12px;">`;
                explanation += controlFlow.explanation;
                explanation += `</div></div>`;
            }
            
            // 7. FINAL SUMMARY
            explanation += `<div style="margin-bottom: 0; padding-top: 12px; border-top: 2px solid #e0e0e0;">`;
            explanation += `<strong style="color: #333; font-size: 14px;">ðŸ’¡ Summary</strong><br>`;
            explanation += `<div style="margin-left: 20px; color: #666; font-size: 12px; line-height: 1.6;">`;
            
            const summary = generateDetailedSummary(code, language, functions, variables, imports);
            explanation += summary;
            
            explanation += `</div></div>`;
            
            explanation += `</div>`; // Close main container
            
            return explanation;
        }
        
        function explainImport(statement, language) {
            if (language === 'python') {
                if (statement.includes('readline')) return 'Enables reading user input from terminal/console';
                if (statement.includes('math')) return 'Provides mathematical functions and constants';
                if (statement.includes('random')) return 'Allows generating random numbers';
                if (statement.includes('datetime')) return 'Handles date and time operations';
                if (statement.includes('os')) return 'Provides operating system functionality';
                if (statement.includes('sys')) return 'System-specific parameters and functions';
                return 'Imports external module for additional functionality';
            } else if (language === 'javascript') {
                if (statement.includes('readline')) return 'Module for reading user input line-by-line';
                if (statement.includes('fs')) return 'File system operations module';
                if (statement.includes('http')) return 'Creates HTTP servers and clients';
                if (statement.includes('express')) return 'Web application framework';
                return 'Imports external module/package';
            }
            return 'Imports external library';
        }
        
        function explainVariable(line, varName, language) {
            const trimmedLine = line.trim();
            
            // Check if it's user input
            if (trimmedLine.includes('input(') || trimmedLine.includes('readline')) {
                return 'Stores user input value';
            }
            
            // Check if it's a calculation
            if (trimmedLine.includes('+') || trimmedLine.includes('-') || trimmedLine.includes('*') || trimmedLine.includes('/')) {
                return 'Stores the result of a calculation/operation';
            }
            
            // Check if it's a constant value
            if (trimmedLine.match(/=\s*\d+/) || trimmedLine.match(/=\s*["']/)) {
                return 'Initialized with a constant value';
            }
            
            // Check if it's a function call result
            if (trimmedLine.includes('(') && trimmedLine.includes(')')) {
                return 'Stores the return value from a function call';
            }
            
            // Check if it's an object/array
            if (trimmedLine.includes('{') || trimmedLine.includes('[')) {
                return 'Creates a data structure (object/array/list)';
            }
            
            return 'Variable to store data for later use';
        }
        
        function explainFunction(funcName, lines, startLine, language) {
            // Look at the function body to understand what it does
            const funcBody = [];
            let braceCount = 0;
            let started = false;
            
            for (let i = startLine; i < Math.min(startLine + 20, lines.length); i++) {
                const line = lines[i].trim();
                if (line.includes('{')) { braceCount++; started = true; }
                if (line.includes('}')) { braceCount--; }
                if (started) funcBody.push(line);
                if (started && braceCount === 0 && language !== 'python') break;
                if (language === 'python' && i > startLine && line && !line.startsWith(' ') && !line.startsWith('\t')) break;
            }
            
            const bodyText = funcBody.join(' ').toLowerCase();
            
            if (bodyText.includes('return') && (bodyText.includes('+') || bodyText.includes('-'))) {
                return 'Performs calculation and returns the result';
            }
            if (bodyText.includes('print') || bodyText.includes('console.log')) {
                return 'Displays information to the user';
            }
            if (bodyText.includes('if')) {
                return 'Contains conditional logic to make decisions';
            }
            if (bodyText.includes('for') || bodyText.includes('while')) {
                return 'Uses loops to repeat operations';
            }
            if (bodyText.includes('return')) {
                return 'Processes data and returns a value';
            }
            
            return 'Custom function to perform specific operations';
        }
        
        function analyzeMainLogic(code, lines, language, functions) {
            let logic = '';
            let step = 1;
            
            // Find main execution code (outside functions)
            const mainLines = [];
            let inFunction = false;
            
            lines.forEach((line, index) => {
                const trimmed = line.trim();
                
                // Detect function start
                if (language === 'python' && trimmed.startsWith('def ')) {
                    inFunction = true;
                } else if (language === 'javascript' && (trimmed.includes('function ') || trimmed.match(/^\s*(const|let|var)\s+\w+\s*=\s*\(/))) {
                    inFunction = true;
                }
                
                // Detect function end
                if (language === 'python' && trimmed && !trimmed.startsWith(' ') && !trimmed.startsWith('\t') && inFunction) {
                    inFunction = false;
                }
                
                // Collect main execution lines
                if (!inFunction && trimmed && !trimmed.startsWith('#') && !trimmed.startsWith('//') && !trimmed.startsWith('import') && !trimmed.startsWith('from')) {
                    mainLines.push({ lineNum: index + 1, code: trimmed });
                }
            });
            
            if (mainLines.length === 0) {
                return `<div style="margin-left: 20px; color: #999; font-size: 12px;">No main execution logic found</div>`;
            }
            
            mainLines.forEach((item, index) => {
                const line = item.code;
                
                if (line.includes('input(') || line.includes('readline')) {
                    logic += `<div style="margin: 6px 0 6px 20px; color: #666; font-size: 12px;">`;
                    logic += `<strong>${step}.</strong> Gets user input <span style="color: #999; font-size: 11px;">(Line ${item.lineNum})</span><br>`;
                    logic += `<span style="margin-left: 20px; color: #999; font-size: 11px;">Waits for user to type and press Enter</span>`;
                    logic += `</div>`;
                    step++;
                } else if (line.includes('int(') || line.includes('float(') || line.includes('Number(') || line.includes('parseInt(')) {
                    logic += `<div style="margin: 6px 0 6px 20px; color: #666; font-size: 12px;">`;
                    logic += `<strong>${step}.</strong> Converts input to number <span style="color: #999; font-size: 11px;">(Line ${item.lineNum})</span><br>`;
                    logic += `<span style="margin-left: 20px; color: #999; font-size: 11px;">Changes text into numeric format</span>`;
                    logic += `</div>`;
                    step++;
                } else if (line.includes('=') && (line.includes('+') || line.includes('-') || line.includes('*') || line.includes('/'))) {
                    logic += `<div style="margin: 6px 0 6px 20px; color: #666; font-size: 12px;">`;
                    logic += `<strong>${step}.</strong> Performs calculation <span style="color: #999; font-size: 11px;">(Line ${item.lineNum})</span><br>`;
                    logic += `<span style="margin-left: 20px; color: #999; font-size: 11px;">Computes result using arithmetic</span>`;
                    logic += `</div>`;
                    step++;
                } else if (line.includes('print(') || line.includes('console.log(')) {
                    logic += `<div style="margin: 6px 0 6px 20px; color: #666; font-size: 12px;">`;
                    logic += `<strong>${step}.</strong> Displays result <span style="color: #999; font-size: 11px;">(Line ${item.lineNum})</span><br>`;
                    logic += `<span style="margin-left: 20px; color: #999; font-size: 11px;">Shows output to user</span>`;
                    logic += `</div>`;
                    step++;
                } else if (line.includes('if ') || line.includes('if(')) {
                    logic += `<div style="margin: 6px 0 6px 20px; color: #666; font-size: 12px;">`;
                    logic += `<strong>${step}.</strong> Makes a decision <span style="color: #999; font-size: 11px;">(Line ${item.lineNum})</span><br>`;
                    logic += `<span style="margin-left: 20px; color: #999; font-size: 11px;">Checks condition and executes accordingly</span>`;
                    logic += `</div>`;
                    step++;
                } else if (line.includes('for ') || line.includes('while ')) {
                    logic += `<div style="margin: 6px 0 6px 20px; color: #666; font-size: 12px;">`;
                    logic += `<strong>${step}.</strong> Repeats operations <span style="color: #999; font-size: 11px;">(Line ${item.lineNum})</span><br>`;
                    logic += `<span style="margin-left: 20px; color: #999; font-size: 11px;">Loops through code multiple times</span>`;
                    logic += `</div>`;
                    step++;
                } else if (functions.some(f => line.includes(f.name + '('))) {
                    const funcName = functions.find(f => line.includes(f.name + '('))?.name;
                    logic += `<div style="margin: 6px 0 6px 20px; color: #666; font-size: 12px;">`;
                    logic += `<strong>${step}.</strong> Calls function ${funcName}() <span style="color: #999; font-size: 11px;">(Line ${item.lineNum})</span><br>`;
                    logic += `<span style="margin-left: 20px; color: #999; font-size: 11px;">Executes the function code</span>`;
                    logic += `</div>`;
                    step++;
                }
            });
            
            if (logic === '') {
                logic = `<div style="margin-left: 20px; color: #999; font-size: 12px;">Sequential execution</div>`;
            }
            
            return logic;
        }
        
        function analyzeIOOperations(code, language) {
            const lines = code.split('\n');
            const result = {
                hasInput: false,
                hasOutput: false,
                inputLines: [],
                outputLines: []
            };
            
            lines.forEach((line, index) => {
                if (line.includes('input(') || line.includes('readline')) {
                    result.hasInput = true;
                    result.inputLines.push({ lineNum: index + 1, code: line.trim() });
                }
                if (line.includes('print(') || line.includes('console.log(')) {
                    result.hasOutput = true;
                    result.outputLines.push({ lineNum: index + 1, code: line.trim() });
                }
            });
            
            return result;
        }
        
        function analyzeControlFlow(code, lines, language) {
            const result = {
                hasControl: false,
                explanation: ''
            };
            
            const hasIf = code.includes('if ') || code.includes('if(');
            const hasLoop = code.includes('for ') || code.includes('while ');
            
            if (hasIf || hasLoop) {
                result.hasControl = true;
                
                if (hasIf) {
                    result.explanation += `â€¢ Has conditional logic (if/else)<br>`;
                }
                
                if (hasLoop) {
                    result.explanation += `â€¢ Uses loops (for/while)<br>`;
                }
            }
            
            return result;
        }
        
        function generateDetailedSummary(code, language, functions, variables, imports) {
            let summary = '';
            
            // Purpose
            if (code.includes('input') || code.includes('readline')) {
                summary += `<strong>Purpose:</strong> This is an <strong>interactive program</strong> that gets data from the user, processes it, and displays results.<br><br>`;
            } else if (functions.length > 0) {
                summary += `<strong>Purpose:</strong> This code defines <strong>${functions.length} reusable function${functions.length > 1 ? 's' : ''}</strong> that can be called to perform specific tasks.<br><br>`;
            } else {
                summary += `<strong>Purpose:</strong> This is a <strong>${language} script</strong> that performs operations and displays output.<br><br>`;
            }
            
            // How it works
            summary += `<strong>How it works:</strong><br>`;
            
            if (code.includes('input(') && code.includes('print(')) {
                summary += `1ï¸âƒ£ Asks the user for input<br>`;
                summary += `2ï¸âƒ£ Processes the data (calculations, operations, etc.)<br>`;
                summary += `3ï¸âƒ£ Shows the final result to the user<br><br>`;
            } else if (code.includes('readline') && code.includes('console.log')) {
                summary += `1ï¸âƒ£ Reads user input from the console<br>`;
                summary += `2ï¸âƒ£ Performs operations on the data<br>`;
                summary += `3ï¸âƒ£ Logs the output back to the console<br><br>`;
            } else if (functions.length > 0) {
                summary += `1ï¸âƒ£ Defines function${functions.length > 1 ? 's' : ''} with specific logic<br>`;
                summary += `2ï¸âƒ£ Can be called from other parts of your program<br>`;
                summary += `3ï¸âƒ£ Returns values or performs actions<br><br>`;
            } else {
                summary += `Executes operations in sequential order<br><br>`;
            }
            
            // Use case
            summary += `<strong>Use case:</strong> `;
            if (code.includes('+') || code.includes('*') || code.includes('sum')) {
                summary += `Mathematical calculations and number processing`;
            } else if (code.includes('if') && code.includes('else')) {
                summary += `Decision-making logic with multiple outcomes`;
            } else if (code.includes('for') || code.includes('while')) {
                summary += `Repetitive operations on multiple items`;
            } else {
                summary += `General-purpose ${language} program`;
            }
            
            return summary;
        }
        
        function findBugs(code, language, functions, variables) {
            const bugs = [];
            const lines = code.split('\n');
            
            // Check for common issues
            lines.forEach((line, index) => {
                const trimmed = line.trim();
                
                // Unclosed parentheses
                const openParens = (line.match(/\(/g) || []).length;
                const closeParens = (line.match(/\)/g) || []).length;
                if (openParens > closeParens) {
                    bugs.push({ line: index + 1, issue: 'Unclosed parenthesis', severity: 'high' });
                }
                
                // Unclosed quotes
                const singleQuotes = (line.match(/'/g) || []).length;
                const doubleQuotes = (line.match(/"/g) || []).length;
                if (singleQuotes % 2 !== 0 || doubleQuotes % 2 !== 0) {
                    bugs.push({ line: index + 1, issue: 'Unclosed quotes', severity: 'high' });
                }
                
                // Python: unused imports
                if (language === 'python' && line.includes('import ')) {
                    const importName = line.match(/import\s+(\w+)/);
                    if (importName && !code.includes(importName[1] + '.')) {
                        bugs.push({ line: index + 1, issue: `Potentially unused import: ${importName[1]}`, severity: 'low' });
                    }
                }
            });
            
            let analysis = `<strong>Bug Analysis</strong><br><br>`;
            
            if (bugs.length === 0) {
                analysis += `âœ… <strong>No obvious bugs detected!</strong><br><br>`;
                analysis += `Your code structure looks good. However, consider:<br>`;
                analysis += `â€¢ Adding error handling (try-catch blocks)<br>`;
                analysis += `â€¢ Input validation for user inputs<br>`;
                analysis += `â€¢ Edge case handling<br>`;
                analysis += `â€¢ Type checking where applicable<br>`;
            } else {
                analysis += `âš ï¸ <strong>Found ${bugs.length} potential issue${bugs.length > 1 ? 's' : ''}:</strong><br><br>`;
                bugs.forEach(bug => {
                    const icon = bug.severity === 'high' ? 'ðŸ”´' : 'ðŸŸ¡';
                    analysis += `${icon} <strong>Line ${bug.line}:</strong> ${bug.issue}<br>`;
                });
            }
            
            return analysis;
        }
        
        function suggestOptimizations(code, language, functions, variables) {
            const suggestions = [];
            
            if (language === 'python') {
                if (code.includes('for ') && code.includes('range(') && !code.includes('enumerate')) {
                    suggestions.push('Consider using enumerate() for index-based loops');
                }
                if (code.includes('list(') && code.includes('for ')) {
                    suggestions.push('List comprehensions can be more Pythonic');
                }
                if (code.includes('print(') && code.includes('+')) {
                    suggestions.push('Use f-strings for better string formatting');
                }
            }
            
            if (language === 'javascript') {
                if (code.includes('var ')) {
                    suggestions.push('Replace var with const/let for better scoping');
                }
                if (code.includes('function ') && !code.includes('=>')) {
                    suggestions.push('Consider arrow functions for shorter syntax');
                }
            }
            
            let analysis = `<strong>Optimization Suggestions</strong><br><br>`;
            
            if (suggestions.length > 0) {
                suggestions.forEach((s, i) => {
                    analysis += `${i + 1}. ${s}<br>`;
                });
            } else {
                analysis += `âœ… Your code is already well-optimized!<br><br>`;
                analysis += `Additional tips:<br>`;
                analysis += `â€¢ Cache frequently used values<br>`;
                analysis += `â€¢ Use appropriate data structures<br>`;
                analysis += `â€¢ Avoid unnecessary loops<br>`;
            }
            
            return analysis;
        }
        
        function addDocumentation(code, language, functions) {
            let doc = `<strong>Documentation Suggestions</strong><br><br>`;
            
            if (functions.length > 0) {
                doc += `For your ${functions.length} function${functions.length > 1 ? 's' : ''}, add:<br><br>`;
                functions.forEach(func => {
                    doc += `<strong>${func.name}():</strong><br>`;
                    doc += `â€¢ Function description<br>`;
                    doc += `â€¢ Parameter explanations<br>`;
                    doc += `â€¢ Return value documentation<br>`;
                    doc += `â€¢ Usage examples<br><br>`;
                });
            } else {
                doc += `Add comments to explain:<br>`;
                doc += `â€¢ What the code does<br>`;
                doc += `â€¢ Why certain decisions were made<br>`;
                doc += `â€¢ Complex logic explanations<br>`;
                doc += `â€¢ Expected input/output formats<br>`;
            }
            
            return doc;
        }
        
        function analyzeCodeFlow(code, language) {
            const lines = code.split('\n');
            let flow = '';
            
            if (code.includes('if ') || code.includes('if(')) {
                flow += 'Contains conditional statements<br>';
            }
            if (code.includes('for ') || code.includes('while ')) {
                flow += 'Uses loops for iteration<br>';
            }
            if (code.includes('def ') || code.includes('function ')) {
                flow += 'Defines reusable functions<br>';
            }
            if (code.includes('return ')) {
                flow += 'Returns values from functions<br>';
            }
            
            return flow || 'Sequential execution';
        }
        
        function generateGeneralAnalysis(message, code, language, functions, variables, imports, totalLines) {
            let analysis = `<strong>Code Analysis</strong><br><br>`;
            analysis += `Analyzing your <strong>${language}</strong> code in response to: "${message}"<br><br>`;
            
            analysis += `<strong>ðŸ“Š Code Statistics:</strong><br>`;
            analysis += `â€¢ Total lines: ${totalLines}<br>`;
            analysis += `â€¢ Code lines: ${code.split('\n').filter(l => l.trim().length > 0).length}<br>`;
            analysis += `â€¢ Functions: ${functions.length}<br>`;
            analysis += `â€¢ Variables: ${variables.length}<br>`;
            analysis += `â€¢ Imports: ${imports.length}<br><br>`;
            
            if (code.trim().length === 0) {
                analysis += `âš ï¸ Your editor is empty. Start typing your code!<br>`;
            } else {
                analysis += `<strong>ðŸ’¡ What I found:</strong><br>`;
                if (functions.length > 0) {
                    analysis += `â€¢ Your code defines ${functions.length} function${functions.length > 1 ? 's' : ''}<br>`;
                }
                if (code.includes('print') || code.includes('console.log')) {
                    analysis += `â€¢ Your code outputs results<br>`;
                }
                if (code.includes('input(') || code.includes('readline')) {
                    analysis += `â€¢ Your code accepts user input<br>`;
                }
                analysis += `<br>ðŸ’¬ <strong>Ask me:</strong> "Explain this code", "Find bugs", "Optimize", or "Add documentation" for detailed help!`;
            }
            
            return analysis;
        }
        
        // AI Error Analysis Functions
        function showAIErrorAnalysis(errorText, code, language) {
            const container = document.getElementById('ai-error-container');
            container.style.display = 'block';
            
            // Create error banner
            container.innerHTML = `
                <div class="ai-error-banner">
                    <div class="ai-error-text">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                            <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                        </svg>
                        <span>AI can help fix this error!</span>
                    </div>
                    <button class="ai-analyze-btn" onclick="analyzeErrorWithAI()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                            <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                        </svg>
                        Analyze Error
                    </button>
                </div>
                <div id="ai-error-solution-box"></div>
            `;
            
            // Store error details for analysis
            window.currentError = { error: errorText, code: code, language: language };
        }
        
        function hideAIErrorAnalysis() {
            const container = document.getElementById('ai-error-container');
            container.style.display = 'none';
            container.innerHTML = '';
        }
        
        async function analyzeErrorWithAI() {
            const solutionBox = document.getElementById('ai-error-solution-box');
            
            // Show analyzing indicator
            solutionBox.innerHTML = `
                <div class="ai-analyzing">
                    <div class="ai-analyzing-spinner"></div>
                    <span style="color: #667eea; font-weight: 500;">AI is analyzing the error...</span>
                </div>
            `;
            
            try {
                const { error, code, language } = window.currentError;
                
                // Call AI to analyze error
                const analysis = await analyzeError(error, code, language);
                
                // Display AI solution
                solutionBox.innerHTML = `
                    <div class="ai-error-solution">
                        <div class="ai-solution-header">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                                <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                            </svg>
                            <span>AI Error Analysis & Solution</span>
                        </div>
                        <div class="ai-solution-content">
                            ${analysis}
                        </div>
                    </div>
                `;
            } catch (err) {
                solutionBox.innerHTML = `
                    <div class="ai-error-solution">
                        <div class="ai-solution-header">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                                <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                            <span>Analysis Error</span>
                        </div>
                        <div class="ai-solution-content">
                            Could not analyze error. Please try again or contact support.
                        </div>
                    </div>
                `;
            }
        }
        
        async function analyzeError(errorText, code, language) {
            // Extract error details from the actual code
            const errorLines = errorText.split('\n');
            const codeLines = code.split('\n');
            
            // Try multiple patterns to find line number
            let lineMatch = errorText.match(/line[:\s]+(\d+)/i);
            if (!lineMatch) lineMatch = errorText.match(/at line (\d+)/i);
            if (!lineMatch) lineMatch = errorText.match(/on line (\d+)/i);
            if (!lineMatch) lineMatch = errorText.match(/Line (\d+)/);
            
            let errorLineNum = lineMatch ? parseInt(lineMatch[1]) - 1 : -1;
            
            // If no line number found, try to find the error in the code itself
            if (errorLineNum < 0) {
                // Analyze code for common syntax errors
                errorLineNum = findErrorInCode(code, errorText, language);
            }
            
            // Get the actual problematic code line
            let problematicCode = '';
            if (errorLineNum >= 0 && errorLineNum < codeLines.length) {
                problematicCode = codeLines[errorLineNum].trim();
            } else {
                // Try to extract code from error message
                const codeInError = errorText.match(/['"`](.+?)['"`]/);
                if (codeInError) {
                    problematicCode = codeInError[1];
                    // Find this code in the editor
                    for (let i = 0; i < codeLines.length; i++) {
                        if (codeLines[i].includes(problematicCode)) {
                            errorLineNum = i;
                            problematicCode = codeLines[i].trim();
                            break;
                        }
                    }
                }
            }
            
            // Find main error message
            const mainError = errorLines.find(line => 
                line.includes('Error') || 
                line.includes('error') || 
                line.includes('Exception')
            ) || errorText;
            
            // If still no line found, analyze entire code
            if (errorLineNum < 0) {
                const analysis = analyzeCodeForErrors(code, errorText, language);
                if (analysis.lineNum >= 0) {
                    errorLineNum = analysis.lineNum;
                    problematicCode = analysis.code;
                }
            }
            
            // Detailed error analysis
            let errorType = 'Unknown Error';
            let explanation = '';
            let solution = '';
            let codeExample = '';
            
            if (errorText.includes('SyntaxError')) {
                errorType = 'Syntax Error';
                
                if (errorText.includes("'(' was never closed") || errorText.includes("was never closed")) {
                    explanation = `<strong>What went wrong:</strong><br>
                    Your code on line ${errorLineNum + 1} has an <strong>unclosed parenthesis</strong>.<br><br>
                    <strong>Current code (INCORRECT):</strong><br>
                    <code style="background: rgba(245, 87, 108, 0.2); padding: 10px 14px; border-radius: 6px; display: block; margin: 10px 0; color: #f48771; font-family: 'Consolas', monospace; font-size: 14px; border-left: 3px solid #f48771;">
                    ${problematicCode}
                    </code><br>
                    In ${language}, every opening parenthesis <code>(</code> must have a matching closing parenthesis <code>)</code>.`;
                    
                    // Generate fixed code
                    const fixedCode = problematicCode + ')';
                    
                    solution = `<strong>Corrected code (FIXED):</strong><br>
                    <code style="color: #4ade80; background: rgba(74, 222, 128, 0.1); padding: 10px 14px; border-radius: 6px; display: block; margin: 10px 0; font-family: 'Consolas', monospace; font-size: 14px; border-left: 3px solid #4ade80;">
                    ${fixedCode}
                    </code><br>
                    <strong>What changed:</strong> Added closing parenthesis <code style="color: #4ade80; font-weight: bold; font-size: 16px;">)</code> at the end`;
                    
                    codeExample = `<div class="ai-solution-fix">
<strong>Step-by-Step Fix:</strong><br><br>
<strong>Step 1:</strong> Go to line <strong>${errorLineNum + 1}</strong> in your code editor<br><br>
<strong>Step 2:</strong> Replace the current line with the corrected version above<br><br>
<strong>Step 3:</strong> Click "Run Code" to test the fix
</div>`;
                    
                } else if (errorText.includes('unexpected EOF') || errorText.includes('Unexpected end of input')) {
                    // Analyze code to find the specific issue
                    const allCode = code;
                    const totalOpenParens = (allCode.match(/\(/g) || []).length;
                    const totalCloseParens = (allCode.match(/\)/g) || []).length;
                    const totalOpenBraces = (allCode.match(/\{/g) || []).length;
                    const totalCloseBraces = (allCode.match(/\}/g) || []).length;
                    const totalOpenBrackets = (allCode.match(/\[/g) || []).length;
                    const totalCloseBrackets = (allCode.match(/\]/g) || []).length;
                    
                    let missingChar = '';
                    let charCount = 0;
                    
                    if (totalOpenParens > totalCloseParens) {
                        missingChar = ')';
                        charCount = totalOpenParens - totalCloseParens;
                    } else if (totalOpenBraces > totalCloseBraces) {
                        missingChar = '}';
                        charCount = totalOpenBraces - totalCloseBraces;
                    } else if (totalOpenBrackets > totalCloseBrackets) {
                        missingChar = ']';
                        charCount = totalOpenBrackets - totalCloseBrackets;
                    }
                    
                    explanation = `<strong>What went wrong:</strong><br>
                    Your ${language} code ended unexpectedly. I analyzed your code and found:<br><br>
                    <strong>Missing character:</strong> <code style="color: #f5576c; font-size: 18px; font-weight: bold;">${missingChar || 'closing bracket/quote'}</code><br>
                    <strong>Count:</strong> You're missing <strong>${charCount || 'at least 1'}</strong> closing character(s)<br><br>
                    ${problematicCode ? `<strong>Likely problematic line (${errorLineNum + 1}):</strong><br>
                    <code style="background: rgba(245, 87, 108, 0.2); padding: 8px 12px; border-radius: 4px; display: block; margin: 8px 0; font-family: 'Consolas', monospace;">
                    ${problematicCode}
                    </code>` : ''}`;
                    
                    solution = `<strong>Analysis Results:</strong><br>
                    â€¢ Opening ${missingChar === ')' ? 'parentheses' : missingChar === '}' ? 'braces' : 'brackets'}: <strong>${totalOpenParens || totalOpenBraces || totalOpenBrackets}</strong><br>
                    â€¢ Closing ${missingChar === ')' ? 'parentheses' : missingChar === '}' ? 'braces' : 'brackets'}: <strong>${totalCloseParens || totalCloseBraces || totalCloseBrackets}</strong><br>
                    â€¢ Missing: <code style="color: #f5576c; font-weight: bold;">${missingChar}</code> (${charCount} needed)`;
                    
                    const fixedCode = problematicCode ? problematicCode + missingChar : '';
                    codeExample = `<div class="ai-solution-fix">
<strong>How to fix it:</strong><br><br>
${problematicCode ? `<strong>Step 1:</strong> Go to line <strong>${errorLineNum + 1}</strong><br><br>
<strong>Step 2:</strong> Current code:<br>
<code style="color: #f48771;">${problematicCode}</code><br><br>
<strong>Step 3:</strong> Add <code>${missingChar}</code> at the end:<br>
<code style="color: #4ade80;">${fixedCode}</code> âœ“` : 
`<strong>Step 1:</strong> Review your code's last few lines<br>
<strong>Step 2:</strong> Add ${charCount} closing <code>${missingChar}</code> character(s)<br>
<strong>Step 3:</strong> Make sure all brackets are balanced`}
</div>`;
                    
                } else {
                    // Analyze what's wrong with this specific line
                    let fixedCode = problematicCode;
                    let errorDetails = '';
                    let fixDescription = '';
                    
                    // Check for unbalanced brackets first (they need to be closed before quotes)
                    const openParens = (problematicCode.match(/\(/g) || []).length;
                    const closeParens = (problematicCode.match(/\)/g) || []).length;
                    const openBraces = (problematicCode.match(/\{/g) || []).length;
                    const closeBraces = (problematicCode.match(/\}/g) || []).length;
                    const openBrackets = (problematicCode.match(/\[/g) || []).length;
                    const closeBrackets = (problematicCode.match(/\]/g) || []).length;
                    
                    // Check for unbalanced quotes
                    const doubleQuotes = (problematicCode.match(/"/g) || []).length;
                    const singleQuotes = (problematicCode.match(/'/g) || []).length;
                    const backticks = (problematicCode.match(/`/g) || []).length;
                    
                    // Smart fixing: Insert missing characters in the correct order
                    // Priority: quotes first (inside), then brackets (outside)
                    
                    if (doubleQuotes % 2 !== 0) {
                        // Missing closing quote - insert before last closing paren if exists
                        if (problematicCode.endsWith(')')) {
                            fixedCode = problematicCode.slice(0, -1) + '")';
                            fixDescription = 'Inserted closing double quote <code>"</code> before closing parenthesis';
                        } else {
                            fixedCode = problematicCode + '"';
                            fixDescription = 'Added closing double quote <code>"</code> at the end';
                        }
                        errorDetails = 'Missing closing double quote <code>"</code>';
                    } else if (singleQuotes % 2 !== 0) {
                        if (problematicCode.endsWith(')')) {
                            fixedCode = problematicCode.slice(0, -1) + "')";
                            fixDescription = 'Inserted closing single quote <code>\'</code> before closing parenthesis';
                        } else {
                            fixedCode = problematicCode + "'";
                            fixDescription = 'Added closing single quote <code>\'</code> at the end';
                        }
                        errorDetails = 'Missing closing single quote <code>\'</code>';
                    } else if (backticks % 2 !== 0) {
                        if (problematicCode.endsWith(')')) {
                            fixedCode = problematicCode.slice(0, -1) + '`)';
                            fixDescription = 'Inserted closing backtick <code>`</code> before closing parenthesis';
                        } else {
                            fixedCode = problematicCode + '`';
                            fixDescription = 'Added closing backtick <code>`</code> at the end';
                        }
                        errorDetails = 'Missing closing backtick <code>`</code>';
                    } else if (openParens > closeParens) {
                        const needed = openParens - closeParens;
                        fixedCode = problematicCode + ')'.repeat(needed);
                        errorDetails = `Missing ${needed} closing parenthesis <code>)</code>`;
                        fixDescription = `Added ${needed} closing parenthesis <code>${')'.repeat(needed)}</code> at the end`;
                    } else if (openBraces > closeBraces) {
                        const needed = openBraces - closeBraces;
                        fixedCode = problematicCode + '}'.repeat(needed);
                        errorDetails = `Missing ${needed} closing brace <code>}</code>`;
                        fixDescription = `Added ${needed} closing brace <code>${'}'.repeat(needed)}</code> at the end`;
                    } else if (openBrackets > closeBrackets) {
                        const needed = openBrackets - closeBrackets;
                        fixedCode = problematicCode + ']'.repeat(needed);
                        errorDetails = `Missing ${needed} closing bracket <code>]</code>`;
                        fixDescription = `Added ${needed} closing bracket <code>${']'.repeat(needed)}</code> at the end`;
                    } else {
                        // Generic fix - no specific pattern detected
                        fixDescription = 'Review the code for typos and missing punctuation';
                    }
                    
                    explanation = `<strong>What went wrong:</strong><br>
                    There's a syntax error in your ${language} code on line ${errorLineNum + 1}.<br><br>
                    ${errorDetails ? `<strong>Issue detected:</strong> ${errorDetails}<br><br>` : ''}
                    <strong>Current code (line ${errorLineNum + 1}):</strong><br>
                    <code style="background: rgba(245, 87, 108, 0.2); padding: 8px 12px; border-radius: 4px; display: block; margin: 8px 0; color: #f48771; font-family: 'Consolas', monospace; font-size: 14px;">
                    ${problematicCode || 'Code line not accessible'}
                    </code>`;
                    
                    solution = `<strong>Common syntax errors in ${language}:</strong><br>
                    â€¢ Unclosed quotes or parentheses<br>
                    â€¢ Missing colons <code>:</code> after if/for/while/def<br>
                    â€¢ Incorrect indentation<br>
                    â€¢ Missing commas in lists`;
                    
                    codeExample = `<div class="ai-solution-fix">
<strong>How to Fix:</strong><br><br>
<strong>Step 1:</strong> Go to line ${errorLineNum + 1}<br><br>
<strong>Step 2:</strong> Replace this INCORRECT line:<br>
<code style="color: #f48771; background: rgba(245, 87, 108, 0.15); padding: 10px 14px; border-radius: 6px; display: block; margin: 10px 0; font-family: 'Consolas', monospace; font-size: 14px; border-left: 3px solid #f48771;">
${problematicCode}
</code><br>
<strong>Step 3:</strong> With this CORRECTED line:<br>
<code style="color: #4ade80; background: rgba(74, 222, 128, 0.1); padding: 10px 14px; border-radius: 6px; display: block; margin: 10px 0; font-family: 'Consolas', monospace; font-size: 14px; border-left: 3px solid #4ade80;">
${fixedCode}
</code><br>
<strong>What changed:</strong> ${fixDescription}
</div>`;
                }
                
            } else if (errorText.includes('NameError')) {
                errorType = 'Name Error';
                
                // Extract variable name
                const varMatch = errorText.match(/name '(\w+)' is not defined/);
                const varName = varMatch ? varMatch[1] : 'variable';
                
                explanation = `<strong>What went wrong:</strong><br>
                You're trying to use a variable called <code>${varName}</code> that hasn't been defined yet.<br><br>
                <strong>Code context:</strong><br>
                <code style="background: rgba(245, 87, 108, 0.2); padding: 8px 12px; border-radius: 4px; display: block; margin: 8px 0; font-family: 'Consolas', monospace;">
                ${problematicCode}
                </code><br>
                In ${language}, you must define a variable before using it.`;
                
                solution = `<strong>How to fix:</strong><br>
                Before using <code>${varName}</code>, you need to assign it a value.`;
                
                codeExample = `<div class="ai-solution-fix">
<strong>Solution Options:</strong><br><br>
<strong>Option 1:</strong> Define the variable before line ${errorLineNum + 1}:<br>
<code style="color: #4ade80;">${varName} = some_value</code><br><br>
<strong>Option 2:</strong> Check for typos in the variable name<br><br>
<strong>Option 3:</strong> If it's from a module, import it:<br>
<code style="color: #4ade80;">from module_name import ${varName}</code>
</div>`;
                
            } else if (errorText.includes('TypeError')) {
                errorType = 'Type Error';
                
                explanation = `<strong>What went wrong:</strong><br>
                You're trying to perform an operation on incompatible data types.<br><br>
                <strong>Problematic code:</strong><br>
                <code style="background: rgba(245, 87, 108, 0.2); padding: 8px 12px; border-radius: 4px; display: block; margin: 8px 0; font-family: 'Consolas', monospace;">
                ${problematicCode}
                </code><br>
                This error occurs when you try to use incompatible types together (like adding a string to a number).`;
                
                solution = '<strong>Common type errors:</strong><br>â€¢ Concatenating string with number<br>â€¢ Calling wrong number of arguments<br>â€¢ Using wrong data type in operations';
                codeExample = '<div class="ai-solution-fix"><strong>Solutions:</strong><br>â€¢ Convert to string: <code>str(number)</code><br>â€¢ Convert to int: <code>int(string)</code><br>â€¢ Check function arguments match requirements</div>';
                
            } else if (errorText.includes('IndentationError')) {
                errorType = 'Indentation Error';
                
                explanation = `<strong>What went wrong:</strong><br>
                Your ${language} code has inconsistent or incorrect indentation on line ${errorLineNum + 1}.<br><br>
                Python uses indentation to define code blocks, and it must be consistent.`;
                
                solution = '<strong>Indentation rules:</strong><br>â€¢ Use 4 spaces per indentation level (recommended)<br>â€¢ Don\'t mix tabs and spaces<br>â€¢ All code at the same level should have the same indentation';
                codeExample = '<div class="ai-solution-fix"><strong>Fix indentation:</strong><br>1. Select all code<br>2. Delete existing indentation<br>3. Re-indent consistently using 4 spaces or Tab key</div>';
                
            } else {
                errorType = 'Runtime Error';
                explanation = `<strong>Error details:</strong><br>${mainError}`;
                solution = '<strong>Debugging tips:</strong><br>â€¢ Read the error message carefully<br>â€¢ Check the line number<br>â€¢ Review your code logic';
                codeExample = '<div class="ai-solution-fix"><strong>Next steps:</strong><br>1. Review error message<br>2. Check line ' + (errorLineNum + 1) + '<br>3. Fix the issue<br>4. Run code again</div>';
            }
            
            // Extract code context (show surrounding lines)
            let codeContext = '';
            if (errorLineNum >= 0) {
                const startLine = Math.max(0, errorLineNum - 2);
                const endLine = Math.min(codeLines.length - 1, errorLineNum + 2);
                const contextLines = [];
                
                for (let i = startLine; i <= endLine; i++) {
                    const lineNum = i + 1;
                    const isErrorLine = i === errorLineNum;
                    const line = codeLines[i];
                    
                    if (isErrorLine) {
                        contextLines.push(`<span style="color: #f5576c; font-weight: bold;">${lineNum}  | ${line}</span> â† ERROR HERE`);
                    } else {
                        contextLines.push(`<span style="color: #888;">${lineNum}  | ${line}</span>`);
                    }
                }
                
                codeContext = `
                    <div style="margin: 16px 0;">
                        <strong>Code Context (lines ${startLine + 1}-${endLine + 1}):</strong><br>
                        <pre style="background: #1e1e1e; padding: 12px; border-radius: 6px; border-left: 3px solid #f5576c; overflow-x: auto; font-family: 'Consolas', monospace; font-size: 13px; line-height: 1.6;">
${contextLines.join('\n')}
                        </pre>
                    </div>
                `;
            }
            
            // Build complete detailed analysis
            return `
                <div style="margin-bottom: 10px;">
                    <span style="background: rgba(245, 87, 108, 0.2); padding: 6px 12px; border-radius: 4px; font-weight: 600; color: #f5576c; font-size: 14px;">
                        ${errorType}
                    </span>
                </div>
                <br>
                ${explanation}
                ${codeContext}
                <br>
                ${solution}
                <br><br>
                ${codeExample}
                <br>
                <div style="margin-top: 16px; padding: 12px; background: rgba(102, 126, 234, 0.1); border-radius: 6px; font-size: 13px; border-left: 3px solid #667eea;">
                    <strong>Pro Tip:</strong> After fixing the error, click <strong>"Run Code"</strong> again to test your changes!
                </div>
                <div style="margin-top: 12px; padding: 12px; background: rgba(74, 222, 128, 0.1); border-radius: 6px; font-size: 12px; border-left: 3px solid #4ade80;">
                    <strong>Need more help?</strong> Click the <strong>"AI Assistant"</strong> button and ask me to explain any part of your code!
                </div>
            `;
        }
        
        // Helper function to find error in code by analyzing it
        function findErrorInCode(code, errorText, language) {
            const lines = code.split('\n');
            
            // Check for common JavaScript/Python errors
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                
                // Check for unclosed parentheses
                if (errorText.includes('was never closed') || errorText.includes('Unexpected end of input')) {
                    const openParens = (line.match(/\(/g) || []).length;
                    const closeParens = (line.match(/\)/g) || []).length;
                    if (openParens > closeParens) {
                        return i;
                    }
                    
                    // Check for unclosed brackets
                    const openBrackets = (line.match(/\{/g) || []).length;
                    const closeBrackets = (line.match(/\}/g) || []).length;
                    if (openBrackets > closeBrackets) {
                        return i;
                    }
                    
                    // Check for unclosed quotes
                    const quotes = (line.match(/"/g) || []).length;
                    if (quotes % 2 !== 0) {
                        return i;
                    }
                }
            }
            
            return -1;
        }
        
        // Analyze entire code for errors
        function analyzeCodeForErrors(code, errorText, language) {
            const lines = code.split('\n');
            let foundLine = -1;
            let foundCode = '';
            
            // Check for syntax errors
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line || line.startsWith('//') || line.startsWith('#')) continue;
                
                // Check for unclosed parentheses
                const openParens = (line.match(/\(/g) || []).length;
                const closeParens = (line.match(/\)/g) || []).length;
                
                if (openParens > closeParens) {
                    foundLine = i;
                    foundCode = line;
                    break;
                }
                
                // Check for unclosed curly braces
                const openBraces = (line.match(/\{/g) || []).length;
                const closeBraces = (line.match(/\}/g) || []).length;
                
                if (openBraces > closeBraces && !line.includes('{')) {
                    foundLine = i;
                    foundCode = line;
                    break;
                }
                
                // Check for unclosed brackets
                const openBrackets = (line.match(/\[/g) || []).length;
                const closeBrackets = (line.match(/\]/g) || []).length;
                
                if (openBrackets > closeBrackets) {
                    foundLine = i;
                    foundCode = line;
                    break;
                }
                
                // Check for unclosed quotes in the line
                const doubleQuotes = (line.match(/"/g) || []).length;
                const singleQuotes = (line.match(/'/g) || []).length;
                
                if (doubleQuotes % 2 !== 0 || singleQuotes % 2 !== 0) {
                    foundLine = i;
                    foundCode = line;
                    break;
                }
            }
            
            // Check overall bracket balance
            if (foundLine < 0 && errorText.includes('Unexpected end')) {
                const allCode = code;
                const totalOpenParens = (allCode.match(/\(/g) || []).length;
                const totalCloseParens = (allCode.match(/\)/g) || []).length;
                const totalOpenBraces = (allCode.match(/\{/g) || []).length;
                const totalCloseBraces = (allCode.match(/\}/g) || []).length;
                
                if (totalOpenParens > totalCloseParens || totalOpenBraces > totalCloseBraces) {
                    // Find the last line with an opening bracket/paren
                    for (let i = lines.length - 1; i >= 0; i--) {
                        if (lines[i].includes('(') || lines[i].includes('{')) {
                            foundLine = i;
                            foundCode = lines[i].trim();
                            break;
                        }
                    }
                }
            }
            
            return { lineNum: foundLine, code: foundCode };
        }
        
        // Terminal helper functions
        function addTerminalOutput(text, color = '#d4d4d4') {
            const outputDiv = document.getElementById('output-content');
            const line = document.createElement('div');
            line.className = 'terminal-output-line';
            line.style.color = color;
            line.textContent = text;
            outputDiv.appendChild(line);
            outputDiv.scrollTop = outputDiv.scrollHeight;
        }
        
        function getTerminalInput(promptText) {
            return new Promise((resolve) => {
                const outputDiv = document.getElementById('output-content');
                
                // Create input line
                const inputLine = document.createElement('div');
                inputLine.className = 'terminal-input-line';
                
                // Create prompt
                const prompt = document.createElement('span');
                prompt.className = 'terminal-prompt-text';
                prompt.textContent = promptText + ' ';
                
                // Create input field
                const inputField = document.createElement('input');
                inputField.type = 'text';
                inputField.className = 'terminal-input-field';
                inputField.placeholder = 'Type here and press Enter...';
                
                // Handle input submission
                inputField.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        const value = inputField.value;
                        
                        // Replace input field with the entered value
                        inputLine.innerHTML = `
                            <span class="terminal-prompt-text">${promptText}</span>
                            <span class="terminal-user-input"> ${value}</span>
                        `;
                        
                        resolve(value);
                    }
                });
                
                inputLine.appendChild(prompt);
                inputLine.appendChild(inputField);
                outputDiv.appendChild(inputLine);
                
                // Auto-focus on the input field
                setTimeout(() => inputField.focus(), 100);
                
                // Scroll to bottom
                outputDiv.scrollTop = outputDiv.scrollHeight;
            });
        }
        
        function extractInputPrompts(code, language) {
            const prompts = [];
            
            if (language === 'python') {
                // Extract prompts from input() calls - support multiple quote types
                // Pattern: input("text") or input('text') or input("""text""")
                const patterns = [
                    /input\(["']([^"']+)["']\)/g,
                    /input\("""(.+?)"""\)/g,
                    /input\('''(.+?)'''\)/g,
                    /input\(f["']([^"']+)["']\)/g  // f-strings
                ];
                
                for (const pattern of patterns) {
                    const matches = [...code.matchAll(pattern)];
                    for (const match of matches) {
                        if (match[1] && match[1].trim()) {
                            prompts.push(match[1].trim());
                        }
                    }
                }
                
                // Count total input() calls
                const totalInputs = (code.match(/input\s*\(/g) || []).length;
                
                // If we found fewer prompts than input() calls, add defaults for missing ones
                while (prompts.length < totalInputs) {
                    prompts.push('Enter input:');
                }
                
                // If no input() found but might need input
                if (prompts.length === 0 && (code.includes('stdin') || code.includes('raw_input'))) {
                    prompts.push('Enter input:');
                }
            } else if (language === 'javascript') {
                // Extract from readline questions
                const patterns = [
                    /\.question\(\s*['"]([^'"]+)['"]/g,
                    /\.question\(\s*`([^`]+)`/g
                ];
                
                for (const pattern of patterns) {
                    const matches = [...code.matchAll(pattern)];
                    for (const match of matches) {
                        if (match[1] && match[1].trim()) {
                            prompts.push(match[1].trim());
                        }
                    }
                }
                
                if (prompts.length === 0 && code.includes('readline')) {
                    prompts.push('Enter your input:');
                }
            } else if (language === 'php') {
                // PHP - look for echo/print before fgets
                const lines = code.split('\n');
                for (let i = 0; i < lines.length; i++) {
                    if (lines[i].includes('fgets')) {
                        // Check previous lines for echo/print
                        if (i > 0) {
                            const prevLine = lines[i - 1];
                            const echoMatch = prevLine.match(/echo\s+["']([^"']+)["']/);
                            const printMatch = prevLine.match(/print\s+["']([^"']+)["']/);
                            
                            if (echoMatch) {
                                prompts.push(echoMatch[1].trim());
                            } else if (printMatch) {
                                prompts.push(printMatch[1].trim());
                            } else {
                                prompts.push('Enter input:');
                            }
                        } else {
                            prompts.push('Enter input:');
                        }
                    }
                }
            }
            
            return prompts;
        }
        
        // Fullscreen functionality
        let isFullscreen = false;
        
        function toggleFullscreen() {
            isFullscreen = !isFullscreen;
            
            if (isFullscreen) {
                document.body.classList.add('fullscreen-mode');
                console.log('âœ… Fullscreen mode activated');
            } else {
                document.body.classList.remove('fullscreen-mode');
                console.log('âœ… Fullscreen mode deactivated');
            }
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + Enter to run
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                runCode();
            }
            
            // Escape to close AI panel or exit fullscreen
            if (e.key === 'Escape') {
                if (isFullscreen) {
                    toggleFullscreen();
                } else {
                    document.getElementById('aiPanel').classList.remove('active');
                }
            }
            
            // F11 to toggle fullscreen
            if (e.key === 'F11') {
                e.preventDefault();
                toggleFullscreen();
            }
        });
    </script>
    
    <!-- Submit Bridge for Moodle Integration -->
    <script src="submit_bridge.js"></script>
    
    <!-- Global Expose for Moodle Submission -->
    <script>
    // Expose editor and output globally for easy access from parent window
    (function() {
        // Update global variables whenever code or output changes
        function updateGlobalData() {
            try {
                // Get code from editor
                if (typeof editor !== 'undefined' && editor && typeof editor.getValue === 'function') {
                    window.submitCode = editor.getValue();
                }
                
                // Get output from terminal
                var outputEl = document.getElementById('output-content');
                if (outputEl) {
                    window.submitOutput = outputEl.textContent || outputEl.innerText || outputEl.innerHTML;
                }
                
                // Get language
                if (typeof editor !== 'undefined' && editor && editor.getModel) {
                    var model = editor.getModel();
                    if (model && model.getLanguageId) {
                        window.submitLanguage = model.getLanguageId();
                    }
                }
                
                // Also update language selector value
                var langSelect = document.querySelector('.language-selector');
                if (langSelect && langSelect.value) {
                    window.submitLanguage = langSelect.value;
                }
                
                console.log('Global data updated:', {
                    codeLength: window.submitCode ? window.submitCode.length : 0,
                    outputLength: window.submitOutput ? window.submitOutput.length : 0,
                    language: window.submitLanguage
                });
            } catch (e) {
                console.error('Error updating global data:', e);
            }
        }
        
        // Update on editor change
        if (typeof editor !== 'undefined' && editor && editor.onDidChangeModelContent) {
            editor.onDidChangeModelContent(function() {
                updateGlobalData();
            });
        }
        
        // Update on output change (poll every second)
        setInterval(updateGlobalData, 1000);
        
        // Initial update
        setTimeout(updateGlobalData, 2000);
        
        console.log('Global submit data exposed: window.submitCode, window.submitOutput, window.submitLanguage');
    })();
    </script>
</body>
</html>




