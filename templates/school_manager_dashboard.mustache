{{!
    School Manager Dashboard Template
    Main dashboard interface for school managers/company managers with default navigation
}}

{{> theme_remui_kids/common_start}}

<!-- School Manager Sidebar -->
{{> theme_remui_kids/school_manager_sidebar}}

<!-- Main Content Area with sidebar -->
<div class="school-manager-main-content">
<div class="school-dashboard-container">
    <!-- Dashboard Header Section -->
    <div class="dashboard-header-section">
        <div class="dashboard-header-content">
            <div class="dashboard-header-main">
                <div class="dashboard-header-title-group">
                    <h1 class="dashboard-school-name">{{#company_name}}{{company_name}}{{/company_name}}{{^company_name}}{{#company_info}}{{company_info.name}}{{/company_info}}{{^company_info}}School Dashboard{{/company_info}}{{/company_name}}</h1>
                    <div class="dashboard-subtitle-wrapper">
                        <span class="dashboard-subtitle-badge">School Admin Dashboard</span>
                    </div>
                </div>
                <div class="dashboard-header-actions">
                    <div class="dashboard-header-badge">
                        <i class="fa fa-shield-alt"></i>
                        <span>Administrator</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Statistics Cards -->
    <div class="summary-section">
        <h2 class="section-title">Summary</h2>
    <div class="stats-grid">
        <!-- Total Teachers Card -->
        <div class="stat-card teachers-card">
            <div class="stat-content">
                <h3 class="stat-number" id="total-teachers">{{total_teachers}}</h3>
                <!-- Updated: {{timestamp}} -->
                <!-- DEBUG: Total teachers count is {{total_teachers}} -->
                <!-- DEBUG: Template received total_teachers = {{total_teachers}} -->
                <p class="stat-label">TOTAL TEACHERS</p>
                <div class="stat-trend">
                    <span class="trend-arrow">↑</span>
                    <span class="trend-text">Active</span>
                </div>
            </div>
            <div class="stat-icon">
                <i class="fa fa-chalkboard-teacher"></i>
            </div>
        </div>

        <!-- Total Students Card -->
        <div class="stat-card students-card">
            <div class="stat-content">
                <h3 class="stat-number" id="total-students">{{#total_students}}{{total_students}}{{/total_students}}{{^total_students}}0{{/total_students}}</h3>
                <!-- DEBUG: Total students count is {{total_students}} -->
                <!-- DEBUG: Template received total_students = {{total_students}} -->
                <p class="stat-label">TOTAL STUDENTS</p>
                <div class="stat-trend">
                    <span class="trend-arrow">↑</span>
                    <span class="trend-text">Active</span>
                </div>
            </div>
            <div class="stat-icon">
                <i class="fa fa-user-graduate"></i>
            </div>
        </div>

        <!-- Courses Card -->
        <div class="stat-card courses-card">
            <div class="stat-content">
                <h3 class="stat-number" id="total-courses">{{total_courses}}</h3>
                <!-- DEBUG: Template received total_courses = {{total_courses}} -->
                <p class="stat-label">AVAILABLE COURSES</p>
                <div class="stat-trend">
                    <span class="trend-arrow">↑</span>
                    <span class="trend-text">Active</span>
                </div>
            </div>
            <div class="stat-icon">
                <i class="fa fa-file-alt"></i>
            </div>
        </div>

        <!-- Enrollments Card -->
        <div class="stat-card enrollments-card">
            <div class="stat-content">
                <h3 class="stat-number" id="active-enrollments">{{active_enrollments}}</h3>
                <!-- DEBUG: Template received active_enrollments = {{active_enrollments}} -->
                <p class="stat-label">ACTIVE ENROLLMENTS</p>
                <div class="stat-trend">
                    <span class="trend-arrow">↑</span>
                    <span class="trend-text">Current</span>
                </div>
            </div>
            <div class="stat-icon">
                <i class="fa fa-user-plus"></i>
            </div>
        </div>

        <!-- Total Parents Card -->
        <div class="stat-card parents-card">
            <div class="stat-content">
                <h3 class="stat-number" id="total-parents">{{#total_parents}}{{total_parents}}{{/total_parents}}{{^total_parents}}0{{/total_parents}}</h3>
                <p class="stat-label">TOTAL PARENTS</p>
                <div class="stat-trend">
                    <span class="trend-arrow">↑</span>
                    <span class="trend-text">Engaged</span>
                </div>
            </div>
            <div class="stat-icon">
                <i class="fa fa-users"></i>
            </div>
        </div>
    </div>

    <!-- Analytics & Insights Section -->
    <div class="analytics-section">
        <h2 class="section-title">Analytics & Insights</h2>

        <!-- Top row charts -->
        <div class="analytics-grid">
            <div class="chart-card wide">
                <div class="chart-card-header">
                    <div>
                        <h3>Grade Distribution</h3>
                        <p>Students grouped by grade level</p>
                    </div>
                    <span class="chart-meta">Total students: {{grade_distribution.total}}</span>
                </div>
                <canvas id="gradeDistributionChart" height="220"></canvas>
            </div>

            <div class="chart-card wide">
                <div class="chart-card-header">
                    <div>
                        <h3>Teacher & Student Login Trend</h3>
                        <p>Daily logins during the last 30 days</p>
                    </div>
                    <div class="chart-meta-group">
                        <span><strong>{{login_trend.total_student_logins}}</strong> student logins</span>
                        <span><strong>{{login_trend.total_teacher_logins}}</strong> teacher logins</span>
                        <span><strong>{{login_trend.average_daily_logins}}</strong> avg / day</span>
                    </div>
                </div>
                <canvas id="loginTrendChart" height="220"></canvas>
            </div>
        </div>

        <!-- Middle row -->
        <div class="analytics-grid">
            <div class="chart-card">
                <div class="chart-card-header">
                    <div>
                        <h3>Assignment & Quiz Summary</h3>
                        <p>Completion status for current assessments</p>
                    </div>
                </div>
                <canvas id="assessmentSummaryChart" height="220"></canvas>
                <div class="chart-inline-stats two-column">
                    <div>
                        <span>Total assignments</span>
                        <strong>{{assessment_summary.assignments.total}}</strong>
                        <small>{{assessment_summary.assignments.graded}} graded</small>
                    </div>
                    <div>
                        <span>Total quizzes</span>
                        <strong>{{assessment_summary.quizzes.total}}</strong>
                        <small>{{assessment_summary.quizzes.completed}} completed</small>
                    </div>
                    <div>
                        <span>Avg assignment grade</span>
                        <strong>{{assessment_summary.assignments.avg_grade}}%</strong>
                    </div>
                    <div>
                        <span>Avg quiz score</span>
                        <strong>{{assessment_summary.quizzes.avg_score}}%</strong>
                    </div>
                </div>
                
                <!-- Detailed Assignment & Quiz Lists -->
                <div class="assessment-details-section">
                    {{#assessment_summary.assignments.has_data}}
                    <div class="assessment-list-container">
                        <h4 style="font-size: 0.95rem; font-weight: 600; color: #1f2937; margin: 0 0 10px 0; display: flex; align-items: center; gap: 8px;">
                            <i class="fa fa-file-alt" style="color: #3b82f6;"></i>
                            Recent Assignments
                        </h4>
                        <div class="assessment-scrollable-list">
                            {{#assessment_summary.assignments.list}}
                            <div class="assessment-item">
                                <div class="assessment-item-header">
                                    <span class="assessment-name">{{name}}</span>
                                    <span class="assessment-status assessment-status-{{status_class}}">{{status}}</span>
                                </div>
                                <div class="assessment-item-details">
                                    <span class="assessment-course"><i class="fa fa-book"></i> {{course_name}}</span>
                                    <span class="assessment-stat"><i class="fa fa-users"></i> {{total_students}} students</span>
                                    <span class="assessment-stat"><i class="fa fa-check-circle"></i> {{submitted_count}} submitted</span>
                                    <span class="assessment-stat"><i class="fa fa-star"></i> {{avg_score_display}}</span>
                                </div>
                            </div>
                            {{/assessment_summary.assignments.list}}
                        </div>
                    </div>
                    {{/assessment_summary.assignments.has_data}}
                    
                    {{#assessment_summary.quizzes.has_data}}
                    <div class="assessment-list-container">
                        <h4 style="font-size: 0.95rem; font-weight: 600; color: #1f2937; margin: 0 0 10px 0; display: flex; align-items: center; gap: 8px;">
                            <i class="fa fa-question-circle" style="color: #10b981;"></i>
                            Recent Quizzes
                        </h4>
                        <div class="assessment-scrollable-list">
                            {{#assessment_summary.quizzes.list}}
                            <div class="assessment-item">
                                <div class="assessment-item-header">
                                    <span class="assessment-name">{{name}}</span>
                                    <span class="assessment-status assessment-status-{{status_class}}">{{status}}</span>
                                </div>
                                <div class="assessment-item-details">
                                    <span class="assessment-course"><i class="fa fa-book"></i> {{course_name}}</span>
                                    <span class="assessment-stat"><i class="fa fa-users"></i> {{total_students}} students</span>
                                    <span class="assessment-stat"><i class="fa fa-check-circle"></i> {{completed_count}} completed</span>
                                    <span class="assessment-stat"><i class="fa fa-star"></i> {{avg_score_display}}</span>
                                </div>
                            </div>
                            {{/assessment_summary.quizzes.list}}
                        </div>
                    </div>
                    {{/assessment_summary.quizzes.has_data}}
                    
                    {{^assessment_summary.assignments.has_data}}
                    {{^assessment_summary.quizzes.has_data}}
                    <div style="text-align: center; padding: 20px; color: #6b7280;">
                        <i class="fa fa-clipboard-list" style="font-size: 2rem; display: block; margin-bottom: 10px; color: #d1d5db;"></i>
                        <p style="margin: 0; font-size: 0.9rem;">No assignments or quizzes available yet</p>
                    </div>
                    {{/assessment_summary.quizzes.has_data}}
                    {{/assessment_summary.assignments.has_data}}
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-card-header">
                    <div>
                        <h3>Course Completion Summary</h3>
                        <p>Overall student completion status</p>
                    </div>
                </div>
                <div style="max-width: 320px; margin: 0 auto 1rem auto; padding: 10px 0;">
                    <canvas id="courseCompletionChart" height="260"></canvas>
                </div>
                <div class="chart-inline-stats" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.75rem; margin-top: 1.5rem;">
                    <div>
                        <span>Completed</span>
                        <strong style="color: #10b981;">{{course_completion_summary.completed}}</strong>
                    </div>
                    <div>
                        <span>In progress</span>
                        <strong style="color: #fbbf24;">{{course_completion_summary.inprogress}}</strong>
                    </div>
                    <div>
                        <span>Not started</span>
                        <strong style="color: #ef4444;">{{course_completion_summary.notstarted}}</strong>
                    </div>
                    <div>
                        <span>Total enrollments</span>
                        <strong>{{course_completion_summary.total}}</strong>
                    </div>
                    <div>
                        <span>Completion rate</span>
                        <strong style="color: #6366f1;">{{course_completion_summary.completion_rate}}%</strong>
                    </div>
                </div>
                
                <!-- Responsive adjustments for completion stats -->
                <style>
                    .chart-card .chart-inline-stats {
                        display: grid;
                        grid-template-columns: repeat(5, 1fr);
                        gap: 0.75rem;
                    }
                    
                    .chart-card .chart-inline-stats div {
                        background: #f8fafc;
                        border-radius: 0.75rem;
                        padding: 0.9rem;
                        border: 1px solid #edf2f7;
                        text-align: center;
                    }
                    
                    .chart-card .chart-inline-stats span {
                        font-size: 0.75rem;
                        text-transform: uppercase;
                        color: #6b7280;
                        letter-spacing: 0.05em;
                        display: block;
                        margin-bottom: 0.5rem;
                    }
                    
                    .chart-card .chart-inline-stats strong {
                        font-size: 1.6rem;
                        display: block;
                        color: #111827;
                        font-weight: 700;
                    }
                    
                    @media (max-width: 1200px) {
                        .chart-card .chart-inline-stats {
                            grid-template-columns: repeat(3, 1fr) !important;
                        }
                    }
                    
                    @media (max-width: 768px) {
                        .chart-card .chart-inline-stats {
                            grid-template-columns: repeat(2, 1fr) !important;
                        }
                    }
                </style>
                
                <!-- Detailed Course List -->
                {{#course_completion_summary.has_courses}}
                <div class="course-completion-details">
                    <h4 style="font-size: 0.95rem; font-weight: 600; color: #1f2937; margin: 1.5rem 0 10px 0; padding-top: 1.5rem; border-top: 1px solid #e5e7eb; display: flex; align-items: center; gap: 8px;">
                        <i class="fa fa-graduation-cap" style="color: #6366f1;"></i>
                        Course Enrollment Details
                    </h4>
                    <div class="course-scrollable-list">
                        {{#course_completion_summary.course_list}}
                        <div class="course-completion-item">
                            <div class="course-header">
                                <div class="course-name-section">
                                    <span class="course-name">{{name}}</span>
                                    <span class="course-shortname">{{shortname}}</span>
            </div>
                                <div class="course-completion-badge">
                                    <span class="completion-percentage">{{completion_percentage}}%</span>
                                </div>
                            </div>
                            <div class="course-stats-row">
                                <div class="course-stat">
                                    <i class="fa fa-users"></i>
                                    <span>{{enrolled_students}} enrolled</span>
                                </div>
                                <div class="course-stat course-stat-success">
                                    <i class="fa fa-check-circle"></i>
                                    <span>{{completed_students}} completed</span>
                                </div>
                                <div class="course-stat course-stat-warning">
                                    <i class="fa fa-clock"></i>
                                    <span>{{inprogress_students}} in progress</span>
                                </div>
                                <div class="course-stat course-stat-danger">
                                    <i class="fa fa-pause-circle"></i>
                                    <span>{{notstarted_students}} not started</span>
                                </div>
                                <div class="course-stat">
                                    <i class="fa fa-star"></i>
                                    <span>{{avg_grade_display}} avg</span>
                                </div>
                            </div>
                            <div class="course-progress-bar">
                                <div class="progress-bar-fill" style="width: {{completion_percentage}}%;"></div>
                            </div>
                        </div>
                        {{/course_completion_summary.course_list}}
                    </div>
                </div>
                {{/course_completion_summary.has_courses}}
                
                {{^course_completion_summary.has_courses}}
                {{#course_completion_summary.total}}
                <div style="text-align: center; padding: 20px; color: #6b7280; margin-top: 1rem; border-top: 1px solid #e5e7eb;">
                    <i class="fa fa-info-circle" style="font-size: 1.5rem; display: block; margin-bottom: 10px; color: #d1d5db;"></i>
                    <p style="margin: 0; font-size: 0.9rem;">Completion data available - {{course_completion_summary.completed}} completed out of {{course_completion_summary.total}}</p>
                </div>
                {{/course_completion_summary.total}}
                {{/course_completion_summary.has_courses}}
            </div>
        </div>

        <!-- Bottom row -->
        <div class="analytics-grid">
            <div class="chart-card wide">
                <div class="chart-card-header">
                    <div>
                        <h3>School Overview Performance</h3>
                        <p>Academic performance, enrollment and activity signals</p>
                    </div>
                </div>

                <div class="overview-metric-grid">
                    <div class="overview-metric">
                        <span>Average Grade</span>
                        <strong>{{school_overview.overall_academic.avg_grade}}%</strong>
                        <div class="metric-bar">
                            <div class="metric-bar-fill" style="width: {{school_overview.overall_academic.avg_grade}}%;"></div>
                        </div>
                    </div>
                    <div class="overview-metric">
                        <span>Pass Rate</span>
                        <strong>{{school_overview.overall_academic.pass_rate}}%</strong>
                        <div class="metric-bar">
                            <div class="metric-bar-fill success" style="width: {{school_overview.overall_academic.pass_rate}}%;"></div>
                        </div>
                    </div>
                    <div class="overview-metric">
                        <span>Total Enrollments</span>
                        <strong>{{school_overview.enrollment_summary.total}}</strong>
                        <small>{{school_overview.enrollment_summary.new}} new this month</small>
                    </div>
                    <div class="overview-metric">
                        <span>Active vs Inactive Users</span>
                        <strong>{{school_overview.active_users.active}} / {{school_overview.active_users.inactive}}</strong>
                        <div class="metric-bar dual">
                            <div class="metric-bar-fill success" style="width: {{school_overview.active_users.active_percent}}%;"></div>
                            <div class="metric-bar-fill muted" style="width: {{school_overview.active_users.inactive_percent}}%;"></div>
                        </div>
                        <small>{{school_overview.active_users.active_percent}}% active users</small>
                    </div>
                </div>

                <div class="overview-chart-grid">
                    <div class="mini-chart-panel">
                        <div class="mini-chart-header">
                            <h4>School Growth Report</h4>
                            <p>New enrollments (last 6 months)</p>
                        </div>
                        <canvas id="growthTrendChart" height="200"></canvas>
                    </div>
                    <div class="mini-chart-panel">
                        <div class="mini-chart-header">
                            <h4>Login Access Report</h4>
                            <p>Active & inactive user status by role (last 30 days)</p>
                        </div>
                        <canvas id="loginAccessChart" height="250"></canvas>
                    </div>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-card-header">
                    <div>
                        <h3>User Role Distribution</h3>
                        <p>Active user mix across key personas</p>
                    </div>
                </div>
                <div style="max-width: 340px; margin: 0 auto 1rem auto; padding: 10px 0;">
                    <canvas id="roleDistributionChart" height="270"></canvas>
                </div>
                <div class="chart-inline-stats" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-top: 1.5rem;">
                    <div>
                        <span>Students</span>
                        <strong style="color: #3b82f6;">{{role_distribution.students}}</strong>
                    </div>
                    <div>
                        <span>Teachers</span>
                        <strong style="color: #34d399;">{{role_distribution.teachers}}</strong>
                    </div>
                    <div>
                        <span>Parents</span>
                        <strong style="color: #ec4899;">{{role_distribution.parents}}</strong>
                    </div>
                    <div>
                        <span>Managers</span>
                        <strong style="color: #f97316;">{{role_distribution.managers}}</strong>
                    </div>
                    <div style="grid-column: span 2;">
                        <span>Total users</span>
                        <strong style="color: #111827;">{{role_distribution.total}}</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Super Admin Action - Course Assignments Section -->
    {{#super_admin_actions.has_data}}
    <div class="super-admin-section">
        <h2 class="section-title">Super Admin Action</h2>
        
        <div class="analytics-grid">
            <div class="chart-card wide" style="grid-column: span 2;">
                <div class="chart-card-header">
                    <div>
                        <h3><i class="fa fa-user-shield" style="color: #8b5cf6;"></i> Course Assignments to Your School</h3>
                        <p>Courses assigned by super admin to <?php echo htmlspecialchars($company_info ? $company_info->name : 'your school'); ?></p>
                    </div>
                    <div class="chart-meta-group">
                        <span><strong>{{super_admin_actions.total_courses_assigned}}</strong> total courses</span>
                        <span class="badge-recent"><strong>{{super_admin_actions.recent_assignments}}</strong> recent (10 days)</span>
                    </div>
                </div>
                
                <!-- Summary Cards -->
                <div class="chart-inline-stats" style="grid-template-columns: repeat(3, 1fr); margin-bottom: 1.5rem;">
                    <div>
                        <span>Total Courses Assigned</span>
                        <strong style="color: #8b5cf6;">{{super_admin_actions.total_courses_assigned}}</strong>
                    </div>
                    <div>
                        <span>Recent Assignments</span>
                        <strong style="color: #10b981;">{{super_admin_actions.recent_assignments}}</strong>
                        <small>Last 10 days</small>
                    </div>
                    <div>
                        <span>View All Courses</span>
                        <a href="{{{config.wwwroot}}}/theme/remui_kids/course_management.php" style="display: inline-block; background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 8px 20px; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 0.9rem; margin-top: 5px;">
                            <i class="fa fa-arrow-right"></i> Manage Courses
                        </a>
                    </div>
                </div>
                
                <!-- Scrollable Course Assignment List -->
                <div class="super-admin-actions-container">
                    <h4 style="font-size: 1rem; font-weight: 600; color: #1f2937; margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px;">
                        <i class="fa fa-list-alt" style="color: #8b5cf6;"></i>
                        Course Assignment History
                    </h4>
                    <div class="super-admin-scrollable-list">
                        {{#super_admin_actions.course_assignments}}
                        <div class="super-admin-action-item {{#is_recent}}recent{{/is_recent}}">
                            <div class="action-item-header">
                                <div class="course-info">
                                    <a href="{{course_url}}" class="course-name-link" target="_blank">
                                        <i class="fa fa-book"></i> {{course_name}}
                                    </a>
                                </div>
                                <div class="action-badges">
                                    {{#is_recent}}<span class="badge-new">NEW</span>{{/is_recent}}
                                    <span class="action-status action-status-{{status_class}}">{{status}}</span>
                                </div>
                            </div>
                            <div class="action-item-details">
                                <span class="action-detail"><i class="fa fa-layer-group"></i> <strong>Parent Category:</strong> {{parent_category_name}}</span>
                                <span class="action-detail"><i class="fa fa-folder"></i> <strong>Category:</strong> {{category_name}}</span>
                                <span class="action-detail"><i class="fa fa-users"></i> <strong>Enrolled:</strong> {{enrolled_students}} students</span>
                                <span class="action-detail"><i class="fa fa-tasks"></i> <strong>Activities:</strong> {{total_activities}}</span>
                                <span class="action-detail"><i class="fa fa-clock"></i> <strong>Assigned:</strong> {{assigned_date}}</span>
                            </div>
                        </div>
                        {{/super_admin_actions.course_assignments}}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {{/super_admin_actions.has_data}}

    <!-- Calendar JavaScript - Must be loaded BEFORE HTML that uses onclick handlers -->
    <script>
    // Global calendar constants and state - Must be defined first
    (function() {
        'use strict';
        
        // Constants
        window.CALENDAR_API_BASE = '{{{config.wwwroot}}}/theme/remui_kids/school_manager/calendar_management.php';
        window.CALENDAR_SESSKEY = '{{sesskey}}';
        
        // Global calendar state
        window.calendarState = {
            currentView: 'week',
            currentWeek: 0,
            currentMonth: new Date().getMonth(),
            currentYear: new Date().getFullYear(),
            currentDay: new Date(),
            allEvents: [],
            allSessions: [],
            selectedEvent: null,
            filters: {
                eventType: 'all',
                course: 'all',
                teacher: 'all'
            }
        };
        
        // Global functions for onclick handlers - MUST be defined before HTML
        // Function to ensure weekly day checkboxes are rendered correctly
        window.ensureWeeklyDayCheckboxes = function() {
            const weeklyDayGroup = document.getElementById('eventWeeklyDayGroup');
            if (!weeklyDayGroup) return;
            
            const checkboxes = weeklyDayGroup.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(function(checkbox) {
                // Remove any existing duplicate checkboxes
                const parent = checkbox.parentElement;
                if (parent) {
                    const allInputs = parent.querySelectorAll('input[type="checkbox"][name="' + checkbox.name + '"][value="' + checkbox.value + '"]');
                    if (allInputs.length > 1) {
                        // Keep only the first one, remove duplicates
                        for (let i = 1; i < allInputs.length; i++) {
                            allInputs[i].remove();
                        }
                    }
                }
                
                // Force checkbox styling
                checkbox.style.appearance = 'checkbox';
                checkbox.style.webkitAppearance = 'checkbox';
                checkbox.style.mozAppearance = 'checkbox';
                checkbox.style.width = '18px';
                checkbox.style.height = '18px';
                checkbox.style.minWidth = '18px';
                checkbox.style.minHeight = '18px';
                checkbox.style.maxWidth = '18px';
                checkbox.style.maxHeight = '18px';
                checkbox.style.margin = '0';
                checkbox.style.padding = '0';
                checkbox.style.border = '1px solid #d1d5db';
                checkbox.style.borderRadius = '3px';
                checkbox.style.backgroundColor = '#ffffff';
                checkbox.style.cursor = 'pointer';
                checkbox.style.display = 'inline-block';
                checkbox.style.verticalAlign = 'middle';
                checkbox.style.boxSizing = 'border-box';
                checkbox.style.position = 'relative';
                checkbox.style.flexShrink = '0';
                checkbox.className = 'weekday-checkbox-input';
                
                // Ensure label styling
                const label = checkbox.closest('label');
                if (label) {
                    label.className = 'weekday-checkbox-label';
                    label.style.display = 'flex';
                    label.style.alignItems = 'center';
                    label.style.gap = '0.5rem';
                    label.style.cursor = 'pointer';
                    label.style.margin = '0';
                    label.style.padding = '0';
                    
                    // Remove any toggle switch elements from label
                    const toggleElements = label.querySelectorAll('.toggle, .switch, [role="switch"]');
                    toggleElements.forEach(function(el) {
                        el.remove();
                    });
                }
            });
        };
        
        window.openCreateEventModal = function() {
            const modal = document.getElementById('createEventModal');
            if (modal) {
                // Ensure End Date field is visible when creating new event
                const endDateGroup = document.getElementById('eventEndDateGroup');
                if (endDateGroup) {
                    endDateGroup.style.display = 'block';
                }
                
                modal.style.display = 'flex';
                // Ensure checkboxes are properly rendered
                setTimeout(function() {
                    if (typeof window.ensureWeeklyDayCheckboxes === 'function') {
                        window.ensureWeeklyDayCheckboxes();
                    }
                }, 100);
                if (typeof window.loadEventFormData === 'function') {
                    window.loadEventFormData();
                }
            }
        };
        
        window.closeCreateEventModal = function() {
            const modal = document.getElementById('createEventModal');
            if (modal) {
                modal.style.display = 'none';
                const form = document.getElementById('createEventForm');
                if (form) {
                    form.reset();
                    // Reset modal title and button text
                    const modalTitle = modal.querySelector('.modal-header h3');
                    const submitBtn = form.querySelector('button[type="submit"]');
                    const eventIdField = document.getElementById('eventId');
                    
                    if (modalTitle) {
                        modalTitle.textContent = 'Create New Event';
                    }
                    if (submitBtn) {
                        submitBtn.textContent = 'Create Event';
                    }
                    if (eventIdField) {
                        eventIdField.value = '';
                    }
                    
                    // Reset Start Date label to "Start Date" when creating new event
                    const startDateField = document.getElementById('eventStartDate');
                    if (startDateField) {
                        const startDateFormGroup = startDateField.closest('.form-group');
                        if (startDateFormGroup) {
                            const label = startDateFormGroup.querySelector('label');
                            if (label && (label.textContent.trim() === 'Date *' || label.textContent.trim().includes('Date *'))) {
                                label.textContent = 'Start Date *';
                            }
                        }
                    }
                    
                    // Show End Date field again (it was hidden during edit)
                    const endDateGroup = document.getElementById('eventEndDateGroup');
                    if (endDateGroup) {
                        endDateGroup.style.display = 'block';
                    }
                    
                    // Reset frequency fields
                    const frequencyGroup = document.getElementById('eventFrequencyGroup');
                    const frequencySelect = document.getElementById('eventFrequency');
                    const specificDateGroup = document.getElementById('eventSpecificDateGroup');
                    const weeklyDayGroup = document.getElementById('eventWeeklyDayGroup');
                    const datePickerContainer = document.getElementById('eventDatePicker');
                    const selectedDatesField = document.getElementById('eventSelectedDates');
                    
                    // Hide frequency group initially (will show if end date is set)
                    if (frequencyGroup) {
                        frequencyGroup.style.display = 'none';
                    }
                    if (frequencySelect) {
                        frequencySelect.value = 'specific_date';
                    }
                    if (specificDateGroup) {
                        specificDateGroup.style.display = 'none';
                    }
                    if (weeklyDayGroup) {
                        weeklyDayGroup.style.display = 'none';
                    }
                    if (datePickerContainer) {
                        datePickerContainer.innerHTML = '';
                    }
                    if (selectedDatesField) {
                        selectedDatesField.value = '';
                    }
                    
                    // Uncheck all weekly day checkboxes
                    document.querySelectorAll('input[name="eventWeeklyDays"]').forEach(cb => {
                        cb.checked = false;
                    });
                    
                    // Reset calendar selected dates
                    if (window.eventCalendarSelectedDates) {
                        window.eventCalendarSelectedDates.clear();
                    }
                    if (window.eventCalendarCurrentMonth) {
                        window.eventCalendarCurrentMonth = null;
                    }
                    
                    // Trigger frequency group visibility check
                    if (typeof window.toggleFrequencyGroupVisibility === 'function') {
                        window.toggleFrequencyGroupVisibility();
                    }
                }
            }
        };
        
        // Toggle Event Frequency Options
        window.toggleEventFrequencyOptions = function() {
            const frequency = document.getElementById('eventFrequency').value;
            const specificDateGroup = document.getElementById('eventSpecificDateGroup');
            const weeklyDayGroup = document.getElementById('eventWeeklyDayGroup');
            
            if (frequency === 'daily') {
                // Daily: Hide both specific date and weekly day groups
                if (specificDateGroup) {
                    specificDateGroup.style.display = 'none';
                }
                if (weeklyDayGroup) {
                    weeklyDayGroup.style.display = 'none';
                }
            } else if (frequency === 'specific_date') {
                if (specificDateGroup) {
                    specificDateGroup.style.display = 'block';
                }
                if (weeklyDayGroup) {
                    weeklyDayGroup.style.display = 'none';
                }
                // Generate date picker when showing specific date option
                // Use a small delay to ensure date fields are updated
                setTimeout(function() {
                    generateEventDatePicker();
                }, 100);
            } else if (frequency === 'weekly') {
                if (specificDateGroup) {
                    specificDateGroup.style.display = 'none';
                }
                if (weeklyDayGroup) {
                    weeklyDayGroup.style.display = 'block';
                    // Ensure checkboxes are properly rendered as checkboxes, not toggle switches
                    setTimeout(function() {
                        if (typeof window.ensureWeeklyDayCheckboxes === 'function') {
                            window.ensureWeeklyDayCheckboxes();
                        }
                    }, 50);
                }
            }
        };
        
        // Generate Event Date Picker for Specific Dates - Calendar Widget
        window.generateEventDatePicker = function() {
            const startDateField = document.getElementById('eventStartDate');
            const endDateField = document.getElementById('eventEndDate');
            const datePickerContainer = document.getElementById('eventDatePicker');
            const selectedDatesField = document.getElementById('eventSelectedDates');
            
            if (!startDateField || !datePickerContainer || !selectedDatesField) {
                return;
            }
            
            const startDate = startDateField.value;
            const endDate = endDateField ? endDateField.value : '';
            
            // Must have start date
            if (!startDate) {
                datePickerContainer.innerHTML = '<p style="color: #ef4444; font-size: 0.875rem;">Please select Start Date first.</p>';
                return;
            }
            
            // If no end date, use start date as end date
            // Parse dates properly to avoid timezone issues - use local time, not UTC
            const startParts = startDate.split('-');
            const endParts = (endDate && endDate.trim() !== '') ? endDate.split('-') : startDate.split('-');
            
            // Create dates in local timezone to avoid UTC conversion issues
            const start = new Date(parseInt(startParts[0]), parseInt(startParts[1]) - 1, parseInt(startParts[2]));
            const end = new Date(parseInt(endParts[0]), parseInt(endParts[1]) - 1, parseInt(endParts[2]));
            
            // Normalize dates to start of day for accurate comparison
            // Use start of day for both to ensure consistent comparison
            start.setHours(0, 0, 0, 0);
            end.setHours(0, 0, 0, 0);
            
            // Store end date at end of day for inclusive comparison
            const endInclusive = new Date(end);
            endInclusive.setHours(23, 59, 59, 999);
            
            // Validate that start is not after end (using normalized dates)
            if (start.getTime() > end.getTime()) {
                datePickerContainer.innerHTML = '<p style="color: #ef4444; font-size: 0.875rem;">End date must be after or equal to start date.</p>';
                return;
            }
            
            // Determine which month to show (show the month containing the start date)
            // If we already have a current month set (from navigation), use it; otherwise use start date month
            let year, month;
            if (window.eventCalendarCurrentMonth) {
                year = window.eventCalendarCurrentMonth.year;
                month = window.eventCalendarCurrentMonth.month;
            } else {
                const currentMonth = new Date(start);
                year = currentMonth.getFullYear();
                month = currentMonth.getMonth();
            }
            
            // Generate calendar HTML
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                              'July', 'August', 'September', 'October', 'November', 'December'];
            const dayNames = ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'];
            
            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            
            // Get previous month's last days
            const prevMonth = new Date(year, month, 0);
            const daysInPrevMonth = prevMonth.getDate();
            
            let calendarHTML = `
                <style>
                    .event-calendar {
                        width: 100%;
                        border-collapse: collapse;
                        font-size: 0.875rem;
                    }
                    .event-calendar-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 0.5rem 0.75rem;
                        margin-bottom: 0.5rem;
                        background-color: #f9fafb;
                        border-radius: 4px;
                    }
                    .event-calendar-nav {
                        cursor: pointer;
                        padding: 0.25rem 0.5rem;
                        border: none;
                        background: transparent;
                        font-size: 1rem;
                        color: #374151;
                    }
                    .event-calendar-nav:hover {
                        background-color: #e5e7eb;
                        border-radius: 4px;
                    }
                    .event-calendar-title {
                        font-weight: 600;
                        color: #111827;
                        font-size: 0.9375rem;
                    }
                    .event-calendar-weekdays {
                        display: grid;
                        grid-template-columns: repeat(7, 1fr);
                        gap: 0.25rem;
                        margin-bottom: 0.5rem;
                    }
                    .event-calendar-weekday {
                        text-align: center;
                        font-weight: 600;
                        color: #6b7280;
                        font-size: 0.75rem;
                        padding: 0.5rem 0;
                    }
                    .event-calendar-days {
                        display: grid;
                        grid-template-columns: repeat(7, 1fr);
                        gap: 0.25rem;
                    }
                    .event-calendar-day {
                        aspect-ratio: 1;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        cursor: pointer;
                        border-radius: 4px;
                        font-size: 0.875rem;
                        position: relative;
                        transition: all 0.2s;
                    }
                    .event-calendar-day.other-month {
                        color: #d1d5db;
                        cursor: not-allowed;
                    }
                    .event-calendar-day.selectable {
                        color: #374151;
                    }
                    .event-calendar-day.selectable:hover {
                        background-color: #e5e7eb;
                    }
                    .event-calendar-day.out-of-range {
                        color: #d1d5db;
                        cursor: not-allowed;
                        opacity: 0.4;
                    }
                    .event-calendar-day.selected {
                        background-color: #3b82f6;
                        color: #ffffff;
                        font-weight: 600;
                    }
                    .event-calendar-day.selected:hover {
                        background-color: #2563eb;
                    }
                    .event-calendar-day.today {
                        border: 2px solid #3b82f6;
                    }
                </style>
                <div class="event-calendar-header">
                    <button class="event-calendar-nav" onclick="eventCalendarPreviousMonth()" type="button">‹</button>
                    <span class="event-calendar-title">${monthNames[month]} ${year}</span>
                    <button class="event-calendar-nav" onclick="eventCalendarNextMonth()" type="button">›</button>
                </div>
                <div class="event-calendar-weekdays">
                    ${dayNames.map(day => `<div class="event-calendar-weekday">${day}</div>`).join('')}
                </div>
                <div class="event-calendar-days" id="eventCalendarDaysGrid">
            `;
            
            // Add previous month's trailing days
            for (let i = startingDayOfWeek - 1; i >= 0; i--) {
                const day = daysInPrevMonth - i;
                calendarHTML += `<div class="event-calendar-day other-month">${day}</div>`;
            }
            
            // Add current month's days
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                date.setHours(0, 0, 0, 0);
                
                // Create date string in YYYY-MM-DD format using local date (not UTC)
                const yearStr = date.getFullYear();
                const monthStr = String(date.getMonth() + 1).padStart(2, '0');
                const dayStr = String(date.getDate()).padStart(2, '0');
                const dateStr = `${yearStr}-${monthStr}-${dayStr}`;
                
                // Check if date is within range (inclusive: includes both start and end dates)
                // Compare only the date part (year, month, day) by converting to timestamp at start of day
                const dateTimestamp = date.getTime();
                const startTimestamp = start.getTime();
                const endInclusiveTimestamp = endInclusive.getTime();
                // Include both start date and end date (inclusive range)
                const isInRange = dateTimestamp >= startTimestamp && dateTimestamp <= endInclusiveTimestamp;
                const isToday = dateStr === new Date().toISOString().split('T')[0];
                const isSelected = window.eventCalendarSelectedDates && window.eventCalendarSelectedDates.has(dateStr);
                
                let dayClass = 'event-calendar-day';
                if (!isInRange) {
                    dayClass += ' out-of-range';
                } else {
                    dayClass += ' selectable';
                }
                if (isToday) {
                    dayClass += ' today';
                }
                if (isSelected) {
                    dayClass += ' selected';
                }
                
                calendarHTML += `
                    <div class="${dayClass}" 
                         data-date="${dateStr}" 
                         data-day="${day}"
                         ${isInRange ? `onclick="eventCalendarToggleDate('${dateStr}')"` : ''}>
                        ${day}
                    </div>
                `;
            }
            
            // Add next month's leading days to complete the grid
            const totalCells = startingDayOfWeek + daysInMonth;
            const remainingCells = 42 - totalCells; // 6 rows x 7 days = 42 cells
            for (let day = 1; day <= remainingCells && day <= 14; day++) {
                calendarHTML += `<div class="event-calendar-day other-month">${day}</div>`;
            }
            
            calendarHTML += '</div></div>';
            datePickerContainer.innerHTML = calendarHTML;
            
            // Store range for navigation - store as YYYY-MM-DD format strings
            // Ensure we store the actual date values, not empty strings
            const storedStartDate = startDate || '';
            const storedEndDate = (endDate && endDate.trim() !== '') ? endDate : startDate;
            window.eventCalendarRange = { 
                start: storedStartDate, 
                end: storedEndDate 
            };
            
            // Preserve selected dates if they exist, otherwise create new Set
            if (!window.eventCalendarSelectedDates) {
                window.eventCalendarSelectedDates = new Set();
            }
            
            // Filter selected dates to only include those within the current range
            const filteredSelectedDates = new Set();
            const startTimestamp = start.getTime();
            const endInclusiveTimestamp = endInclusive.getTime();
            window.eventCalendarSelectedDates.forEach(dateStr => {
                const dateParts = dateStr.split('-');
                const date = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]));
                date.setHours(0, 0, 0, 0);
                const dateTimestamp = date.getTime();
                // Include dates that are within range (inclusive of both start and end dates)
                if (dateTimestamp >= startTimestamp && dateTimestamp <= endInclusiveTimestamp) {
                    filteredSelectedDates.add(dateStr);
                }
            });
            window.eventCalendarSelectedDates = filteredSelectedDates;
            
            // Update selected dates display
            updateEventCalendarDisplay();
        };
        
        // Toggle date selection in calendar
        window.eventCalendarToggleDate = function(dateStr) {
            if (!window.eventCalendarSelectedDates) {
                window.eventCalendarSelectedDates = new Set();
            }
            
            if (window.eventCalendarSelectedDates.has(dateStr)) {
                window.eventCalendarSelectedDates.delete(dateStr);
            } else {
                window.eventCalendarSelectedDates.add(dateStr);
            }
            
            updateEventCalendarDisplay();
            updateSelectedDates();
        };
        
        // Update calendar display with selected dates
        function updateEventCalendarDisplay() {
            const daysGrid = document.getElementById('eventCalendarDaysGrid');
            if (!daysGrid) return;
            
            const selectedDates = window.eventCalendarSelectedDates || new Set();
            const range = window.eventCalendarRange || { start: '', end: '' };
            
            // If range is not set, try to get it from the form fields
            if (!range.start || !range.end) {
                const startDateField = document.getElementById('eventStartDate');
                const endDateField = document.getElementById('eventEndDate');
                if (startDateField && startDateField.value) {
                    range.start = startDateField.value;
                }
                if (endDateField && endDateField.value) {
                    range.end = endDateField.value;
                } else if (startDateField && startDateField.value) {
                    range.end = startDateField.value; // Use start date as end date if end date not set
                }
            }
            
            // Parse dates properly to avoid timezone issues
            let start = null;
            let end = null;
            
            if (range.start && range.start.trim() !== '') {
                const startParts = range.start.split('-');
                if (startParts.length === 3) {
                    start = new Date(parseInt(startParts[0]), parseInt(startParts[1]) - 1, parseInt(startParts[2]));
                    start.setHours(0, 0, 0, 0);
                }
            }
            
            if (range.end && range.end.trim() !== '') {
                const endParts = range.end.split('-');
                if (endParts.length === 3) {
                    end = new Date(parseInt(endParts[0]), parseInt(endParts[1]) - 1, parseInt(endParts[2]));
                    end.setHours(0, 0, 0, 0);
                }
            } else if (start) {
                // If no end date, use start date as end date
                end = new Date(start);
            }
            
            // Create end date at end of day for inclusive comparison
            const endInclusive = end ? new Date(end) : null;
            if (endInclusive) {
                endInclusive.setHours(23, 59, 59, 999);
            }
            
            daysGrid.querySelectorAll('.event-calendar-day').forEach(dayEl => {
                const dateStr = dayEl.getAttribute('data-date');
                if (!dateStr || dayEl.classList.contains('other-month')) return;
                
                const dateParts = dateStr.split('-');
                if (dateParts.length !== 3) return;
                
                const date = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]));
                date.setHours(0, 0, 0, 0);
                
                // Check if date is within range (inclusive: includes both start and end dates)
                const dateTimestamp = date.getTime();
                const startTimestamp = start ? start.getTime() : -Infinity;
                const endInclusiveTimestamp = endInclusive ? endInclusive.getTime() : Infinity;
                const isInRange = dateTimestamp >= startTimestamp && dateTimestamp <= endInclusiveTimestamp;
                const isSelected = selectedDates.has(dateStr);
                const isToday = dateStr === new Date().toISOString().split('T')[0];
                
                // Update classes
                dayEl.className = 'event-calendar-day';
                if (!isInRange) {
                    dayEl.classList.add('out-of-range');
                } else {
                    dayEl.classList.add('selectable');
                    dayEl.setAttribute('onclick', `eventCalendarToggleDate('${dateStr}')`);
                }
                if (isToday) {
                    dayEl.classList.add('today');
                }
                if (isSelected) {
                    dayEl.classList.add('selected');
                }
            });
        }
        
        // Calendar navigation
        window.eventCalendarPreviousMonth = function() {
            if (!window.eventCalendarCurrentMonth) return;
            const { year, month } = window.eventCalendarCurrentMonth;
            const newMonth = month === 0 ? 11 : month - 1;
            const newYear = month === 0 ? year - 1 : year;
            window.eventCalendarCurrentMonth = { year: newYear, month: newMonth };
            generateEventDatePicker();
        };
        
        window.eventCalendarNextMonth = function() {
            if (!window.eventCalendarCurrentMonth) return;
            const { year, month } = window.eventCalendarCurrentMonth;
            const newMonth = month === 11 ? 0 : month + 1;
            const newYear = month === 11 ? year + 1 : year;
            window.eventCalendarCurrentMonth = { year: newYear, month: newMonth };
            generateEventDatePicker();
        };
        
        // Update selected dates hidden field
        window.updateSelectedDates = function() {
            const selectedDates = Array.from(window.eventCalendarSelectedDates || []).sort();
            const selectedDatesField = document.getElementById('eventSelectedDates');
            if (selectedDatesField) {
                selectedDatesField.value = selectedDates.join(',');
            }
        };
        
        // Update Selected Dates Hidden Field - Updated for calendar widget
        window.updateSelectedDates = function() {
            const selectedDates = Array.from(window.eventCalendarSelectedDates || []).sort();
            const selectedDatesField = document.getElementById('eventSelectedDates');
            if (selectedDatesField) {
                selectedDatesField.value = selectedDates.join(',');
            }
        };
        
        window.openCreateLectureModal = function() {
            const modal = document.getElementById('createLectureModal');
            if (modal) {
                modal.style.display = 'flex';
                
                // Reset teacher dropdown and error message
                const teacherSelect = document.getElementById('lectureTeacher');
                const errorMessage = document.getElementById('teacherErrorMessage');
                if (teacherSelect) {
                    teacherSelect.innerHTML = '<option value="">Select Teacher</option>';
                    teacherSelect.disabled = false;
                }
                if (errorMessage) {
                    errorMessage.style.display = 'none';
                }
                
                if (typeof window.loadLectureFormData === 'function') {
                    window.loadLectureFormData();
                }
            }
        };
        
        window.closeCreateLectureModal = function() {
            const modal = document.getElementById('createLectureModal');
            if (modal) {
                modal.style.display = 'none';
                const form = document.getElementById('createLectureForm');
                if (form) {
                    form.reset();
                    // Reset modal title and button text
                    const modalTitle = modal.querySelector('.modal-header h3');
                    const submitBtn = form.querySelector('button[type="submit"]');
                    const scheduleIdField = document.getElementById('lectureScheduleId');
                    
                    if (modalTitle) {
                        modalTitle.textContent = 'Schedule Lecture';
                    }
                    if (submitBtn) {
                        submitBtn.textContent = 'Create Schedule';
                    }
                    if (scheduleIdField) {
                        scheduleIdField.value = '';
                    }
                    
                    // Reset session ID field if it exists
                    const sessionIdField = document.getElementById('lectureSessionId');
                    if (sessionIdField) {
                        sessionIdField.value = '';
                    }
                    
                    // Show frequency field again (it was hidden during edit)
                    const frequencyGroup = document.getElementById('frequencyGroup');
                    if (frequencyGroup) {
                        frequencyGroup.style.display = 'block';
                    }
                    const daysSelection = document.getElementById('daysSelection');
                    if (daysSelection) {
                        daysSelection.style.display = 'none';
                    }
                    
                    // Show date range fields and hide single date field (for new schedule creation)
                    const dateRangeGroup = document.getElementById('lectureDateRangeGroup');
                    const singleDateGroup = document.getElementById('lectureSingleDateGroup');
                    if (dateRangeGroup) {
                        dateRangeGroup.style.display = 'flex';
                    }
                    if (singleDateGroup) {
                        singleDateGroup.style.display = 'none';
                    }
                    
                    // Clear the read-only date field
                    const sessionDateField = document.getElementById('lectureSessionDate');
                    if (sessionDateField) {
                        sessionDateField.value = '';
                    }
                    
                    // Re-enable all disabled fields
                    const disabledFields = form.querySelectorAll('[disabled]');
                    disabledFields.forEach(field => {
                        field.disabled = false;
                    });
                }
                
                // Reset teacher dropdown and error message
                const teacherSelect = document.getElementById('lectureTeacher');
                const errorMessage = document.getElementById('teacherErrorMessage');
                if (teacherSelect) {
                    teacherSelect.innerHTML = '<option value="">Select Teacher</option>';
                    teacherSelect.disabled = false;
                }
                if (errorMessage) {
                    errorMessage.style.display = 'none';
                }
            }
        };
        
        window.switchView = function(view) {
            if (window.calendarState) {
                window.calendarState.currentView = view;
                document.querySelectorAll('.view-toggle').forEach(t => t.classList.remove('active'));
                const toggle = document.querySelector(`.view-toggle[data-view="${view}"]`);
                if (toggle) toggle.classList.add('active');
                if (typeof window.renderCurrentView === 'function') {
                    window.renderCurrentView();
                }
            }
        };
        
        window.changeCalendarPeriod = function(direction) {
            if (!window.calendarState) return;
            
            if (window.calendarState.currentView === 'week') {
                window.calendarState.currentWeek += direction;
            } else if (window.calendarState.currentView === 'month') {
                window.calendarState.currentMonth += direction;
                if (window.calendarState.currentMonth > 11) {
                    window.calendarState.currentMonth = 0;
                    window.calendarState.currentYear++;
                } else if (window.calendarState.currentMonth < 0) {
                    window.calendarState.currentMonth = 11;
                    window.calendarState.currentYear--;
                }
            } else if (window.calendarState.currentView === 'day') {
                const newDate = new Date(window.calendarState.currentDay);
                newDate.setDate(newDate.getDate() + direction);
                window.calendarState.currentDay = newDate;
            }
            if (typeof window.renderCurrentView === 'function') {
                window.renderCurrentView();
            }
        };
        
        window.goToToday = function() {
            if (!window.calendarState) return;
            
            const today = new Date();
            window.calendarState.currentWeek = 0;
            window.calendarState.currentMonth = today.getMonth();
            window.calendarState.currentYear = today.getFullYear();
            window.calendarState.currentDay = today;
            if (typeof window.renderCurrentView === 'function') {
                window.renderCurrentView();
            }
        };
        
        window.applyFilters = function() {
            if (!window.calendarState) return;
            
            const filterEventType = document.getElementById('filterEventType');
            const filterCourse = document.getElementById('filterCourse');
            const filterTeacher = document.getElementById('filterTeacher');
            
            if (filterEventType) window.calendarState.filters.eventType = filterEventType.value;
            if (filterCourse) window.calendarState.filters.course = filterCourse.value;
            if (filterTeacher) window.calendarState.filters.teacher = filterTeacher.value;
            
            if (typeof window.renderCurrentView === 'function') {
                window.renderCurrentView();
            }
        };
        
        window.toggleDaysSelection = function() {
            const frequency = document.getElementById('lectureFrequency');
            const daysSelection = document.getElementById('daysSelection');
            if (frequency && daysSelection) {
                daysSelection.style.display = frequency.value === 'custom' ? 'block' : 'none';
            }
        };
        
        window.loadCohortMembers = function() {
            console.log('Loading cohort members...');
        };
        
        window.showDayEvents = function(dateStr) {
            if (window.calendarState && window.calendarState.allEvents) {
                const allItems = [...window.calendarState.allEvents, ...window.calendarState.allSessions];
                const dayItems = allItems.filter(e => e.date === dateStr);
                
                if (dayItems.length > 0 && typeof window.switchView === 'function') {
                    window.switchView('day');
                    window.calendarState.currentDay = new Date(dateStr);
                    if (typeof window.renderDayView === 'function') {
                        window.renderDayView();
                    }
                }
            }
        };
        
        // Save Event - Global function
        window.saveEvent = function(e) {
            if (e) e.preventDefault();
            
            const formData = new FormData();
            const eventIdField = document.getElementById('eventId');
            const isEditMode = eventIdField && eventIdField.value;
            
            // Determine action based on edit mode
            const action = isEditMode ? 'update_event' : 'create_event';
            formData.append('action', action);
            formData.append('sesskey', window.CALENDAR_SESSKEY);
            
            // Check if editing all events in a series
            const editAllEvents = window.calendarState && window.calendarState.editAllEvents;
            
            // Add event_id if editing
            if (isEditMode) {
                // When editing all, we'll update each event individually after this one
                // But for now, update the current event and then update others
                formData.append('event_id', eventIdField.value);
                
                // Store editAllEvents in formData for later processing
                if (editAllEvents && Array.isArray(editAllEvents) && editAllEvents.length > 0) {
                    // We'll handle updating all events in the success callback
                    formData.append('_edit_all_events', JSON.stringify(editAllEvents));
                }
            }
            
            const title = document.getElementById('eventTitle').value.trim();
            const description = document.getElementById('eventDescription').value.trim();
            const startDate = document.getElementById('eventStartDate').value;
            const endDate = document.getElementById('eventEndDate').value;
            const startTime = document.getElementById('eventStartTime').value;
            const endTime = document.getElementById('eventEndTime').value;
            const eventType = document.getElementById('eventType').value;
            const color = document.getElementById('eventColor').value;
            
            // Validate required fields
            if (!title) {
                alert('Please enter an event title');
                return;
            }
            if (!startDate) {
                alert('Please select a start date');
                return;
            }
            
            // End date handling: 
            // - In edit mode with hidden end date field, preserve original end date from event
            // - Otherwise, use provided end date or start date
            let finalEndDate = endDate;
            let hasEndDate = endDate && endDate.trim() !== '';
            
            if (isEditMode) {
                const endDateGroup = document.getElementById('eventEndDateGroup');
                const isEndDateHidden = endDateGroup && endDateGroup.style.display === 'none';
                
                if (isEndDateHidden && window.calendarState && window.calendarState.selectedEvent) {
                    // Preserve original end date when field is hidden
                    const originalEvent = window.calendarState.selectedEvent;
                    const originalEndDate = originalEvent.end_date || originalEvent.start_date || originalEvent.date || '';
                    if (originalEndDate && originalEndDate !== startDate) {
                        // Convert to YYYY-MM-DD format if needed
                        if (originalEndDate.includes('/')) {
                            const parts = originalEndDate.split('/');
                            if (parts.length === 3) {
                                finalEndDate = `${parts[2]}-${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}`;
                            } else {
                                finalEndDate = originalEndDate;
                            }
                        } else {
                            finalEndDate = originalEndDate;
                        }
                        hasEndDate = true;
                    } else {
                        // No original end date or same as start date, use start date
                        finalEndDate = startDate;
                        hasEndDate = false;
                    }
                }
            }
            
            // Validate end date if provided
            if (hasEndDate && finalEndDate && new Date(startDate) > new Date(finalEndDate)) {
                alert('End date must be after or equal to start date');
                return;
            }
            
            if (!startTime) {
                alert('Please select a start time');
                return;
            }
            if (!endTime) {
                alert('Please select an end time');
                return;
            }
            if (!eventType) {
                alert('Please select an event type');
                return;
            }
            
            // Validate frequency-specific fields only if end date is provided and frequency group is visible
            // Skip frequency validation in edit mode when end date field is hidden
            const frequencyGroup = document.getElementById('eventFrequencyGroup');
            const isFrequencyGroupVisible = frequencyGroup && frequencyGroup.style.display !== 'none';
            
            if (hasEndDate && isFrequencyGroupVisible) {
                const frequencyField = document.getElementById('eventFrequency');
                const frequency = frequencyField ? frequencyField.value : '';
                
                if (!frequency) {
                    alert('Please select a frequency');
                    return;
                }
                
                if (frequency === 'specific_date') {
                    const selectedDates = document.getElementById('eventSelectedDates').value;
                    if (!selectedDates || selectedDates.trim() === '') {
                        alert('Please select at least one specific date');
                        return;
                    }
                } else if (frequency === 'weekly') {
                    const selectedDays = Array.from(document.querySelectorAll('input[name="eventWeeklyDays"]:checked')).map(cb => cb.value);
                    if (selectedDays.length === 0) {
                        alert('Please select at least one day of the week');
                        return;
                    }
                }
            }
            
            // Convert start date to timestamp (Unix timestamp)
            const [startYear, startMonth, startDay] = startDate.split('-').map(Number);
            const startDateObj = new Date(Date.UTC(startYear, startMonth - 1, startDay, 0, 0, 0));
            const startdate = Math.floor(startDateObj.getTime() / 1000);
            
            // End date is optional - if not provided, use start date
            // Use finalEndDate which may have been adjusted for edit mode
            let enddate = startdate;
            if (hasEndDate && finalEndDate && finalEndDate.trim() !== '') {
                const [endYear, endMonth, endDay] = finalEndDate.split('-').map(Number);
                const endDateObj = new Date(Date.UTC(endYear, endMonth - 1, endDay, 23, 59, 59));
                enddate = Math.floor(endDateObj.getTime() / 1000);
            }
            
            // For backward compatibility, use start date as event date
            const eventdate = startdate;
            
            // Convert time from HTML5 time input (HH:MM) to 24-hour format for database
            // HTML5 time input returns HH:MM in 24-hour format, so we can use it directly
            // But if it's in 12-hour format (from a custom picker), convert it
            function convertTo24Hour(timeStr) {
                // If already in 24-hour format (HH:MM), return as is
                if (/^([0-1][0-9]|2[0-3]):[0-5][0-9]$/.test(timeStr)) {
                    return timeStr;
                }
                // If in 12-hour format with AM/PM, convert it
                const match = timeStr.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
                if (match) {
                    let hours = parseInt(match[1]);
                    const minutes = match[2];
                    const ampm = match[3].toUpperCase();
                    
                    if (ampm === 'PM' && hours !== 12) {
                        hours += 12;
                    } else if (ampm === 'AM' && hours === 12) {
                        hours = 0;
                    }
                    
                    return String(hours).padStart(2, '0') + ':' + minutes;
                }
                // Return as is if format is unknown
                return timeStr;
            }
            
            const starttime = convertTo24Hour(startTime);
            const endtime = convertTo24Hour(endTime);
            
            // Store variables needed for updating all events (after all calculations)
            const updateVariables = {
                title: title,
                description: description,
                starttime: starttime,
                endtime: endtime,
                eventType: eventType,
                color: color,
                startdate: startdate,
                enddate: enddate
            };
            
            console.log('📝 Sending event data:');
            console.log('  Mode:', isEditMode ? 'EDIT' : 'CREATE');
            console.log('  Title:', title);
            console.log('  Start Date:', startDate, '-> Timestamp:', startdate);
            console.log('  End Date:', finalEndDate || '(not set)', '-> Timestamp:', enddate);
            console.log('  Start Time:', starttime);
            console.log('  End Time:', endtime);
            console.log('  Event Type:', eventType);
            console.log('  Color:', color);
            console.log('  Has End Date:', hasEndDate);
            
            formData.append('title', title);
            formData.append('description', description);
            formData.append('eventdate', eventdate); // For backward compatibility
            formData.append('startdate', startdate);
            formData.append('enddate', enddate);
            formData.append('starttime', starttime);
            formData.append('endtime', endtime);
            formData.append('eventtype', eventType);
            formData.append('color', color);
            
            // Frequency is only relevant if end date is provided
            if (hasEndDate) {
                const frequencyField = document.getElementById('eventFrequency');
                const frequency = frequencyField ? frequencyField.value : 'specific_date';
                formData.append('frequency', frequency);
                
                if (frequency === 'daily') {
                    // Daily frequency: no additional parameters needed
                    // Backend will create events for all days between start and end date
                } else if (frequency === 'specific_date') {
                    const selectedDates = document.getElementById('eventSelectedDates').value;
                    formData.append('selected_dates', selectedDates || '');
                } else if (frequency === 'weekly') {
                    const selectedDays = Array.from(document.querySelectorAll('input[name="eventWeeklyDays"]:checked')).map(cb => cb.value);
                    formData.append('weekly_days', selectedDays.join(','));
                }
            }
            
            const teacherSelect = document.getElementById('eventTeachers');
            if (teacherSelect) {
                const teacherIds = Array.from(teacherSelect.selectedOptions)
                    .map(opt => opt.value)
                    .filter(id => id && id !== '');
                console.log('📋 Selected Teacher IDs:', teacherIds);
                // FormData: append with same key creates array in PHP
                teacherIds.forEach(id => {
                    formData.append('teacher_ids[]', id);
                });
            }
            
            const studentSelect = document.getElementById('eventStudents');
            if (studentSelect) {
                const studentIds = Array.from(studentSelect.selectedOptions)
                    .map(opt => opt.value)
                    .filter(id => id && id !== '');
                console.log('📋 Selected Student IDs:', studentIds);
                studentIds.forEach(id => {
                    formData.append('student_ids[]', id);
                });
            }
            
            const cohortSelect = document.getElementById('eventCohorts');
            if (cohortSelect) {
                const cohortIds = Array.from(cohortSelect.selectedOptions)
                    .map(opt => opt.value)
                    .filter(id => id && id !== '');
                console.log('📋 Selected Cohort IDs:', cohortIds);
                cohortIds.forEach(id => {
                    formData.append('cohort_ids[]', id);
                });
            }
            
            // Debug: Log all FormData entries
            console.log('📦 FormData entries:');
            for (let pair of formData.entries()) {
                console.log('  ' + pair[0] + ': ' + pair[1]);
            }
            
            fetch(window.CALENDAR_API_BASE, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                console.log('📡 Response status:', response.status, response.statusText);
                if (!response.ok) {
                    // Try to parse error response
                    return response.text().then(text => {
                        console.error('❌ Error response body:', text);
                        let errorData;
                        try {
                            errorData = JSON.parse(text);
                        } catch (e) {
                            errorData = { message: text || `HTTP ${response.status}: ${response.statusText}` };
                        }
                        throw new Error(errorData.message || `HTTP ${response.status}: ${response.statusText}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('✅ Response data:', data);
                if (data.status === 'success') {
                    const editAllEvents = window.calendarState && window.calendarState.editAllEvents;
                    
                    if (editAllEvents && Array.isArray(editAllEvents) && editAllEvents.length > 0 && isEditMode) {
                        // Update all related events with same data
                        const currentEventId = eventIdField ? eventIdField.value : null;
                        
                        // Normalize all IDs to strings for comparison
                        const editAllEventsStr = editAllEvents.map(id => String(id));
                        const currentEventIdStr = String(currentEventId);
                        
                        // Filter out the current event from the list
                        const remainingEventIds = editAllEventsStr.filter(id => id !== currentEventIdStr);
                        
                        console.log('🔄 Editing all events:', {
                            totalEvents: editAllEvents.length,
                            currentEventId: currentEventIdStr,
                            remainingEventIds: remainingEventIds,
                            editAllEvents: editAllEventsStr
                        });
                        
                        // Update ALL events including the current one, but we already updated current one
                        // So update the remaining ones
                        if (remainingEventIds.length > 0) {
                            // Use stored variables for updating remaining events
                            const updateData = updateVariables;
                            
                            // Get participants
                            const teacherSelect = document.getElementById('eventTeachers');
                            const studentSelect = document.getElementById('eventStudents');
                            const cohortSelect = document.getElementById('eventCohorts');
                            
                            const teacherIds = teacherSelect ? Array.from(teacherSelect.selectedOptions)
                                .map(opt => opt.value)
                                .filter(id => id && id !== '') : [];
                            
                            const studentIds = studentSelect ? Array.from(studentSelect.selectedOptions)
                                .map(opt => opt.value)
                                .filter(id => id && id !== '') : [];
                            
                            const cohortIds = cohortSelect ? Array.from(cohortSelect.selectedOptions)
                                .map(opt => opt.value)
                                .filter(id => id && id !== '') : [];
                            
                            // Get original dates for each event to preserve them
                            // Each event should keep its own date but get updated with new times, title, etc.
                            const allEvents = window.calendarState.allEvents || [];
                            
                            // Update remaining events one by one
                            const updatePromises = remainingEventIds.map(eventId => {
                                // Find the original event to get its date
                                const originalEvent = allEvents.find(e => {
                                    const eId = e.id || '';
                                    return String(eId) === String(eventId);
                                });
                                
                                // Preserve the original event's date
                                let eventDate = updateData.startdate; // Default to new start date
                                let eventEndDate = updateData.enddate; // Default to new end date
                                
                                if (originalEvent) {
                                    // Get original date and convert to timestamp
                                    // Prefer timestart if available (most accurate), otherwise use date field
                                    if (originalEvent.timestart && originalEvent.timestart > 0) {
                                        // Use timestart directly - this is the actual start timestamp
                                        // Extract just the date portion (midnight of that day)
                                        const dateFromTimestamp = new Date(originalEvent.timestart * 1000);
                                        const year = dateFromTimestamp.getFullYear();
                                        const month = dateFromTimestamp.getMonth();
                                        const day = dateFromTimestamp.getDate();
                                        // Create date at local midnight to get Unix timestamp for that day
                                        const dayStart = new Date(year, month, day, 0, 0, 0, 0);
                                        eventDate = Math.floor(dayStart.getTime() / 1000);
                                        eventEndDate = eventDate;
                                        console.log('✅ Preserved date from timestart:', originalEvent.timestart, '-> date:', dateFromTimestamp.toLocaleDateString(), '-> timestamp:', eventDate);
                                    } else {
                                        // Fallback to parsing date string
                                        const originalDateStr = originalEvent.start_date || originalEvent.date || '';
                                        console.log('📅 Preserving date for event', eventId, ':', originalDateStr, 'from event:', originalEvent);
                                        
                                        if (originalDateStr) {
                                        let dateObj;
                                        if (originalDateStr.includes('/')) {
                                            // MM/DD/YYYY format
                                            const parts = originalDateStr.split('/');
                                            if (parts.length === 3) {
                                                dateObj = new Date(parseInt(parts[2]), parseInt(parts[0]) - 1, parseInt(parts[1]));
                                            } else {
                                                dateObj = new Date(originalDateStr);
                                            }
                                        } else if (originalDateStr.includes('-')) {
                                            // YYYY-MM-DD format (from backend)
                                            const parts = originalDateStr.split('-');
                                            if (parts.length === 3) {
                                                // Use local date components (not UTC) to preserve the exact date
                                                // This prevents timezone shifts that could move events to different days
                                                const year = parseInt(parts[0]);
                                                const month = parseInt(parts[1]) - 1; // Month is 0-indexed
                                                const day = parseInt(parts[2]);
                                                dateObj = new Date(year, month, day, 0, 0, 0, 0); // Local midnight
                                            } else {
                                                dateObj = new Date(originalDateStr);
                                            }
                                        } else {
                                            dateObj = new Date(originalDateStr);
                                        }
                                        
                                        if (dateObj && !isNaN(dateObj.getTime())) {
                                            // Convert to Unix timestamp (local midnight for that date)
                                            // Using local time ensures the date doesn't shift due to timezone
                                            eventDate = Math.floor(dateObj.getTime() / 1000);
                                            eventEndDate = eventDate; // Single day event
                                            console.log('✅ Preserved date:', originalDateStr, '-> timestamp:', eventDate, '-> local date:', new Date(eventDate * 1000).toLocaleDateString());
                                        } else {
                                            console.error('❌ Invalid date object for event', eventId, ':', originalDateStr);
                                        }
                                        } else {
                                            console.warn('⚠️ No date found for event', eventId, ':', originalEvent);
                                        }
                                    }
                                }
                                
                                console.log('📝 Updating event ID:', eventId, 'with date:', eventDate);
                                
                                const updateFormData = new FormData();
                                updateFormData.append('action', 'update_event');
                                updateFormData.append('sesskey', window.CALENDAR_SESSKEY);
                                updateFormData.append('event_id', eventId);
                                updateFormData.append('title', updateData.title);
                                updateFormData.append('description', updateData.description);
                                updateFormData.append('startdate', eventDate); // Use original event's date
                                updateFormData.append('enddate', eventEndDate); // Use original event's date
                                updateFormData.append('starttime', updateData.starttime);
                                updateFormData.append('endtime', updateData.endtime);
                                // Ensure eventtype is set correctly (use eventType from updateData with capital T)
                                const eventTypeValue = updateData.eventType || updateData.eventtype || 'meeting';
                                console.log('🔧 Setting eventtype for event', eventId, ':', eventTypeValue, 'from updateData:', updateData);
                                updateFormData.append('eventtype', eventTypeValue);
                                updateFormData.append('color', updateData.color);
                                updateFormData.append('eventdate', eventDate); // For backward compatibility - this is what backend uses
                                
                                // Add participants
                                teacherIds.forEach(id => {
                                    updateFormData.append('teacher_ids[]', id);
                                });
                                studentIds.forEach(id => {
                                    updateFormData.append('student_ids[]', id);
                                });
                                cohortIds.forEach(id => {
                                    updateFormData.append('cohort_ids[]', id);
                                });
                                
                                return fetch(window.CALENDAR_API_BASE, {
                                    method: 'POST',
                                    body: updateFormData
                                })
                                .then(response => {
                                    if (!response.ok) {
                                        return response.text().then(text => {
                                            console.error('Error response for event', eventId, ':', text);
                                            return { status: 'error', message: text || `HTTP ${response.status}` };
                                        });
                                    }
                                    return response.json();
                                })
                                .then(data => {
                                    console.log('✅ Update response for event', eventId, ':', data);
                                    return data;
                                })
                                .catch(error => {
                                    console.error('Error updating event:', eventId, error);
                                    return { status: 'error', message: error.message };
                                });
                            });
                            
                            Promise.all(updatePromises)
                                .then(results => {
                                    const successCount = results.filter(r => r.status === 'success').length;
                                    const updatedCount = successCount + 1; // +1 for the current event that was already updated
                                    const totalCount = editAllEvents.length;
                                    
                                    console.log('✅ Update results:', {
                                        totalEvents: totalCount,
                                        remainingUpdated: successCount,
                                        currentUpdated: 1,
                                        totalUpdated: updatedCount
                                    });
                                    
                                    // Clear editAllEvents flag
                                    delete window.calendarState.editAllEvents;
                                    
                                    if (typeof window.closeCreateEventModal === 'function') {
                                        window.closeCreateEventModal();
                                    }
                                    
                                    if (typeof window.loadCalendarData === 'function') {
                                        window.loadCalendarData(true);
                                    }
                                    
                                    if (updatedCount === totalCount) {
                                        alert(`Successfully updated all ${totalCount} event(s)!`);
                                    } else {
                                        alert(`Updated ${updatedCount} out of ${totalCount} event(s).`);
                                    }
                                    
                                    // Force refresh the current view
                                    if (typeof window.renderCurrentView === 'function') {
                                        setTimeout(() => {
                                            window.renderCurrentView();
                                        }, 500);
                                    }
                                })
                                .catch(error => {
                                    console.error('Error updating all events:', error);
                                    alert('Updated the first event, but some updates failed.');
                                    delete window.calendarState.editAllEvents;
                                });
                            
                            return; // Don't show success message yet, wait for all updates
                        } else {
                            // No remaining events to update, just show success for current event
                            console.log('✅ Only one event or all events updated');
                            if (window.calendarState && window.calendarState.editAllEvents) {
                                delete window.calendarState.editAllEvents;
                            }
                        }
                    }
                    
                    // Single event update or create
                    if (window.calendarState && window.calendarState.editAllEvents) {
                        delete window.calendarState.editAllEvents;
                    }
                    
                    alert(isEditMode ? 'Event updated successfully!' : 'Event created successfully!');
                    if (typeof window.closeCreateEventModal === 'function') {
                        window.closeCreateEventModal();
                    }
                    if (typeof window.loadCalendarData === 'function') {
                        window.loadCalendarData();
                    }
                } else {
                    if (window.calendarState && window.calendarState.editAllEvents) {
                        delete window.calendarState.editAllEvents;
                    }
                    alert('Error: ' + (data.message || (isEditMode ? 'Failed to update event' : 'Failed to create event')));
                }
            })
            .catch(error => {
                console.error('❌ Error creating event:', error);
                console.error('  Error message:', error.message);
                alert('Error creating event: ' + error.message);
            });
        };
        
        // Save Lecture Schedule - Global function
        window.saveLectureSchedule = function(e) {
            if (e) e.preventDefault();
            
            const formData = new FormData();
            const scheduleIdField = document.getElementById('lectureScheduleId');
            const sessionIdField = document.getElementById('lectureSessionId');
            const isEditMode = scheduleIdField && scheduleIdField.value;
            const isSingleSessionEdit = sessionIdField && sessionIdField.value;
            
            // Determine action based on edit mode
            let action;
            if (isSingleSessionEdit) {
                action = 'update_lecture_session';
                formData.append('session_id', sessionIdField.value);
            } else {
                action = isEditMode ? 'update_lecture_schedule' : 'create_lecture_schedule';
                if (isEditMode) {
                    formData.append('schedule_id', scheduleIdField.value);
                }
            }
            
            formData.append('action', action);
            formData.append('sesskey', window.CALENDAR_SESSKEY);
            
            if (isSingleSessionEdit) {
                // For single session, send all editable fields including course and teacher
                formData.append('starttime', document.getElementById('lectureStartTime').value);
                formData.append('endtime', document.getElementById('lectureEndTime').value);
                formData.append('description', document.getElementById('lectureDescription').value);
                // Allow course and teacher to be changed for single session
                const courseField = document.getElementById('lectureCourse');
                const teacherField = document.getElementById('lectureTeacher');
                const startDateField = document.getElementById('lectureStartDate');
                if (courseField && courseField.value) {
                    formData.append('courseid', courseField.value);
                }
                if (teacherField && teacherField.value) {
                    formData.append('teacherid', teacherField.value);
                }
                if (startDateField && startDateField.value) {
                    formData.append('sessiondate', Math.floor(new Date(startDateField.value).getTime() / 1000));
                }
            } else {
                // For full schedule, send all fields
                formData.append('courseid', document.getElementById('lectureCourse').value);
                formData.append('teacherid', document.getElementById('lectureTeacher').value);
                formData.append('description', document.getElementById('lectureDescription').value);
                formData.append('startdate', Math.floor(new Date(document.getElementById('lectureStartDate').value).getTime() / 1000));
                formData.append('enddate', Math.floor(new Date(document.getElementById('lectureEndDate').value).getTime() / 1000));
                formData.append('starttime', document.getElementById('lectureStartTime').value);
                formData.append('endtime', document.getElementById('lectureEndTime').value);
                formData.append('color', document.getElementById('lectureColor').value);
                
                // Only send frequency if it's visible (i.e., creating new schedule, not editing)
                const frequencyGroup = document.getElementById('frequencyGroup');
                if (frequencyGroup && frequencyGroup.style.display !== 'none') {
                    const frequencyField = document.getElementById('lectureFrequency');
                    if (frequencyField) {
                        formData.append('frequency', frequencyField.value);
                        const frequency = frequencyField.value;
                if (frequency === 'custom') {
                    const selectedDays = Array.from(document.querySelectorAll('input[name="lectureDays"]:checked')).map(cb => cb.value);
                    formData.append('days', selectedDays.join(','));
                        }
                    }
                }
            }
            
            fetch(window.CALENDAR_API_BASE, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    if (isSingleSessionEdit) {
                        alert('Lecture session updated successfully!');
                    } else {
                        alert(isEditMode ? 'Lecture schedule updated successfully!' : 'Lecture schedule created successfully!');
                    }
                    if (typeof window.closeCreateLectureModal === 'function') {
                        window.closeCreateLectureModal();
                    }
                    
                    // Reset form and show frequency field again for next use
                    const frequencyGroup = document.getElementById('frequencyGroup');
                    if (frequencyGroup) {
                        frequencyGroup.style.display = 'block';
                    }
                    
                    // Force reload calendar data to ensure teacher availability status is updated
                    // Clear any cached data and reload from server
                    if (typeof window.loadCalendarData === 'function') {
                        // Force reload with cache-busting timestamp
                        window.loadCalendarData(true); // Pass true to force reload
                    } else if (typeof window.loadLectureSessions === 'function') {
                        // If loadCalendarData doesn't exist, directly load sessions
                        window.loadLectureSessions(true); // Pass true to force reload
                    }
                    // Force refresh the current view after a short delay to ensure data is loaded
                    if (typeof window.renderCurrentView === 'function') {
                        setTimeout(() => {
                            window.renderCurrentView();
                        }, 800); // Increased delay to ensure server data is ready
                    }
                    
                    // Also refresh the page calendar view if available
                    if (typeof window.refreshCalendarView === 'function') {
                        setTimeout(() => {
                            window.refreshCalendarView();
                        }, 1000);
                    }
                    
                    // Additional forced refresh after teacher reassignment
                    if (data.teacher_changed) {
                        console.log('Teacher changed - forcing calendar refresh');
                        setTimeout(() => {
                            // Reload page calendar data with cache busting
                            if (typeof window.loadCalendarData === 'function') {
                                const timestamp = new Date().getTime();
                                window.loadCalendarData(true);
                            }
                            if (typeof window.renderCurrentView === 'function') {
                                window.renderCurrentView();
                            }
                        }, 1200);
                    }
                } else {
                    if (data.conflicts) {
                        alert('Time conflicts detected. Please adjust the schedule.');
                    } else {
                        alert('Error: ' + (data.message || (isEditMode ? 'Failed to update schedule' : 'Failed to create schedule')));
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error creating lecture schedule');
            });
        };
        
        // Show Event Details Modal - Global function
        window.showEventDetailsModal = function(event) {
            if (!window.calendarState) return;
            
            // Handle both object and string (from inline onclick)
            let eventObj = event;
            if (typeof event === 'string') {
                try {
                    eventObj = JSON.parse(event.replace(/&quot;/g, '"'));
                } catch(e) {
                    console.error('Error parsing event data:', e);
                    return;
                }
            }
            
            window.calendarState.selectedEvent = eventObj;
            const modal = document.getElementById('eventDetailsModal');
            const titleEl = document.getElementById('eventDetailsTitle');
            const contentEl = document.getElementById('eventDetailsContent');
            const actionsEl = modal ? modal.querySelector('.form-actions') : null;
            
            if (modal && titleEl && contentEl) {
                // Check if this is a lecture session
                const isLecture = eventObj.schedule_id || eventObj.lecture_session;
                
                if (isLecture) {
                    // Get course name - check both snake_case and camelCase for compatibility
                    const courseName = eventObj.course_name || eventObj.coursename || eventObj.name || 'Unknown Course';
                    titleEl.textContent = courseName;
                    contentEl.innerHTML = `
                        <div class="event-detail-item">
                            <strong>Type:</strong> <span class="badge badge-${eventObj.color || 'green'}">LECTURE</span>
                        </div>
                        <div class="event-detail-item">
                            <strong>Course:</strong> ${courseName}
                        </div>
                        ${eventObj.teacher_name ? `<div class="event-detail-item"><strong>Teacher:</strong> ${eventObj.teacher_name}</div>` : ''}
                        <div class="event-detail-item">
                            <strong>Date:</strong> ${new Date(eventObj.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                        </div>
                        <div class="event-detail-item">
                            <strong>Time:</strong> ${eventObj.start_time || eventObj.time || ''} - ${eventObj.end_time || ''}
                        </div>
                        ${eventObj.description ? `<div class="event-detail-item"><strong>Description:</strong> ${eventObj.description}</div>` : ''}
                    `;
                    
                    // Update action buttons for lecture with separate Edit, Delete, More dropdown, and Close (last)
                    if (actionsEl) {
                        const sessionId = eventObj.id || eventObj.session_id || '';
                        const scheduleId = eventObj.schedule_id || '';
                        const uniqueId = scheduleId + '_' + sessionId;
                        
                        actionsEl.innerHTML = `
                            <button class="btn-edit" onclick="editSingleSession(${sessionId})">Edit</button>
                            <button class="btn-delete" onclick="deleteSingleSession(${sessionId})">Delete</button>
                            <div class="more-actions-wrapper">
                                <button class="btn-more" onclick="toggleMoreMenu(event)" id="moreBtn_${uniqueId}">
                                    More <span style="margin-left: 5px;">▼</span>
                                </button>
                                <div class="more-menu-dropdown" id="moreMenu_${uniqueId}">
                                    <button class="more-menu-item" onclick="editAllSchedule(${scheduleId})">
                                        Edit all schedule
                                    </button>
                                    <button class="more-menu-item" onclick="deleteAllSchedule(${scheduleId})">
                                        Delete all schedule
                                    </button>
                                </div>
                            </div>
                            <button class="btn-cancel" onclick="closeEventDetailsModal()">Close</button>
                        `;
                    }
                } else {
                    // Regular event
                    titleEl.textContent = eventObj.title || 'Event Details';
                    contentEl.innerHTML = `
                        <div class="event-detail-item">
                            <strong>Type:</strong> <span class="badge badge-${eventObj.color || 'blue'}">${eventObj.type || 'Event'}</span>
                        </div>
                        <div class="event-detail-item">
                            <strong>Date:</strong> ${new Date(eventObj.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                        </div>
                        <div class="event-detail-item">
                            <strong>Time:</strong> ${eventObj.start_time} - ${eventObj.end_time}
                        </div>
                        ${eventObj.description ? `<div class="event-detail-item"><strong>Description:</strong> ${eventObj.description}</div>` : ''}
                    `;
                    
                    // Check if this event is part of a recurring series
                    // We'll check if there are other events with the same title, times, type, and color
                    const hasRelatedEvents = checkForRelatedEvents(eventObj);
                    const eventId = eventObj.id || '';
                    
                    // Update action buttons for event
                    if (actionsEl) {
                        if (hasRelatedEvents) {
                            // Show More button for recurring events
                            actionsEl.innerHTML = `
                                <button class="btn-edit" onclick="editEvent()">Edit</button>
                                <button class="btn-delete" onclick="deleteEvent()">Delete</button>
                                <div class="more-actions-wrapper">
                                    <button class="btn-more" onclick="toggleEventMoreMenu(event)" id="eventMoreBtn_${eventId}">
                                        More <span style="margin-left: 5px;">▼</span>
                                    </button>
                                    <div class="more-menu-dropdown" id="eventMoreMenu_${eventId}">
                                        <button class="more-menu-item" onclick="editAllEvent()">
                                            Edit all event
                                        </button>
                                        <button class="more-menu-item" onclick="deleteAllEvent()">
                                            Delete all event
                                        </button>
                                    </div>
                                </div>
                                <button class="btn-cancel" onclick="closeEventDetailsModal()">Close</button>
                            `;
                        } else {
                            // Single event - no More button
                        actionsEl.innerHTML = `
                            <button class="btn-edit" onclick="editEvent()">Edit</button>
                            <button class="btn-delete" onclick="deleteEvent()">Delete</button>
                            <button class="btn-cancel" onclick="closeEventDetailsModal()">Close</button>
                        `;
                        }
                    }
                }
                
                modal.style.display = 'flex';
            }
        };
        
        // Close Event Details Modal - Global function
        window.closeEventDetailsModal = function() {
            const modal = document.getElementById('eventDetailsModal');
            if (modal) {
                modal.style.display = 'none';
                if (window.calendarState) {
                    window.calendarState.selectedEvent = null;
                }
            }
        };
        
        // Edit Event - Global function
        window.editEvent = function() {
            if (!window.calendarState || !window.calendarState.selectedEvent) {
                alert('No event selected for editing');
                return;
            }
            
            const event = window.calendarState.selectedEvent;
            
            // Close details modal
            if (typeof window.closeEventDetailsModal === 'function') {
                window.closeEventDetailsModal();
            }
            
            // Open create event modal (we'll reuse it for editing)
            const modal = document.getElementById('createEventModal');
            const modalTitle = modal.querySelector('.modal-header h3');
            const form = document.getElementById('createEventForm');
            const submitBtn = form.querySelector('button[type="submit"]');
            const eventIdInput = document.getElementById('eventId');
            
            if (!modal || !form) {
                alert('Error: Modal form not found');
                return;
            }
            
            // Create or update hidden event_id input
            let eventIdField = eventIdInput;
            if (!eventIdField) {
                eventIdField = document.createElement('input');
                eventIdField.type = 'hidden';
                eventIdField.id = 'eventId';
                eventIdField.name = 'event_id';
                form.insertBefore(eventIdField, form.firstChild);
            }
            eventIdField.value = event.id || '';
            
            // Update modal title
            if (modalTitle) {
                modalTitle.textContent = 'Edit Event';
            }
            
            // Update submit button text
            if (submitBtn) {
                submitBtn.textContent = 'Update Event';
            }
            
            // Check if editing all events
            const editAllEvents = window.calendarState && window.calendarState.editAllEvents;
            const isEditingAll = editAllEvents && Array.isArray(editAllEvents) && editAllEvents.length > 1;
            
            // Change Start Date label to "Date" when editing single event only
            // Keep "Start Date" when editing all events
            const startDateField = document.getElementById('eventStartDate');
            if (startDateField) {
                const startDateFormGroup = startDateField.closest('.form-group');
                if (startDateFormGroup) {
                    const label = startDateFormGroup.querySelector('label');
                    if (label) {
                        if (isEditingAll) {
                            // When editing all events, keep "Start Date" label
                            if (label.textContent.trim() === 'Date *') {
                                label.textContent = 'Start Date *';
                            }
                        } else {
                            // When editing single event, change to "Date"
                            if (label.textContent.trim().includes('Start Date')) {
                                label.textContent = 'Date *';
                            }
                        }
                    }
                }
            }
            
            // Show/hide End Date field based on edit mode
            const endDateGroup = document.getElementById('eventEndDateGroup');
            if (endDateGroup) {
                if (isEditingAll) {
                    // Show End Date field when editing all events
                    endDateGroup.style.display = 'block';
                } else {
                    // Hide End Date field when editing single event (user requested to remove it)
                    endDateGroup.style.display = 'none';
                }
            }
            
            // Hide frequency group when editing (not needed for event edit)
            const frequencyGroup = document.getElementById('eventFrequencyGroup');
            if (frequencyGroup) {
                frequencyGroup.style.display = 'none';
            }
            const specificDateGroup = document.getElementById('eventSpecificDateGroup');
            if (specificDateGroup) {
                specificDateGroup.style.display = 'none';
            }
            const weeklyDayGroup = document.getElementById('eventWeeklyDayGroup');
            if (weeklyDayGroup) {
                weeklyDayGroup.style.display = 'none';
            }
            
            // Load form data first (teachers, students, cohorts)
            if (typeof window.loadEventFormData === 'function') {
                window.loadEventFormData();
            }
            
            // Populate form fields with event data
            setTimeout(() => {
                const titleField = document.getElementById('eventTitle');
                const descField = document.getElementById('eventDescription');
                const startDateField = document.getElementById('eventStartDate');
                const endDateField = document.getElementById('eventEndDate');
                const startTimeField = document.getElementById('eventStartTime');
                const endTimeField = document.getElementById('eventEndTime');
                const typeField = document.getElementById('eventType');
                const colorField = document.getElementById('eventColor');
                const frequencyField = document.getElementById('eventFrequency');
                const teacherSelect = document.getElementById('eventTeachers');
                const studentSelect = document.getElementById('eventStudents');
                const cohortSelect = document.getElementById('eventCohorts');
                
                // Populate all fields with event data
                if (titleField) {
                    titleField.value = event.title || '';
                }
                if (descField) {
                    descField.value = event.description || '';
                }
                
                // Set start date (use event.date for backward compatibility if start_date not available)
                if (startDateField) {
                    const eventStartDate = event.start_date || event.date || '';
                    if (eventStartDate) {
                        // Format date to YYYY-MM-DD if needed
                        let formattedDate = eventStartDate;
                        if (eventStartDate.includes('/')) {
                            // Convert MM/DD/YYYY to YYYY-MM-DD
                            const parts = eventStartDate.split('/');
                            if (parts.length === 3) {
                                formattedDate = `${parts[2]}-${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}`;
                            }
                        }
                        startDateField.value = formattedDate;
                    }
                }
                
                // Set end date when editing all events
                if (isEditingAll && endDateField) {
                    // Find the earliest and latest dates from all related events
                    const allEvents = window.calendarState.allEvents || [];
                    const relatedEvents = allEvents.filter(e => {
                        const eventId = e.id || '';
                        return editAllEvents.includes(Number(eventId)) || editAllEvents.includes(String(eventId));
                    });
                    
                    if (relatedEvents.length > 0) {
                        // Get all dates and find min/max
                        const dates = relatedEvents.map(e => {
                            const dateStr = e.start_date || e.date || '';
                            if (dateStr) {
                                // Convert to timestamp for comparison
                                if (dateStr.includes('/')) {
                                    const parts = dateStr.split('/');
                                    if (parts.length === 3) {
                                        return new Date(parseInt(parts[2]), parseInt(parts[0]) - 1, parseInt(parts[1])).getTime();
                                    }
                                } else {
                                    return new Date(dateStr).getTime();
                                }
                            }
                            return null;
                        }).filter(d => d !== null);
                        
                        if (dates.length > 0) {
                            const minDate = new Date(Math.min(...dates));
                            const maxDate = new Date(Math.max(...dates));
                            
                            // Format as YYYY-MM-DD
                            const formatDate = (date) => {
                                const year = date.getFullYear();
                                const month = String(date.getMonth() + 1).padStart(2, '0');
                                const day = String(date.getDate()).padStart(2, '0');
                                return `${year}-${month}-${day}`;
                            };
                            
                            // Set start date to earliest date
                            startDateField.value = formatDate(minDate);
                            // Set end date to latest date
                            endDateField.value = formatDate(maxDate);
                        }
                    } else {
                        // Fallback: use current event's date for end date
                        const eventEndDate = event.end_date || event.start_date || event.date || '';
                        if (eventEndDate) {
                            let formattedDate = eventEndDate;
                            if (eventEndDate.includes('/')) {
                                const parts = eventEndDate.split('/');
                                if (parts.length === 3) {
                                    formattedDate = `${parts[2]}-${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}`;
                                }
                            }
                            endDateField.value = formattedDate;
                        }
                    }
                }
                
                // Helper function to convert 12-hour format to 24-hour format for HTML5 time input
                function convert12To24Hour(time12h) {
                    if (!time12h || time12h.trim() === '') {
                        return '';
                    }
                    
                    // Check if already in 24-hour format (HH:MM without AM/PM)
                    if (/^([0-1][0-9]|2[0-3]):[0-5][0-9]$/.test(time12h.trim())) {
                        return time12h.trim();
                    }
                    
                    // Parse 12-hour format (e.g., "01:00 PM" or "1:00 PM")
                    const match = time12h.trim().match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
                    if (match) {
                        let hours = parseInt(match[1], 10);
                        const minutes = match[2];
                        const ampm = match[3].toUpperCase();
                        
                        if (ampm === 'PM' && hours !== 12) {
                            hours += 12;
                        } else if (ampm === 'AM' && hours === 12) {
                            hours = 0;
                        }
                        
                        return String(hours).padStart(2, '0') + ':' + minutes;
                    }
                    
                    // If format is unknown, try to return as is or return empty
                    return time12h.trim();
                }
                
                // Set times (convert from 12-hour format to 24-hour format for HTML5 time input)
                if (startTimeField && event.start_time) {
                    const convertedStartTime = convert12To24Hour(event.start_time);
                    if (convertedStartTime) {
                        startTimeField.value = convertedStartTime;
                    }
                }
                if (endTimeField && event.end_time) {
                    const convertedEndTime = convert12To24Hour(event.end_time);
                    if (convertedEndTime) {
                        endTimeField.value = convertedEndTime;
                    }
                }
                
                // Set event type (handle both 'type' and 'eventtype' properties)
                if (typeField) {
                    const eventType = event.type || event.eventtype || '';
                    console.log('🔍 Setting event type:', {
                        eventType: eventType,
                        eventObject: event,
                        typeFieldExists: !!typeField,
                        availableOptions: Array.from(typeField.options).map(opt => ({ value: opt.value, text: opt.text }))
                    });
                    
                    if (eventType) {
                        // Normalize to lowercase for matching
                        const normalizedType = eventType.toLowerCase().trim();
                        // Try to set the value
                        typeField.value = normalizedType;
                        
                        // Verify the value was set (in case the option doesn't exist)
                        if (typeField.value !== normalizedType) {
                            console.warn('⚠️ Event type "' + normalizedType + '" not found in dropdown. Available options:', 
                                Array.from(typeField.options).map(opt => opt.value));
                            // Try to find a matching option (case-insensitive)
                            const matchingOption = Array.from(typeField.options).find(opt => 
                                opt.value.toLowerCase() === normalizedType
                            );
                            if (matchingOption) {
                                typeField.value = matchingOption.value;
                                console.log('✅ Found matching option:', matchingOption.value);
                            } else {
                                // Default to 'meeting' if no match found
                                console.warn('⚠️ No matching option found, defaulting to "meeting"');
                                typeField.value = 'meeting';
                            }
                        } else {
                            console.log('✅ Event type set successfully:', normalizedType);
                        }
                    } else {
                        console.warn('⚠️ No event type found in event object. Event data:', event);
                        // Default to 'meeting' if no type is found
                        typeField.value = 'meeting';
                    }
                }
                
                // Set color
                if (colorField && event.color) {
                    colorField.value = event.color.toLowerCase();
                }
                
                // Pre-select participants (wait a bit more to ensure selects are populated)
                setTimeout(() => {
                if (teacherSelect && event.teacher_ids && Array.isArray(event.teacher_ids)) {
                    event.teacher_ids.forEach(teacherId => {
                        const option = teacherSelect.querySelector(`option[value="${teacherId}"]`);
                        if (option) option.selected = true;
                    });
                }
                
                if (studentSelect && event.student_ids && Array.isArray(event.student_ids)) {
                    event.student_ids.forEach(studentId => {
                        const option = studentSelect.querySelector(`option[value="${studentId}"]`);
                        if (option) option.selected = true;
                    });
                }
                
                if (cohortSelect && event.cohort_ids && Array.isArray(event.cohort_ids)) {
                    event.cohort_ids.forEach(cohortId => {
                        const option = cohortSelect.querySelector(`option[value="${cohortId}"]`);
                        if (option) option.selected = true;
                    });
                }
                }, 600); // Wait a bit longer for form data to load
            }, 300); // Initial timeout for form fields
            
            // Show modal
            modal.style.display = 'flex';
        };
        
        // Edit Lecture Schedule - Global function
        window.editLectureSchedule = function(scheduleId) {
            if (!scheduleId) {
                // Try to get schedule_id from selected event/session
                if (window.calendarState && window.calendarState.selectedEvent && window.calendarState.selectedEvent.schedule_id) {
                    scheduleId = window.calendarState.selectedEvent.schedule_id;
                } else {
                    alert('No lecture schedule selected for editing');
                    return;
                }
            }
            
            // Close the event details modal first
            if (typeof window.closeEventDetailsModal === 'function') {
                window.closeEventDetailsModal();
            }
            
            // Fetch schedule details
            const API_BASE = window.CALENDAR_API_BASE || '{{{config.wwwroot}}}/theme/remui_kids/school_manager/calendar_management.php';
            const SESSKEY = window.CALENDAR_SESSKEY || '{{sesskey}}';
            
            fetch(`${API_BASE}?action=get_lecture_schedules&schedule_id=${scheduleId}&sesskey=${SESSKEY}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success' && data.schedule) {
                        const schedule = data.schedule;
                        
                        // Open create lecture modal (we'll reuse it for editing)
                        const modal = document.getElementById('createLectureModal');
                        const modalTitle = modal.querySelector('.modal-header h3');
                        const form = document.getElementById('createLectureForm');
                        const submitBtn = form.querySelector('button[type="submit"]');
                        const scheduleIdField = document.getElementById('lectureScheduleId');
                        
                        if (!modal || !form) {
                            alert('Error: Modal form not found');
                            return;
                        }
                        
                        // Set schedule ID
                        if (scheduleIdField) {
                            scheduleIdField.value = schedule.id || '';
                        }
                        
                        // Update modal title
                        if (modalTitle) {
                            modalTitle.textContent = 'Edit Lecture Session';
                        }
                        
                        // Update submit button text
                        if (submitBtn) {
                            submitBtn.textContent = 'Update Schedule';
                        }
                        
                        // Hide Frequency field when editing (not needed for editing)
                        const frequencyGroup = document.getElementById('frequencyGroup');
                        const daysSelection = document.getElementById('daysSelection');
                        if (frequencyGroup) {
                            frequencyGroup.style.display = 'none';
                        }
                        if (daysSelection) {
                            daysSelection.style.display = 'none';
                        }
                        
                        // Show date range fields and hide single date field (for full schedule editing)
                        const dateRangeGroup = document.getElementById('lectureDateRangeGroup');
                        const singleDateGroup = document.getElementById('lectureSingleDateGroup');
                        if (dateRangeGroup) {
                            dateRangeGroup.style.display = 'flex';
                        }
                        if (singleDateGroup) {
                            singleDateGroup.style.display = 'none';
                        }
                        
                        // Load form data first (courses, teachers) - This populates course dropdown
                        if (typeof window.loadLectureFormData === 'function') {
                            window.loadLectureFormData();
                        }
                        
                        // Populate form fields with schedule data
                        setTimeout(() => {
                            const courseField = document.getElementById('lectureCourse');
                            const teacherField = document.getElementById('lectureTeacher');
                            const descField = document.getElementById('lectureDescription');
                            const startDateField = document.getElementById('lectureStartDate');
                            const endDateField = document.getElementById('lectureEndDate');
                            const startTimeField = document.getElementById('lectureStartTime');
                            const endTimeField = document.getElementById('lectureEndTime');
                            const frequencyField = document.getElementById('lectureFrequency');
                            const colorField = document.getElementById('lectureColor');
                            
                            if (courseField) {
                                courseField.value = schedule.course_id || '';
                                // Trigger teacher loading
                                if (schedule.course_id && typeof window.loadCourseTeachers === 'function') {
                                    window.loadCourseTeachers(schedule.course_id);
                                }
                            }
                            
                            // Wait a bit for teachers to load, then set teacher
                            setTimeout(() => {
                                if (teacherField && schedule.teacher_id) {
                                    teacherField.value = schedule.teacher_id || '';
                                }
                            }, 500);
                            
                            if (descField) descField.value = schedule.description || '';
                            if (startDateField && schedule.start_date) startDateField.value = schedule.start_date;
                            if (endDateField && schedule.end_date) endDateField.value = schedule.end_date;
                            if (startTimeField && schedule.start_time) startTimeField.value = schedule.start_time;
                            if (endTimeField && schedule.end_time) endTimeField.value = schedule.end_time;
                            // Frequency field is hidden in edit mode, so we don't need to set it
                            if (colorField && schedule.color) colorField.value = schedule.color.toLowerCase();
                        }, 300);
                        
                        // Show modal
                        modal.style.display = 'flex';
                    } else {
                        alert('Error: ' + (data.message || 'Failed to load schedule details'));
                    }
                })
                .catch(error => {
                    console.error('Error loading schedule:', error);
                    alert('Error loading schedule details: ' + error.message);
                });
        };
        
        // Delete Lecture Schedule - Global function
        window.deleteLectureSchedule = function(scheduleId) {
            if (!scheduleId) {
                // Try to get schedule_id from selected event/session
                if (window.calendarState && window.calendarState.selectedEvent && window.calendarState.selectedEvent.schedule_id) {
                    scheduleId = window.calendarState.selectedEvent.schedule_id;
                } else {
                    alert('No lecture schedule selected for deletion');
                    return;
                }
            }
            
            if (!confirm('Are you sure you want to delete this lecture schedule? This will delete all associated lecture sessions.')) {
                return;
            }
            
            const formData = new FormData();
            formData.append('action', 'delete_lecture_schedule');
            formData.append('sesskey', window.CALENDAR_SESSKEY);
            formData.append('schedule_id', scheduleId);
            
            const API_BASE = window.CALENDAR_API_BASE || '{{{config.wwwroot}}}/theme/remui_kids/school_manager/calendar_management.php';
            
            fetch(API_BASE, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Lecture schedule deleted successfully!');
                    if (typeof window.closeEventDetailsModal === 'function') {
                        window.closeEventDetailsModal();
                    }
                    if (typeof window.loadCalendarData === 'function') {
                        window.loadCalendarData();
                    }
                    // Force refresh the current view after a short delay
                    if (typeof window.renderCurrentView === 'function') {
                        setTimeout(() => {
                            window.renderCurrentView();
                        }, 500);
                    }
                } else {
                    alert('Error: ' + (data.message || 'Failed to delete lecture schedule'));
                }
            })
            .catch(error => {
                console.error('Error deleting lecture schedule:', error);
                alert('Error deleting lecture schedule: ' + error.message);
            });
        };
        
        // Check if event is part of a recurring series
        function checkForRelatedEvents(eventObj) {
            if (!window.calendarState || !window.calendarState.allEvents) {
                return false;
            }
            
            const currentEvent = eventObj;
            const allEvents = window.calendarState.allEvents || [];
            
            // Find events with same title, start_time, end_time, type, and color
            // These indicate they're part of the same recurring series
            const relatedEvents = allEvents.filter(e => {
                // Skip the current event itself
                if (e.id === currentEvent.id) {
                    return false;
                }
                
                // Match on key properties that indicate same series
                return e.title === currentEvent.title &&
                       e.start_time === currentEvent.start_time &&
                       e.end_time === currentEvent.end_time &&
                       e.type === currentEvent.type &&
                       e.color === currentEvent.color;
            });
            
            // If we find at least one related event, this is part of a series
            return relatedEvents.length > 0;
        }
        
        // Toggle More Menu for Events - Global function
        window.toggleEventMoreMenu = function(event) {
            event.stopPropagation();
            const btn = event.target.closest('.btn-more');
            if (!btn) return;
            
            const menuId = btn.id.replace('eventMoreBtn_', 'eventMoreMenu_');
            const menu = document.getElementById(menuId);
            
            if (!menu) return;
            
            // Close all other menus
            document.querySelectorAll('.more-menu-dropdown').forEach(m => {
                if (m.id !== menuId) {
                    m.classList.remove('show');
                }
            });
            
            // Toggle current menu
            menu.classList.toggle('show');
        };
        
        // Toggle More Menu - Global function (for lecture schedules)
        window.toggleMoreMenu = function(event) {
            event.stopPropagation();
            const btn = event.target.closest('.btn-more');
            if (!btn) return;
            
            const scheduleId = btn.id.replace('moreBtn_', '');
            const menu = document.getElementById('moreMenu_' + scheduleId);
            
            // Close all other menus
            document.querySelectorAll('.more-menu-dropdown').forEach(m => {
                if (m !== menu) {
                    m.style.display = 'none';
                }
            });
            
            // Toggle current menu
            if (menu) {
                menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
            }
        };
        
        // Close More Menu when clicking outside (for both events and schedules)
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.more-actions-wrapper')) {
                document.querySelectorAll('.more-menu-dropdown').forEach(menu => {
                    // Use classList for event menus, style.display for schedule menus
                    if (menu.id && menu.id.startsWith('eventMoreMenu_')) {
                        menu.classList.remove('show');
                    } else {
                    menu.style.display = 'none';
                    }
                });
            }
        });
        
        // Edit All Schedule - Global function
        window.editAllSchedule = function(scheduleId) {
            // Close the more menu
            const menu = document.getElementById('moreMenu_' + scheduleId);
            if (menu) {
                menu.style.display = 'none';
            }
            
            // Call the existing edit function
            if (typeof window.editLectureSchedule === 'function') {
                window.editLectureSchedule(scheduleId);
            }
        };
        
        // Delete All Schedule - Global function
        window.deleteAllSchedule = function(scheduleId) {
            // Close the more menu
            document.querySelectorAll('.more-menu-dropdown').forEach(menu => {
                menu.style.display = 'none';
            });
            
            // Confirm deletion
            if (!confirm('Are you sure you want to delete this entire lecture schedule and all its sessions?')) {
                return;
            }
            
            // Call the existing delete function
            if (typeof window.deleteLectureSchedule === 'function') {
                window.deleteLectureSchedule(scheduleId);
            }
        };
        
        // Edit Single Session - Global function
        window.editSingleSession = function(sessionId) {
            if (!sessionId) {
                alert('No lecture session selected for editing');
                return;
            }
            
            // Close the more menu
            document.querySelectorAll('.more-menu-dropdown').forEach(menu => {
                menu.style.display = 'none';
            });
            
            // Close the event details modal
            if (typeof window.closeEventDetailsModal === 'function') {
                window.closeEventDetailsModal();
            }
            
            // Fetch session details
            const API_BASE = window.CALENDAR_API_BASE || '{{{config.wwwroot}}}/theme/remui_kids/school_manager/calendar_management.php';
            const SESSKEY = window.CALENDAR_SESSKEY || '{{sesskey}}';
            
            fetch(`${API_BASE}?action=get_lecture_session&session_id=${sessionId}&sesskey=${SESSKEY}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success' && data.session) {
                        const session = data.session;
                        
                        // Open a simple edit modal for single session
                        const modal = document.getElementById('createLectureModal');
                        const modalTitle = modal.querySelector('.modal-header h3');
                        const form = document.getElementById('createLectureForm');
                        const submitBtn = form.querySelector('button[type="submit"]');
                        const scheduleIdField = document.getElementById('lectureScheduleId');
                        
                        if (!modal || !form) {
                            alert('Error: Modal form not found');
                            return;
                        }
                        
                        // Set schedule ID to indicate this is a single session edit
                        if (scheduleIdField) {
                            scheduleIdField.value = session.schedule_id || '';
                        }
                        
                        // Store session ID in a hidden field
                        let sessionIdField = document.getElementById('lectureSessionId');
                        if (!sessionIdField) {
                            sessionIdField = document.createElement('input');
                            sessionIdField.type = 'hidden';
                            sessionIdField.id = 'lectureSessionId';
                            sessionIdField.name = 'session_id';
                            form.insertBefore(sessionIdField, form.firstChild);
                        }
                        sessionIdField.value = sessionId;
                        
                        // Update modal title
                        if (modalTitle) {
                            modalTitle.textContent = 'Edit Lecture Session';
                        }
                        
                        // Update submit button text
                        if (submitBtn) {
                            submitBtn.textContent = 'Update Session';
                        }
                        
                        // Hide Frequency field when editing single session
                        const frequencyGroup = document.getElementById('frequencyGroup');
                        const daysSelection = document.getElementById('daysSelection');
                        if (frequencyGroup) {
                            frequencyGroup.style.display = 'none';
                        }
                        if (daysSelection) {
                            daysSelection.style.display = 'none';
                        }
                        
                        // Hide Start Date and End Date fields, show single read-only date field
                        const dateRangeGroup = document.getElementById('lectureDateRangeGroup');
                        const singleDateGroup = document.getElementById('lectureSingleDateGroup');
                        if (dateRangeGroup) {
                            dateRangeGroup.style.display = 'none';
                        }
                        if (singleDateGroup) {
                            singleDateGroup.style.display = 'block';
                        }
                        
                        // Load form data first (courses, teachers) - This populates course dropdown
                        if (typeof window.loadLectureFormData === 'function') {
                            window.loadLectureFormData();
                        }
                        
                        // Populate form fields (all fields are editable for single session except date)
                        setTimeout(() => {
                            const courseField = document.getElementById('lectureCourse');
                            const teacherField = document.getElementById('lectureTeacher');
                            
                            if (courseField) {
                                courseField.value = session.course_id || '';
                                courseField.disabled = false; // Course can be changed
                        
                        // Load teachers for the selected course and then select the teacher
                                if (session.course_id && typeof window.loadCourseTeachers === 'function') {
                        window.loadCourseTeachers(session.course_id).then(() => {
                                        if (teacherField && session.teacher_id) {
                                            teacherField.value = session.teacher_id || '';
                                            teacherField.disabled = false; // Teacher can be changed
                                        }
                                    });
                                }
                            }
                        
                        document.getElementById('lectureDescription').value = session.description || '';
                            
                            // Show date in read-only field (format: MM/DD/YYYY)
                            const sessionDateField = document.getElementById('lectureSessionDate');
                            if (sessionDateField && session.date) {
                                // Convert YYYY-MM-DD to MM/DD/YYYY format
                                const dateParts = session.date.split('-');
                                if (dateParts.length === 3) {
                                    const formattedDate = `${dateParts[1]}/${dateParts[2]}/${dateParts[0]}`;
                                    sessionDateField.value = formattedDate;
                                } else {
                                    sessionDateField.value = session.date;
                                }
                            }
                            
                            // Still set the hidden date fields for form submission (but keep them hidden)
                        document.getElementById('lectureStartDate').value = session.date || '';
                        document.getElementById('lectureEndDate').value = session.date || '';
                            
                        document.getElementById('lectureStartTime').value = session.start_time || '';
                        document.getElementById('lectureEndTime').value = session.end_time || '';
                        document.getElementById('lectureColor').value = session.color || 'green';
                        }, 300);
                        
                        // Show modal
                        modal.style.display = 'flex';
                    } else {
                        alert('Error: ' + (data.message || 'Failed to load session details'));
                    }
                })
                .catch(error => {
                    console.error('Error loading session:', error);
                    alert('Error loading session details: ' + error.message);
                });
        };
        
        // Delete Single Session - Global function
        window.deleteSingleSession = function(sessionId) {
            if (!sessionId) {
                alert('No lecture session selected for deletion');
                return;
            }
            
            // Close the more menu
            document.querySelectorAll('.more-menu-dropdown').forEach(menu => {
                menu.style.display = 'none';
            });
            
            // Confirm deletion
            if (!confirm('Are you sure you want to delete this lecture session? This will only delete this specific occurrence.')) {
                return;
            }
            
            const formData = new FormData();
            formData.append('action', 'delete_lecture_session');
            formData.append('sesskey', window.CALENDAR_SESSKEY);
            formData.append('session_id', sessionId);
            
            fetch(window.CALENDAR_API_BASE, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Lecture session deleted successfully!');
                    if (typeof window.closeEventDetailsModal === 'function') {
                        window.closeEventDetailsModal();
                    }
                    if (typeof window.loadCalendarData === 'function') {
                        window.loadCalendarData();
                    }
                    // Force refresh the current view after a short delay
                    if (typeof window.renderCurrentView === 'function') {
                        setTimeout(() => {
                            window.renderCurrentView();
                        }, 500);
                    }
                } else {
                    alert('Error: ' + (data.message || 'Failed to delete lecture session'));
                }
            })
            .catch(error => {
                console.error('Error deleting lecture session:', error);
                alert('Error deleting lecture session: ' + error.message);
            });
        };
        
        // Delete Event - Global function
        window.deleteEvent = function() {
            if (!window.calendarState || !window.calendarState.selectedEvent || !confirm('Are you sure you want to delete this event?')) {
                return;
            }
            
            const formData = new FormData();
            formData.append('action', 'delete_event');
            formData.append('sesskey', window.CALENDAR_SESSKEY);
            formData.append('event_id', window.calendarState.selectedEvent.id);
            
            fetch(window.CALENDAR_API_BASE, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Event deleted successfully!');
                    if (typeof window.closeEventDetailsModal === 'function') {
                        window.closeEventDetailsModal();
                    }
                    if (typeof window.loadCalendarData === 'function') {
                        window.loadCalendarData();
                    }
                } else {
                    alert('Error: ' + (data.message || 'Failed to delete event'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error deleting event');
            });
        };
        
        // Get all related events (part of same recurring series)
        function getAllRelatedEventIds(eventObj) {
            if (!window.calendarState || !window.calendarState.allEvents) {
                return [eventObj.id];
            }
            
            const currentEvent = eventObj;
            const allEvents = window.calendarState.allEvents || [];
            
            // Find all events with same title, start_time, end_time, type, and color
            const relatedEvents = allEvents.filter(e => {
                return e.title === currentEvent.title &&
                       e.start_time === currentEvent.start_time &&
                       e.end_time === currentEvent.end_time &&
                       e.type === currentEvent.type &&
                       e.color === currentEvent.color;
            });
            
            return relatedEvents.map(e => e.id);
        }
        
        // Edit All Events in Series - Global function
        window.editAllEvent = function() {
            if (!window.calendarState || !window.calendarState.selectedEvent) {
                alert('No event selected');
                return;
            }
            
            const currentEvent = window.calendarState.selectedEvent;
            const relatedEventIds = getAllRelatedEventIds(currentEvent);
            
            if (relatedEventIds.length <= 1) {
                // Only one event, just edit normally
                editEvent();
                return;
            }
            
            // Close the more menu
            document.querySelectorAll('.more-menu-dropdown').forEach(menu => {
                menu.classList.remove('show');
            });
            
            // Store related event IDs for editing all BEFORE closing modal
            window.calendarState.editAllEvents = relatedEventIds;
            
            // IMPORTANT: Preserve selectedEvent before closing modal
            // because closeEventDetailsModal() clears it
            const preservedEvent = JSON.parse(JSON.stringify(currentEvent));
            
            // Close the details modal
            if (typeof window.closeEventDetailsModal === 'function') {
                window.closeEventDetailsModal();
            }
            
            // Restore selectedEvent so editEvent() can use it
            window.calendarState.selectedEvent = preservedEvent;
            
            // Open edit modal with all events marked
            editEvent();
            
            // Show notification that editing all events
            setTimeout(() => {
                const modalTitle = document.querySelector('#createEventModal .modal-header h3');
                if (modalTitle) {
                    modalTitle.textContent = `Edit Event (All ${relatedEventIds.length} occurrences)`;
                }
            }, 100);
        };
        
        // Delete All Events in Series - Global function
        window.deleteAllEvent = function() {
            if (!window.calendarState || !window.calendarState.selectedEvent) {
                alert('No event selected');
                return;
            }
            
            const currentEvent = window.calendarState.selectedEvent;
            const relatedEventIds = getAllRelatedEventIds(currentEvent);
            
            if (relatedEventIds.length <= 1) {
                // Only one event, just delete normally
                deleteEvent();
                return;
            }
            
            if (!confirm(`Are you sure you want to delete all ${relatedEventIds.length} occurrences of this event?`)) {
                return;
            }
            
            // Close the more menu
            document.querySelectorAll('.more-menu-dropdown').forEach(menu => {
                menu.classList.remove('show');
            });
            
            // Delete all related events
            const API_BASE = window.CALENDAR_API_BASE || '{{{config.wwwroot}}}/theme/remui_kids/school_manager/calendar_management.php';
            const SESSKEY = window.CALENDAR_SESSKEY || '{{sesskey}}';
            
            // Delete events one by one
            let deletedCount = 0;
            let failedCount = 0;
            
            Promise.all(relatedEventIds.map(eventId => {
                const formData = new FormData();
                formData.append('action', 'delete_event');
                formData.append('sesskey', SESSKEY);
                formData.append('event_id', eventId);
                
                return fetch(API_BASE, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        deletedCount++;
                    } else {
                        failedCount++;
                    }
                })
                .catch(error => {
                    console.error('Error deleting event:', error);
                    failedCount++;
                });
            }))
            .then(() => {
                // Close modal
                if (typeof window.closeEventDetailsModal === 'function') {
                    window.closeEventDetailsModal();
                }
                
                // Reload calendar
                if (typeof window.loadCalendarData === 'function') {
                    window.loadCalendarData(true);
                }
                
                // Show result message
                if (failedCount === 0) {
                    alert(`Successfully deleted ${deletedCount} event(s)!`);
                } else {
                    alert(`Deleted ${deletedCount} event(s), but ${failedCount} failed to delete.`);
                }
                
                // Force refresh the current view
                if (typeof window.renderCurrentView === 'function') {
                    setTimeout(() => {
                        window.renderCurrentView();
                    }, 500);
                }
            });
        };
    })();
    </script>

    <!-- School Admin Calendar Section -->
    <div class="calendar-sessions-section">
        <div class="calendar-management-header">
            <div class="calendar-header-left">
                <h2 class="calendar-section-title">School Calendar</h2>
                <p class="calendar-section-subtitle">Manage events and lecture schedules</p>
            </div>
            <div class="calendar-header-actions">
                <button class="btn-create-event" onclick="openCreateEventModal()">
                    <i class="fa fa-plus"></i> Create Event
                </button>
                <button class="btn-create-lecture" onclick="openCreateLectureModal()">
                    <i class="fa fa-chalkboard-teacher"></i> Schedule Lecture
                </button>
            </div>
        </div>
        
        <div class="calendar-filters">
            <div class="filter-group">
                <label>Filter by Type:</label>
                <select id="filterEventType" onchange="applyFilters()">
                    <option value="all">All Events</option>
                    <option value="meeting">Meetings</option>
                    <option value="lecture">Lectures</option>
                    <option value="exam">Exams</option>
                    <option value="activity">Activities</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Filter by Course:</label>
                <select id="filterCourse" onchange="applyFilters()">
                    <option value="all">All Courses</option>
                    {{#calendar_courses}}
                    <option value="{{id}}">{{fullname}}</option>
                    {{/calendar_courses}}
                </select>
            </div>
            <div class="filter-group">
                <label>Filter by Teacher:</label>
                <select id="filterTeacher" onchange="applyFilters()">
                    <option value="all">All Teachers</option>
                    {{#calendar_teachers}}
                    <option value="{{id}}">{{#firstname}}{{firstname}} {{/firstname}}{{#lastname}}{{lastname}}{{/lastname}}</option>
                    {{/calendar_teachers}}
                </select>
            </div>
        </div>
        
            <div class="calendar-container">
                <div class="calendar-header">
                <h2 class="calendar-title">Calendar View</h2>
                    <div class="calendar-navigation">
                    <button class="nav-btn" onclick="changeCalendarPeriod(-1)">
                        <i class="fa fa-chevron-left"></i>
                    </button>
                    <span class="current-period" id="currentPeriod">May 5 - 11, 2025</span>
                    <button class="nav-btn" onclick="changeCalendarPeriod(1)">
                        <i class="fa fa-chevron-right"></i>
                    </button>
                        <button class="today-btn" onclick="goToToday()">Today</button>
                    <button class="today-btn" onclick="refreshCalendar()" title="Refresh Calendar" style="margin-left: 0.5rem;">
                        <i class="fa fa-sync-alt"></i> Refresh
                    </button>
                    </div>
                    <div class="view-toggles">
                    <button class="view-toggle active" data-view="week" onclick="switchView('week')">
                        <i class="fa fa-calendar-week"></i> Week
                    </button>
                    <button class="view-toggle" data-view="month" onclick="switchView('month')">
                        <i class="fa fa-calendar-alt"></i> Month
                    </button>
                    <button class="view-toggle" data-view="day" onclick="switchView('day')">
                        <i class="fa fa-calendar-day"></i> Day
                    </button>
                    </div>
                </div>
                
            <!-- Week View -->
            <div class="calendar-week-view" id="calendarWeekView">
                <div class="week-events" id="weekGrid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.75rem;">
                    <!-- Events will be dynamically inserted here -->
                </div>
                    </div>
                    
            <!-- Month View -->
            <div class="calendar-month-view" id="calendarMonthView" style="display: none;">
                <div class="month-grid" id="monthGrid">
                    <!-- Month calendar will be dynamically generated -->
                            </div>
                        </div>
                        
            <!-- Day View -->
            <div class="calendar-day-view" id="calendarDayView" style="display: none;">
                <div class="day-timeline" id="dayTimeline">
                    <!-- Day timeline will be dynamically generated -->
                            </div>
                        </div>
                            </div>
                        </div>
                        
    <!-- Create Event Modal -->
    <div id="createEventModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Event</h3>
                <button class="modal-close" onclick="closeCreateEventModal()">&times;</button>
                            </div>
            <form id="createEventForm" onsubmit="saveEvent(event)">
                <input type="hidden" id="eventId" name="event_id" value="">
                <div class="form-group">
                    <label>Event Title *</label>
                    <input type="text" id="eventTitle" required>
                        </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="eventDescription" rows="3"></textarea>
                            </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Start Date *</label>
                        <input type="date" id="eventStartDate" required>
                        </div>
                    <div class="form-group" id="eventEndDateGroup">
                        <label>End Date</label>
                        <input type="date" id="eventEndDate">
                        </div>
                            </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Start Time *</label>
                        <input type="time" id="eventStartTime" required>
                            </div>
                    <div class="form-group">
                        <label>End Time *</label>
                        <input type="time" id="eventEndTime" required>
                        </div>
                            </div>
                <div class="form-group" id="eventFrequencyGroup" style="display: none;">
                    <label>Frequency *</label>
                    <select id="eventFrequency" onchange="toggleEventFrequencyOptions()">
                        <option value="daily">Daily</option>
                        <option value="specific_date">Specific Date</option>
                        <option value="weekly">Weekly Day</option>
                    </select>
                </div>
                <!-- Specific Date Selection - Show when "Specific Date" is selected -->
                <div class="form-group" id="eventSpecificDateGroup" style="display: none;">
                    <label>Select Specific Date(s) *</label>
                    <div id="eventDatePickerContainer" style="border: 1px solid #ddd; padding: 1rem; border-radius: 4px; background-color: #ffffff; max-width: 350px;">
                        <p style="margin: 0 0 0.75rem 0; color: #6b7280; font-size: 0.875rem;">Select date(s) between Start Date and End Date:</p>
                        <div id="eventDatePicker" style="width: 100%;">
                            <!-- Calendar widget will be generated dynamically -->
                        </div>
                        <input type="hidden" id="eventSelectedDates" name="selected_dates">
                    </div>
                </div>
                <!-- Weekly Day Selection - Show when "Weekly Day" is selected -->
                <div class="form-group" id="eventWeeklyDayGroup" style="display: none;">
                    <label>Select Day(s) of Week *</label>
                    <div class="days-checkboxes event-weekly-days" style="display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 0.5rem;">
                        <label class="weekday-checkbox-label" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin: 0; padding: 0;">
                            <input type="checkbox" name="eventWeeklyDays" value="1" class="weekday-checkbox-input" style="width: 18px; height: 18px; cursor: pointer; margin: 0; padding: 0; border: 1px solid #d1d5db; border-radius: 3px; appearance: checkbox; -webkit-appearance: checkbox; -moz-appearance: checkbox;"> 
                            <span>Monday</span>
                        </label>
                        <label class="weekday-checkbox-label" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin: 0; padding: 0;">
                            <input type="checkbox" name="eventWeeklyDays" value="2" class="weekday-checkbox-input" style="width: 18px; height: 18px; cursor: pointer; margin: 0; padding: 0; border: 1px solid #d1d5db; border-radius: 3px; appearance: checkbox; -webkit-appearance: checkbox; -moz-appearance: checkbox;"> 
                            <span>Tuesday</span>
                        </label>
                        <label class="weekday-checkbox-label" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin: 0; padding: 0;">
                            <input type="checkbox" name="eventWeeklyDays" value="3" class="weekday-checkbox-input" style="width: 18px; height: 18px; cursor: pointer; margin: 0; padding: 0; border: 1px solid #d1d5db; border-radius: 3px; appearance: checkbox; -webkit-appearance: checkbox; -moz-appearance: checkbox;"> 
                            <span>Wednesday</span>
                        </label>
                        <label class="weekday-checkbox-label" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin: 0; padding: 0;">
                            <input type="checkbox" name="eventWeeklyDays" value="4" class="weekday-checkbox-input" style="width: 18px; height: 18px; cursor: pointer; margin: 0; padding: 0; border: 1px solid #d1d5db; border-radius: 3px; appearance: checkbox; -webkit-appearance: checkbox; -moz-appearance: checkbox;"> 
                            <span>Thursday</span>
                        </label>
                        <label class="weekday-checkbox-label" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin: 0; padding: 0;">
                            <input type="checkbox" name="eventWeeklyDays" value="5" class="weekday-checkbox-input" style="width: 18px; height: 18px; cursor: pointer; margin: 0; padding: 0; border: 1px solid #d1d5db; border-radius: 3px; appearance: checkbox; -webkit-appearance: checkbox; -moz-appearance: checkbox;"> 
                            <span>Friday</span>
                        </label>
                        <label class="weekday-checkbox-label" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin: 0; padding: 0;">
                            <input type="checkbox" name="eventWeeklyDays" value="6" class="weekday-checkbox-input" style="width: 18px; height: 18px; cursor: pointer; margin: 0; padding: 0; border: 1px solid #d1d5db; border-radius: 3px; appearance: checkbox; -webkit-appearance: checkbox; -moz-appearance: checkbox;"> 
                            <span>Saturday</span>
                        </label>
                        <label class="weekday-checkbox-label" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin: 0; padding: 0;">
                            <input type="checkbox" name="eventWeeklyDays" value="7" class="weekday-checkbox-input" style="width: 18px; height: 18px; cursor: pointer; margin: 0; padding: 0; border: 1px solid #d1d5db; border-radius: 3px; appearance: checkbox; -webkit-appearance: checkbox; -moz-appearance: checkbox;"> 
                            <span>Sunday</span>
                        </label>
                        </div>
                            </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Event Type *</label>
                        <select id="eventType" required>
                            <option value="meeting">Meeting</option>
                            <option value="lecture">Lecture</option>
                            <option value="exam">Exam</option>
                            <option value="activity">Activity</option>
                            <option value="other">Other</option>
                        </select>
                        </div>
                    <div class="form-group">
                        <label>Color</label>
                        <select id="eventColor">
                            <option value="blue">Blue</option>
                            <option value="green">Green</option>
                            <option value="purple">Purple</option>
                            <option value="orange">Orange</option>
                            <option value="red">Red</option>
                            <option value="pink">Pink</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Select Teachers</label>
                    <select id="eventTeachers" multiple style="min-height: 100px;">
                        <!-- Populated dynamically -->
                    </select>
                </div>
                <div class="form-group">
                    <label>Select Students</label>
                    <select id="eventStudents" multiple style="min-height: 100px;">
                        <!-- Populated dynamically -->
                    </select>
            </div>
                <div class="form-group">
                    <label>Select Cohorts</label>
                    <select id="eventCohorts" multiple style="min-height: 100px;" onchange="loadCohortMembers()">
                        <!-- Populated dynamically -->
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-cancel" onclick="closeCreateEventModal()">Cancel</button>
                    <button type="submit" class="btn-save">Create Event</button>
                            </div>
            </form>
                        </div>
                    </div>
    
    <!-- Create Lecture Schedule Modal -->
    <div id="createLectureModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Schedule Lecture</h3>
                <button class="modal-close" onclick="closeCreateLectureModal()">&times;</button>
                    </div>
            <form id="createLectureForm" onsubmit="saveLectureSchedule(event)">
                <input type="hidden" id="lectureScheduleId" name="schedule_id" value="">
                <div class="form-group">
                    <label>Course *</label>
                    <select id="lectureCourse" required onchange="loadCourseTeachers(this.value)">
                        <option value="">Select Course</option>
                        <!-- Populated dynamically -->
                    </select>
                </div>
                <div class="form-group">
                    <label>Assign Teacher *</label>
                    <select id="lectureTeacher" required>
                        <option value="">Select Teacher</option>
                        <!-- Populated dynamically -->
                    </select>
                    <div id="teacherErrorMessage" class="error-message" style="display: none; color: #ef4444; font-size: 0.875rem; margin-top: 0.5rem;">
                        First assign teacher to this course
                    </div>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="lectureDescription" rows="3"></textarea>
                </div>
                <!-- Date fields for full schedule creation -->
                <div class="form-row" id="lectureDateRangeGroup">
                    <div class="form-group">
                        <label>Start Date *</label>
                        <input type="date" id="lectureStartDate" required>
                    </div>
                    <div class="form-group">
                        <label>End Date *</label>
                        <input type="date" id="lectureEndDate" required>
                    </div>
                </div>
                <!-- Single date field for single session edit (read-only) -->
                <div class="form-group" id="lectureSingleDateGroup" style="display: none;">
                    <label>Date</label>
                    <input type="text" id="lectureSessionDate" readonly style="background-color: #f3f4f6; cursor: not-allowed;">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Start Time *</label>
                        <input type="time" id="lectureStartTime" required>
                    </div>
                    <div class="form-group">
                        <label>End Time *</label>
                        <input type="time" id="lectureEndTime" required>
                    </div>
                </div>
                <!-- Frequency field - Only show when creating new schedule, hide when editing -->
                <div class="form-group" id="frequencyGroup">
                    <label>Frequency *</label>
                    <select id="lectureFrequency" required onchange="toggleDaysSelection()">
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="custom">Custom Days</option>
                    </select>
                </div>
                <div class="form-group" id="daysSelection" style="display: none;">
                    <label>Select Days</label>
                    <div class="days-checkboxes">
                        <label><input type="checkbox" name="lectureDays" value="1"> Monday</label>
                        <label><input type="checkbox" name="lectureDays" value="2"> Tuesday</label>
                        <label><input type="checkbox" name="lectureDays" value="3"> Wednesday</label>
                        <label><input type="checkbox" name="lectureDays" value="4"> Thursday</label>
                        <label><input type="checkbox" name="lectureDays" value="5"> Friday</label>
                        <label><input type="checkbox" name="lectureDays" value="6"> Saturday</label>
                        <label><input type="checkbox" name="lectureDays" value="7"> Sunday</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Color</label>
                    <select id="lectureColor">
                        <option value="green">Green</option>
                        <option value="blue">Blue</option>
                        <option value="purple">Purple</option>
                        <option value="orange">Orange</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-cancel" onclick="closeCreateLectureModal()">Cancel</button>
                    <button type="submit" class="btn-save">Create Schedule</button>
                </div>
            </form>
        </div>
                </div>
                
    <!-- Event Details Modal -->
    <div id="eventDetailsModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="eventDetailsTitle">Event Details</h3>
                <button class="modal-close" onclick="closeEventDetailsModal()">&times;</button>
                </div>
            <div id="eventDetailsContent">
                <!-- Event details will be populated here -->
            </div>
            <div class="form-actions">
                <button class="btn-edit" onclick="editEvent()">Edit</button>
                <button class="btn-delete" onclick="deleteEvent()">Delete</button>
                <button class="btn-cancel" onclick="closeEventDetailsModal()">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Dashboard Styles -->
<style>
    /* OPTIMIZATION: Loading spinner styles for lazy-loaded charts */
    .chart-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 220px;
        color: #6b7280;
    }
    
    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #e5e7eb;
        border-top-color: #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 1rem;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .chart-loading p {
        margin: 0;
        font-size: 0.875rem;
        color: #6b7280;
    }
    
    /* Hide "My courses" link from navigation bar for school managers */
    .primary-navigation .nav-link[href*="/my/courses"],
    .primary-navigation a[href*="/my/courses"],
    .navbar .nav-link[href*="/my/courses"],
    .navbar a[href*="/my/courses"],
    .primary-navigation .nav-item:has(a[href*="/my/courses"]),
    .navbar .nav-item:has(a[href*="/my/courses"]),
    #page-header .nav-link[data-key="mycourses"],
    #page-header .nav-link[href*="/my/courses"],
    .primary-navigation .nav-link[data-key="mycourses"],
    .moremenu .nav-link[data-key="mycourses"],
    .moremenu a[href*="/my/courses"],
    li.nav-item:has(> a[href*="/my/courses"]) {
        display: none !important;
    }

    .school-dashboard-container {
        padding: 2rem;
        max-width: none;
        margin: 0;
        width: 100%;
        min-height: 100vh;
        background: transparent;
        overflow: visible;
    }

    /* Dashboard Header Section - Professional Design */
    .dashboard-header-section {
        background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
        border-radius: 0.75rem;
        padding: 2rem 2.5rem;
        margin-bottom: 2rem;
        border: 1px solid #e2e8f0;
        box-shadow: 
            0 1px 3px rgba(0, 0, 0, 0.05),
            0 4px 12px rgba(0, 0, 0, 0.04);
        position: relative;
        overflow: visible;
    }

    .dashboard-header-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(180deg, #3b82f6 0%, #06b6d4 100%);
        border-radius: 0.75rem 0 0 0.75rem;
    }

    .dashboard-header-content {
        position: relative;
        z-index: 1;
    }

    .dashboard-header-main {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 2rem;
    }

    .dashboard-header-title-group {
        flex: 1;
        min-width: 0;
    }

    .dashboard-school-name {
        font-size: 1.875rem;
        font-weight: 700;
        color: #1e293b;
        margin: 0 0 0.75rem 0;
        letter-spacing: -0.5px;
        line-height: 1.2;
        font-family: 'Inter', 'Segoe UI', 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    .dashboard-subtitle-wrapper {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .dashboard-subtitle-badge {
        font-size: 0.75rem;
        font-weight: 600;
        color: #64748b;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        padding: 0.375rem 0.875rem;
        background: #f1f5f9;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        display: inline-block;
    }

    .dashboard-header-actions {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex-shrink: 0;
    }

    .dashboard-header-badge {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        border: none;
        border-radius: 8px;
        padding: 0.625rem 1.25rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #ffffff;
        font-weight: 600;
        font-size: 0.8125rem;
        box-shadow: 
            0 2px 8px rgba(59, 130, 246, 0.2),
            0 1px 4px rgba(37, 99, 235, 0.15);
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        letter-spacing: 0.2px;
        text-transform: uppercase;
        position: relative;
    }

    .dashboard-header-badge:hover {
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        transform: translateY(-1px);
        box-shadow: 
            0 4px 12px rgba(59, 130, 246, 0.3),
            0 2px 6px rgba(37, 99, 235, 0.2);
    }

    .dashboard-header-badge:active {
        transform: translateY(0);
        box-shadow: 
            0 1px 4px rgba(59, 130, 246, 0.2);
    }

    .dashboard-header-badge i {
        font-size: 0.9375rem;
        color: #ffffff;
    }

    .dashboard-header-badge span {
        letter-spacing: 0.3px;
        font-weight: 600;
    }

    /* Responsive Design for Dashboard Header */
    @media (max-width: 1024px) {
        .dashboard-header-section {
            padding: 1.75rem 2rem;
        }

        .dashboard-school-name {
            font-size: 1.625rem;
        }
    }

    @media (max-width: 768px) {
        .dashboard-header-section {
            padding: 1.5rem 1.5rem;
            margin-bottom: 1.5rem;
        }

        .dashboard-header-main {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }

        .dashboard-school-name {
            font-size: 1.5rem;
            margin-bottom: 0.625rem;
        }

        .dashboard-subtitle-badge {
            font-size: 0.6875rem;
            padding: 0.3125rem 0.75rem;
        }

        .dashboard-header-actions {
            width: 100%;
            justify-content: flex-start;
        }

        .dashboard-header-badge {
            padding: 0.5625rem 1rem;
            font-size: 0.75rem;
        }
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
        width: 100%;
    }

    .stat-card {
        background: white;
        border-radius: 0.75rem;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border: 1px solid #e9ecef;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        min-height: 140px;
        border-top: 4px solid transparent;
        animation: none !important;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.12);
    }

    .stat-card.teachers-card {
        border-top-color: #667eea;
        background: linear-gradient(180deg, rgba(102, 126, 234, 0.08), #ffffff);
    }

    .stat-card.students-card {
        border-top-color: #f093fb;
        background: linear-gradient(180deg, rgba(240, 147, 251, 0.08), #ffffff);
    }

    .stat-card.courses-card {
        border-top-color: #4facfe;
        background: linear-gradient(180deg, rgba(79, 172, 254, 0.08), #ffffff);
    }

    .stat-card.enrollments-card {
        border-top-color: #43e97b;
        background: linear-gradient(180deg, rgba(67, 233, 123, 0.08), #ffffff);
    }

    .stat-card.parents-card {
        border-top-color: #ec4899;
        background: linear-gradient(180deg, rgba(236, 72, 153, 0.08), #ffffff);
    }

    .stat-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .stat-content h3.stat-number {
        font-size: 2.25rem;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 0.5rem;
        line-height: 1;
        animation: none !important;
        transition: none !important;
    }

    .stat-content .stat-label {
        font-size: 0.75rem;
        color: #6c757d;
        margin-bottom: 0.75rem;
        font-weight: 600;
        letter-spacing: 0.5px;
        text-transform: uppercase;
    }

    .stat-trend {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .stat-trend .trend-arrow {
        color: #28a745;
        font-size: 0.875rem;
        font-weight: bold;
    }

    .stat-trend .trend-text {
        font-size: 0.75rem;
        color: #28a745;
        font-weight: 500;
    }

    .stat-sub-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 0.5rem;
        padding-top: 0.5rem;
        border-top: 1px solid #e9ecef;
    }

    .stat-sub-info .sub-label {
        font-size: 0.7rem;
        color: #6c757d;
        font-weight: 500;
    }

    .stat-sub-info .sub-value {
        font-size: 0.7rem;
        color: #667eea;
        font-weight: 600;
        text-align: right;
        flex: 1;
    }

    .stat-icon {
        position: absolute;
        top: 1rem;
        right: 1rem;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        color: white;
    }

    .teachers-card .stat-icon {
        background: linear-gradient(135deg, #667eea, #764ba2);
    }

    .students-card .stat-icon {
        background: linear-gradient(135deg, #f093fb, #fecfef);
    }

    .courses-card .stat-icon {
        background: linear-gradient(135deg, #4facfe, #00f2fe);
    }

    .enrollments-card .stat-icon {
        background: linear-gradient(135deg, #43e97b, #38f9d7);
    }

    .parents-card .stat-icon {
        background: linear-gradient(135deg, #ec4899, #f472b6);
    }

    .stat-action {
        position: absolute;
        bottom: 1rem;
        right: 1rem;
    }

    .stat-action .stat-link {
        color: #6c757d;
        font-size: 1rem;
        transition: color 0.3s ease;
    }

    .stat-action .stat-link:hover {
        color: #667eea;
    }

    .summary-section, .recent-activity-section {
        margin-bottom: 2rem;
    }

    .analytics-section {
        margin: 2rem 0 3rem;
        padding: 0 1rem;
    }

    .analytics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .chart-card {
        background: #ffffff;
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 5px 25px rgba(15, 23, 42, 0.08);
        border: 1px solid #e5e7eb;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .chart-card.wide {
        grid-column: span 2;
    }

    @media (max-width: 1024px) {
        .chart-card.wide {
            grid-column: span 1;
        }
    }

    .chart-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 1rem;
    }

    .chart-card-header h3 {
        margin: 0;
        font-size: 1.2rem;
        font-weight: 600;
        color: #1f2937;
    }

    .chart-card-header p {
        margin: 0.1rem 0 0 0;
        color: #6b7280;
        font-size: 0.85rem;
    }

    .chart-meta,
    .chart-meta-group span {
        font-size: 0.85rem;
        color: #6b7280;
        font-weight: 600;
    }

    .chart-meta-group {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        justify-content: flex-end;
    }

    .chart-inline-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 0.75rem;
    }

    .chart-inline-stats.two-column {
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    }

    .chart-inline-stats .full-width {
        grid-column: span 2;
    }

    .chart-inline-stats div {
        background: #f8fafc;
        border-radius: 0.75rem;
        padding: 0.75rem;
        border: 1px solid #edf2f7;
    }

    .chart-inline-stats span {
        display: block;
        font-size: 0.8rem;
        text-transform: uppercase;
        color: #6b7280;
        letter-spacing: 0.05em;
    }

    .chart-inline-stats strong {
        display: block;
        font-size: 1.2rem;
        margin-top: 0.25rem;
        color: #111827;
    }

    .chart-inline-stats small {
        display: block;
        color: #9ca3af;
        font-size: 0.75rem;
        margin-top: 0.15rem;
    }

    .chart-empty-label {
        grid-column: span 2;
        text-align: center;
        color: #9ca3af;
        font-size: 0.85rem;
        padding: 0.5rem 0;
    }
    
    /* Assessment Details Section Styles */
    .assessment-details-section {
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px solid #e5e7eb;
    }
    
    .assessment-list-container {
        margin-bottom: 1.5rem;
    }
    
    .assessment-list-container:last-child {
        margin-bottom: 0;
    }
    
    .assessment-scrollable-list {
        max-height: 275px;
        overflow-y: auto;
        overflow-x: hidden;
        padding-right: 8px;
        /* Limit to show exactly 3 items at a time - each item is ~90px tall with margins */
    }
    
    .assessment-scrollable-list::-webkit-scrollbar {
        width: 6px;
    }
    
    .assessment-scrollable-list::-webkit-scrollbar-track {
        background: #f3f4f6;
        border-radius: 3px;
    }
    
    .assessment-scrollable-list::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 3px;
    }
    
    .assessment-scrollable-list::-webkit-scrollbar-thumb:hover {
        background: #9ca3af;
    }
    
    .assessment-item {
        background: #f9fafb;
        border-radius: 8px;
        padding: 12px 14px;
        margin-bottom: 10px;
        border: 1px solid #e5e7eb;
        transition: all 0.2s ease;
        min-height: 85px;
        box-sizing: border-box;
    }
    
    .assessment-item:hover {
        background: #f3f4f6;
        border-color: #d1d5db;
        transform: translateX(2px);
    }
    
    .assessment-item:last-child {
        margin-bottom: 0;
    }
    
    .assessment-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }
    
    .assessment-name {
        font-size: 0.9rem;
        font-weight: 600;
        color: #1f2937;
        flex: 1;
        margin-right: 10px;
    }
    
    .assessment-status {
        font-size: 0.75rem;
        font-weight: 600;
        padding: 3px 10px;
        border-radius: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .assessment-status-active {
        background: #d1fae5;
        color: #065f46;
    }
    
    .assessment-status-overdue,
    .assessment-status-closed {
        background: #fee2e2;
        color: #991b1b;
    }
    
    .assessment-item-details {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        font-size: 0.8rem;
        color: #6b7280;
    }
    
    .assessment-course {
        font-weight: 500;
        color: #4b5563;
    }
    
    .assessment-stat {
        display: flex;
        align-items: center;
        gap: 4px;
    }
    
    .assessment-stat i {
        font-size: 0.75rem;
        color: #9ca3af;
    }
    
    /* Course Completion Details Styles */
    .course-completion-details {
        margin-top: 1rem;
    }
    
    .course-scrollable-list {
        max-height: 440px;
        overflow-y: auto;
        overflow-x: hidden;
        padding-right: 8px;
        /* Show exactly 3 full courses + half of 4th course (3 × (115px + 12px margin) + 58px half = 439px, rounded to 440px) */
    }
    
    .course-scrollable-list::-webkit-scrollbar {
        width: 6px;
    }
    
    .course-scrollable-list::-webkit-scrollbar-track {
        background: #f3f4f6;
        border-radius: 3px;
    }
    
    .course-scrollable-list::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 3px;
    }
    
    .course-scrollable-list::-webkit-scrollbar-thumb:hover {
        background: #9ca3af;
    }
    
    .course-completion-item {
        background: #f9fafb;
        border-radius: 10px;
        padding: 14px 16px;
        margin-bottom: 12px;
        border: 1px solid #e5e7eb;
        transition: all 0.2s ease;
        min-height: 115px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
    }
    
    .course-completion-item:hover {
        background: #f3f4f6;
        border-color: #d1d5db;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    
    .course-completion-item:last-child {
        margin-bottom: 0;
    }
    
    .course-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 10px;
    }
    
    .course-name-section {
        flex: 1;
        margin-right: 12px;
    }
    
    .course-name {
        display: block;
        font-size: 0.95rem;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 4px;
    }
    
    .course-shortname {
        display: block;
        font-size: 0.75rem;
        color: #6b7280;
        font-weight: 500;
    }
    
    .course-completion-badge {
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: white;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 700;
        min-width: 60px;
        text-align: center;
    }
    
    .completion-percentage {
        display: block;
    }
    
    .course-stats-row {
        display: flex;
        flex-wrap: wrap;
        gap: 14px;
        margin-bottom: 10px;
        font-size: 0.8rem;
        color: #6b7280;
    }
    
    .course-stat {
        display: flex;
        align-items: center;
        gap: 5px;
        font-weight: 500;
    }
    
    .course-stat i {
        font-size: 0.75rem;
        color: #9ca3af;
    }
    
    .course-stat-success {
        color: #059669;
    }
    
    .course-stat-success i {
        color: #10b981;
    }
    
    .course-stat-warning {
        color: #d97706;
    }
    
    .course-stat-warning i {
        color: #f59e0b;
    }
    
    .course-stat-danger {
        color: #dc2626;
    }
    
    .course-stat-danger i {
        color: #ef4444;
    }
    
    /* Super Admin Action Styles */
    .super-admin-section {
        margin: 3rem 0;
        padding: 0 1rem;
    }
    
    .super-admin-actions-container {
        margin-top: 1.5rem;
    }
    
    .super-admin-scrollable-list {
        max-height: 450px;
        overflow-y: auto;
        padding-right: 10px;
    }
    
    .super-admin-scrollable-list::-webkit-scrollbar {
        width: 8px;
    }
    
    .super-admin-scrollable-list::-webkit-scrollbar-track {
        background: #f3f4f6;
        border-radius: 4px;
    }
    
    .super-admin-scrollable-list::-webkit-scrollbar-thumb {
        background: #8b5cf6;
        border-radius: 4px;
    }
    
    .super-admin-scrollable-list::-webkit-scrollbar-thumb:hover {
        background: #7c3aed;
    }
    
    .super-admin-action-item {
        background: #ffffff;
        border-radius: 12px;
        padding: 18px 20px;
        margin-bottom: 14px;
        border: 2px solid #e5e7eb;
        transition: all 0.3s ease;
    }
    
    .super-admin-action-item:hover {
        background: #f9fafb;
        border-color: #8b5cf6;
        box-shadow: 0 4px 15px rgba(139, 92, 246, 0.15);
        transform: translateX(3px);
    }
    
    .super-admin-action-item.recent {
        border-left: 5px solid #10b981;
        background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%);
    }
    
    .super-admin-action-item:last-child {
        margin-bottom: 0;
    }
    
    .action-item-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
        gap: 15px;
    }
    
    .course-info {
        flex: 1;
        min-width: 0;
    }
    
    .course-name-link {
        font-size: 1.05rem;
        font-weight: 600;
        color: #1f2937;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 6px;
        transition: color 0.2s;
    }
    
    .course-name-link:hover {
        color: #8b5cf6;
        text-decoration: underline;
    }
    
    .course-name-link i {
        color: #8b5cf6;
        font-size: 0.95rem;
    }
    
    .course-shortname {
        display: block;
        font-size: 0.8rem;
        color: #6b7280;
        font-weight: 500;
        margin-top: 2px;
    }
    
    .action-badges {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
    }
    
    .badge-new {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }
    
    .badge-recent {
        background: #d1fae5;
        color: #065f46;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 600;
    }
    
    .action-status {
        font-size: 0.75rem;
        font-weight: 600;
        padding: 4px 12px;
        border-radius: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .action-status-active {
        background: #d1fae5;
        color: #065f46;
    }
    
    .action-status-hidden {
        background: #f3f4f6;
        color: #6b7280;
    }
    
    .action-status-ended {
        background: #fee2e2;
        color: #991b1b;
    }
    
    .action-item-details {
        display: flex;
        flex-wrap: wrap;
        gap: 18px;
        font-size: 0.85rem;
        color: #6b7280;
        padding: 12px 0 0 0;
        border-top: 1px solid #f3f4f6;
    }
    
    .action-detail {
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .action-detail i {
        font-size: 0.8rem;
        color: #9ca3af;
    }
    
    .action-detail strong {
        color: #4b5563;
        font-weight: 600;
    }
    
    .course-progress-bar {
        height: 6px;
        background: #e5e7eb;
        border-radius: 3px;
        overflow: hidden;
    }
    
    .course-progress-bar .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #10b981, #34d399);
        border-radius: 3px;
        transition: width 0.3s ease;
    }

    .overview-metric-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .overview-metric {
        background: #f8f9ff;
        border-radius: 0.75rem;
        padding: 1rem;
        border: 1px solid #e0e7ff;
    }

    .overview-metric span {
        font-size: 0.85rem;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .overview-metric strong {
        display: block;
        font-size: 1.4rem;
        margin: 0.35rem 0;
        color: #111827;
    }

    .overview-metric small {
        color: #9ca3af;
        font-size: 0.8rem;
    }

    .metric-bar {
        height: 8px;
        background: #e5e7eb;
        border-radius: 999px;
        overflow: hidden;
        margin-top: 0.4rem;
        position: relative;
    }

    .metric-bar.dual {
        display: flex;
    }

    .metric-bar-fill {
        height: 100%;
        background: #6366f1;
    }

    .metric-bar-fill.success {
        background: #22c55e;
    }

    .metric-bar-fill.muted {
        background: #d4d4d8;
    }

    .overview-chart-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 1.25rem;
    }

    .mini-chart-panel {
        border: 1px solid #e5e7eb;
        border-radius: 0.85rem;
        padding: 1rem;
        background: #fbfcff;
    }

    .mini-chart-header h4 {
        margin: 0;
        font-size: 1rem;
        font-weight: 600;
        color: #1f2937;
    }

    .mini-chart-header p {
        margin: 0.15rem 0 0 0;
        color: #6b7280;
        font-size: 0.85rem;
    }

    .section-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 1.5rem;
    }


    .activity-list {
        background: white;
        border-radius: 1rem;
        padding: 2rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border: 1px solid #e9ecef;
        width: 100%;
    }

    .activity-item {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        padding: 1.5rem 0;
        border-bottom: 1px solid #f8f9fa;
    }

    .activity-item:last-child {
        border-bottom: none;
    }

    .activity-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: #f8f9fa;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.4rem;
        flex-shrink: 0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .activity-icon.text-success {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
    }

    .activity-icon.text-info {
        background: linear-gradient(135deg, #17a2b8, #6f42c1);
        color: white;
    }

    .activity-icon.text-warning {
        background: linear-gradient(135deg, #ffc107, #fd7e14);
        color: white;
    }

    .activity-content h4.activity-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 0.5rem;
    }

    .activity-content .activity-description {
        color: #6c757d;
        margin-bottom: 0.5rem;
    }

    .activity-time {
        font-size: 0.85rem;
        color: #adb5bd;
    }

    /* Full width layout */
    .dashboard-header {
        width: 100%;
        padding: 0 1rem;
    }

    .stats-grid {
        padding: 0 1rem;
    }

    .recent-activity-section {
        padding: 0 1rem;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .school-dashboard-container {
            padding: 1rem;
        }

        .dashboard-header {
            flex-direction: column;
            gap: 1rem;
            padding: 0 1rem;
        }

        .welcome-section h1.dashboard-title {
            font-size: 2rem;
        }

        .stats-grid {
            grid-template-columns: 1fr;
            padding: 0 1rem;
        }
    }
    
    /* Ensure content has proper spacing */
    .school-dashboard-container {
        min-height: calc(100vh - 200px);
        padding-bottom: 2rem;
    }
    
    /* School Manager Main Content Area with Sidebar */
    .school-manager-main-content {
        position: fixed;
        top: 0;
        left: 280px;
        width: calc(100vw - 280px);
        height: 100vh;
        background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
        overflow-y: auto;
        z-index: 99;
        will-change: transform;
        backface-visibility: hidden;
        padding-top: 80px;
        margin-top: 0;
        padding-left: 0;
        padding-right: 0;
    }
    
    /* Mobile responsive for sidebar layout */
    @media (max-width: 768px) {
        .school-manager-main-content {
            position: relative;
            left: 0;
            width: 100vw;
            height: auto;
            min-height: 100vh;
            padding-top: 20px;
        }
    }


    /* Comprehensive Calendar Management Styles */
    .calendar-sessions-section {
        margin-top: 2rem;
        width: 100%;
        max-width: 100%;
    }
    
    .calendar-management-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding: 1.5rem;
        background: #ffffff;
        border-radius: 0.75rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        border: 1px solid #e2e8f0;
    }
    
    .calendar-header-left {
        flex: 1;
    }
    
    .calendar-section-title {
        font-size: 1.875rem;
        font-weight: 700;
        color: #1e293b;
        margin: 0 0 0.5rem 0;
    }
    
    .calendar-section-subtitle {
        font-size: 0.875rem;
        color: #64748b;
        margin: 0;
    }

    .calendar-header-actions {
        display: flex;
        gap: 1rem;
    }
    
    .btn-create-event,
    .btn-create-lecture {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: #ffffff;
        border: none;
        border-radius: 8px;
        padding: 0.625rem 1.25rem;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
    }
    
    .btn-create-event:hover,
    .btn-create-lecture:hover {
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }
    
    .btn-create-lecture {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);
    }
    
    .btn-create-lecture:hover {
        background: linear-gradient(135deg, #059669 0%, #047857 100%);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    
    .calendar-filters {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: #f8fafc;
        border-radius: 0.75rem;
        border: 1px solid #e2e8f0;
    }
    
    .filter-group {
        display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
    .filter-group label {
            font-size: 0.75rem;
        font-weight: 600;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .filter-group select {
        padding: 0.5rem 0.75rem;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 0.875rem;
        background: #ffffff;
        min-width: 150px;
    }

    /* Calendar Container */
    .calendar-container {
        background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
        border-radius: 1.25rem;
        padding: 2.25rem;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08), 0 2px 8px rgba(0, 0, 0, 0.04);
        border: 1px solid rgba(0, 0, 0, 0.08);
        position: relative;
        overflow: hidden;
    }
    
    .calendar-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 50%, #667eea 100%);
        background-size: 200% 100%;
        animation: shimmer 3s ease-in-out infinite;
    }
    
    @keyframes shimmer {
        0%, 100% { background-position: 0% 0%; }
        50% { background-position: 100% 0%; }
    }

    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.75rem;
        flex-wrap: wrap;
        gap: 1.5rem;
        padding-top: 0.25rem;
    }

    .calendar-title {
        font-size: 1.625rem;
        font-weight: 700;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin: 0;
        letter-spacing: -0.5px;
    }

    .calendar-navigation {
        display: flex;
        align-items: center;
        gap: 0.625rem;
        background: white;
        padding: 0.5rem 0.75rem;
        border-radius: 0.875rem;
        border: 1px solid #e9ecef;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .nav-btn {
        background: linear-gradient(145deg, #ffffff, #f8f9fa);
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        width: 2.25rem;
        height: 2.25rem;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 1.25rem;
        color: #495057;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .nav-btn:hover {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: transparent;
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .nav-btn:active {
        transform: scale(0.95);
    }

    .current-week {
        font-size: 1rem;
        font-weight: 600;
        color: #2c3e50;
        padding: 0 0.875rem;
        min-width: 170px;
        text-align: center;
        letter-spacing: 0.3px;
    }

    .today-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 0.625rem;
        padding: 0.5rem 1.25rem;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
        letter-spacing: 0.3px;
    }

    .today-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        background: linear-gradient(135deg, #5568d3 0%, #6339a0 100%);
    }

    .today-btn:active {
        transform: translateY(0);
        box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
    }

    .view-toggles {
        display: flex;
        gap: 0.375rem;
        background: #f1f3f5;
        padding: 0.3rem;
        border-radius: 0.75rem;
        border: 1px solid #e9ecef;
    }

    .view-toggle {
        background: transparent;
        border: none;
        border-radius: 0.5rem;
        padding: 0.5rem 1.125rem;
        font-size: 0.875rem;
        font-weight: 600;
        color: #6c757d;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
    }

    .view-toggle:hover {
        color: #495057;
        background: rgba(255, 255, 255, 0.6);
    }

    .view-toggle.active {
        background: white;
        color: #667eea;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08), 0 1px 3px rgba(0, 0, 0, 0.04);
    }

    /* Calendar Week View */
    .calendar-week-view {
        margin-bottom: 1.5rem;
    }

    .week-header {
        display: none;
    }
    
    .week-header .time-column {
        display: none;
    }

    .day-header {
        text-align: center;
        font-weight: 700;
        color: #495057;
        padding: 1rem 0.75rem;
        border-radius: 0.875rem;
        background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
        font-size: 0.9375rem;
        border: 1px solid #e9ecef;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        letter-spacing: 0.5px;
    }

    .day-header.selected {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: transparent;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        transform: translateY(-2px);
    }

    .week-events {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 0.75rem;
        min-height: 280px;
    }

    .calendar-day-column {
        display: flex;
        flex-direction: column;
        background: #ffffff;
        border-radius: 0.875rem;
        border: 1px solid #e9ecef;
        overflow: hidden;
        height: 400px;
        min-height: 400px;
        max-height: 400px;
    }
    
    .calendar-day-column.today {
        border-color: #667eea;
        box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
    }
    
    .day-column-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 1rem;
        text-align: center;
        border-bottom: 2px solid #e2e8f0;
    }
    
    .calendar-day-column.today .day-column-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #ffffff;
    }
    
    .day-name-abbr {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        color: #64748b;
        margin-bottom: 0.25rem;
        letter-spacing: 0.5px;
    }
    
    .calendar-day-column.today .day-name-abbr {
        color: rgba(255, 255, 255, 0.9);
    }
    
    .day-date-number {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1e293b;
        line-height: 1.2;
    }
    
    .calendar-day-column.today .day-date-number {
        color: #ffffff;
    }
    
    .day-events-container {
        flex: 1;
        padding: 0.5rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        overflow-y: auto;
        overflow-x: hidden;
        min-height: 0;
        max-height: calc(400px - 100px); /* Subtract header height */
    }
    
    .day-events-container::-webkit-scrollbar {
        width: 4px;
    }
    
    .day-events-container::-webkit-scrollbar-track {
        background: transparent;
        border-radius: 2px;
    }
    
    .day-events-container::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 2px;
        opacity: 0.5;
    }
    
    .day-events-container::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
        opacity: 0.7;
    }
    
    /* Firefox scrollbar */
    .day-events-container {
        scrollbar-width: thin;
        scrollbar-color: #cbd5e1 transparent;
    }

    .event-item {
        background: #ffffff;
        border-radius: 0.375rem;
        padding: 0.625rem 0.75rem;
        border-left: 3px solid;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        border: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    .event-item:hover {
        transform: translateY(-2px) scale(1.01);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1), 0 2px 6px rgba(0, 0, 0, 0.05);
        border-left-width: 4px;
        z-index: 10;
    }

    .event-item:active {
        transform: translateY(-1px) scale(1.005);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .event-item:last-child {
        margin-bottom: 0;
    }

    .event-time {
        font-size: 0.8125rem;
        font-weight: 700;
        color: #1a202c;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.375rem;
        letter-spacing: 0.3px;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .event-time::before {
        content: '●';
        font-size: 0.5rem;
        opacity: 0.7;
    }

    .event-title {
        font-size: 0.8125rem;
        font-weight: 600;
        color: #1f2937;
        line-height: 1.3;
        margin-bottom: 0.5rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        letter-spacing: -0.2px;
    }

    .event-type-badge {
        font-size: 0.625rem;
        font-weight: 700;
        text-transform: uppercase;
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        display: block;
        letter-spacing: 0.6px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.06);
        margin: 0.375rem auto 0;
        width: fit-content;
        text-align: center;
    }
    
    .event-teacher-name {
        font-size: 0.625rem;
        font-weight: 500;
        color: #64748b;
        margin-top: 0.25rem;
        padding-top: 0.125rem;
        width: 100%;
        text-align: center;
    }

    /* Modern color schemes for events */
    .event-blue { 
        border-left-color: #3b82f6;
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, #ffffff 100%);
    }
    .event-blue:hover {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, #ffffff 100%);
        border-left-color: #2563eb;
    }
    .event-blue .event-time::before {
        color: #3b82f6;
    }
    .event-blue .event-type-badge {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        color: #1e40af;
    }

    .event-green { 
        border-left-color: #10b981;
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, #ffffff 100%);
    }
    .event-green:hover {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.08) 0%, #ffffff 100%);
        border-left-color: #059669;
    }
    .event-green .event-time::before {
        color: #10b981;
    }
    .event-green .event-type-badge {
        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        color: #047857;
    }

    .event-purple { 
        border-left-color: #8b5cf6;
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.05) 0%, #ffffff 100%);
    }
    .event-purple:hover {
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.08) 0%, #ffffff 100%);
        border-left-color: #7c3aed;
    }
    .event-purple .event-time::before {
        color: #8b5cf6;
    }
    .event-purple .event-type-badge {
        background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%);
        color: #6d28d9;
    }

    .event-orange { 
        border-left-color: #f97316;
        background: linear-gradient(135deg, rgba(249, 115, 22, 0.05) 0%, #ffffff 100%);
    }
    .event-orange:hover {
        background: linear-gradient(135deg, rgba(249, 115, 22, 0.08) 0%, #ffffff 100%);
        border-left-color: #ea580c;
    }
    .event-orange .event-time::before {
        color: #f97316;
    }
    .event-orange .event-type-badge {
        background: linear-gradient(135deg, #ffedd5 0%, #fed7aa 100%);
        color: #9a3412;
    }

    .event-yellow { 
        border-left-color: #f59e0b;
        background: linear-gradient(135deg, rgba(245, 158, 11, 0.05) 0%, #ffffff 100%);
    }
    .event-yellow:hover {
        background: linear-gradient(135deg, rgba(245, 158, 11, 0.08) 0%, #ffffff 100%);
        border-left-color: #d97706;
    }
    .event-yellow .event-time::before {
        color: #f59e0b;
    }
    .event-yellow .event-type-badge {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        color: #92400e;
    }

    .event-red { 
        border-left-color: #ef4444;
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.05) 0%, #ffffff 100%);
    }
    .event-red:hover {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.08) 0%, #ffffff 100%);
        border-left-color: #dc2626;
    }
    .event-red .event-time::before {
        color: #ef4444;
    }
    .event-red .event-type-badge {
        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        color: #991b1b;
    }

    .event-pink { 
        border-left-color: #ec4899;
        background: linear-gradient(135deg, rgba(236, 72, 153, 0.05) 0%, #ffffff 100%);
    }
    .event-pink:hover {
        background: linear-gradient(135deg, rgba(236, 72, 153, 0.08) 0%, #ffffff 100%);
        border-left-color: #db2777;
    }
    .event-pink .event-time::before {
        color: #ec4899;
    }
    .event-pink .event-type-badge {
        background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);
        color: #9f1239;
    }

    .calendar-footer {
        text-align: right;
        margin-top: 1.5rem;
        padding-top: 1rem;
        border-top: 1px solid #e9ecef;
    }

    .view-full-schedule {
        color: #667eea;
        text-decoration: none;
        font-weight: 600;
        font-size: 0.875rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
    }

    .view-full-schedule:hover {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.08), rgba(118, 75, 162, 0.08));
        transform: translateX(4px);
        color: #764ba2;
    }
    
    .view-full-schedule::after {
        content: '→';
        transition: transform 0.3s ease;
    }
    
    .view-full-schedule:hover::after {
        transform: translateX(4px);
    }

    /* Calendar Month View */
    .calendar-month-view {
        margin-bottom: 1.5rem;
    }

    .month-calendar {
        width: 100%;
    }

    .month-header {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 8px;
        margin-bottom: 8px;
    }

    .month-day-name {
        text-align: center;
        font-weight: 600;
        color: #6c757d;
        padding: 12px 4px;
        font-size: 0.875rem;
        background: #f8f9fa;
        border-radius: 8px;
    }

    .month-days {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 8px;
    }

    .month-day {
        min-height: 80px;
        padding: 8px;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        background: white;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
    }

    .month-day:not(.empty):hover {
        border-color: #007bff;
        box-shadow: 0 2px 8px rgba(0, 123, 255, 0.15);
        transform: translateY(-2px);
    }

    .month-day.empty {
        background: #f8f9fa;
        cursor: default;
        border-color: transparent;
    }

    .month-day.today {
        background: linear-gradient(135deg, #e7f3ff, #cfe7ff);
        border-color: #007bff;
        font-weight: 600;
    }

    .day-number {
        font-size: 1rem;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 4px;
    }

    .event-dots {
        display: flex;
        gap: 3px;
        flex-wrap: wrap;
        margin-top: 4px;
    }

    .dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        display: inline-block;
    }

    .dot-blue { background-color: #007bff; }
    .dot-green { background-color: #28a745; }
    .dot-red { background-color: #dc3545; }
    .dot-yellow { background-color: #ffc107; }
    .dot-purple { background-color: #6f42c1; }
    .dot-orange { background-color: #fd7e14; }
    .dot-pink { background-color: #e83e8c; }

    /* Calendar List View */
    .calendar-list-view {
        margin-bottom: 1.5rem;
    }

    .event-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .list-event-item {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 16px;
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .list-event-item:hover {
        border-color: #007bff;
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.1);
        transform: translateY(-2px);
    }

    .list-event-date {
        flex-shrink: 0;
        width: 60px;
        text-align: center;
        padding: 8px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        border-radius: 8px;
        color: white;
    }

    .list-date-day {
        font-size: 1.5rem;
        font-weight: 700;
        line-height: 1;
    }

    .list-date-month {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        margin-top: 4px;
    }

    .list-event-content {
        flex: 1;
    }

    .list-event-title {
        font-size: 1rem;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 6px;
    }

    .list-event-meta {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        font-size: 0.875rem;
        color: #6c757d;
    }

    .list-event-arrow {
        font-size: 1.5rem;
        color: #007bff;
        font-weight: bold;
    }

    .badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .badge-blue { background: #e7f3ff; color: #007bff; }
    .badge-green { background: #d4edda; color: #28a745; }
    .badge-red { background: #f8d7da; color: #dc3545; }
    .badge-yellow { background: #fff3cd; color: #856404; }
    .badge-purple { background: #e7e3f7; color: #6f42c1; }
    .badge-orange { background: #ffe5d0; color: #fd7e14; }
    .badge-pink { background: #f7d6e6; color: #e83e8c; }

    /* Upcoming Sessions Container */
    .upcoming-sessions-container {
        background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
        border-radius: 1.25rem;
        padding: 2rem;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08), 0 2px 8px rgba(0, 0, 0, 0.04);
        border: 1px solid rgba(0, 0, 0, 0.08);
        position: relative;
        overflow: hidden;
    }
    
    .upcoming-sessions-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #10b981 0%, #3b82f6 50%, #10b981 100%);
        background-size: 200% 100%;
        animation: shimmer 3s ease-in-out infinite;
    }

    /* Fade indicator at bottom when more sessions are available */
    .upcoming-sessions-container::after {
        content: '';
        position: absolute;
        bottom: 80px;
        left: 2rem;
        right: 2rem;
        height: 80px;
        background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(248,249,250,0.98));
        pointer-events: none;
        border-radius: 0 0 1.25rem 1.25rem;
    }

    .sessions-header {
        margin-bottom: 1.5rem;
        padding-top: 0.5rem;
    }

    .sessions-title {
        font-size: 1.625rem;
        font-weight: 700;
        background: linear-gradient(135deg, #10b981 0%, #3b82f6 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin: 0;
        letter-spacing: -0.5px;
    }

    .sessions-list {
        display: flex;
        flex-direction: column;
        gap: 0.625rem;
        max-height: 420px;
        overflow-y: auto;
        overflow-x: hidden;
        padding-right: 0.5rem;
    }

    /* Custom scrollbar styling for sessions list */
    .sessions-list::-webkit-scrollbar {
        width: 8px;
    }

    .sessions-list::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    .sessions-list::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #667eea, #764ba2);
        border-radius: 10px;
    }

    .sessions-list::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, #5568d3, #6339a0);
    }

    .session-item {
        display: flex;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
        border-radius: 0.875rem;
        border: 1px solid #e9ecef;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
    }

    .session-item:hover {
        background: #ffffff;
        transform: translateY(-3px) translateX(2px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        border-color: rgba(102, 126, 234, 0.2);
    }

    .session-bar {
        width: 5px;
        border-radius: 3px;
        flex-shrink: 0;
        box-shadow: 0 0 6px rgba(0, 0, 0, 0.15);
    }

    .session-bar.session-blue { 
        background: linear-gradient(180deg, #3b82f6 0%, #2563eb 100%);
        box-shadow: 0 0 8px rgba(59, 130, 246, 0.3);
    }
    .session-bar.session-green { 
        background: linear-gradient(180deg, #10b981 0%, #059669 100%);
        box-shadow: 0 0 8px rgba(16, 185, 129, 0.3);
    }
    .session-bar.session-purple { 
        background: linear-gradient(180deg, #8b5cf6 0%, #7c3aed 100%);
        box-shadow: 0 0 8px rgba(139, 92, 246, 0.3);
    }
    .session-bar.session-orange { 
        background: linear-gradient(180deg, #f97316 0%, #ea580c 100%);
        box-shadow: 0 0 8px rgba(249, 115, 22, 0.3);
    }
    .session-bar.session-yellow { 
        background: linear-gradient(180deg, #f59e0b 0%, #d97706 100%);
        box-shadow: 0 0 8px rgba(245, 158, 11, 0.3);
    }
    .session-bar.session-red { 
        background: linear-gradient(180deg, #ef4444 0%, #dc2626 100%);
        box-shadow: 0 0 8px rgba(239, 68, 68, 0.3);
    }
    .session-bar.session-pink { 
        background: linear-gradient(180deg, #ec4899 0%, #db2777 100%);
        box-shadow: 0 0 8px rgba(236, 72, 153, 0.3);
    }

    .session-content {
        flex: 1;
    }

    .session-title {
        font-size: 0.875rem;
        font-weight: 600;
        color: #2c3e50;
        margin: 0 0 0.3rem 0;
        line-height: 1.25;
    }

    .session-details {
        display: flex;
        flex-wrap: wrap;
        gap: 0.375rem;
        margin-bottom: 0.3rem;
        font-size: 0.6875rem;
        color: #6c757d;
    }

    .session-details span {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .session-details span::before {
        content: "•";
        color: #adb5bd;
        font-weight: bold;
    }

    .session-details span:first-child::before {
        display: none;
    }

    .session-enrollment {
        font-size: 0.6875rem;
        color: #28a745;
        font-weight: 500;
        margin-bottom: 0.3rem;
    }

    .session-link {
        color: #007bff;
        text-decoration: none;
        font-size: 0.6875rem;
        font-weight: 500;
    }

    .session-link:hover {
        text-decoration: underline;
    }

    .sessions-footer {
        text-align: right;
        margin-top: 1.5rem;
        position: relative;
        z-index: 2;
        background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
        padding-top: 1rem;
        border-top: 1px solid #e9ecef;
    }

    /* Mobile Responsive for Calendar and Sessions */
    @media (max-width: 1024px) {
        .calendar-sessions-grid {
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
        
        .calendar-header {
            flex-direction: column;
            align-items: stretch;
            gap: 1rem;
        }
        
        .calendar-navigation {
            justify-content: center;
        }
        
        .view-toggles {
            justify-content: center;
        }
    }

    @media (max-width: 768px) {
        .calendar-container,
        .upcoming-sessions-container {
            padding: 1.5rem;
        }
        
        .week-header,
        .week-events {
            grid-template-columns: repeat(7, 1fr);
            gap: 0.25rem;
        }
        
        .day-header {
            font-size: 0.75rem;
            padding: 0.5rem 0.25rem;
        }
        
        .day-events {
            min-height: 80px;
            padding: 0.25rem;
        }
        
        .event-item {
            padding: 0.625rem 0.75rem;
            margin-bottom: 0.5rem;
            border-left-width: 3px;
        }
        
        .event-item:hover {
            transform: translateY(-2px) scale(1.01);
            border-left-width: 4px;
        }
        
        .event-time {
            font-size: 0.7rem;
            margin-bottom: 0.375rem;
        }
        
        .event-title {
            font-size: 0.75rem;
            margin-bottom: 0.5rem;
        }
        
        .event-type-badge {
            font-size: 0.625rem;
            padding: 0.25rem 0.5rem;
        }
        
        .calendar-title,
        .sessions-title {
            font-size: 1.25rem;
        }
        
        .calendar-navigation {
            padding: 0.375rem 0.5rem;
        }
        
        .nav-btn {
            width: 2rem;
            height: 2rem;
            font-size: 1.1rem;
        }
        
        .current-week {
            font-size: 0.875rem;
            min-width: 140px;
        }
        
        .event-title {
            font-size: 0.8rem;
        }
        
        .session-item {
            padding: 0.5rem 0.75rem;
            gap: 0.5rem;
        }
        
        .session-title {
            font-size: 0.8125rem;
            margin-bottom: 0.25rem;
        }
        
        .session-details {
            flex-direction: column;
            gap: 0.25rem;
            margin-bottom: 0.25rem;
            font-size: 0.65rem;
        }
        
        .session-enrollment {
            font-size: 0.65rem;
            margin-bottom: 0.25rem;
        }
        
        .session-link {
            font-size: 0.65rem;
        }
    }
    
    /* New Calendar System Styles */
    .week-header {
        display: grid;
        grid-template-columns: 80px repeat(7, 1fr);
        gap: 0.5rem;
        margin-bottom: 0.5rem;
        font-weight: 600;
    }
    
    .time-column {
        padding: 0.75rem;
        text-align: center;
        color: #64748b;
    }
    
    .week-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 0.75rem;
        min-height: 400px;
    }
    
    .no-events {
        text-align: center;
        color: #94a3b8;
        font-size: 0.875rem;
        padding: 2rem 1rem;
        font-style: italic;
    }
    
    .day-timeline {
        padding: 1rem;
    }
    
    .day-events-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .day-event-item {
        background: #ffffff;
        border-left: 3px solid;
        border-radius: 6px;
        padding: 0.625rem 0.875rem;
        cursor: pointer;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.75rem;
    }
    
    .day-event-item:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
        transform: translateY(-1px);
    }
    
    .day-event-item .event-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }
    
    .day-event-item .event-title {
        font-weight: 600;
        color: #2c3e50;
        font-size: 0.875rem;
        line-height: 1.3;
    }
    
    .day-event-item .event-time {
        font-size: 0.75rem;
        color: #64748b;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.375rem;
    }
    
    .day-event-item .event-time::before {
        content: '🕐';
        font-size: 0.75rem;
    }
    
    .day-event-item .event-type-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        font-size: 0.6875rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        white-space: nowrap;
    }
    
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: transparent;
        display: flex;
        align-items: flex-start;
        justify-content: center;
        z-index: 10000;
        padding: 20px;
        padding-top:3500px;
        backdrop-filter: none;
    }
    
    .modal-content {
        background: #ffffff;
        border-radius: 1rem;
        padding:2rem;
        max-width: 600px;
        width: 100%;
        max-height: calc(90vh - 80px);
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        margin-top: 0;
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #e2e8f0;
    }
    
    .modal-header h3 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 700;
        color: #1e293b;
    }
    
    .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: #64748b;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
    }
    
    .modal-close:hover {
        background: #f1f5f9;
        color: #1e293b;
    }
    
    .form-group {
        margin-bottom: 1.25rem;
    }
    
    .form-group label {
        display: block;
        font-size: 0.875rem;
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.5rem;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 0.625rem 0.75rem;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 0.875rem;
        background: #ffffff;
        box-sizing: border-box;
    }
    
    .form-group textarea {
        resize: vertical;
        min-height: 80px;
    }
    
    .form-group select[multiple] {
        min-height: 120px;
    }
    
    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }
    
    .days-checkboxes {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
    }
    
    .days-checkboxes label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 400;
        cursor: pointer;
    }
    
    /* Ensure event weekly days checkboxes are regular checkboxes, not toggle switches */
    /* Remove any toggle switch styling from any parent or global CSS */
    #eventWeeklyDayGroup input[type="checkbox"],
    .event-weekly-days input[type="checkbox"],
    #eventWeeklyDayGroup .event-weekly-days input[type="checkbox"] {
        appearance: checkbox !important;
        -webkit-appearance: checkbox !important;
        -moz-appearance: checkbox !important;
        width: 18px !important;
        height: 18px !important;
        min-width: 18px !important;
        min-height: 18px !important;
        max-width: 18px !important;
        max-height: 18px !important;
        margin: 0 !important;
        padding: 0 !important;
        cursor: pointer !important;
        border: 1px solid #d1d5db !important;
        border-radius: 3px !important;
        background-color: #ffffff !important;
        position: relative !important;
        flex-shrink: 0 !important;
        display: inline-block !important;
        vertical-align: middle !important;
        box-sizing: border-box !important;
        /* Remove any toggle switch styling */
        opacity: 1 !important;
        clip: unset !important;
        clip-path: none !important;
        transform: none !important;
        transition: none !important;
    }
    
    /* Remove any ::before and ::after pseudo-elements that might create toggle switches */
    #eventWeeklyDayGroup input[type="checkbox"]::before,
    #eventWeeklyDayGroup input[type="checkbox"]::after,
    .event-weekly-days input[type="checkbox"]::before,
    .event-weekly-days input[type="checkbox"]::after,
    #eventWeeklyDayGroup .event-weekly-days input[type="checkbox"]::before,
    #eventWeeklyDayGroup .event-weekly-days input[type="checkbox"]::after {
        display: none !important;
        content: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        width: 0 !important;
        height: 0 !important;
        margin: 0 !important;
        padding: 0 !important;
        border: none !important;
        background: none !important;
    }
    
    #eventWeeklyDayGroup input[type="checkbox"]:checked,
    .event-weekly-days input[type="checkbox"]:checked,
    #eventWeeklyDayGroup .event-weekly-days input[type="checkbox"]:checked {
        background-color: #3b82f6 !important;
        border-color: #3b82f6 !important;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='none' stroke='%23ffffff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' d='M2 6l3 3 5-6'/%3E%3C/svg%3E") !important;
        background-repeat: no-repeat !important;
        background-position: center !important;
        background-size: 12px 12px !important;
    }
    
    #eventWeeklyDayGroup input[type="checkbox"]:focus,
    .event-weekly-days input[type="checkbox"]:focus,
    #eventWeeklyDayGroup .event-weekly-days input[type="checkbox"]:focus {
        outline: 2px solid #3b82f6 !important;
        outline-offset: 2px !important;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2) !important;
    }
    
    #eventWeeklyDayGroup label,
    .event-weekly-days label,
    #eventWeeklyDayGroup .event-weekly-days label {
        display: flex !important;
        align-items: center !important;
        gap: 0.5rem !important;
        cursor: pointer !important;
        margin: 0 !important;
        padding: 0 !important;
        position: relative !important;
    }
    
    /* Remove any toggle switch wrapper styling */
    #eventWeeklyDayGroup label::before,
    #eventWeeklyDayGroup label::after,
    .event-weekly-days label::before,
    .event-weekly-days label::after {
        display: none !important;
        content: none !important;
    }
    
    #eventWeeklyDayGroup label span,
    .event-weekly-days label span {
        user-select: none;
        display: inline-block;
    }
    
    /* Ensure no duplicate checkboxes are created */
    #eventWeeklyDayGroup input[type="checkbox"] + input[type="checkbox"],
    .event-weekly-days input[type="checkbox"] + input[type="checkbox"] {
        display: none !important;
    }
    
    /* Additional classes for extra specificity */
    .weekday-checkbox-input,
    .weekday-checkbox-label .weekday-checkbox-input,
    #eventWeeklyDayGroup .weekday-checkbox-input {
        appearance: checkbox !important;
        -webkit-appearance: checkbox !important;
        -moz-appearance: checkbox !important;
        width: 18px !important;
        height: 18px !important;
        min-width: 18px !important;
        min-height: 18px !important;
        max-width: 18px !important;
        max-height: 18px !important;
        margin: 0 !important;
        padding: 0 !important;
        border: 1px solid #d1d5db !important;
        border-radius: 3px !important;
        background-color: #ffffff !important;
        cursor: pointer !important;
        display: inline-block !important;
        vertical-align: middle !important;
        box-sizing: border-box !important;
        position: relative !important;
        flex-shrink: 0 !important;
    }
    
    .weekday-checkbox-input::before,
    .weekday-checkbox-input::after,
    .weekday-checkbox-label::before,
    .weekday-checkbox-label::after {
        display: none !important;
        content: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        width: 0 !important;
        height: 0 !important;
    }
    
    .weekday-checkbox-input:checked {
        background-color: #3b82f6 !important;
        border-color: #3b82f6 !important;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='none' stroke='%23ffffff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' d='M2 6l3 3 5-6'/%3E%3C/svg%3E") !important;
        background-repeat: no-repeat !important;
        background-position: center !important;
        background-size: 12px 12px !important;
    }
    
    .weekday-checkbox-label {
        display: flex !important;
        align-items: center !important;
        gap: 0.5rem !important;
        cursor: pointer !important;
        margin: 0 !important;
        padding: 0 !important;
    }
    
    .form-actions {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid #e2e8f0;
    }
    
    .btn-save,
    .btn-cancel,
    .btn-edit,
    .btn-delete {
        padding: 0.625rem 1.25rem;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        border: none;
        flex: 1;
    }
    
    .btn-save {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: #ffffff;
    }
    
    .btn-save:hover {
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
    }
    
    .btn-cancel {
        background: #f1f5f9;
        color: #64748b;
    }
    
    .btn-cancel:hover {
        background: #e2e8f0;
    }
    
    .btn-edit {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: #ffffff;
    }
    
    .btn-delete {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: #ffffff;
    }
    
    .btn-more {
        background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        color: #ffffff;
        padding: 0.625rem 1.25rem;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        border: none;
        display: inline-flex;
        align-items: center;
        transition: all 0.2s ease;
    }
    
    .btn-more:hover {
        background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(99, 102, 241, 0.3);
    }
    
    .more-actions-wrapper {
        position: relative;
        display: inline-block;
    }
    
    .more-menu-dropdown {
        position: absolute;
        bottom: 100%;
        left: 0;
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        min-width: 200px;
        margin-bottom: 5px;
        overflow: hidden;
        display: none;
        opacity: 0;
        transform: translateY(5px);
        transition: opacity 0.2s ease, transform 0.2s ease;
    }
    
    .more-menu-dropdown.show {
        display: block;
        opacity: 1;
        transform: translateY(0);
    }
    
    .more-menu-item {
        width: 100%;
        text-align: left;
        padding: 12px 16px;
        border: none;
        background: white;
        cursor: pointer;
        font-size: 0.875rem;
        color: #334155;
        transition: background-color 0.2s ease;
        display: block;
    }
    
    .more-menu-item:first-child {
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
    }
    
    .more-menu-item:last-child {
        border-bottom-left-radius: 8px;
        border-bottom-right-radius: 8px;
    }
    
    .more-menu-item:hover {
        background: #f1f5f9;
        color: #1e293b;
    }
    
    .more-menu-item:not(:last-child) {
        border-bottom: 1px solid #e2e8f0;
    }
    
    .more-menu-divider {
        height: 1px;
        background: #e2e8f0;
        margin: 4px 0;
    }
    
    .event-detail-item {
        margin-bottom: 1rem;
        padding: 0.75rem;
        background: #f8fafc;
        border-radius: 6px;
    }
    
    .event-detail-item strong {
        color: #374151;
        margin-right: 0.5rem;
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<!-- Chart Data as JSON Script Tags - SIMPLIFIED WITHOUT CONDITIONALS -->
<script type="application/json" id="grade-distribution-data">{{{ grade_distribution_json }}}</script>
<script type="application/json" id="login-trend-data">{{{ login_trend_json }}}</script>
<script type="application/json" id="assessment-summary-data">{{{ assessment_summary_json }}}</script>
<script type="application/json" id="course-completion-data">{{{ course_completion_json }}}</script>
<script type="application/json" id="school-overview-data">{{{ school_overview_json }}}</script>
<script type="application/json" id="role-distribution-data">{{{ role_distribution_json }}}</script>
<!-- Calendar Form Data as JSON Script Tags - SAME TECHNIQUE AS GRADE DISTRIBUTION -->
<!-- DEBUG: Calendar Data Counts - Teachers: {{calendar_teachers_count}}, Students: {{calendar_students_count}}, Cohorts: {{calendar_cohorts_count}}, Courses: {{calendar_courses_count}} -->
<script type="application/json" id="calendar-teachers-data">{{{ calendar_teachers_json }}}</script>
<script type="application/json" id="calendar-students-data">{{{ calendar_students_json }}}</script>
<script type="application/json" id="calendar-cohorts-data">{{{ calendar_cohorts_json }}}</script>
<script type="application/json" id="calendar-courses-data">{{{ calendar_courses_json }}}</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    if (typeof Chart === 'undefined') {
        console.warn('Chart.js not loaded');
        return;
    }

    // Parse chart data with error handling - using JSON.parse from script tags
    let gradeDistributionData, loginTrendData, assessmentSummaryData, courseCompletionData, schoolOverviewData, roleDistributionData;
    
    try {
        const gradeDistEl = document.getElementById('grade-distribution-data');
        const gradeDistText = gradeDistEl ? gradeDistEl.textContent.trim() : '{"labels": [], "values": [], "total": 0}';
        console.log('=== GRADE DISTRIBUTION DEBUG ===');
        console.log('Element exists:', !!gradeDistEl);
        console.log('Raw JSON text:', gradeDistText);
        gradeDistributionData = JSON.parse(gradeDistText);
        console.log('Parsed Data:', gradeDistributionData);
        console.log('Labels count:', gradeDistributionData.labels ? gradeDistributionData.labels.length : 0);
        console.log('Values count:', gradeDistributionData.values ? gradeDistributionData.values.length : 0);
        console.log('Total:', gradeDistributionData.total);
        console.log('=================================');
    } catch(e) {
        console.error('Error parsing grade distribution data:', e);
        console.error('Error details:', e.message);
        gradeDistributionData = {"labels": [], "values": [], "total": 0};
    }
    
    try {
        const loginTrendEl = document.getElementById('login-trend-data');
        const loginTrendText = loginTrendEl ? loginTrendEl.textContent.trim() : '{"dates": [], "student": [], "teacher": [], "total_student_logins": 0, "total_teacher_logins": 0, "average_daily_logins": 0}';
        loginTrendData = JSON.parse(loginTrendText);
        console.log('Login Trend Data:', loginTrendData);
    } catch(e) {
        console.error('Error parsing login trend data:', e);
        loginTrendData = {"dates": [], "student": [], "teacher": [], "total_student_logins": 0, "total_teacher_logins": 0, "average_daily_logins": 0};
    }
    
    try {
        const assessmentEl = document.getElementById('assessment-summary-data');
        const assessmentText = assessmentEl ? assessmentEl.textContent.trim() : '{"assignments": {"total":0,"graded":0,"submitted":0}, "quizzes": {"total":0,"attempts":0,"completed":0}}';
        assessmentSummaryData = JSON.parse(assessmentText);
        console.log('Assessment Summary Data:', assessmentSummaryData);
    } catch(e) {
        console.error('Error parsing assessment summary data:', e);
        assessmentSummaryData = {"assignments": {"total":0,"graded":0,"submitted":0}, "quizzes": {"total":0,"attempts":0,"completed":0}};
    }
    
    try {
        const completionEl = document.getElementById('course-completion-data');
        const completionText = completionEl ? completionEl.textContent.trim() : '{"total":0,"completed":0,"inprogress":0,"completion_rate":0}';
        courseCompletionData = JSON.parse(completionText);
        console.log('=== COURSE COMPLETION DEBUG ===');
        console.log('Course Completion Data:', courseCompletionData);
        console.log('Total enrollments:', courseCompletionData.total);
        console.log('✅ Completed:', courseCompletionData.completed);
        console.log('⏳ In progress:', courseCompletionData.inprogress);
        console.log('⏸️ Not started:', courseCompletionData.notstarted);
        console.log('Completion rate:', courseCompletionData.completion_rate + '%');
        console.log('Has course list:', courseCompletionData.has_courses);
        console.log('Course count:', courseCompletionData.course_list ? courseCompletionData.course_list.length : 0);
        console.log('================================');
    } catch(e) {
        console.error('Error parsing course completion data:', e);
        courseCompletionData = {"total":0,"completed":0,"inprogress":0,"completion_rate":0};
    }
    
    try {
        const overviewEl = document.getElementById('school-overview-data');
        const overviewText = overviewEl ? overviewEl.textContent.trim() : '{"growth_report":{"labels":[],"values":[]}, "login_access":{"labels":[],"values":[]}, "active_users":{"active_percent":0,"inactive_percent":0,"active":0,"inactive":0},"enrollment_summary":{"total":0,"new":0},"overall_academic":{"avg_grade":0,"pass_rate":0}}';
        schoolOverviewData = JSON.parse(overviewText);
        console.log('=== SCHOOL OVERVIEW DEBUG ===');
        console.log('School Overview Data:', schoolOverviewData);
        console.log('📊 Average Grade:', schoolOverviewData.overall_academic.avg_grade + '%');
        console.log('📈 Pass Rate:', schoolOverviewData.overall_academic.pass_rate + '%');
        console.log('👥 Total Enrollments:', schoolOverviewData.enrollment_summary.total);
        console.log('🆕 New This Month:', schoolOverviewData.enrollment_summary.new);
        console.log('✅ Active Users:', schoolOverviewData.active_users.active, '(' + schoolOverviewData.active_users.active_percent + '%)');
        console.log('❌ Inactive Users:', schoolOverviewData.active_users.inactive, '(' + schoolOverviewData.active_users.inactive_percent + '%)');
        console.log('📅 Growth Report Months:', schoolOverviewData.growth_report.labels.length);
        console.log('📊 Login Access Active:', schoolOverviewData.login_access.active_values);
        console.log('📊 Login Access Inactive:', schoolOverviewData.login_access.inactive_values);
        console.log('================================');
    } catch(e) {
        console.error('Error parsing school overview data:', e);
        schoolOverviewData = {"growth_report":{"labels":[],"values":[]}, "login_access":{"labels":[],"values":[]}, "active_users":{"active_percent":0,"inactive_percent":0,"active":0,"inactive":0},"enrollment_summary":{"total":0,"new":0},"overall_academic":{"avg_grade":0,"pass_rate":0}};
    }
    
    try {
        const roleDistEl = document.getElementById('role-distribution-data');
        const roleDistText = roleDistEl ? roleDistEl.textContent.trim() : '{"labels": [], "values": []}';
        roleDistributionData = JSON.parse(roleDistText);
        console.log('Role Distribution Data:', roleDistributionData);
    } catch(e) {
        console.error('Error parsing role distribution data:', e);
        roleDistributionData = {"labels": [], "values": []};
    }

    const palette = ['#6366F1', '#EC4899', '#22C55E', '#F97316', '#0EA5E9', '#FACC15'];

    const noDataPlugin = {
        id: 'emptyState',
        afterDraw(chart, args, opts) {
            const hasData = chart.data.datasets.some(ds => Array.isArray(ds.data) && ds.data.some(val => Number(val) > 0));
            if (hasData) {
                return;
            }
            const { ctx, chartArea: { left, top, width, height } } = chart;
            ctx.save();
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.font = '500 14px "Inter", sans-serif';
            ctx.fillStyle = '#cbd5f5';
            ctx.fillText(opts && opts.text ? opts.text : 'No data available yet', left + width / 2, top + height / 2);
            ctx.restore();
        }
    };

    Chart.register(noDataPlugin);

    function createChart(ctx, config) {
        if (!ctx) {
            return null;
        }
        if (!config.plugins) {
            config.plugins = {};
        }
        config.plugins.emptyState = { text: 'No data available yet' };
        return new Chart(ctx, config);
    }

    // OPTIMIZATION: Function to initialize all charts (called immediately or after AJAX)
    function initializeAllCharts(chartData) {
        // Update data variables if provided via AJAX
        if (chartData) {
            if (chartData.grade_distribution) gradeDistributionData = chartData.grade_distribution;
            if (chartData.login_trend) loginTrendData = chartData.login_trend;
            if (chartData.assessment_summary) assessmentSummaryData = chartData.assessment_summary;
            if (chartData.course_completion) courseCompletionData = chartData.course_completion;
            if (chartData.school_overview) schoolOverviewData = chartData.school_overview;
            if (chartData.role_distribution) roleDistributionData = chartData.role_distribution;
    }

    // Grade distribution bar chart
    createChart(document.getElementById('gradeDistributionChart'), {
        type: 'bar',
        data: {
            labels: gradeDistributionData.labels || [],
            datasets: [{
                label: 'Learners',
                data: gradeDistributionData.values || [],
                backgroundColor: gradeDistributionData.labels ? gradeDistributionData.labels.map((_, idx) => palette[idx % palette.length]) : palette
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true, grid: { color: '#e5e7eb' } },
                x: { grid: { display: false } }
            }
        }
    });

    // Login trend line chart
    // Format dates for display (e.g., "Nov 3", "Nov 8")
    const formattedDates = (loginTrendData.dates || []).map(dateStr => {
        if (!dateStr) return '';
        const date = new Date(dateStr + 'T00:00:00');
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        return monthNames[date.getMonth()] + ' ' + date.getDate();
    });
    
    createChart(document.getElementById('loginTrendChart'), {
        type: 'line',
        data: {
            labels: formattedDates,
            datasets: [
                {
                    label: 'Student Logins',
                    data: loginTrendData.student || [],
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.2)',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 3,
                    pointHoverRadius: 5
                },
                {
                    label: 'Teacher Logins',
                    data: loginTrendData.teacher || [],
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.2)',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 3,
                    pointHoverRadius: 5
                }
            ]
        },
        options: {
            responsive: true,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: { 
                    display: true, 
                    position: 'bottom',
                    labels: {
                        usePointStyle: true,
                        padding: 15,
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: {
                        size: 14,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 13
                    },
                    callbacks: {
                        title: function(context) {
                            const index = context[0].dataIndex;
                            const dateStr = loginTrendData.dates[index];
                            if (dateStr) {
                                const date = new Date(dateStr + 'T00:00:00');
                                const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                                return dayNames[date.getDay()] + ', ' + monthNames[date.getMonth()] + ' ' + date.getDate() + ', ' + date.getFullYear();
                            }
                            return formattedDates[index] || '';
                        },
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y + ' logins';
                        }
                    }
                }
            },
            scales: {
                y: { 
                    beginAtZero: true, 
                    grid: { color: '#e5e7eb' },
                    ticks: {
                        stepSize: 1,
                        precision: 0
                    }
                },
                x: { 
                    grid: { display: false },
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45,
                        font: {
                            size: 11
                        }
                    }
                }
            }
        }
    });

    // Assessment summary stacked bar
    const assignments = (assessmentSummaryData && assessmentSummaryData.assignments) || {total:0, graded:0};
    const quizzes = (assessmentSummaryData && assessmentSummaryData.quizzes) || {total:0, completed:0};
    const assignmentCompleted = assignments.graded || 0;
    const quizCompleted = quizzes.completed || 0;
    const assignmentPending = Math.max((assignments.total || 0) - assignmentCompleted, 0);
    const quizPending = Math.max((quizzes.total || 0) - quizCompleted, 0);

    createChart(document.getElementById('assessmentSummaryChart'), {
        type: 'bar',
        data: {
            labels: ['Assignments', 'Quizzes'],
            datasets: [
                {
                    label: 'Completed / Graded',
                    data: [assignmentCompleted, quizCompleted],
                    backgroundColor: '#22c55e',
                    stack: 'stack1'
                },
                {
                    label: 'Remaining',
                    data: [assignmentPending, quizPending],
                    backgroundColor: '#f87171',
                    stack: 'stack1'
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'bottom' }
            },
            scales: {
                x: { stacked: true, grid: { display: false } },
                y: { stacked: true, beginAtZero: true, grid: { color: '#e5e7eb' } }
            }
        }
    });

    // Course completion doughnut - 3 segments (Completed, In Progress, Not Started)
    const completionTotal = (courseCompletionData.completed || 0) + (courseCompletionData.inprogress || 0) + (courseCompletionData.notstarted || 0);
    createChart(document.getElementById('courseCompletionChart'), {
        type: 'doughnut',
        data: {
            labels: ['Completed', 'In Progress', 'Not Started'],
            datasets: [{
                data: [
                    courseCompletionData.completed || 0,
                    courseCompletionData.inprogress || 0,
                    courseCompletionData.notstarted || 0
                ],
                backgroundColor: ['#10b981', '#fbbf24', '#ef4444'],
                borderWidth: 3,
                borderColor: '#ffffff',
                hoverOffset: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            cutout: '60%',
            plugins: {
                legend: { 
                    position: 'bottom',
                    labels: {
                        usePointStyle: true,
                        padding: 12,
                        font: {
                            size: 11,
                            weight: '500'
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.85)',
                    padding: 14,
                    titleFont: {
                        size: 14,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 13
                    },
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const percentage = completionTotal > 0 ? ((value / completionTotal) * 100).toFixed(1) : 0;
                            return label + ': ' + value + ' (' + percentage + '%)';
                        }
                    }
                }
            }
        }
    });

    // School growth chart (6-month enrollment trend)
    const growthData = schoolOverviewData.growth_report || {labels: [], values: []};
    createChart(document.getElementById('growthTrendChart'), {
        type: 'bar',
        data: {
            labels: growthData.labels || [],
            datasets: [{
                label: 'New Enrollments',
                data: growthData.values || [],
                backgroundColor: '#6366f1',
                borderRadius: 6,
                hoverBackgroundColor: '#4f46e5'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: { size: 13, weight: 'bold' },
                    bodyFont: { size: 12 },
                    callbacks: {
                        title: function(context) {
                            return context[0].label + ' 2025';
                        },
                        label: function(context) {
                            return 'New Enrollments: ' + context.parsed.y;
                        }
                    }
                }
            },
            scales: {
                y: { 
                    beginAtZero: true, 
                    grid: { color: '#e5e7eb' },
                    ticks: { precision: 0, font: { size: 10 } }
                },
                x: { 
                    grid: { display: false },
                    ticks: { font: { size: 10, weight: '500' } }
                }
            }
        }
    });

    // Login access report (horizontal bar chart)
    const loginAccessData = schoolOverviewData.login_access || {labels: ['Students', 'Teachers', 'Parents'], active_values: [0, 0, 0], inactive_values: [0, 0, 0]};
    createChart(document.getElementById('loginAccessChart'), {
        type: 'bar',
        data: {
            labels: loginAccessData.labels || ['Students', 'Teachers', 'Parents'],
            datasets: [
                {
                    label: 'Active',
                    data: loginAccessData.active_values || [0, 0, 0],
                    backgroundColor: '#10b981',
                    borderRadius: 6,
                    barThickness: 20
                },
                {
                    label: 'Inactive',
                    data: loginAccessData.inactive_values || [0, 0, 0],
                    backgroundColor: '#ef4444',
                    borderRadius: 6,
                    barThickness: 20
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            indexAxis: 'y',
            plugins: {
                legend: { 
                    display: true,
                    position: 'top',
                    align: 'end',
                    labels: {
                        boxWidth: 12,
                        boxHeight: 12,
                        padding: 10,
                        font: { size: 11, weight: '500' },
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: { size: 13, weight: 'bold' },
                    bodyFont: { size: 12 },
                    callbacks: {
                        label: function(context) {
                            const label = context.dataset.label || '';
                            const value = context.parsed.x || 0;
                            return label + ': ' + value + ' users';
                        }
                    }
                }
            },
            scales: {
                x: { 
                    beginAtZero: true, 
                    grid: { color: '#e5e7eb' },
                    ticks: { precision: 0, font: { size: 10 } },
                    stacked: false
                },
                y: { 
                    grid: { display: false },
                    ticks: { font: { size: 11, weight: '500' } },
                    stacked: false
                }
            }
        }
    });

    // Role distribution doughnut
    console.log('=== ROLE DISTRIBUTION DEBUG ===');
    console.log('Role Distribution Data:', roleDistributionData);
    console.log('👥 Students:', roleDistributionData.students);
    console.log('👨‍🏫 Teachers:', roleDistributionData.teachers);
    console.log('👪 Parents:', roleDistributionData.parents);
    console.log('🏢 Managers:', roleDistributionData.managers);
    console.log('📊 Total Users:', roleDistributionData.total);
    console.log('================================');
    
    const roleDistTotal = roleDistributionData.total || 0;
    createChart(document.getElementById('roleDistributionChart'), {
        type: 'doughnut',
        data: {
            labels: roleDistributionData.labels || ['Students', 'Teachers', 'Parents', 'Managers'],
            datasets: [{
                data: roleDistributionData.values || [0, 0, 0, 0],
                backgroundColor: ['#3b82f6', '#34d399', '#ec4899', '#f97316'],
                borderWidth: 3,
                borderColor: '#ffffff',
                hoverOffset: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            cutout: '58%',
            plugins: {
                legend: { 
                    position: 'bottom',
                    labels: {
                        usePointStyle: true,
                        padding: 12,
                        font: {
                            size: 11,
                            weight: '500'
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.85)',
                    padding: 14,
                    titleFont: {
                        size: 14,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 13
                    },
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const percentage = roleDistTotal > 0 ? ((value / roleDistTotal) * 100).toFixed(1) : 0;
                            return label + ': ' + value + ' (' + percentage + '%)';
                        }
                    }
                }
            }
        }
    });
    } // End initializeAllCharts function

    // OPTIMIZATION: Lazy load charts if enabled
    const lazyLoadCharts = {{#lazy_load_charts}}{{lazy_load_charts}}{{/lazy_load_charts}}{{^lazy_load_charts}}false{{/lazy_load_charts}};
    
    if (lazyLoadCharts) {
        // Show loading states for charts
        const chartContainers = document.querySelectorAll('.chart-card canvas');
        chartContainers.forEach(canvas => {
            const container = canvas.closest('.chart-card');
            if (container) {
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'chart-loading';
                loadingDiv.innerHTML = '<div class="loading-spinner"></div><p>Loading chart data...</p>';
                loadingDiv.style.cssText = 'display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 220px; color: #6b7280;';
                canvas.style.display = 'none';
                container.appendChild(loadingDiv);
            }
        });

        // Load chart data via AJAX
        fetch('{{{config.wwwroot}}}/theme/remui_kids/school_manager_dashboard.php?action=get_chart_data&sesskey={{sesskey}}')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success' && data.data) {
                    // Remove loading states
                    document.querySelectorAll('.chart-loading').forEach(el => el.remove());
                    document.querySelectorAll('.chart-card canvas').forEach(canvas => canvas.style.display = '');
                    
                    // Initialize charts with loaded data
                    initializeAllCharts(data.data);
                } else {
                    console.error('Error loading chart data:', data.message);
                    // Fallback: initialize with empty data
                    initializeAllCharts();
                }
            })
            .catch(error => {
                console.error('Error fetching chart data:', error);
                // Fallback: initialize with empty data
                document.querySelectorAll('.chart-loading').forEach(el => el.remove());
                document.querySelectorAll('.chart-card canvas').forEach(canvas => canvas.style.display = '');
                initializeAllCharts();
            });
    } else {
        // Initialize charts immediately with available data
        initializeAllCharts();
    }
});

// Ensure all label elements on the dashboard are associated with a real form field
document.addEventListener('DOMContentLoaded', function() {
    const interactiveTags = ['INPUT', 'SELECT', 'TEXTAREA'];
    const autoLabels = document.querySelectorAll('label');

    autoLabels.forEach(function(label, index) {
        // Skip labels already linked to a control or wrapping their own input
        if (label.htmlFor || label.querySelector('input, select, textarea')) {
            return;
        }

        // Try to associate the label with the next form control sibling
        let candidate = label.nextElementSibling;
        while (candidate && !interactiveTags.includes(candidate.tagName)) {
            candidate = candidate.nextElementSibling;
        }

        if (candidate) {
            if (!candidate.id) {
                candidate.id = 'auto-label-field-' + index;
            }
            label.setAttribute('for', candidate.id);
        }
    });
});


</script>

<!-- Dashboard Stats AJAX Update -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Function to fetch and update dashboard stats
    function fetchDashboardStats() {
        const statsUrl = '{{{config.wwwroot}}}/theme/remui_kids/school_manager_dashboard.php?action=get_dashboard_stats';
        
        // Show loading state
        const statNumbers = document.querySelectorAll('.stat-number');
        statNumbers.forEach(el => {
            if (!el.classList.contains('loading')) {
                el.classList.add('loading');
                el.dataset.originalText = el.textContent;
                el.textContent = '...';
            }
        });
        
        fetch(statsUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log('Dashboard stats fetched:', data);
                
                if (data.status === 'success') {
                    // Update Total Teachers
                    const teachersEl = document.getElementById('total-teachers');
                    if (teachersEl) {
                        teachersEl.textContent = data.total_teachers || 0;
                        teachersEl.classList.remove('loading');
                    }
                    
                    // Update Total Students
                    const studentsEl = document.getElementById('total-students');
                    if (studentsEl) {
                        studentsEl.textContent = data.total_students || 0;
                        studentsEl.classList.remove('loading');
                    }
                    
                    // Update Total Courses
                    const coursesEl = document.getElementById('total-courses');
                    if (coursesEl) {
                        coursesEl.textContent = data.total_courses || 0;
                        coursesEl.classList.remove('loading');
                    }
                    
                    // Update Active Enrollments
                    const enrollmentsEl = document.getElementById('active-enrollments');
                    if (enrollmentsEl) {
                        enrollmentsEl.textContent = data.active_enrollments || 0;
                        enrollmentsEl.classList.remove('loading');
                    }
                    
                    // Update Total Parents
                    const parentsEl = document.getElementById('total-parents');
                    if (parentsEl) {
                        parentsEl.textContent = data.total_parents || 0;
                        parentsEl.classList.remove('loading');
                    }
                    
                    // Animation removed - display stats immediately
                    console.log('Dashboard stats updated successfully');
                } else {
                    throw new Error(data.message || 'Failed to fetch dashboard stats');
                }
            })
            .catch(error => {
                console.error('Error fetching dashboard stats:', error);
                
                // Restore original values on error
                statNumbers.forEach(el => {
                    if (el.dataset.originalText) {
                        el.textContent = el.dataset.originalText;
                    }
                    el.classList.remove('loading');
                });
                
                // Show error message (optional)
                // You can add a toast notification here if needed
            });
    }
    
    // Fetch stats on page load
    fetchDashboardStats();
    
    // Optionally refresh stats every 30 seconds
    // setInterval(fetchDashboardStats, 30000);
});
</script>

<style>
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-5px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.stat-number.loading {
    color: #6c757d;
    font-style: italic;
}
</style>

<!-- Comprehensive Calendar Management JavaScript - DOMContentLoaded Block -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ==================== EVENT FORM INITIALIZATION ====================
    // Add event listeners for start/end date changes
    const eventStartDateField = document.getElementById('eventStartDate');
    const eventEndDateField = document.getElementById('eventEndDate');
    const eventFrequencyGroup = document.getElementById('eventFrequencyGroup');
    
    // Function to toggle frequency group visibility based on end date
    window.toggleFrequencyGroupVisibility = function() {
        if (eventEndDateField && eventFrequencyGroup) {
            const hasEndDate = eventEndDateField.value && eventEndDateField.value.trim() !== '';
            if (hasEndDate) {
                eventFrequencyGroup.style.display = 'block';
                // Trigger frequency option toggle if frequency is already selected
                const frequency = document.getElementById('eventFrequency');
                if (frequency && frequency.value) {
                    toggleEventFrequencyOptions();
                }
            } else {
                eventFrequencyGroup.style.display = 'none';
                // Hide frequency-specific options
                const specificDateGroup = document.getElementById('eventSpecificDateGroup');
                const weeklyDayGroup = document.getElementById('eventWeeklyDayGroup');
                if (specificDateGroup) specificDateGroup.style.display = 'none';
                if (weeklyDayGroup) weeklyDayGroup.style.display = 'none';
            }
        }
    };
    
    if (eventStartDateField) {
        eventStartDateField.addEventListener('change', function() {
            toggleFrequencyGroupVisibility();
            const frequency = document.getElementById('eventFrequency');
            // Regenerate calendar if specific_date is selected and we have both dates
            if (frequency && frequency.value === 'specific_date') {
                // Clear the current month so it regenerates with the new start date
                window.eventCalendarCurrentMonth = null;
                setTimeout(function() {
                    generateEventDatePicker();
                }, 50);
            }
        });
    }
    
    if (eventEndDateField) {
        eventEndDateField.addEventListener('change', function() {
            toggleFrequencyGroupVisibility();
            const frequency = document.getElementById('eventFrequency');
            // Regenerate calendar if specific_date is selected
            if (frequency && frequency.value === 'specific_date') {
                setTimeout(function() {
                    generateEventDatePicker();
                }, 50);
            }
        });
    }
    
    // Initialize frequency group visibility on page load
    toggleFrequencyGroupVisibility();
    
    // ==================== SCHOOL CALENDAR SYSTEM ====================
    // Use window-prefixed variables defined in earlier script block
    const API_BASE = window.CALENDAR_API_BASE || '{{{config.wwwroot}}}/theme/remui_kids/school_manager/calendar_management.php';
    const SESSKEY = window.CALENDAR_SESSKEY || '{{sesskey}}';
    
    // Use global calendarState if it exists, otherwise create it
    if (!window.calendarState) {
        window.calendarState = {
        currentView: 'week',
        currentWeek: 0,
        currentMonth: new Date().getMonth(),
        currentYear: new Date().getFullYear(),
            currentDay: new Date(),
            allEvents: [],
            allSessions: [],
            selectedEvent: null,
            filters: {
                eventType: 'all',
                course: 'all',
                teacher: 'all'
            }
        };
    }
    
    // Reference to calendarState for easier access
    const calendarState = window.calendarState;
    
    // Load calendar data from API - Make globally accessible
    window.loadCalendarData = function(forceReload = false) {
        if (!window.calendarState) return;
        const calendarState = window.calendarState;
        const today = new Date();
        
        // Extend date range to cover past 30 days and future 90 days to ensure all events are visible
        const startDate = new Date(today);
        startDate.setDate(today.getDate() - 30);
        startDate.setHours(0, 0, 0, 0);
        
        const endDate = new Date(today);
        endDate.setDate(today.getDate() + 90);
        endDate.setHours(23, 59, 59, 999);
        
        const startTimestamp = Math.floor(startDate.getTime() / 1000);
        const endTimestamp = Math.floor(endDate.getTime() / 1000);
        
        // Load events
        const API_BASE = window.CALENDAR_API_BASE || '{{{config.wwwroot}}}/theme/remui_kids/school_manager/calendar_management.php';
        const SESSKEY = window.CALENDAR_SESSKEY || '{{sesskey}}';
        
        // Add cache-busting timestamp if force reload is requested
        const cacheBust = forceReload ? '&_t=' + new Date().getTime() : '';
        
        fetch(`${API_BASE}?action=get_events&start_date=${startTimestamp}&end_date=${endTimestamp}&sesskey=${SESSKEY}${cacheBust}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    if (window.calendarState) {
                        window.calendarState.allEvents = data.events || [];
                    }
                    if (typeof window.loadLectureSessions === 'function') {
                        window.loadLectureSessions(forceReload);
                    }
                }
            })
            .catch(error => {
                console.error('Error loading events:', error);
                if (window.calendarState) {
                    window.calendarState.allEvents = [];
                }
                if (typeof window.loadLectureSessions === 'function') {
                    window.loadLectureSessions(forceReload);
                }
            });
    };
    
    // Load lecture sessions - Make globally accessible
    window.loadLectureSessions = function(forceReload = false) {
        if (!window.calendarState) return;
        const calendarState = window.calendarState;
        const today = new Date();
        
        // Extend date range to cover past 30 days and future 90 days to ensure all sessions are visible
        const startDate = new Date(today);
        startDate.setDate(today.getDate() - 30);
        startDate.setHours(0, 0, 0, 0);
        
        const endDate = new Date(today);
        endDate.setDate(today.getDate() + 90);
        endDate.setHours(23, 59, 59, 999);
        
        const startTimestamp = Math.floor(startDate.getTime() / 1000);
        const endTimestamp = Math.floor(endDate.getTime() / 1000);
        
        const API_BASE = window.CALENDAR_API_BASE || '{{{config.wwwroot}}}/theme/remui_kids/school_manager/calendar_management.php';
        const SESSKEY = window.CALENDAR_SESSKEY || '{{sesskey}}';
        
        // Add cache-busting timestamp if force reload is requested
        const cacheBust = forceReload ? '&_t=' + new Date().getTime() : '';
        
        fetch(`${API_BASE}?action=get_lecture_sessions&start_date=${startTimestamp}&end_date=${endTimestamp}&sesskey=${SESSKEY}${cacheBust}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Debug: Log sessions data to check teacher_available
                    console.log('📥 Loaded lecture sessions from backend (forceReload=' + forceReload + '):', data.sessions?.length || 0, 'sessions');
                    if (data.sessions && data.sessions.length > 0) {
                        data.sessions.forEach(session => {
                            console.log(`📋 Session ${session.id}:`, {
                                course_name: session.course_name,
                                teacher_name: session.teacher_name,
                                teacher_available: session.teacher_available,
                                teacher_available_type: typeof session.teacher_available,
                                date: session.date,
                                schedule_id: session.schedule_id
                            });
                            
                            // Check if teacher_available is missing
                            if (session.teacher_available === undefined) {
                                console.warn('⚠️ WARNING: Session', session.id, 'is missing teacher_available field!');
                            }
        });
    } else {
                        console.warn('⚠️ No lecture sessions returned from backend');
                    }
                    
                    if (window.calendarState) {
                        window.calendarState.allSessions = data.sessions || [];
                        console.log('✅ Updated calendarState.allSessions with', window.calendarState.allSessions.length, 'sessions');
                    }
                    if (typeof window.renderCurrentView === 'function') {
                        console.log('🔄 Calling renderCurrentView()...');
                        window.renderCurrentView();
                    }
                } else {
                    console.error('❌ Failed to load lecture sessions:', data.message || 'Unknown error');
                }
            })
            .catch(error => {
                console.error('Error loading sessions:', error);
                if (window.calendarState) {
                    window.calendarState.allSessions = [];
                }
                if (typeof window.renderCurrentView === 'function') {
                    window.renderCurrentView();
                }
            });
    };
    
    // Load filter options (courses, teachers, cohorts) - Make globally accessible
    // Uses SAME TECHNIQUE as loadEventFormData and loadLectureFormData
    window.loadFilterOptions = function() {
        console.log('🔄 loadFilterOptions called');
        console.log('==========================================');
        console.log('📊 FILTER OPTIONS LOADING - DEBUG MODE');
        console.log('==========================================');
        
        try {
            let courses = [];
            let teachers = [];
            
            // Get courses from JSON script tag (SAME AS loadLectureFormData)
            try {
                const coursesEl = document.getElementById('calendar-courses-data');
                if (!coursesEl) {
                    console.error('❌ calendar-courses-data script tag not found!');
                    courses = [];
        } else {
                    const coursesText = coursesEl.textContent.trim();
                    console.log('📋 Calendar Courses - Element exists: YES');
                    console.log('📋 Calendar Courses - Raw JSON length:', coursesText.length);
                    if (coursesText && coursesText !== '[]' && coursesText.length > 2) {
                        courses = JSON.parse(coursesText);
                        courses = Array.isArray(courses) ? courses : [];
                        console.log('✅ Courses JSON parsed:', courses.length, 'courses');
                        if (courses.length > 0) {
                            console.log('  Sample course:', courses[0]);
                        } else {
                            console.warn('⚠️ Courses array is empty after parsing');
                        }
                    } else {
                        console.warn('⚠️ Courses JSON is empty or invalid:', coursesText);
                        courses = [];
                    }
                }
            } catch(e) {
                console.error('❌ Error parsing courses JSON:', e);
                console.error('  Error message:', e.message);
                courses = [];
            }
            
            // Get teachers from JSON script tag (SAME AS loadLectureFormData)
            try {
                const teachersEl = document.getElementById('calendar-teachers-data');
                if (!teachersEl) {
                    console.error('❌ calendar-teachers-data script tag not found!');
                    teachers = [];
                } else {
                    const teachersText = teachersEl.textContent.trim();
                    console.log('📋 Calendar Teachers - Element exists: YES');
                    console.log('📋 Calendar Teachers - Raw JSON length:', teachersText.length);
                    if (teachersText && teachersText !== '[]' && teachersText.length > 2) {
                        teachers = JSON.parse(teachersText);
                        teachers = Array.isArray(teachers) ? teachers : [];
                        console.log('✅ Teachers JSON parsed:', teachers.length, 'teachers');
                        if (teachers.length > 0) {
                            console.log('  Sample teacher:', teachers[0]);
                        } else {
                            console.warn('⚠️ Teachers array is empty after parsing');
                        }
                    } else {
                        console.warn('⚠️ Teachers JSON is empty or invalid:', teachersText);
                        teachers = [];
                    }
                }
            } catch(e) {
                console.error('❌ Error parsing teachers JSON:', e);
                console.error('  Error message:', e.message);
                teachers = [];
            }
            
            console.log('📊 Filter Options Summary - Courses:', courses.length, 'Teachers:', teachers.length);
            
            // Populate filter dropdowns
            const filterCourse = document.getElementById('filterCourse');
            if (filterCourse) {
                // Save the "All Courses" option text first
                const allOptionText = filterCourse.querySelector('option[value="all"]')?.textContent || 'All Courses';
                // Clear and rebuild dropdown
                filterCourse.innerHTML = '';
                // Add "All Courses" option first
                const allOpt = document.createElement('option');
                allOpt.value = 'all';
                allOpt.textContent = allOptionText;
                filterCourse.appendChild(allOpt);
                
                if (courses.length > 0) {
                    courses.forEach(course => {
                        const option = document.createElement('option');
                        option.value = course.id;
                        option.textContent = course.fullname || course.shortname || 'Unnamed Course';
                        filterCourse.appendChild(option);
                    });
                    console.log('✅ Filter Course dropdown populated with', courses.length, 'courses');
        } else {
                    console.warn('⚠️ No courses to populate in filter dropdown');
                }
            } else {
                console.error('❌ filterCourse element not found');
            }
            
            const filterTeacher = document.getElementById('filterTeacher');
            if (filterTeacher) {
                // Save the "All Teachers" option text first
                const allOptionText = filterTeacher.querySelector('option[value="all"]')?.textContent || 'All Teachers';
                // Clear and rebuild dropdown
                filterTeacher.innerHTML = '';
                // Add "All Teachers" option first
                const allOpt = document.createElement('option');
                allOpt.value = 'all';
                allOpt.textContent = allOptionText;
                filterTeacher.appendChild(allOpt);
                
                if (teachers.length > 0) {
                    teachers.forEach(teacher => {
                        const option = document.createElement('option');
                        option.value = teacher.id;
                        const fullname = teacher.fullname || (teacher.firstname + ' ' + teacher.lastname).trim() || 'Unknown';
                        option.textContent = fullname;
                        filterTeacher.appendChild(option);
                    });
                    console.log('✅ Filter Teacher dropdown populated with', teachers.length, 'teachers');
                } else {
                    console.warn('⚠️ No teachers to populate in filter dropdown');
                }
            } else {
                console.error('❌ filterTeacher element not found');
            }
            
            console.log('==========================================');
            console.log('✅ FILTER OPTIONS LOADING COMPLETE');
            console.log('==========================================');
        } catch(error) {
            console.error('❌ Error loading filter options:', error);
            console.error('  Stack:', error.stack);
        }
    };
    
    // Initialize calendar
    if (typeof window.loadCalendarData === 'function') {
        window.loadCalendarData();
    }
    if (typeof window.loadFilterOptions === 'function') {
        window.loadFilterOptions();
    }
    
    // Initial render
    if (typeof window.renderCurrentView === 'function') {
        window.renderCurrentView();
    }
    
    // TEST: Check if calendar data script tags exist and have content on page load
    console.log('==========================================');
    console.log('🔍 PAGE LOAD TEST - Calendar Data Script Tags');
    console.log('==========================================');
    const testTeachersEl = document.getElementById('calendar-teachers-data');
    const testStudentsEl = document.getElementById('calendar-students-data');
    const testCohortsEl = document.getElementById('calendar-cohorts-data');
    console.log('Teachers script tag exists:', !!testTeachersEl);
    console.log('Students script tag exists:', !!testStudentsEl);
    console.log('Cohorts script tag exists:', !!testCohortsEl);
    if (testTeachersEl) {
        const text = testTeachersEl.textContent.trim();
        console.log('Teachers JSON length:', text.length);
        console.log('Teachers JSON content:', text);
        try {
            const parsed = JSON.parse(text);
            console.log('Teachers parsed successfully:', parsed.length, 'items');
            if (parsed.length > 0) {
                console.log('First teacher:', parsed[0]);
            }
        } catch(e) {
            console.error('Teachers JSON parse error:', e);
        }
    }
    if (testStudentsEl) {
        const text = testStudentsEl.textContent.trim();
        console.log('Students JSON length:', text.length);
        console.log('Students JSON content:', text);
        try {
            const parsed = JSON.parse(text);
            console.log('Students parsed successfully:', parsed.length, 'items');
            if (parsed.length > 0) {
                console.log('First student:', parsed[0]);
            }
        } catch(e) {
            console.error('Students JSON parse error:', e);
        }
    }
    if (testCohortsEl) {
        const text = testCohortsEl.textContent.trim();
        console.log('Cohorts JSON length:', text.length);
        console.log('Cohorts JSON content:', text);
        try {
            const parsed = JSON.parse(text);
            console.log('Cohorts parsed successfully:', parsed.length, 'items');
            if (parsed.length > 0) {
                console.log('First cohort:', parsed[0]);
            }
        } catch(e) {
            console.error('Cohorts JSON parse error:', e);
        }
    }
    console.log('==========================================');
    
    console.log('📅 School Calendar Initialized');
    
    // Refresh calendar function - manually refresh to see updated teacher availability
    window.refreshCalendar = function() {
        console.log('🔄 Manually refreshing calendar...');
        if (typeof window.loadLectureSessions === 'function') {
            window.loadLectureSessions();
        }
        if (typeof window.loadCalendarData === 'function') {
            window.loadCalendarData();
        }
    };
    
    // Auto-refresh calendar every 15 seconds to show updated teacher availability
    // This ensures school admin sees cross marks when teachers mark themselves unavailable
    if (typeof window.loadLectureSessions === 'function') {
        setInterval(function() {
            console.log('🔄 Auto-refreshing calendar to check teacher availability...');
            window.loadLectureSessions();
        }, 15000); // Refresh every 15 seconds for faster updates
    }
    
    // Note: Navigation functions (changeCalendarPeriod, goToToday, switchView) 
    // are already defined globally in the earlier script block
    
    // Make rendering functions globally accessible
    window.renderCurrentView = function() {
        if (!window.calendarState) return;
        const calendarState = window.calendarState;
            
            if (calendarState.currentView === 'week') {
            window.renderWeekView();
            } else if (calendarState.currentView === 'month') {
            window.renderMonthView();
        } else if (calendarState.currentView === 'day') {
            window.renderDayView();
        }
    };
    
    // ============ WEEK VIEW ============
    window.renderWeekView = function() {
        if (!window.calendarState) return;
        const calendarState = window.calendarState;
        const today = new Date();
        const startOfWeek = new Date(today);
        
        const dayOfWeek = startOfWeek.getDay();
        const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
        startOfWeek.setDate(startOfWeek.getDate() + daysToMonday + (calendarState.currentWeek * 7));
        startOfWeek.setHours(0, 0, 0, 0);
        
        const endOfWeek = new Date(startOfWeek);
        endOfWeek.setDate(startOfWeek.getDate() + 6);
        endOfWeek.setHours(23, 59, 59, 999);
        
        const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        const weekDisplay = `${monthNames[startOfWeek.getMonth()]} ${startOfWeek.getDate()} - ${endOfWeek.getDate()}, ${endOfWeek.getFullYear()}`;
        const periodEl = document.getElementById('currentPeriod');
        if (periodEl) periodEl.textContent = weekDisplay;
        
        const dayNames = ['MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT', 'SUN'];
        const dateToDay = {};
        
        // Update day headers
        // Build date to day number mapping - use local date methods for consistency
        for (let i = 0; i < 7; i++) {
            const dayDate = new Date(startOfWeek);
            dayDate.setDate(startOfWeek.getDate() + i);
            // Use local date methods to avoid timezone issues
            const year = dayDate.getFullYear();
            const month = String(dayDate.getMonth() + 1).padStart(2, '0');
            const day = String(dayDate.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day}`;
            dateToDay[dateStr] = i + 1;
        }
        
        // Combine events and sessions
        const allItems = [...calendarState.allEvents, ...calendarState.allSessions];
        
        // Filter items
        const filteredItems = allItems.filter(item => {
            // Determine event type for filtering
            let itemType = item.type || item.eventtype || 'Event';
            // Handle undefined/null/empty string values
            if (!itemType || itemType === 'undefined' || itemType === 'null' || String(itemType).trim() === '') {
                itemType = 'Event';
            }
            if (item.schedule_id) {
                itemType = 'Lecture';
            }
            
            if (calendarState.filters.eventType !== 'all' && itemType !== calendarState.filters.eventType) {
                return false;
            }
            if (calendarState.filters.course !== 'all' && item.course_id && item.course_id != calendarState.filters.course) {
                return false;
            }
            if (calendarState.filters.teacher !== 'all' && item.teacher_id && item.teacher_id != calendarState.filters.teacher) {
                return false;
            }
            return true;
        });
        
        // Create day columns with header and events container
        const weekGrid = document.getElementById('weekGrid');
        if (!weekGrid) return;
        
        weekGrid.innerHTML = '';
        
        // Group events by day - use actual start timestamp to determine correct date
        const eventsByDay = {};
        filteredItems.forEach(item => {
            // Use item.date from backend (already correctly calculated from actual_start_timestamp)
            // Only calculate from timestart if date is missing
            let dateStr = item.date;
            if (!dateStr && item.timestart) {
                // Fallback: Calculate date from timestamp using local timezone (not UTC)
                const eventDate = new Date(item.timestart * 1000);
                // Use local date methods to avoid timezone issues
                const year = eventDate.getFullYear();
                const month = String(eventDate.getMonth() + 1).padStart(2, '0');
                const day = String(eventDate.getDate()).padStart(2, '0');
                dateStr = `${year}-${month}-${day}`;
            }
            if (!dateStr) {
                // Skip items without a valid date
                return;
            }
            
            // Match date to day number in the week
            const dayNumber = dateToDay[dateStr];
            if (!dayNumber) {
                // If exact match not found, try to find the day by comparing dates
                // This handles edge cases where date format might differ slightly
                const itemDate = new Date(dateStr + 'T00:00:00');
                const weekStart = new Date(startOfWeek);
                weekStart.setHours(0, 0, 0, 0);
                const weekEnd = new Date(endOfWeek);
                weekEnd.setHours(23, 59, 59, 999);
                
                // Check if the item's date falls within the week
                if (itemDate >= weekStart && itemDate <= weekEnd) {
                    // Calculate which day of the week this is (0-6, then convert to 1-7)
                    const daysDiff = Math.floor((itemDate - weekStart) / (1000 * 60 * 60 * 24));
                    if (daysDiff >= 0 && daysDiff < 7) {
                        const adjustedDayNumber = daysDiff + 1;
                        if (!eventsByDay[adjustedDayNumber]) {
                            eventsByDay[adjustedDayNumber] = [];
                        }
                        eventsByDay[adjustedDayNumber].push(item);
                    }
                }
                return;
            }
            
            if (!eventsByDay[dayNumber]) {
                eventsByDay[dayNumber] = [];
            }
            eventsByDay[dayNumber].push(item);
        });
        
        // Create 7 day columns with header and events
        for (let i = 1; i <= 7; i++) {
            const dayDate = new Date(startOfWeek);
            dayDate.setDate(startOfWeek.getDate() + (i - 1));
            // Use local date methods to avoid timezone issues
            const year = dayDate.getFullYear();
            const month = String(dayDate.getMonth() + 1).padStart(2, '0');
            const day = String(dayDate.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day}`;
            const isToday = dayDate.toDateString() === today.toDateString();
            
            const dayColumn = document.createElement('div');
            dayColumn.className = 'calendar-day-column';
            dayColumn.style.cssText = 'display: flex; flex-direction: column; background: #ffffff; border-radius: 0.875rem; border: 1px solid #e9ecef; overflow: hidden; height: 400px; min-height: 400px; max-height: 400px;';
            if (isToday) {
                dayColumn.classList.add('today');
            }
            
            // Day header with date
            const dayHeader = document.createElement('div');
            dayHeader.className = 'day-column-header';
            dayHeader.style.cssText = 'flex-shrink: 0;';
            dayHeader.innerHTML = `
                <div class="day-name-abbr">${dayNames[i - 1]}</div>
                <div class="day-date-number">${dayDate.getDate()}</div>
            `;
            dayColumn.appendChild(dayHeader);
            
            // Events container with fixed height and scrollbar
            const eventsContainer = document.createElement('div');
            eventsContainer.className = 'day-events-container';
            eventsContainer.style.cssText = 'flex: 1; padding: 0.5rem; display: flex; flex-direction: column; gap: 0.5rem; overflow-y: auto; overflow-x: hidden; min-height: 0; max-height: calc(400px - 100px);';
            const dayEvents = eventsByDay[i] || [];
            
            if (dayEvents.length === 0) {
                eventsContainer.innerHTML = '<div class="no-events">No events</div>';
                } else {
                // Sort events by start time (use timestart if available, otherwise parse start_time)
                dayEvents.sort((a, b) => {
                    if (a.timestart && b.timestart) {
                        return a.timestart - b.timestart;
                    }
                    // Fallback to time string comparison
                    const timeA = a.start_time || a.startTime || '00:00 AM';
                    const timeB = b.start_time || b.startTime || '00:00 AM';
                    return timeA.localeCompare(timeB);
                });
                
                // Show all events (scrollbar will handle if more than 3)
                dayEvents.forEach(item => {
                    // Debug: Log all lecture sessions to check teacher_available
                    if (item.schedule_id) {
                        console.log('📋 Rendering lecture session:', {
                            id: item.id,
                            course_name: item.course_name,
                            teacher_name: item.teacher_name,
                            teacher_available: item.teacher_available,
                            teacher_available_type: typeof item.teacher_available,
                            date: item.date
                        });
                    }
                    
                    const eventEl = document.createElement('div');
                    eventEl.className = `event-item event-${item.color || 'blue'}`;
                    eventEl.style.borderLeftColor = getEventColor(item.color || 'blue');
                    eventEl.style.flexShrink = '0'; // Prevent event items from shrinking
                    
                    // Determine event type - sessions are lectures, events have their own type
                    let eventType = item.type || item.eventtype || 'Event';
                    // Handle undefined/null/empty string values
                    if (!eventType || eventType === 'undefined' || eventType === 'null' || eventType.trim() === '') {
                        eventType = 'Event';
                    }
                    if (item.schedule_id) {
                        // This is a lecture session
                        eventType = 'Lecture';
                    }
                    
                    // For lecture sessions, show course name, then badge, then teacher name below
                    let displayText = item.title || 'Untitled Event';
                    let teacherNameHtml = '';
                    if (item.schedule_id && item.course_name) {
                        displayText = item.course_name;
                        if (item.teacher_name) {
                            // Check teacher availability - show cross mark if teacher is not available (0)
                            let teacherAvailable = item.teacher_available;
                            
                            // Debug: Always log teacher availability for lecture sessions
                            console.log('🔍 Checking teacher availability for session:', {
                                sessionId: item.id,
                                teacherName: item.teacher_name,
                                raw_teacher_available: item.teacher_available,
                                type: typeof item.teacher_available,
                                isUndefined: teacherAvailable === undefined,
                                isNull: teacherAvailable === null
                            });
                            
                            // Handle undefined/null - default to available (1)
                            if (teacherAvailable === undefined || teacherAvailable === null) {
                                teacherAvailable = 1;
                                console.log('⚠️ teacher_available was undefined/null, defaulting to 1');
                            }
                            
                            // Convert to number for reliable comparison
                            const availableNum = Number(teacherAvailable);
                            
                            // Show cross mark if teacher is NOT available (0)
                            const showUnavailableMark = (availableNum === 0);
                            
                            console.log('✅ Availability check result:', {
                                sessionId: item.id,
                                teacherAvailable: teacherAvailable,
                                availableNum: availableNum,
                                showUnavailableMark: showUnavailableMark
                            });
                            
                            const unavailableMark = showUnavailableMark 
                                ? '<span class="teacher-unavailable-mark" style="color: #ef4444; font-weight: bold; margin-left: 6px; font-size: 20px; display: inline-block; vertical-align: middle; line-height: 1;" title="Teacher Not Available">✗</span> <span style="color: #ef4444; font-size: 12px; font-weight: 600;">(Not Available)</span>' 
                                : '';
                            teacherNameHtml = `<div class="event-teacher-name" style="display: flex; align-items: center; gap: 4px; margin-top: 4px; flex-wrap: wrap;">${item.teacher_name}${unavailableMark}</div>`;
                        }
                    }
                    
                    // Format time in 12-hour format
                    let timeDisplay = '';
                    if (item.start_time || item.startTime) {
                        const timeStr = item.start_time || item.startTime;
                        // Convert 24-hour to 12-hour if needed
                        if (timeStr.includes(':') && !timeStr.includes('AM') && !timeStr.includes('PM')) {
                            const [hours, minutes] = timeStr.split(':');
                            const hour = parseInt(hours);
                            const ampm = hour >= 12 ? 'PM' : 'AM';
                            const hour12 = hour % 12 || 12;
                            timeDisplay = `${hour12}:${minutes} ${ampm}`;
            } else {
                            timeDisplay = timeStr;
                        }
                    }
                    
                    eventEl.innerHTML = `
                        ${timeDisplay ? `<div class="event-time">${timeDisplay}</div>` : ''}
                        <div class="event-title">${displayText}</div>
                        <div class="event-type-badge">${eventType.toUpperCase()}</div>
                        ${teacherNameHtml}
                    `;
                    eventEl.onclick = () => showEventDetailsModal(item);
                    eventsContainer.appendChild(eventEl);
                });
            }
            
            dayColumn.appendChild(eventsContainer);
            weekGrid.appendChild(dayColumn);
        }
        
        // Helper function to get event color
        function getEventColor(colorName) {
            const colors = {
                'blue': '#3b82f6',
                'red': '#ef4444',
                'green': '#10b981',
                'orange': '#f59e0b',
                'purple': '#8b5cf6',
                'yellow': '#eab308',
                'pink': '#ec4899'
            };
            return colors[colorName.toLowerCase()] || colors['blue'];
        }
        
        // Show week view
        document.getElementById('calendarWeekView').style.display = 'block';
        document.getElementById('calendarMonthView').style.display = 'none';
        document.getElementById('calendarDayView').style.display = 'none';
    }
    
    // ============ MONTH VIEW ============
    window.renderMonthView = function() {
        if (!window.calendarState) return;
        const calendarState = window.calendarState;
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const monthDisplay = `${monthNames[calendarState.currentMonth]} ${calendarState.currentYear}`;
        const periodEl = document.getElementById('currentPeriod');
        if (periodEl) periodEl.textContent = monthDisplay;
        
        const monthGrid = document.getElementById('monthGrid');
        if (!monthGrid) return;
        
        const firstDay = new Date(calendarState.currentYear, calendarState.currentMonth, 1);
        const lastDay = new Date(calendarState.currentYear, calendarState.currentMonth + 1, 0);
        const startDay = firstDay.getDay() || 7;
        const daysInMonth = lastDay.getDate();
        
        let html = '<div class="month-calendar"><div class="month-header">';
        ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].forEach(day => {
            html += `<div class="month-day-name">${day}</div>`;
        });
        html += '</div><div class="month-days">';
        
        for (let i = 1; i < startDay; i++) {
            html += '<div class="month-day empty"></div>';
        }
        
        const today = new Date();
        const allItems = [...calendarState.allEvents, ...calendarState.allSessions];
        
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(calendarState.currentYear, calendarState.currentMonth, day);
            const dateStr = date.toISOString().split('T')[0];
            const dayItems = allItems.filter(e => e.date === dateStr);
            const isToday = date.toDateString() === today.toDateString();
            
            html += `<div class="month-day ${isToday ? 'today' : ''}" data-date="${dateStr}" onclick="showDayEvents('${dateStr}')">
                <div class="day-number">${day}</div>
                ${dayItems.length > 0 ? `<div class="event-dots">${dayItems.slice(0, 3).map(e => `<span class="dot dot-${e.color || 'blue'}"></span>`).join('')}</div>` : ''}
            </div>`;
        }
        
        html += '</div></div>';
        monthGrid.innerHTML = html;
        
        document.getElementById('calendarWeekView').style.display = 'none';
        document.getElementById('calendarMonthView').style.display = 'block';
        document.getElementById('calendarDayView').style.display = 'none';
    }
    
    // ============ DAY VIEW ============
    window.renderDayView = function() {
        if (!window.calendarState) return;
        const calendarState = window.calendarState;
        const dayTimeline = document.getElementById('dayTimeline');
        if (!dayTimeline) return;
        
        const dateStr = calendarState.currentDay.toISOString().split('T')[0];
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const dayDisplay = `${monthNames[calendarState.currentDay.getMonth()]} ${calendarState.currentDay.getDate()}, ${calendarState.currentDay.getFullYear()}`;
        const periodEl = document.getElementById('currentPeriod');
        if (periodEl) periodEl.textContent = dayDisplay;
        
        const allItems = [...calendarState.allEvents, ...calendarState.allSessions];
        const dayItems = allItems.filter(e => e.date === dateStr);
        
        // Simple list view without time slots
        let html = '<div class="day-events-list">';
        if (dayItems.length === 0) {
            html += '<div class="no-events">No events for this day</div>';
        } else {
            // Sort events by start time (use timestart if available, otherwise parse time string)
            dayItems.sort((a, b) => {
                if (a.timestart && b.timestart) {
                    return a.timestart - b.timestart;
                }
                // Fallback to time string comparison
                const timeA = a.start_time || a.startTime || '00:00 AM';
                const timeB = b.start_time || b.startTime || '00:00 AM';
                return timeA.localeCompare(timeB);
            });
            
            dayItems.forEach(item => {
                // Get time - already in 12-hour format from backend
                let startTime = item.start_time || item.startTime || '';
                let endTime = item.end_time || item.endTime || '';
                
                // If time is in 24-hour format (fallback), convert to 12-hour
                if (startTime && startTime.includes(':') && !startTime.includes('AM') && !startTime.includes('PM') && !startTime.includes('am') && !startTime.includes('pm')) {
                    const [hours, minutes] = startTime.split(':');
                    const hour = parseInt(hours);
                    const ampm = hour >= 12 ? 'PM' : 'AM';
                    const hour12 = hour % 12 || 12;
                    startTime = `${hour12}:${minutes} ${ampm}`;
                }
                if (endTime && endTime.includes(':') && !endTime.includes('AM') && !endTime.includes('PM') && !endTime.includes('am') && !endTime.includes('pm')) {
                    const [hours, minutes] = endTime.split(':');
                    const hour = parseInt(hours);
                    const ampm = hour >= 12 ? 'PM' : 'AM';
                    const hour12 = hour % 12 || 12;
                    endTime = `${hour12}:${minutes} ${ampm}`;
                }
                
                const timeDisplay = startTime && endTime ? `${startTime} - ${endTime}` : (startTime || 'All Day');
                
                // Determine event type - sessions are lectures, events have their own type
                let eventType = item.type || item.eventtype || 'Event';
                // Handle undefined/null/empty string values
                if (!eventType || eventType === 'undefined' || eventType === 'null' || String(eventType).trim() === '') {
                    eventType = 'Event';
                }
                if (item.schedule_id) {
                    // This is a lecture session
                    eventType = 'Lecture';
                }
                
                // For lecture sessions, show course name, then badge, then teacher name below
                let displayText = item.title || 'Untitled Event';
                let teacherNameHtml = '';
                if (item.schedule_id && item.course_name) {
                    displayText = item.course_name;
                    if (item.teacher_name) {
                        // Check teacher availability - show cross mark if teacher is not available (0)
                        let teacherAvailable = item.teacher_available;
                        
                        // Handle undefined/null - default to available (1)
                        if (teacherAvailable === undefined || teacherAvailable === null) {
                            teacherAvailable = 1;
                        }
                        
                        // Convert to number for reliable comparison
                        const availableNum = Number(teacherAvailable);
                        
                        // Show cross mark if teacher is NOT available (0)
                        const showUnavailableMark = (availableNum === 0);
                        
                        // Debug log
                        if (showUnavailableMark) {
                            console.log('⚠️ Day View - Teacher NOT available:', {
                                sessionId: item.id,
                                teacherName: item.teacher_name,
                                teacher_available: item.teacher_available,
                                availableNum: availableNum
                            });
                        }
                        
                        const unavailableMark = showUnavailableMark 
                            ? '<span class="teacher-unavailable-mark" style="color: #ef4444; font-weight: bold; margin-left: 6px; font-size: 20px; display: inline-block; vertical-align: middle; line-height: 1;" title="Teacher Not Available">✗</span> <span style="color: #ef4444; font-size: 12px; font-weight: 600;">(Not Available)</span>' 
                            : '';
                        teacherNameHtml = `<div class="event-teacher-name" style="display: flex; align-items: center; gap: 4px; flex-wrap: wrap;">${item.teacher_name}${unavailableMark}</div>`;
                    }
                }
                
                html += `
                    <div class="day-event-item event-${item.color || 'blue'}" onclick="showEventDetailsModal(${JSON.stringify(item).replace(/"/g, '&quot;')})">
                        <div class="event-content">
                            <div class="event-title">${displayText}</div>
                            <div class="event-time">${timeDisplay}</div>
                        </div>
                        <div class="event-type-badge">${eventType.toUpperCase()}</div>
                        ${teacherNameHtml}
                    </div>
                `;
            });
        }
            html += '</div>';
        dayTimeline.innerHTML = html;
        
        document.getElementById('calendarWeekView').style.display = 'none';
        document.getElementById('calendarMonthView').style.display = 'none';
        document.getElementById('calendarDayView').style.display = 'block';
    }
    
    // ============ EVENT MANAGEMENT FUNCTIONS ============
    // Note: All global functions (saveEvent, saveLectureSchedule, showEventDetailsModal, etc.) 
    // are already defined in the earlier script block before the HTML
    
    // Load form data (teachers, students, cohorts, courses) - Make globally accessible
    // USING SAME TECHNIQUE AS GRADE DISTRIBUTION (parsing from script tags)
    window.loadEventFormData = function() {
        console.log('🔄 loadEventFormData called');
        console.log('==========================================');
        console.log('📊 CALENDAR DATA LOADING - DEBUG MODE');
        console.log('==========================================');
        
        try {
            // Get data from JSON script tags (SAME TECHNIQUE AS GRADE DISTRIBUTION)
            let teachers = [];
            let students = [];
            let cohorts = [];
            
            try {
                // Parse from script tag (SAME AS grade-distribution-data)
                const teachersEl = document.getElementById('calendar-teachers-data');
                console.log('📋 Teachers Script Tag - Element found:', !!teachersEl);
                if (!teachersEl) {
                    console.error('❌ calendar-teachers-data script tag not found!');
                    console.error('  Check if script tag exists in HTML with id="calendar-teachers-data"');
                    teachers = [];
        } else {
                    const teachersText = teachersEl.textContent.trim();
                    console.log('📋 Calendar Teachers - Element exists: YES');
                    console.log('📋 Calendar Teachers - Raw JSON length:', teachersText.length);
                    console.log('📋 Calendar Teachers - Raw JSON (full):', teachersText);
                    
                    if (teachersText && teachersText.length >= 2) {
                        try {
                            teachers = JSON.parse(teachersText);
                            teachers = Array.isArray(teachers) ? teachers : [];
                            console.log('✅ Teachers JSON parsed successfully:', teachers.length, 'teachers');
                            if (teachers.length > 0) {
                                console.log('  Sample teacher:', teachers[0]);
                                console.log('  All teachers:', teachers);
                            } else {
                                console.warn('⚠️ Teachers array is empty - query returned 0 results');
                            }
                        } catch(parseError) {
                            console.error('❌ JSON Parse Error for teachers:', parseError);
                            console.error('  Invalid JSON text:', teachersText);
                            teachers = [];
                        }
                    } else {
                        console.warn('⚠️ Teachers JSON text is empty or too short');
                        console.warn('  Raw text:', teachersText);
                        teachers = [];
                    }
                }
            } catch(e) {
                console.error('❌ Error parsing teachers JSON:', e);
                console.error('  Error message:', e.message);
                console.error('  Stack:', e.stack);
                teachers = [];
            }
            
            try {
                // Parse from script tag (SAME AS grade-distribution-data)
                const studentsEl = document.getElementById('calendar-students-data');
                console.log('📋 Students Script Tag - Element found:', !!studentsEl);
                if (!studentsEl) {
                    console.error('❌ calendar-students-data script tag not found!');
                    students = [];
                } else {
                    const studentsText = studentsEl.textContent.trim();
                    console.log('📋 Calendar Students - Element exists: YES');
                    console.log('📋 Calendar Students - Raw JSON length:', studentsText.length);
                    console.log('📋 Calendar Students - Raw JSON (full):', studentsText);
                    
                    if (studentsText && studentsText.length >= 2) {
                        try {
                            students = JSON.parse(studentsText);
                            students = Array.isArray(students) ? students : [];
                            console.log('✅ Students JSON parsed successfully:', students.length, 'students');
                            if (students.length > 0) {
                                console.log('  Sample student:', students[0]);
                                console.log('  All students:', students);
                            } else {
                                console.warn('⚠️ Students array is empty - query returned 0 results');
                            }
                        } catch(parseError) {
                            console.error('❌ JSON Parse Error for students:', parseError);
                            console.error('  Invalid JSON text:', studentsText);
                            students = [];
                        }
                    } else {
                        console.warn('⚠️ Students JSON text is empty or too short');
                        students = [];
                    }
                }
            } catch(e) {
                console.error('❌ Error parsing students JSON:', e);
                console.error('  Error message:', e.message);
                console.error('  Stack:', e.stack);
                students = [];
            }
            
            try {
                // Parse from script tag (SAME AS grade-distribution-data)
                const cohortsEl = document.getElementById('calendar-cohorts-data');
                console.log('📋 Cohorts Script Tag - Element found:', !!cohortsEl);
                if (!cohortsEl) {
                    console.error('❌ calendar-cohorts-data script tag not found!');
                    cohorts = [];
                } else {
                    const cohortsText = cohortsEl.textContent.trim();
                    console.log('📋 Calendar Cohorts - Element exists: YES');
                    console.log('📋 Calendar Cohorts - Raw JSON length:', cohortsText.length);
                    console.log('📋 Calendar Cohorts - Raw JSON (full):', cohortsText);
                    
                    if (cohortsText && cohortsText.length >= 2) {
                        try {
                            cohorts = JSON.parse(cohortsText);
                            cohorts = Array.isArray(cohorts) ? cohorts : [];
                            console.log('✅ Cohorts JSON parsed successfully:', cohorts.length, 'cohorts');
                            if (cohorts.length > 0) {
                                console.log('  Sample cohort:', cohorts[0]);
                                console.log('  All cohorts:', cohorts);
                            } else {
                                console.warn('⚠️ Cohorts array is empty - query returned 0 results');
                            }
                        } catch(parseError) {
                            console.error('❌ JSON Parse Error for cohorts:', parseError);
                            console.error('  Invalid JSON text:', cohortsText);
                            cohorts = [];
                        }
                    } else {
                        console.warn('⚠️ Cohorts JSON text is empty or too short');
                        cohorts = [];
                    }
                }
            } catch(e) {
                console.error('❌ Error parsing cohorts JSON:', e);
                console.error('  Error message:', e.message);
                console.error('  Stack:', e.stack);
                cohorts = [];
            }
            
            console.log('📊 Loading form data - Teachers:', teachers.length, 'Students:', students.length, 'Cohorts:', cohorts.length);
            
            // Populate teachers dropdown
            const teacherSelect = document.getElementById('eventTeachers');
            if (teacherSelect) {
                teacherSelect.innerHTML = '';
                if (teachers.length > 0) {
                    teachers.forEach(teacher => {
                        const option = document.createElement('option');
                        option.value = teacher.id || teacher.userid;
                        const fullname = teacher.fullname || (teacher.firstname + ' ' + teacher.lastname).trim() || 'Unknown';
                        const email = teacher.email || '';
                        option.textContent = email ? `${fullname} (${email})` : fullname;
                        teacherSelect.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No teachers available';
                    option.disabled = true;
                    teacherSelect.appendChild(option);
                }
            }
            
            // Populate students dropdown
            const studentSelect = document.getElementById('eventStudents');
            if (studentSelect) {
                studentSelect.innerHTML = '';
                if (students.length > 0) {
                    students.forEach(student => {
                        const option = document.createElement('option');
                        option.value = student.id || student.userid;
                        const fullname = student.fullname || (student.firstname + ' ' + student.lastname).trim() || 'Unknown';
                        const email = student.email || '';
                        option.textContent = email ? `${fullname} (${email})` : fullname;
                        studentSelect.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No students available';
                    option.disabled = true;
                    studentSelect.appendChild(option);
                }
            }
            
            // Populate cohorts dropdown
            const cohortSelect = document.getElementById('eventCohorts');
            if (cohortSelect) {
                cohortSelect.innerHTML = '';
                if (cohorts.length > 0) {
                    cohorts.forEach(cohort => {
                        const option = document.createElement('option');
                        option.value = cohort.id;
                        option.textContent = cohort.name || 'Unnamed Cohort';
                        cohortSelect.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No cohorts available';
                    option.disabled = true;
                    cohortSelect.appendChild(option);
                }
            }
        } catch(error) {
            console.error('Error loading event form data:', error);
        }
    };
    
    // OPTIMIZATION: Load calendar form data via AJAX if lazy loading is enabled
    window.loadLectureFormData = function() {
        const lazyLoadCalendarForm = {{#lazy_load_calendar_form}}{{lazy_load_calendar_form}}{{/lazy_load_calendar_form}}{{^lazy_load_calendar_form}}false{{/lazy_load_calendar_form}};
        
        // Check if data is already loaded in script tags
        const coursesEl = document.getElementById('calendar-courses-data');
        const teachersEl = document.getElementById('calendar-teachers-data');
        const coursesText = coursesEl ? coursesEl.textContent.trim() : '[]';
        const teachersText = teachersEl ? teachersEl.textContent.trim() : '[]';
        const hasData = coursesText !== '[]' || teachersText !== '[]';
        
        // If lazy loading is enabled and data is not loaded, fetch via AJAX
        if (lazyLoadCalendarForm && !hasData) {
            // Show loading state
            const courseSelect = document.getElementById('lectureCourse');
            const teacherSelect = document.getElementById('lectureTeacher');
            if (courseSelect) courseSelect.innerHTML = '<option value="">Loading courses...</option>';
            if (teacherSelect) teacherSelect.innerHTML = '<option value="">Loading teachers...</option>';
            
            // Load calendar form data via AJAX
            fetch('{{{config.wwwroot}}}/theme/remui_kids/school_manager_dashboard.php?action=get_calendar_form_data&sesskey={{sesskey}}')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Update script tags with loaded data for future use
                        if (coursesEl) coursesEl.textContent = data.calendar_courses_json || '[]';
                        if (teachersEl) teachersEl.textContent = data.calendar_teachers_json || '[]';
                        
                        // Update students and cohorts script tags if they exist
                        const studentsEl = document.getElementById('calendar-students-data');
                        const cohortsEl = document.getElementById('calendar-cohorts-data');
                        if (studentsEl && data.calendar_students_json) studentsEl.textContent = data.calendar_students_json;
                        if (cohortsEl && data.calendar_cohorts_json) cohortsEl.textContent = data.calendar_cohorts_json;
                        
                        // Populate form dropdowns
                        populateLectureFormData(data.calendar_courses || [], data.calendar_teachers || []);
                    } else {
                        console.error('Error loading calendar form data:', data.message);
                        populateLectureFormData([], []);
                    }
                })
                .catch(error => {
                    console.error('Error fetching calendar form data:', error);
                    populateLectureFormData([], []);
                });
        } else {
            // Use existing data from script tags
            try {
            let courses = [];
            let teachers = [];
            
            try {
                courses = JSON.parse(coursesText);
                courses = Array.isArray(courses) ? courses : [];
            } catch(e) {
                courses = [];
            }
            
            try {
                teachers = JSON.parse(teachersText);
                teachers = Array.isArray(teachers) ? teachers : [];
            } catch(e) {
                teachers = [];
            }
            
                populateLectureFormData(courses, teachers);
            } catch(error) {
                console.error('Error loading lecture form data:', error);
                populateLectureFormData([], []);
            }
        }
    };
    
    // Helper function to populate lecture form dropdowns
    function populateLectureFormData(courses, teachers) {
            // Populate courses dropdown
            const courseSelect = document.getElementById('lectureCourse');
            if (courseSelect) {
                courseSelect.innerHTML = '<option value="">Select Course</option>';
                if (courses.length > 0) {
                    courses.forEach(course => {
                        const option = document.createElement('option');
                        option.value = course.id;
                        option.textContent = course.fullname || course.shortname || 'Unnamed Course';
                        courseSelect.appendChild(option);
                    });
                }
            }
            
            // Populate teachers dropdown
            const teacherSelect = document.getElementById('lectureTeacher');
            if (teacherSelect) {
                teacherSelect.innerHTML = '<option value="">Select Teacher</option>';
                if (teachers.length > 0) {
                    teachers.forEach(teacher => {
                        const option = document.createElement('option');
                        option.value = teacher.id || teacher.userid;
                        const fullname = teacher.fullname || (teacher.firstname + ' ' + teacher.lastname).trim() || 'Unknown';
                        option.textContent = fullname;
                        teacherSelect.appendChild(option);
                    });
                }
            }
            
            // Populate filter dropdowns
            const filterCourse = document.getElementById('filterCourse');
            if (filterCourse) {
                filterCourse.innerHTML = '<option value="all">All Courses</option>';
                if (courses.length > 0) {
                    courses.forEach(course => {
                        const option = document.createElement('option');
                        option.value = course.id;
                        option.textContent = course.fullname || course.shortname || 'Unnamed Course';
                        filterCourse.appendChild(option);
                    });
                }
            }
            
            const filterTeacher = document.getElementById('filterTeacher');
            if (filterTeacher) {
                filterTeacher.innerHTML = '<option value="all">All Teachers</option>';
                if (teachers.length > 0) {
                    teachers.forEach(teacher => {
                        const option = document.createElement('option');
                        option.value = teacher.id || teacher.userid;
                        const fullname = teacher.fullname || (teacher.firstname + ' ' + teacher.lastname).trim() || 'Unknown';
                        option.textContent = fullname;
                        filterTeacher.appendChild(option);
                    });
                }
            }
        }
    
    // Load teachers for selected course
    window.loadCourseTeachers = function(courseId) {
        const teacherSelect = document.getElementById('lectureTeacher');
        const errorMessage = document.getElementById('teacherErrorMessage');
        
        if (!teacherSelect) return;
        
        // Reset teacher dropdown
        teacherSelect.innerHTML = '<option value="">Select Teacher</option>';
        teacherSelect.disabled = false;
        
        // Hide error message initially
        if (errorMessage) {
            errorMessage.style.display = 'none';
        }
        
        if (!courseId || courseId === '') {
            return Promise.resolve();
        }
        
        // Show loading state
        teacherSelect.disabled = true;
        teacherSelect.innerHTML = '<option value="">Loading teachers...</option>';
        
        const API_BASE = window.CALENDAR_API_BASE || '{{{config.wwwroot}}}/theme/remui_kids/school_manager/calendar_management.php';
        const SESSKEY = window.CALENDAR_SESSKEY || '{{sesskey}}';
        
        return fetch(`${API_BASE}?action=get_course_teachers&course_id=${courseId}&sesskey=${SESSKEY}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                teacherSelect.innerHTML = '<option value="">Select Teacher</option>';
                teacherSelect.disabled = false;
                
                if (data.status === 'success' && data.teachers && data.teachers.length > 0) {
                    // Populate teachers dropdown
                    data.teachers.forEach(teacher => {
                        const option = document.createElement('option');
                        option.value = teacher.id;
                        option.textContent = teacher.fullname || (teacher.firstname + ' ' + teacher.lastname).trim() || 'Unknown';
                        teacherSelect.appendChild(option);
                    });
                    
                    // Hide error message
                    if (errorMessage) {
                        errorMessage.style.display = 'none';
                    }
                } else {
                    // No teachers found - show error message
                    if (errorMessage) {
                        errorMessage.style.display = 'block';
                    }
                    teacherSelect.disabled = true;
                }
            })
            .catch(error => {
                console.error('Error loading course teachers:', error);
                teacherSelect.innerHTML = '<option value="">Error loading teachers</option>';
                teacherSelect.disabled = true;
                if (errorMessage) {
                    errorMessage.style.display = 'block';
                }
                throw error; // Re-throw to allow chaining
            });
    };
    
    // Note: All global functions (saveEvent, saveLectureSchedule, showEventDetailsModal, etc.) 
    // are defined above, outside DOMContentLoaded block
    
    // Note: showDayEvents and applyFilters are defined above as global functions
    
    // Close modals when clicking outside
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal-overlay')) {
            e.target.style.display = 'none';
        }
    });
    
    // Initial load of calendar data when page loads
    if (typeof window.loadCalendarData === 'function') {
        window.loadCalendarData();
    }
});
</script>

<!-- Dashboard with sidebar -->
</div> <!-- End school-dashboard-container -->

<!-- Default Moodle Page Content -->
<div class="default-moodle-content" style="padding: 20px; background: #f8fafc; margin-top: 30px; border-radius: 12px;">
    <div id="region-main-box" class="d-print-block">
        <section id="region-main" class="d-print-block" aria-label="Content">
            {{{ output.course_content_header }}}
            <div class="rui-course-content">
                {{{ output.main_content }}}
    </div>
            {{{ output.course_content_footer }}}
        </section>
    </div>
</div>

</div> <!-- End school-manager-main-content -->

{{> theme_remui/common_end}}
