
{{!
    Teacher Dashboard Template for remui_kids theme
    
    This template provides a teacher dashboard interface with course management,
    student tracking, and assignment monitoring capabilities.
}}

{{> theme_remui_kids/common_start}}

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

<!-- Teacher Schedule CSS -->
<link rel="stylesheet" href="{{config.wwwroot}}/theme/remui_kids/style/teacher_schedule.css">
<style>

.teacher-dashboard-wrapper .resources-list .resource-item {
    cursor: pointer;
}

.teacher-dashboard-wrapper .resources-list .resource-item:focus {
    outline: 2px solid #3b82f6;
    outline-offset: 2px;
}

.teacher-dashboard-wrapper .resources-list .resource-actions button {
    border: none;
    background: none;
    padding: 0;
    cursor: pointer;
}

.teacher-dashboard-wrapper .resources-list .resource-actions button .fa {
    pointer-events: none;
}

/* Resource Preview Modal */
.ppt-player-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    z-index: 10500;
    padding: 20px;
}

.ppt-player-modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
}

.ppt-player-content {
    background: #ffffff;
    border-radius: 12px;
    width: 100%;
    max-width: 1200px;
    height: 90vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 25px 50px rgba(15, 23, 42, 0.35);
}

.ppt-player-header {
    padding: 20px 30px;
    background: #f8f9fa;
    border-bottom: 2px solid #e2e8f0;
    border-radius: 12px 12px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.ppt-player-title {
    font-size: 20px;
    font-weight: 600;
    color: #1f2937;
    margin: 0;
}

.ppt-player-close {
    background: none;
    border: none;
    font-size: 28px;
    color: #475569;
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    transition: all 0.2s ease;
}

.ppt-player-close:hover {
    background: #e2e8f0;
    color: #111827;
}

.ppt-player-body {
    flex: 1;
    padding: 20px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.ppt-player-iframe {
    width: 100%;
    height: 100%;
    border: none;
    border-radius: 8px;
    background: #0f172a;
}

.ppt-spreadsheet-container {
    flex: 1;
    width: 100%;
    overflow: auto;
    background: #ffffff;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
    padding: 16px;
}

.ppt-spreadsheet-container table {
    width: 100%;
    border-collapse: collapse;
}

.ppt-spreadsheet-container th,
.ppt-spreadsheet-container td {
    border: 1px solid #e2e8f0;
    padding: 6px 8px;
    font-size: 13px;
}

.spreadsheet-error {
    color: #b91c1c;
}

.spreadsheet-loading {
    color: #475569;
    font-style: italic;
}
.ppt-player-content{
    margin-top:4%;
}
.maincalendar{
    background: #ffff;
    padding: 1%;
    border-radius: 1%;
}

/* Competency name and code truncation */
.competency-info {
    width: 100%;
    max-width: 100%;
    overflow: hidden;
    min-width: 0;
}

.competency-code,
.competency-name {
    max-width: 100%;
    width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    word-break: break-word;
    display: block;
    box-sizing: border-box;
}

.competency-item {
    min-width: 0; /* Allows flex items to shrink below content size */
    max-width: 100%;
    width: 100%;
    overflow: hidden;
    box-sizing: border-box;
}

.competency-chart-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    width: 100%;
}

/* Tier Cards Container - Infographic Style */
.tier-cards-container {
    margin-bottom: 5rem;
    width: 100%;
    padding: 2rem 2rem 3rem 2rem;
    position: relative;
    min-height: 300px;
    background: linear-gradient(135deg, #faf8ff 0%, #f0f4ff 50%, #fef7f0 100%);
    border: 1px solid #e8e5f3;
    border-radius: 16px;
}

.tier-cards-grid {
    display: grid;
    grid-template-columns: 1fr auto 1fr auto 1fr;
    gap: 2.5rem;
    align-items: flex-start;
    justify-items: center;
    width: 100%;
    max-width: 1450px;
    margin: 0 auto;
    padding-bottom: 3rem;
    position: relative;
    z-index: 2;
}

/* Flow Arrow Between Cards - Curved Connector */
.tier-card-arrow-between {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 80px;
    height: 100%;
    flex-shrink: 0;
    position: relative;
}

.flow-arrow {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 3px;
    background: linear-gradient(90deg, #e8e5f3 0%, #d4c5e8 50%, #e8e5f3 100%);
    position: relative;
    transition: all 0.3s ease;
}

.flow-arrow::after {
    content: '';
    position: absolute;
    right: -8px;
    top: 50%;
    transform: translateY(-50%);
    width: 0;
    height: 0;
    border-left: 8px solid #d4c5e8;
    border-top: 6px solid transparent;
    border-bottom: 6px solid transparent;
    transition: all 0.3s ease;
}

.flow-arrow:hover {
    background: linear-gradient(90deg, #b8a9d9 0%, #a599d1 50%, #b8a9d9 100%);
}

.flow-arrow:hover::after {
    border-left-color: #a599d1;
    right: -10px;
}

/* Tier Card Base Styles - Infographic Dotted Border Design */
.tier-card {
    background: #ffffff;
    border: 3px dotted #e8e5f3;
    border-radius: 0 25px 0 25px;
    position: relative;
    padding: 2rem 2rem 2rem 1.5rem;
    transition: all 0.3s ease;
    cursor: pointer;
    min-width: 320px;
    max-width: 380px;
    width: 100%;
    display: flex;
    flex-direction: column;
    box-shadow: 0 2px 8px rgba(184, 169, 217, 0.06);
    overflow: visible;
}

/* Solid Corner Brackets - Top Right and Bottom Left - More Circular & Bold */
.tier-card::before {
    content: '';
    position: absolute;
    top: -3px;
    right: -3px;
    width: 70px;
    height: 70px;
    border-right: 7px solid;
    border-top: 7px solid;
    border-radius: 0 25px 0 0;
    background: #ffffff;
    transition: all 0.3s ease;
    z-index: 1;
}

.tier-card::after {
    content: '';
    position: absolute;
    bottom: -3px;
    left: -3px;
    width: 70px;
    height: 70px;
    border-left: 7px solid;
    border-bottom: 7px solid;
    border-radius: 0 0 0 25px;
    background: #ffffff;
    transition: all 0.3s ease;
    z-index: 1;
}

/* Planning Card - Step 1 - Soft Lavender Theme */
.tier-card-planning {
    border-color: #e8e5f3;
}

.tier-card-planning::before,
.tier-card-planning::after {
    border-color: #dbeafe;
}

/* Resources Card - Step 2 - Soft Mint Theme */
.tier-card-resources {
    border-color: #e5f3f0;
}

.tier-card-resources::before,
.tier-card-resources::after {
    border-color: #e9d5ff;
}

/* Assessments Card - Step 3 - Soft Peach Theme */
.tier-card-assessments {
    border-color: #f3e8e5;
}

.tier-card-assessments::before,
.tier-card-assessments::after {
    border-color: #dbeafe;
}

/* Hover Effects */
.tier-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 20px rgba(184, 169, 217, 0.12);
}

.tier-card:hover::before,
.tier-card:hover::after {
    width: 80px;
    height: 80px;
}

/* Active State */
.tier-card.active {
    border-color: currentColor;
    box-shadow: 0 12px 32px rgba(184, 169, 217, 0.15);
    z-index: 9999;
    position: relative;
}

.tier-card-1.active {
    border-color: #dbeafe;
}

.tier-card-2.active {
    border-color: #e9d5ff;
}

.tier-card-3.active {
    border-color: #dbeafe;
}

/* Card Content Layout - Horizontal with Icon, Divider, and Content */
.tier-card-content {
    display: flex;
    align-items: flex-start;
    gap: 1.5rem;
    padding: 0;
    min-height: auto;
    background: transparent;
    border-radius: 0;
    position: relative;
    z-index: 2;
}

/* Icon Section - Left Side */
.tier-card-icon-section {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    padding-top: 0.5rem;
}

/* Vertical Divider Line */
.tier-card-divider {
    width: 3px;
    min-height: 120px;
    height: 100%;
    background: #f0e8f7;
    flex-shrink: 0;
    border-radius: 2px;
    align-self: stretch;
}

.tier-card-1 .tier-card-divider {
    background: linear-gradient(to bottom, #dbeafe, rgba(219, 234, 254, 0.3));
}

.tier-card-2 .tier-card-divider {
    background: linear-gradient(to bottom, #e9d5ff, rgba(233, 213, 255, 0.3));
}

.tier-card-3 .tier-card-divider {
    background: linear-gradient(to bottom, #dbeafe, rgba(219, 234, 254, 0.3));
}

.tier-card-icon {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    transition: all 0.3s ease;
    border: 4px solid;
    background: #ffffff;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.tier-card-1 .tier-card-icon {
    border-color: #dbeafe;
    color: #2563eb;
    background: #ffffff;
}

.tier-card-2 .tier-card-icon {
    border-color: #e9d5ff;
    color: #9333ea;
    background: #ffffff;
}

.tier-card-3 .tier-card-icon {
    border-color: #dbeafe;
    color: #2563eb;
    background: #ffffff;
}

.tier-card:hover .tier-card-icon {
    transform: scale(1.1);
    box-shadow: 0 6px 16px rgba(184, 169, 217, 0.12);
}

/* Content Section - Right Side */
.tier-card-body {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    padding-top: 0.5rem;
}

.tier-card-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1e293b;
    margin: 0;
    text-transform: uppercase;
    letter-spacing: 1px;
    line-height: 1.2;
}

.tier-card-description {
    font-size: 0.875rem;
    color: #64748b;
    margin: 0;
    line-height: 1.7;
    font-weight: 400;
}

/* Subsection Style - Appears Outside Card */
.tier-cards-container {
    position: relative;
    overflow: visible;
    width: 100%;
}

.tier-cards-grid {
    position: relative;
}

.tier-card-subsection {
    position: absolute;
    top: calc(100% + 0.5rem);
    left: 50%;
    transform: translateX(-50%) translateY(-10px);
    width: 95%;
    max-width: 1600px;
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease, padding 0.3s ease, opacity 0.3s ease, transform 0.3s ease;
    background: #ffffff;
    border: 2px solid #f0e8f7;
    border-radius: 8px;
    padding: 0;
    opacity: 0;
    z-index: 10000;
    box-shadow: 0 8px 24px rgba(184, 169, 217, 0.12);
    pointer-events: none;
    box-sizing: border-box;
}

/* Center all subsections at the same position relative to container */
.tier-cards-container {
    position: relative;
}

@media (max-width: 768px) {
    .tier-card-subsection {
        width: calc(100% - 2rem);
        left: 50% !important;
        transform: translateX(-50%) translateY(-10px);
    }
}

.tier-card.active .tier-card-subsection {
    max-height: 600px;
    padding: 1.5rem;
    opacity: 1;
    pointer-events: auto;
    width: 95%;
    max-width: 1600px;
    transform: translateX(-50%) translateY(0);
}

.subsection-content {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    width: 100%;
    max-width: 100%;
}

.subsection-link {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.875rem 1rem;
    border-radius: 6px;
    background: #faf8ff;
    color: #6b5b95;
    text-decoration: none;
    font-weight: 500;
    font-size: 0.9rem;
    transition: all 0.2s ease;
    border: 1px solid #f0e8f7;
    position: relative;
    box-shadow: 0 1px 3px rgba(184, 169, 217, 0.05);
}

.subsection-link i:first-child {
    font-size: 1rem;
    color: #a599d1;
    width: 20px;
    text-align: center;
}

.subsection-link span {
    flex: 1;
}

.subsection-arrow {
    font-size: 0.75rem;
    color: #d4c5e8;
    transition: transform 0.2s ease;
}

.subsection-link:hover {
    background: #ffffff;
    color: #8b7ab8;
    text-decoration: none;
    border-color: #8b7ab8;
    transform: translateX(4px);
    box-shadow: 0 2px 6px rgba(139, 122, 184, 0.15);
}

.subsection-link:hover i:first-child {
    color: #8b7ab8;
}

.subsection-link:hover .subsection-arrow {
    color: #8b7ab8;
    transform: translateX(4px);
}

/* Step-specific subsection styling */
.tier-card-1.active .tier-card-subsection {
    border-color: #dbeafe;
    border-top-width: 3px;
}

.tier-card-2.active .tier-card-subsection {
    border-color: #e9d5ff;
    border-top-width: 3px;
}

.tier-card-3.active .tier-card-subsection {
    border-color: #dbeafe;
    border-top-width: 3px;
}

.tier-card.active .tier-card-icon {
    transform: scale(1.15);
    box-shadow: 0 6px 20px rgba(184, 169, 217, 0.12);
}

/* Resource Category Cards - Horizontal Layout */
.resource-category-cards-container {
    display: flex;
    flex-direction: row;
    gap: 2rem;
    width: 100%;
    max-width: 100%;
    margin-bottom: 1.5rem;
    padding: 0;
    box-sizing: border-box;
}

.resource-category-card {
    flex: 1;
    position: relative;
    display: flex;
    background: #ffffff;
    border: 2px solid #2563eb;
    border-radius: 8px;
    padding: 2rem;
    cursor: pointer;
    transition: all 0.2s ease;
    min-height: 120px;
    align-items: center;
    justify-content: center;
    text-align: center;
    box-sizing: border-box;
}

.resource-category-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
    border-color: #1d4ed8;
}

.resource-category-card-checkbox {
    position: absolute;
    opacity: 0;
    pointer-events: none;
}

.resource-category-card-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
    width: 100%;
}

.resource-category-card-title {
    display: block;
    font-size: 1rem;
    font-weight: 600;
    color: #1e293b;
    margin: 0;
}

.resource-category-card-count {
    display: block;
    font-size: 0.75rem;
    color: #64748b;
    font-style: normal;
    margin: 0;
}

.resource-category-card-checkbox:checked + .resource-category-card-content {
    opacity: 0.7;
}

.resource-category-card-checkbox:checked ~ .resource-category-card::before,
.resource-category-card:has(.resource-category-card-checkbox:checked) {
    background: #eff6ff;
    border-color: #1d4ed8;
}

.resource-category-card:has(.resource-category-card-checkbox:checked) {
    background: #eff6ff;
    border-color: #1d4ed8;
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

/* Ensure content below tier cards has lower z-index */
.schedule-sessions-grid,
.recent-submissions-grid,
.community-doubts-grid,
.course-statistics-section,
.competency-analytics-section,
.best-students-section {
    position: relative;
    z-index: 1;
}

/* Schedule List View Styles */
.schedule-list-view-container {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    padding: 0.5rem 0;
}

.schedule-list-item {
    background: #ffffff;
    border-radius: 12px;
    padding: 0.875rem 1.25rem;
    display: flex;
    align-items: flex-start;
    gap: 1.25rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    transition: all 0.2s ease;
    position: relative;
    min-height: auto;
}

.schedule-list-item:hover {
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    transform: translateY(-1px);
}

/* Date Section - Left Side */
.schedule-item-date {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 80px;
    flex-shrink: 0;
    padding-right: 1.5rem;
    position: relative;
}

.schedule-item-date::after {
    content: '';
    position: absolute;
    right: 0;
    top: 0;
    bottom: 0;
    width: 1px;
    background: #e5e7eb;
}

.date-day {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1e293b;
    line-height: 1;
    margin-bottom: 0.25rem;
    text-align: center;
}

.date-month-year {
    font-size: 0.7125rem;
    font-weight: 500;
    color: #94a3b8;
    line-height: 1.2;
    text-align: center;
}

/* Content Wrapper - Center */
.schedule-item-content-wrapper {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    position: relative;
    padding-right: 2.5rem;
}

.schedule-item-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 0.75rem;
}

.schedule-item-title {
    font-size: 0.75rem;
    font-weight: 600;
    color: #1e293b;
    line-height: 1.3;
    flex: 1;
    min-width: 0;
}

.schedule-event-type-badge {
    font-size: 0.60rem;
    font-weight: 600;
    padding: 0.375rem 0.75rem;
    border-radius: 6px;
    background: #e9d5ff; /* Default lavender - will be overridden by inline style */
    color: white;
    white-space: nowrap;
    flex-shrink: 0;
    text-transform: capitalize;
}

.schedule-item-description {
    font-size: 0.875rem;
    color: #64748b;
    line-height: 1.4;
    margin-top: 0.125rem;
}

.schedule-item-time-range {
    font-size: 0.675rem;
    color: #1e293b;
    font-weight: 500;
    margin-top: auto;
    text-align: right;
}

.schedule-item-actions {
    flex-shrink: 0;
    position: absolute;
    top: 0;
    right: 0;
}

.lecture-item {
    /* Border color will be set inline dynamically */
}

.admin-event-item {
    /* Border color will be set inline dynamically */
}

.no-events-message {
    text-align: center;
    padding: 3rem 1rem;
    color: #94a3b8;
}

.no-events-message .fa {
    font-size: 3rem;
    color: #cbd5e1;
    margin-bottom: 1rem;
    display: block;
}

.no-events-message .fa-spinner {
    color: #dbeafe;
}

.no-events-message p {
    font-size: 1rem;
    font-weight: 500;
    color: #64748b;
}

/* Lecture menu button styles for list view */
.schedule-list-item .lecture-menu-btn {
    position: relative;
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 4px;
    color: #64748b;
    font-size: 1.25rem;
    line-height: 1;
    transition: all 0.2s ease;
}

.schedule-list-item .lecture-menu-btn:hover {
    background: rgba(0, 0, 0, 0.05);
    color: #334155;
}

.schedule-list-item .lecture-menu-dropdown {
    position: absolute;
    top: 100%;
    right: 0;
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
    z-index: 100000;
    min-width: 140px;
    margin-top: 4px;
    overflow: hidden;
    padding: 4px 0;
}

/* Fixed sizes for schedule views */
.schedule-week-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    background: #e2e8f0;
    border-radius: 12px;
    overflow: hidden;
    align-items: start; /* Ensure all columns start at the same height */
}

.schedule-day-column,
.calendar-day.schedule-day-column {
    background: #ffffff;
    height: 400px !important;
    min-height: 400px !important;
    max-height: 400px !important;
    padding: 0.75rem;
    display: flex !important;
    flex-direction: column !important;
    width: 100%;
    box-sizing: border-box;
    overflow: hidden; /* Prevent content from expanding the column */
}

.schedule-day-header,
.day-header.schedule-day-header {
    flex-shrink: 0;
    margin-bottom: 0.75rem;
    text-align: center;
    height: auto;
    min-height: auto;
}

.schedule-events-container,
.day-events.schedule-events-container {
    display: flex !important;
    flex-direction: column !important;
    gap: 0.5rem;
    overflow-y: auto !important;
    overflow-x: hidden !important;
    flex: 1 1 auto;
    min-height: 0;
    max-height: calc(400px - 100px) !important; /* Subtract header and padding */
    width: 100%;
    padding-right: 0; /* Ensure scrollbar is on the right edge */
    margin-right: 0;
}

.schedule-events-container::-webkit-scrollbar {
    width: 4px;
}

.schedule-events-container::-webkit-scrollbar-track {
    background: transparent;
    border-radius: 2px;
}

.schedule-events-container::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 2px;
    opacity: 0.5;
}

.schedule-events-container::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
    opacity: 0.7;
}

/* Firefox scrollbar */
.schedule-events-container {
    scrollbar-width: thin;
    scrollbar-color: #cbd5e1 transparent;
}

.schedule-event-card {
    flex-shrink: 0;
    min-height: 80px;
    max-height: 80px;
    overflow: hidden;
}

.schedule-event-title {
    font-size: 0.875rem;
    font-weight: 500;
    color: #1e293b;
    line-height: 1.3;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    margin-bottom: 0.25rem;
}

.schedule-event-title.lecture-title {
    -webkit-line-clamp: 1;
    text-align: center;
}

.schedule-event-course {
    font-size: 0.75rem;
    color: #64748b;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* Month view fixed size - reduced dimensions */
.schedule-month-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    background: #e2e8f0;
    border-radius: 12px;
    overflow: hidden;
}

.schedule-month-day {
    background: #ffffff;
    min-height: 80px !important;
    max-height: 80px !important;
    height: 80px !important;
    padding: 0.375rem;
    display: flex;
    flex-direction: column;
    width: 100%;
    box-sizing: border-box;
    overflow: hidden;
}

.schedule-month-events {
    display: flex;
    flex-direction: column;
    gap: 2px;
    overflow-y: auto;
    overflow-x: hidden;
    flex: 1;
    max-height: calc(80px - 25px) !important; /* Subtract day number height */
    min-height: 0;
}

.schedule-month-events::-webkit-scrollbar {
    width: 3px;
}

.schedule-month-events::-webkit-scrollbar-track {
    background: transparent;
    border-radius: 2px;
}

.schedule-month-events::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 2px;
    opacity: 0.5;
}

.schedule-month-events::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
    opacity: 0.7;
}

/* Firefox scrollbar */
.schedule-month-events {
    scrollbar-width: thin;
    scrollbar-color: #cbd5e1 transparent;
}

/* List view fixed size - matching month view */
.schedule-list-container {
    max-height: 480px;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 0.5rem;
}

.schedule-list-container::-webkit-scrollbar {
    width: 4px;
}

.schedule-list-container::-webkit-scrollbar-track {
    background: transparent;
    border-radius: 2px;
}

.schedule-list-container::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 2px;
    opacity: 0.5;
}

.schedule-list-container::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
    opacity: 0.7;
}

/* Firefox scrollbar */
.schedule-list-container {
    scrollbar-width: thin;
    scrollbar-color: #cbd5e1 transparent;
}

/* Recent Resources fixed size - Increased by 20% height and 10% width */
.recent-resources-section {
    max-height: 600px; /* Increased from 500px (20% more) */
    display: flex;
    flex-direction: column;
}

.resources-list {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    max-height: calc(600px - 80px); /* Subtract header height */
    min-height: 0;
}

.resources-list::-webkit-scrollbar {
    width: 4px;
}

.resources-list::-webkit-scrollbar-track {
    background: transparent;
    border-radius: 2px;
}

.resources-list::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 2px;
    opacity: 0.5;
}

.resources-list::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
    opacity: 0.7;
}

/* Firefox scrollbar */
.resources-list {
    scrollbar-width: thin;
    scrollbar-color: #cbd5e1 transparent;
}

/* Global Search Bar - Higher z-index for search results dropdown */
.teacher-dashboard-wrapper .search-bar-container,
.teacher-dashboard-wrapper .global-search-container {
    position: relative;
    z-index: 1001;
}

/* Tablet Responsive */
@media (max-width: 1200px) and (min-width: 769px) {
    .tier-cards-grid {
        grid-template-columns: 1fr auto 1fr auto 1fr;
        gap: 1.5rem;
    }

    .tier-card {
        min-width: 280px;
        max-width: 320px;
        padding: 2rem 1.5rem;
    }

    .tier-card-arrow-between {
        width: 60px;
    }

    .tier-card-icon {
        width: 60px;
        height: 60px;
        font-size: 1.75rem;
    }

    .tier-card-title {
        font-size: 1.2rem;
    }

    .tier-card-description {
        font-size: 0.85rem;
    }
}

/* Mobile Responsive */
@media (max-width: 768px) {
    .tier-cards-container {
        margin-bottom: 2rem;
        padding: 1.5rem 1rem 2rem 1rem;
        border-radius: 12px;
        min-height: 200px;
    }

    .tier-cards-grid {
        grid-template-columns: 1fr;
        gap: 1.5rem;
    }

    .tier-card-arrow-between {
        display: none; /* Hide arrows on mobile */
    }

    .tier-card {
        min-width: auto;
        max-width: 100%;
        padding: 2rem 1.5rem;
        border-radius: 0 20px 0 20px;
    }

    .tier-card-content {
        flex-direction: row;
        gap: 1rem;
    }

    .tier-card-icon-section {
        padding-top: 0.25rem;
    }

    .tier-card-divider {
        min-height: 100px;
        width: 2px;
    }

    .tier-card-body {
        padding-top: 0.25rem;
    }

    .tier-card-icon {
        width: 60px;
        height: 60px;
        font-size: 1.75rem;
        border-width: 3px;
    }

    .tier-card-title {
        font-size: 1.15rem;
    }

    .tier-card-description {
        font-size: 0.8rem;
    }

    .tier-card::before,
    .tier-card::after {
        width: 45px;
        height: 45px;
        border-width: 4px;
    }

    .tier-card:hover::before,
    .tier-card:hover::after {
        width: 50px;
        height: 50px;
    }

    .subsection-link {
        font-size: 0.875rem;
        padding: 0.75rem 0.875rem;
    }

    .subsection-link i:first-child {
        font-size: 0.9rem;
    }
}

/* Recent Submissions - Improved Minimal Design */
.recent-submissions-card .card-header {
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid #f1f5f9;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.recent-submissions-card .card-title {
    display: flex;
    align-items: center;
    gap: 0.625rem;
    font-size: 1rem;
    font-weight: 600;
    color: #1e293b;
}

.recent-submissions-card .card-title i {
    font-size: 1.125rem;
    color: #64748b;
}

.recent-submissions-card .btn-link {
    font-size: 0.875rem;
    color: #3b82f6;
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 0.375rem;
    font-weight: 500;
    transition: color 0.2s ease;
}

.recent-submissions-card .btn-link:hover {
    color: #2563eb;
}

.recent-submissions-card .btn-link i {
    font-size: 0.75rem;
}

.recent-submissions-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.submission-item {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    padding: 1rem 1.25rem;
    border-radius: 14px;
    background: #f8fafc;
    text-decoration: none;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
}

.submission-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 28px rgba(15, 23, 42, 0.12);
}

.submission-left {
    display: flex;
    align-items: flex-start;
    gap: 0.85rem;
    flex: 1;
    min-width: 0;
}

.submission-avatar {
    width: 52px;
    height: 52px;
    border-radius: 14px;
    overflow: hidden;
    flex-shrink: 0;
    background: linear-gradient(135deg, #dbeafe 0%, #f8fafc 100%);
    border: none;
}

.submission-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.submission-details {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    min-width: 0;
}

.submission-details .student-name {
    font-size: 0.95rem;
    font-weight: 700;
    color: #0f172a;
}

.submission-details .assignment-name,
.submission-details .course-name {
    font-size: 0.85rem;
    color: #475569;
    display: flex;
    align-items: center;
    gap: 0.35rem;
    line-height: 1.4;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.submission-details .assignment-name i,
.submission-details .course-name i {
    font-size: 0.75rem;
    color: #94a3b8;
    flex-shrink: 0;
}

.submission-right {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 0.45rem;
    flex-shrink: 0;
}

.submission-time {
    font-size: 0.8rem;
    color: #64748b;
    display: flex;
    align-items: center;
    gap: 0.35rem;
    white-space: nowrap;
}

.submission-time i {
    font-size: 0.75rem;
    color: #94a3b8;
}

.submission-status {
    font-size: 0.8rem;
    font-weight: 600;
    padding: 0.35rem 1rem;
    border-radius: 999px;
    white-space: nowrap;
}

.submission-status.status-submitted {
    background: #ede9fe;
    color: #5b21b6;
}

.submission-status.status-graded {
    background: #dcfce7;
    color: #047857;
}

.submission-status.status-pending {
    background: #e0f2fe;
    color: #0369a1;
}

.submission-status.status-late {
    background: #fee2e2;
    color: #b91c1c;
}

.submission-status.grade-badge {
    background: #fef3c7;
    color: #92400e;
}

.recent-submissions-card .empty-state {
    text-align: center;
    padding: 3rem 2rem;
    color: #94a3b8;
}

.recent-submissions-card .empty-state i {
    font-size: 3rem;
    color: #cbd5e1;
    margin-bottom: 1rem;
    display: block;
}

.recent-submissions-card .empty-state p {
    font-size: 0.9375rem;
    color: #64748b;
    margin: 0;
}

/* Responsive for submission items */
@media (max-width: 768px) {
    .submission-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.75rem;
    }
    
    .submission-right {
        align-items: flex-start;
        margin-left: 0;
        width: 100%;
        flex-direction: row;
        justify-content: space-between;
    }
}

/* Dashboard Analytics Grid - Course Progress 70%, Assignment Statistics 30% */
.dashboard-analytics-grid {
    margin: 2rem 0;
    display: grid;
    grid-template-columns: 70% 30%;
    gap: 1.5rem;
    width: 100%;
}

.assignment-stats-card,
.course-progress-card {
    background: #ffffff;
    border-radius: 16px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    padding: 1.5rem;
    border: 1px solid #f1f5f9;
}

.stats-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.stats-card-title {
    font-size: 1.125rem;
    font-weight: 700;
    color: #1e293b;
    margin: 0;
}

.stats-menu-btn {
    background: none;
    border: none;
    color: #94a3b8;
    cursor: pointer;
    padding: 0.25rem 0.5rem;
    font-size: 1.125rem;
    transition: color 0.2s ease;
}

.stats-menu-btn:hover {
    color: #64748b;
}

.stats-card-body {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1.5rem;
}

.doughnut-chart-container {
    position: relative;
    width: 200px;
    height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.chart-center-label {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    pointer-events: none;
}

.chart-total-number {
    font-size: 2.5rem;
    font-weight: 700;
    color: #1e293b;
    line-height: 1;
    margin-bottom: 0.25rem;
}

.chart-total-label {
    font-size: 0.875rem;
    color: #64748b;
    font-weight: 500;
}

.stats-legend {
    width: 100%;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.875rem;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.legend-color {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    flex-shrink: 0;
}

.legend-label {
    font-size: 0.875rem;
    color: #64748b;
    flex: 1;
}

.legend-value {
    font-size: 0.9375rem;
    font-weight: 700;
    color: #1e293b;
}

/* Course Progress Section */
.course-progress-body {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
    padding-top: 0.5rem;
}

.course-progress-item {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.course-progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.course-progress-name {
    font-size: 0.9375rem;
    color: #1e293b;
    font-weight: 500;
}

.course-progress-percentage {
    font-size: 0.9375rem;
    font-weight: 700;
    color: #1e293b;
}

.course-progress-bar-container {
    width: 100%;
    height: 8px;
    background: #f1f5f9;
    border-radius: 10px;
    overflow: hidden;
}

.course-progress-bar {
    height: 100%;
    border-radius: 10px;
    transition: width 0.3s ease;
}

.overall-completion {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 0.75rem;
    margin-top: 0.5rem;
    border-top: 2px solid #f1f5f9;
}

.overall-label {
    font-size: 0.9375rem;
    color: #64748b;
    font-weight: 500;
}

.overall-percentage {
    font-size: 1.125rem;
    font-weight: 700;
    color: #6366f1;
}

.empty-state-small {
    text-align: center;
    padding: 2rem 1rem;
    color: #94a3b8;
}

.empty-state-small i {
    font-size: 2.5rem;
    color: #cbd5e1;
    margin-bottom: 0.75rem;
    display: block;
}

.empty-state-small p {
    font-size: 0.875rem;
    color: #64748b;
    margin: 0;
}

/* Responsive for analytics grid */
@media (max-width: 1024px) {
    .dashboard-analytics-grid {
        grid-template-columns: 1fr;
        gap: 1.5rem;
    }
}

@media (max-width: 768px) {
    .dashboard-analytics-grid {
        gap: 1rem;
    }
}

</style>
{{#teacher_dashboard}}
<!-- Full Screen Teacher Dashboard Wrapper -->
<div class="teacher-dashboard-wrapper">
    
    {{{sidebar_html}}}

<!-- Main Content Area with Sidebar -->
<div class="teacher-main-content">
    <div class="container-fluid">
        <!-- Statistics Cards Grid -->
        <div class="stats-grid">
            {{#teacher_stats}}
            <!-- Active Courses Card -->
            <div class="stat-card courses-card" id="courses-card">
                <div class="highlight-card-header">
                    <span class="card-icon icon-courses"><i class="fa fa-book"></i></span>
                    <span class="label">Active Courses</span>
                    </div>
                <span class="value" id="total-courses-count">{{total_courses}}</span>
            </div>
            
            <!-- Pending Assignments Card -->
            <div class="stat-card students-card" id="students-card">
                <div class="highlight-card-header">
                    <span class="card-icon icon-pending"><i class="fa fa-clipboard-list"></i></span>
                    <span class="label">Pending Assignments</span>
                    </div>
                <span class="value" id="total-students-count">{{total_students}}</span>
            </div>
            
            <!-- Ungraded Submissions Card -->
            <div class="stat-card assignments-card" id="assignments-card">
                <div class="highlight-card-header">
                    <span class="card-icon icon-ungraded"><i class="fa fa-file-alt"></i></span>
                    <span class="label">Ungraded Assignments</span>
                    </div>
                <span class="value" id="pending-assignments-count">{{pending_assignments}}</span>
            </div>
            
            <!-- Overdue Grades Card -->
            <div class="stat-card grades-card" id="grades-card">
                <div class="highlight-card-header">
                    <span class="card-icon icon-overdue"><i class="fa fa-award"></i></span>
                    <span class="label">Overdue Grades</span>
                    </div>
                <span class="value" id="pending-grades-count">{{pending_grades}}</span>
            </div>
            
            <!-- Teacher Profile Card -->
            <div class="teacher-profile-card">
                <div class="profile-image-container">
                    <img src="{{teacher_profile.teacher_profile_picture}}" alt="{{teacher_profile.teacher_name}}" class="profile-image">
                </div>
                <div class="profile-info">
                    <h4 class="teacher-name">{{teacher_profile.teacher_name}}</h4>
                    <p class="teacher-email">{{teacher_profile.teacher_email}}</p>
                    <div class="profile-stats">
                        <span class="profile-stat-item">
                            <i class="fa fa-graduation-cap"></i>
                            Grades <strong>{{teacher_profile.unique_grades_count}}</strong>
                        </span>
                        <span class="profile-stat-item">
                            <i class="fa fa-users"></i>
                            Students <strong>{{teacher_profile.total_students_count}}</strong>
                        </span>
                    </div>
                </div>
            </div>
            
            {{/teacher_stats}}
        </div>

        <!-- Navigation Tier Cards - Infographic Style -->
        {{#quick_navigation_enabled}}
        <div class="tier-cards-container">
            <div class="tier-cards-grid">
                <!-- Step 1 Card - Planning -->
                <div class="tier-card tier-card-1 tier-card-planning" data-tab="planning">
                    <div class="tier-card-content">
                        <!-- Icon on Left -->
                        <div class="tier-card-icon-section">
                            <div class="tier-card-icon icon-planning">
                                <i class="fa fa-lightbulb"></i>
                            </div>
                        </div>
                        
                        <!-- Vertical Divider Line -->
                        <div class="tier-card-divider"></div>
                        
                        <!-- Content Section -->
                        <div class="tier-card-body">
                            <h3 class="tier-card-title">Plan</h3>
                            <p class="tier-card-description">Organize your lesson plans and curriculum to create engaging educational content.</p>
                        </div>
                    </div>
                    <!-- Planning Subsection -->
                    <div class="tier-card-subsection" id="sub-tabs-planning-cards">
                        <div class="subsection-content">
                            <div class="resource-category-panel" aria-label="Resource categories">
                                <div class="resource-category-cards-container">
                                    {{#resource_categories}}
                                    <label class="resource-category-card" data-category-id="{{id}}" data-category-name="{{name}}">
                                        <input type="checkbox" data-category-id="{{id}}" data-courses='{{{courses_json}}}' class="resource-category-card-checkbox">
                                        <div class="resource-category-card-content">
                                            <strong class="resource-category-card-title">{{name}}</strong>
                                            <em class="resource-category-card-count">{{courses_count}} courses</em>
                                        </div>
                                    </label>
                                    {{/resource_categories}}
                                    {{^resource_categories}}
                                    <p class="resource-category-empty">No categories available yet. Visit the Teacher Resources page to sync your courses.</p>
                                    {{/resource_categories}}
                                </div>
                                <div class="resource-category-course-container">
                                    <div class="resource-category-course-header">Courses</div>
                                    <div class="resource-category-course-items"></div>
                                </div>
                                <button type="button" class="resource-category-view-all" data-view-url="{{config.wwwroot}}/theme/remui_kids/teacher/view_course.php">
                                    View
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Arrow Between Cards -->
                <div class="tier-card-arrow-between">
                    <div class="flow-arrow"></div>
                </div>

                <!-- Step 2 Card - Teaching -->
                <div class="tier-card tier-card-2 tier-card-resources" data-tab="resources">
                    <div class="tier-card-content">
                        <!-- Icon on Left -->
                        <div class="tier-card-icon-section">
                            <div class="tier-card-icon icon-resources">
                                <i class="fa fa-chalkboard-user"></i>
                            </div>
                        </div>
                        
                        <!-- Vertical Divider Line -->
                        <div class="tier-card-divider"></div>
                        
                        <!-- Content Section -->
                        <div class="tier-card-body">
                            <h3 class="tier-card-title">Teach</h3>
                            <p class="tier-card-description">Deliver lessons and share activities that help students learn confidently.</p>
                        </div>
                    </div>
                    <!-- Teaching Subsection -->
                    <div class="tier-card-subsection" id="sub-tabs-resources-cards">
                        <div class="subsection-content">
                            <div class="resource-category-panel" aria-label="Resource categories">
                                <div class="resource-category-cards-container">
                                    {{#resource_categories}}
                                    <label class="resource-category-card" data-category-id="{{id}}" data-category-name="{{name}}">
                                        <input type="checkbox" data-category-id="{{id}}" data-courses='{{{courses_json}}}' class="resource-category-card-checkbox">
                                        <div class="resource-category-card-content">
                                            <strong class="resource-category-card-title">{{name}}</strong>
                                            <em class="resource-category-card-count">{{courses_count}} courses</em>
                                        </div>
                                    </label>
                                    {{/resource_categories}}
                                    {{^resource_categories}}
                                    <p class="resource-category-empty">No categories available yet. Visit the Teacher Resources page to sync your courses.</p>
                                    {{/resource_categories}}
                                </div>
                                <div class="resource-category-course-container">
                                    <div class="resource-category-course-header">Courses</div>
                                    <div class="resource-category-course-items"></div>
                                </div>
                                <button type="button" class="resource-category-view-all" data-view-url="{{config.wwwroot}}/theme/remui_kids/teacher/view_course.php">
                                    View
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Arrow Between Cards -->
                <div class="tier-card-arrow-between">
                    <div class="flow-arrow"></div>
                </div>

                <!-- Step 3 Card - Assessments -->
                <div class="tier-card tier-card-3 tier-card-assessments" data-tab="assessments">
                    <div class="tier-card-content">
                        <!-- Icon on Left -->
                        <div class="tier-card-icon-section">
                            <div class="tier-card-icon">
                                <i class="fa fa-edit"></i>
                            </div>
                        </div>
                        
                        <!-- Vertical Divider Line -->
                        <div class="tier-card-divider"></div>
                        
                        <!-- Content Section -->
                        <div class="tier-card-body">
                            <h3 class="tier-card-title">Assess</h3>
                            <p class="tier-card-description">Manage assignments and quizzes to track progress and provide feedback.</p>
                        </div>
                    </div>
                    <!-- Assessments Subsection -->
                    <div class="tier-card-subsection" id="sub-tabs-assessments-cards">
                        <div class="subsection-content">
                            <div class="resource-category-panel" aria-label="Resource categories">
                                <div class="resource-category-cards-container">
                                    {{#resource_categories}}
                                    <label class="resource-category-card" data-category-id="{{id}}" data-category-name="{{name}}">
                                        <input type="checkbox" data-category-id="{{id}}" data-courses='{{{courses_json}}}' class="resource-category-card-checkbox">
                                        <div class="resource-category-card-content">
                                            <strong class="resource-category-card-title">{{name}}</strong>
                                            <em class="resource-category-card-count">{{courses_count}} courses</em>
                                        </div>
                                    </label>
                                    {{/resource_categories}}
                                    {{^resource_categories}}
                                    <p class="resource-category-empty">No categories available yet. Visit the Teacher Resources page to sync your courses.</p>
                                    {{/resource_categories}}
                                </div>
                                <div class="resource-category-course-container">
                                    <div class="resource-category-course-header">Courses</div>
                                    <div class="resource-category-course-items"></div>
                                </div>
                                <button type="button" class="resource-category-view-all" data-view-url="{{config.wwwroot}}/theme/remui_kids/teacher/view_course.php">
                                    View
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {{/quick_navigation_enabled}}

        <!-- Three Column Layout: Resources, Graph, Schedule -->
        <div class="dashboard-three-column-grid">
            <!-- Recent Resources Section -->
            <div class="recent-resources-section">
                <div class="resources-header-section">
                    <h2 class="resources-title">Recent Resources</h2>
                    <a href="{{config.wwwroot}}/theme/remui_kids/teacher/view_course.php" class="view-resources-link">
                        View All Resources →
                    </a>
                </div>
                
                <div class="resources-list">
                    {{#recent_teacher_resources}}
                    {{#resources}}
                    <div class="resource-item" data-file-type="{{file_type}}" data-file-ext="{{file_type}}" data-file-url="{{view_url}}" data-file-name="{{filename}}"{{#preview_url}} data-preview-url="{{preview_url}}"{{/preview_url}} tabindex="0">
                        <div class="resource-icon-box" style="background: {{icon_bg}};">
                            <i class="fa {{icon_class}}" style="color: {{icon_color}};"></i>
                        </div>
                        <div class="resource-info">
                            <div class="resource-name">{{filename}}</div>
                            <div class="resource-meta">
                                <span class="resource-course">{{course_name}}</span>
                                <span class="resource-meta-separator">•</span>
                                <span class="resource-size">{{filesize}}</span>
                                <span class="resource-meta-separator">•</span>
                                <span class="resource-date">{{uploaded_date}}</span>
                            </div>
                        </div>
                        <div class="resource-actions">
                            <button type="button" class="btn-view btn-preview" title="Preview" aria-label="Preview">
                                <i class="fa fa-play-circle"></i>
                            </button>
                            <a href="{{download_url}}" class="btn-download" title="Download" download>
                                <i class="fa fa-download"></i>
                            </a>
                        </div>
                    </div>
                    {{/resources}}
                    {{/recent_teacher_resources}}
                    
                    {{^recent_teacher_resources}}
                    <div class="empty-resources">
                        <i class="fa fa-folder-open"></i>
                        <p>No recent resources uploaded</p>
                    </div>
                    {{/recent_teacher_resources}}
                </div>
            </div>
            
            <!-- Analytics Graph Section -->
            <div class="analytics-graph-section">
                <div class="graph-header">
                    <h2 class="graph-title">Student Activity Overview</h2>
                    <div class="graph-legend">
                        <span class="legend-item">
                            <span class="legend-dot" style="background: #8b5cf6;"></span>
                            <span class="legend-label">Assignments</span>
                        </span>
                        <span class="legend-item">
                            <span class="legend-dot" style="background: #3b82f6;"></span>
                            <span class="legend-label">Quizzes</span>
                        </span>
                    </div>
                </div>
                <div class="graph-container">
                    <canvas id="activityLineChart" width="400" height="340"></canvas>
                </div>
                <div class="graph-summary">
                    <div class="summary-item">
                        <span class="summary-label">This Week</span>
                        <span class="summary-value" style="color: #8b5cf6;">+12%</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Avg. Score</span>
                        <span class="summary-value" style="color: #3b82f6;">85%</span>
                    </div>
                </div>
            </div>
            
            <!-- Upcoming Schedule Section -->
            <div class="schedule-section">
                <div class="schedule-header">
                    <h2 class="schedule-title">Upcoming Schedule</h2>
                    <a href="{{config.wwwroot}}/theme/remui_kids/teacher/schedule.php" class="view-schedule-link">
                        View Full Calendar →
                    </a>
                </div>
                
                {{#teacher_schedule}}
                <div class="schedule-calendar">
                    <div class="schedule-list-view-container">
                        <div class="no-events-message" id="scheduleLoadingMessage">
                            <i class="fa fa-spinner fa-spin"></i>
                            <p>Loading schedule...</p>
                        </div>
                    </div>
                </div>
                {{/teacher_schedule}}
                
                {{^teacher_schedule}}
                <div class="empty-schedule">
                    <i class="fa fa-calendar"></i>
                    <p>No schedule data available</p>
                </div>
                {{/teacher_schedule}}
            </div>
        </div>
        
        <!-- Course Progress and Assignment Statistics Grid -->
        <div class="dashboard-analytics-grid">
            <!-- Course Progress Section -->
            <div class="course-progress-card">
                <div class="stats-card-header">
                    <h3 class="stats-card-title">Course Progress</h3>
                </div>
                <div class="course-progress-body">
                    {{#course_progress_data.courses}}
                    <div class="course-progress-item">
                        <div class="course-progress-header">
                            <span class="course-progress-name">{{name}}</span>
                            <span class="course-progress-percentage">{{percentage}}%</span>
                        </div>
                        <div class="course-progress-bar-container">
                            <div class="course-progress-bar" style="width: {{percentage}}%; background: {{color}};"></div>
                        </div>
                    </div>
                    {{/course_progress_data.courses}}
                    {{^course_progress_data.courses}}
                    <div class="empty-state-small">
                        <i class="fa fa-chart-line"></i>
                        <p>No course progress data available</p>
                    </div>
                    {{/course_progress_data.courses}}

                    {{#course_progress_data.overall}}
                    <div class="overall-completion">
                        <span class="overall-label">Overall Completion</span>
                        <span class="overall-percentage">{{percentage}}%</span>
                    </div>
                    {{/course_progress_data.overall}}
                </div>
            </div>
            
            <!-- Assignment Statistics Section -->
            <div class="assignment-stats-card">
                <div class="stats-card-header">
                    <h3 class="stats-card-title">Assignment Statistics</h3>
                </div>
                <div class="stats-card-body">
                    <div class="doughnut-chart-container">
                        <canvas id="assignmentStatsChart"></canvas>
                        <div class="chart-center-label">
                            <div class="chart-total-number" id="assignmentTotalCount">{{#assignment_stats_summary}}{{total}}{{/assignment_stats_summary}}{{^assignment_stats_summary}}0{{/assignment_stats_summary}}</div>
                            <div class="chart-total-label">Total</div>
                        </div>
                    </div>
                    <div class="stats-legend">
                        <div class="legend-item">
                            <span class="legend-color" style="background: #a78bfa;"></span>
                            <span class="legend-label">Submitted</span>
                            <span class="legend-value" id="submittedCount">{{#assignment_stats_summary}}{{submitted}}{{/assignment_stats_summary}}{{^assignment_stats_summary}}0{{/assignment_stats_summary}}</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background: #60a5fa;"></span>
                            <span class="legend-label">Pending</span>
                            <span class="legend-value" id="pendingCount">{{#assignment_stats_summary}}{{pending}}{{/assignment_stats_summary}}{{^assignment_stats_summary}}0{{/assignment_stats_summary}}</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background: #fbbf24;"></span>
                            <span class="legend-label">Overdue</span>
                            <span class="legend-value" id="overdueCount">{{#assignment_stats_summary}}{{overdue}}{{/assignment_stats_summary}}{{^assignment_stats_summary}}0{{/assignment_stats_summary}}</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background: #c084fc;"></span>
                            <span class="legend-label">Graded</span>
                            <span class="legend-value" id="gradedCount">{{#assignment_stats_summary}}{{graded}}{{/assignment_stats_summary}}{{^assignment_stats_summary}}0{{/assignment_stats_summary}}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Recent Submissions Grid -->
        <div class="recent-submissions-grid">
            <!-- Recent Assignment Submissions -->
            <div class="content-card recent-submissions-card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fa fa-file-alt"></i>
                        <span>Recent Assignment Submissions</span>
                    </div>
                    <a href="{{config.wwwroot}}/theme/remui_kids/teacher/assignments.php" class="btn-link">View All</a>
                </div>
                <div class="card-content">
                    {{#recent_assignment_submissions}}
                    <div class="modern-table-container">
                        <table class="modern-submissions-table">
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Assignment</th>
                                    <th>Course</th>
                                    <th>Time</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{#submissions}}
                                <tr class="table-row-clickable" onclick="window.location.href='{{config.wwwroot}}/theme/remui_kids/teacher/grade_assignment.php?id={{assignment_id}}'">
                                    <td>
                                        <div class="table-student-info">
                                            <img src="{{student_avatar}}" alt="{{student_name}}" class="table-avatar" onerror="this.src='{{config.wwwroot}}/user/pix.php/1/f1.jpg'">
                                            <span class="table-student-name">{{student_name}}</span>
                                        </div>
                                    </td>
                                    <td class="table-assignment-name">{{assignment_name}}</td>
                                    <td class="table-course-name">{{course_fullname}}</td>
                                    <td class="table-time">{{time_ago}}</td>
                                    <td>
                                        <span class="table-status {{status_class}}">{{status}}</span>
                                    </td>
                                </tr>
                                {{/submissions}}
                            </tbody>
                        </table>
                    </div>
                    {{/recent_assignment_submissions}}
                    {{^recent_assignment_submissions}}
                    <div class="empty-state">
                        <i class="fa fa-inbox"></i>
                        <p>No recent assignment submissions</p>
                    </div>
                    {{/recent_assignment_submissions}}
                </div>
            </div>

            <!-- Recent Quiz Completions -->
            <div class="content-card recent-submissions-card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fa fa-question-circle"></i>
                        <span>Recent Quiz Completions</span>
                    </div>
                    <a href="{{config.wwwroot}}/theme/remui_kids/teacher/quizzes.php" class="btn-link">View All</a>
                </div>
                <div class="card-content">
                    {{#recent_quiz_completions}}
                    <div class="modern-table-container">
                        <table class="modern-submissions-table">
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Quiz</th>
                                    <th>Course</th>
                                    <th>Time</th>
                                    <th>Grade</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{#completions}}
                                <tr class="table-row-clickable" onclick="window.location.href='{{config.wwwroot}}/theme/remui_kids/teacher/quiz_review.php?attemptid={{attempt_id}}'">
                                    <td>
                                        <div class="table-student-info">
                                            <img src="{{student_avatar}}" alt="{{student_name}}" class="table-avatar" onerror="this.src='{{config.wwwroot}}/user/pix.php/1/f1.jpg'">
                                            <span class="table-student-name">{{student_name}}</span>
                                        </div>
                                    </td>
                                    <td class="table-assignment-name">{{quiz_name}}</td>
                                    <td class="table-course-name">{{course_fullname}}</td>
                                    <td class="table-time">{{time_ago}}</td>
                                    <td>
                                        {{#is_graded}}
                                        <span class="table-status grade-badge">{{grade_percentage}}%</span>
                                        {{/is_graded}}
                                        {{^is_graded}}
                                        <span class="table-status status-submitted">{{status}}</span>
                                        {{/is_graded}}
                                    </td>
                                </tr>
                                {{/completions}}
                            </tbody>
                        </table>
                    </div>
                    {{/recent_quiz_completions}}
                    {{^recent_quiz_completions}}
                    <div class="empty-state">
                        <i class="fa fa-inbox"></i>
                        <p>No recent quiz completions</p>
                    </div>
                    {{/recent_quiz_completions}}
                </div>
            </div>
        </div>
        <!-- Community & Doubts Grid -->
        <div class="community-doubts-grid">
            <div class="content-card community-posts-card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fa fa-comments"></i>
                        <span>Recent Community Posts</span>
                    </div>
                    <a href="{{config.wwwroot}}/theme/remui_kids/community.php" class="btn-link">Open Community</a>
                </div>
                <div class="card-content community-posts-list">
                    {{#recent_community_posts.posts}}
                    <div class="community-post-card" data-post-id="{{id}}">
                        <div class="post-header">
                            <div class="post-left">
                                <div class="post-author-info">
                                    <img src="{{author_avatar}}" alt="{{author_name}}" class="post-author-avatar" onerror="this.src='{{config.wwwroot}}/user/pix.php/1/f1.jpg'">
                                    <div class="post-author-details">
                                        <div class="post-author-name">{{author_name}}</div>
                                        <div class="post-date">{{time_ago}}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="post-right">
                                <div class="post-communities">
                                    <span class="community-pill">{{community_name}}</span>
                                    {{#space_name}}
                                    <span class="space-pill">{{space_name}}</span>
                                    {{/space_name}}
                                </div>
                            </div>
                        </div>
                        <div class="post-content">
                            {{#subject}}
                            <div class="post-title">{{subject}}</div>
                            {{/subject}}
                            <div class="post-description">{{message_summary}}</div>
                        </div>
                        <div class="post-actions">
                            <button class="post-action-btn like-btn{{#liked}} liked{{/liked}}" onclick="toggleLike({{id}}, 0)" id="likeBtn-{{id}}">
                                <i class="{{#liked}}fas{{/liked}}{{^liked}}far{{/liked}} fa-heart"></i>
                            </button>
                            <button class="post-action-btn comment-btn" onclick="openCommentModal({{id}})">
                                <i class="far fa-comment"></i>
                            </button>
                            <button class="post-action-btn save-btn{{#saved}} saved{{/saved}}" onclick="toggleSavePost({{id}})" id="saveBtn-{{id}}">
                                <i class="{{#saved}}fas{{/saved}}{{^saved}}far{{/saved}} fa-bookmark"></i>
                            </button>
                        </div>
                    </div>
                    {{/recent_community_posts.posts}}
                    {{^recent_community_posts.posts}}
                    <div class="empty-state small">
                        <i class="fa fa-comments"></i>
                        <p>No community posts yet.</p>
                        <span>Share an update with your peers to see it here.</span>
                    </div>
                    {{/recent_community_posts.posts}}
                </div>
            </div>
            <div class="content-card student-doubts-card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fa fa-question-circle"></i>
                        <span>Student Doubts & Queries</span>
                    </div>
                    <a href="{{config.wwwroot}}/theme/remui_kids/pages/teacher_doubts.php" class="btn-link">View All</a>
                </div>
                <div class="card-content doubts-list">
                    {{#recent_student_doubts.doubts}}
                    <div class="doubt-card">
                        <a href="{{link}}" class="doubt-card-link">
                            <div class="doubt-card-top">
                                <div class="student-profile">
                                    <div class="student-avatar">
                                        <img src="{{student_avatar}}" alt="{{student_name}}" onerror="this.src='{{config.wwwroot}}/user/pix.php/1/f1.jpg'">
                                    </div>
                                    <div class="student-details">
                                        <span class="student-name">{{student_name}}</span>
                                        <span class="doubt-date">{{last_activity}}</span>
                                    </div>
                                </div>
                                <div class="doubt-right">
                                    <span class="doubt-course">{{course_name}}</span>
                                    <span class="doubt-status {{status_class}}">{{status_label}}</span>
                                </div>
                            </div>
                            {{#subject}}
                            <h4 class="doubt-subject">{{subject}}</h4>
                            {{/subject}}
                            {{#message_summary}}
                            <p class="doubt-description">{{message_summary}}</p>
                            {{/message_summary}}
                            <div class="doubt-footer">
                                <span class="doubt-meta">
                                    <i class="fa fa-comments"></i>
                                    {{message_count}} {{#message_count}}replies{{/message_count}}{{^message_count}}reply{{/message_count}}
                                </span>
                            </div>
                        </a>
                    </div>
                    {{/recent_student_doubts.doubts}}
                    {{^recent_student_doubts.doubts}}
                    <div class="empty-state">
                        <i class="fa fa-comment-slash"></i>
                        <h4>No Doubts Yet</h4>
                        <p>Students haven't asked any questions yet.</p>
                    </div>
                    {{/recent_student_doubts.doubts}}
                </div>
            </div>
        </div>
        <!-- Best Performing Students Section -->
        {{#best_students.has_data}}
        <div class="best-students-section">
            <div class="section-header-best-students">
                <div class="students-title-group">
                    <h2 class="students-section-title">
                        Best Performing Students
                    </h2>
                    <div class="course-filter-dropdown">
                        <select id="bestStudentsCourseFilter" class="students-course-select" onchange="loadBestStudents(this.value)">
                            <option value="0">All Courses (Overall)</option>
                            {{#teacher_courses}}
                            <option value="{{id}}">{{shortname}} - {{fullname}}</option>
                            {{/teacher_courses}}
                        </select>
                        <i class="fa fa-chevron-down dropdown-icon"></i>
                    </div>
                </div>
                <p class="students-subtitle">Top performers based on grades, competencies, assignments, and quizzes</p>
            </div>
            
            <div class="best-students-list" id="bestStudentsGrid">
                {{#best_students.students}}
                <a href="{{profile_url}}" class="student-performance-row {{#rank_is_1}}leader-row{{/rank_is_1}}">
                    <div class="rank-badge">
                        <span class="rank-badge-number">{{rank}}</span>
                        </div>
                    <div class="student-info-compact">
                        <div class="student-avatar-small">
                            <img src="{{avatar_url}}" alt="{{fullname}}" onerror="this.src='{{config.wwwroot}}/user/pix.php/1/f1.jpg'">
                        </div>
                        <div class="student-details-compact">
                            <h3 class="student-name-compact">{{fullname}}</h3>
                            <div class="student-email-compact">{{email}}</div>
                        </div>
                    </div>
                    <div class="student-metrics-simple">
                        <div class="metric-simple">
                            <span class="metric-simple-label">Grade</span>
                            <span class="metric-simple-value">{{grade_average}}%</span>
                        </div>
                        <div class="metric-simple">
                            <span class="metric-simple-label">Competency</span>
                            <span class="metric-simple-value">{{competency_rate}}%</span>
                        </div>
                        <div class="metric-simple">
                            <span class="metric-simple-label">Assignments</span>
                            <span class="metric-simple-value">{{assignment_rate}}%</span>
                        </div>
                        <div class="metric-simple">
                            <span class="metric-simple-label">Quizzes</span>
                            <span class="metric-simple-value">{{quiz_average}}%</span>
                        </div>
                    </div>
                    <div class="score-pill">
                        <span class="score-pill-value">{{performance_score}}</span>
                        <span class="score-pill-label">Score</span>
                    </div>
                </a>
                {{/best_students.students}}
            </div>
            
            {{^best_students.students}}
            <div class="empty-best-students">
                <i class="fa fa-user-graduate"></i>
                <p>No student performance data available</p>
            </div>
            {{/best_students.students}}
        </div>
        {{/best_students.has_data}}

    </div> <!-- End container-fluid -->

    <!-- Resource Preview Modal -->
    <div id="teacherResourcePreviewModal" class="ppt-player-modal" aria-hidden="true">
        <div class="ppt-player-content" role="dialog" aria-modal="true" aria-labelledby="teacherResourcePreviewTitle">
            <div class="ppt-player-header">
                <h3 class="ppt-player-title" id="teacherResourcePreviewTitle">Resource Viewer</h3>
                <button class="ppt-player-close" type="button" onclick="closeTeacherResourcePreview()" aria-label="Close preview">×</button>
            </div>
            <div class="ppt-player-body">
                <iframe id="teacherResourcePreviewIframe" class="ppt-player-iframe" src="" title="Resource preview frame"></iframe>
                <div id="teacherResourceSpreadsheetContainer" class="ppt-spreadsheet-container" hidden></div>
                <div class="ppt-player-fallback">
                    <p>If the preview does not load, you can <a id="teacherResourceDownloadLink" href="#" target="_blank" rel="noopener">open the file in a new tab</a>.</p>
                </div>
            </div>
        </div>
    </div>


{{/teacher_dashboard}}

<!-- Comment Modal -->
<div id="commentModal" class="comment-modal">
    <div class="comment-modal-content">
        <div class="comment-modal-header">
            <h3 id="commentPostTitle">Post a Comment</h3>
            <button type="button" class="comment-modal-close" onclick="closeCommentModal()">
                <i class="fa fa-times"></i>
            </button>
        </div>
        <div class="comment-modal-body">
            <input type="hidden" id="commentPostId" value="">
            <textarea id="commentMessage" placeholder="Write your comment here..." rows="4"></textarea>
        </div>
        <div class="comment-modal-footer">
            <button type="button" class="comment-modal-btn comment-modal-cancel" onclick="closeCommentModal()">Cancel</button>
            <button type="button" class="comment-modal-btn comment-modal-submit" onclick="submitComment()">Post Comment</button>
        </div>
    </div>
</div>

<!-- Regular Dashboard Content (fallback) -->
<div class="dashboard-content">
    <div id="region-main-box" class="d-print-block">
        <section id="region-main" class="d-print-block" aria-label="{{#str}}content{{/str}}">
            <div class="rui-course-content">
                {{{ output.main_content }}}
            </div>
        </section>
    </div>
</div>
</div> <!-- End teacher-main-content -->
</div> <!-- End teacher-dashboard-wrapper -->
{{> theme_remui/common_end}}

<!-- All styling moved to teacher_dashboard.scss -->

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>

/* Dashboard Card Styles - REMOVED - Now in teacher_dashboard.scss */
.dashboard-card {
    background-color: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    margin-bottom: 20px;
    border: none;
}

.dashboard-card .card-header {
    background-color: transparent;
    border-bottom: 1px solid #f0f0f0;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.dashboard-card .card-title {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
    color: #333;
}

.dashboard-card .card-body {
    padding: 20px;
}

/* Stat Card Styles */
.teacher-stat-card {
    background-color: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    padding: 20px;
    margin-bottom: 20px;
    position: relative;
    transition: transform 0.3s, box-shadow 0.3s;
}

.teacher-stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

.stat-icon-container {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 15px;
}

.courses-card .stat-icon-container {
    background-color: rgba(54, 162, 235, 0.1);
    color: #36a2eb;
}

.students-card .stat-icon-container {
    background-color: rgba(255, 99, 132, 0.1);
    color: #ff6384;
}

.assignments-card .stat-icon-container {
    background-color: rgba(255, 206, 86, 0.1);
    color: #ffce56;
}

.classes-card .stat-icon-container {
    background-color: rgba(75, 192, 192, 0.1);
    color: #4bc0c0;
}

.stat-number {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 5px;
}

.stat-label {
    font-size: 14px;
    color: #666;
    margin-bottom: 10px;
}

.stat-change {
    font-size: 12px;
    font-weight: 600;
}

.stat-change.positive {
    color: #28a745;
}

.stat-change.negative {
    color: #dc3545;
}

/* Progress Styles */
.progress-container {
    margin-bottom: 15px;
}

.progress-info {
    display: flex;
    justify-content: space-between;
    margin-bottom: 5px;
}

.progress-label {
    font-weight: 600;
}

.progress-value {
    font-weight: 700;
}

.progress {
    height: 10px;
    background-color: #f0f0f0;
    border-radius: 5px;
    overflow: hidden;
}

.progress-bar {
    height: 100%;
    border-radius: 5px;
}

/* Top Lists Styles */
.top-students-list, .top-courses-list {
    margin-top: 10px;
}

.student-item, .course-item {
    display: flex;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid #f0f0f0;
}

.student-item:last-child, .course-item:last-child {
    border-bottom: none;
}

.student-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    overflow: hidden;
    margin-right: 15px;
    box-shadow: none !important;
}

.student-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.course-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: #f0f0f0;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 15px;
    color: #666;
}

.student-info, .course-info {
    flex: 1;
}

.student-name, .course-name {
    font-weight: 600;
    margin-bottom: 3px;
}

.student-score, .course-enrollment {
    font-size: 14px;
    color: #666;
}

/* Feedback Styles */
.feedback-overview {
    display: flex;
    flex-direction: column;
}

.rating-summary {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 20px;
}

.rating-number {
    font-size: 48px;
    font-weight: 700;
    line-height: 1;
    margin-bottom: 5px;
}

.rating-stars {
    color: #ffc107;
    margin-bottom: 5px;
}

.rating-count {
    font-size: 14px;
    color: #666;
}

.rating-breakdown {
    margin-top: 15px;
}

.rating-bar {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
}

.rating-label {
    width: 60px;
    font-size: 14px;
}

.rating-bar .progress {
    flex: 1;
    height: 8px;
    margin: 0 10px;
    background-color: #f0f0f0;
}

.rating-bar .progress-bar {
    background-color: #ffc107;
}

.rating-percentage {
    width: 40px;
    text-align: right;
    font-size: 14px;
}

.feedback-list {
    max-height: 300px;
    overflow-y: auto;
}

.feedback-item {
    padding: 15px 0;
    border-bottom: 1px solid #f0f0f0;
}

.feedback-item:last-child {
    border-bottom: none;
}

.feedback-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 5px;
}

.student-name {
    font-weight: 600;
}

.feedback-date {
    font-size: 14px;
    color: #666;
}

.feedback-rating {
    color: #ffc107;
    margin-bottom: 5px;
}

.feedback-comment {
    font-size: 14px;
    color: #333;
}

/* No Data Message Styles */
.no-data-message, .no-courses-message, .no-students-message, .no-assignments-message, .no-feedback-message {
    text-align: center;
    padding: 20px;
    color: #666;
}

.no-data-message i, .no-courses-message i, .no-students-message i, .no-assignments-message i, .no-feedback-message i {
    font-size: 48px;
    margin-bottom: 15px;
    color: #ddd;
}

/* Responsive Styles */
@media (max-width: 768px) {
    .teacher-stats-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
    }
    
    .teacher-stat-card {
        width: 48%;
        margin-bottom: 15px;
    }
    
    .feedback-overview {
        flex-direction: column;
    }
    
    .rating-summary {
        margin-bottom: 20px;
    }
}
*/
</script>

<script>
// Teacher Dashboard JavaScript
// Note: Sidebar is now loaded from sidebar.php via drawers.php

const TEACHER_SPREADSHEET_EXTENSIONS = ['xls', 'xlsx', 'xlsm', 'csv'];
const TEACHER_OFFICE_EXTENSIONS = ['ppt', 'pptx', 'pps', 'ppsx', 'doc', 'docx'];
const TEACHER_LOCAL_HOST_REGEX = /(localhost|127\.0\.0\.1|192\.168\.)/i;
const OFFICE_VIEWER_ENABLED = window.location.protocol === 'https:' && !TEACHER_LOCAL_HOST_REGEX.test(window.location.hostname);
let teacherResourceOriginalUrl = '';

document.addEventListener('DOMContentLoaded', setupRecentResourcePreviews);
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeTeacherResourcePreview();
    }
});

// Dashboard-specific initialization
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Charts
    // Charts removed - now using real activity feed and course overview
    // initializeCharts();
});

function setupRecentResourcePreviews() {
    const resourceItems = document.querySelectorAll('.resources-list .resource-item');
    if (!resourceItems.length) {
        return;
    }

    resourceItems.forEach(item => {
        item.addEventListener('click', function(event) {
            const target = event.target;
            if (target.closest('.btn-download')) {
                return;
            }
            openResourcePreviewFromElement(item);
        });

        item.addEventListener('keydown', function(event) {
            if ((event.key === 'Enter' || event.key === ' ') && !event.target.closest('.resource-actions')) {
                event.preventDefault();
                openResourcePreviewFromElement(item);
            }
        });
    });

            const previewButtons = document.querySelectorAll('.resource-actions .btn-preview');
    previewButtons.forEach(button => {
        button.addEventListener('click', function(event) {
            event.preventDefault();
            event.stopPropagation();
            const item = button.closest('.resource-item');
            // Use same preview handling as view_course.php - no special handling for PowerPoint
            openResourcePreviewFromElement(item);
        });
    });

    const modal = document.getElementById('teacherResourcePreviewModal');
    if (modal) {
        modal.addEventListener('click', function(event) {
            if (event.target === modal) {
                closeTeacherResourcePreview();
            }
        });
    }
}

function openResourcePreviewFromElement(element) {
    if (!element) {
        return;
    }
    const url = element.dataset.fileUrl || '';
    const ext = (element.dataset.fileExt || '').toLowerCase();
    const name = element.dataset.fileName || 'Resource';
    const previewUrl = element.dataset.previewUrl || ''; // Get preview URL if available (for PPT/DOCX)

    if (!url) {
        return;
    }

    // Use same preview handling as view_course.php
    openTeacherResourcePreview(url, name, ext, { previewUrl: previewUrl });
}

function openTeacherResourcePreview(url, title, ext, options = {}) {
    if (!url) {
        return;
    }

    const modal = document.getElementById('teacherResourcePreviewModal');
    const iframe = document.getElementById('teacherResourcePreviewIframe');
    const spreadsheetContainer = document.getElementById('teacherResourceSpreadsheetContainer');
    const titleElement = document.getElementById('teacherResourcePreviewTitle');
    const downloadLink = document.getElementById('teacherResourceDownloadLink');

    const extension = (ext || '').toLowerCase();
    const isSpreadsheet = TEACHER_SPREADSHEET_EXTENSIONS.includes(extension);
    const isPPT = ['ppt', 'pptx', 'pps', 'ppsx'].includes(extension);
    const isDOCX = extension === 'docx';
    const previewUrl = options.previewUrl || '';
    let viewerUrl = url;

    teacherResourceOriginalUrl = url;

    if (downloadLink) {
        downloadLink.href = url;
    }

    // Handle PPT files - show first slide preview (same as view_course.php)
    if (isPPT) {
        if (iframe) {
            iframe.style.display = 'none';
            iframe.src = 'about:blank';
        }
        if (spreadsheetContainer) {
            spreadsheetContainer.hidden = false;
            if (previewUrl) {
                // Show preview image with proper styling (same as view_course.php)
                spreadsheetContainer.innerHTML = 
                    '<div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px; min-height: 500px; display: flex; flex-direction: column; align-items: center; justify-content: center;">' +
                    '<img src="' + escapeHtml(previewUrl) + '" alt="' + escapeHtml(title) + ' - First Slide Preview" ' +
                    'style="max-width: 100%; max-height: 84vh; width: auto; height: auto; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); background: white; padding: 8px; object-fit: contain;" ' +
                    'onerror="this.style.display=\'none\'; this.nextElementSibling.style.display=\'block\';" />' +
                    '<div style="display: none; color: #666; padding: 40px;"><p style="font-size: 16px; margin-bottom: 12px;">Preview image failed to load</p><p style="font-size: 14px;">Click Download to view the full presentation</p></div>' +
                    '</div>' +
                    '<p style="text-align: center; color: #666; margin-top: 16px; font-size: 14px; padding: 0 20px;">First Slide Preview - Click Download button above to view the full presentation</p>';
            } else {
                // No preview available - show sorry message (same as view_course.php)
                spreadsheetContainer.innerHTML = 
                    '<div style="text-align: center; padding: 60px 40px; color: #666; background: #f8f9fa; border-radius: 8px; min-height: 400px; display: flex; flex-direction: column; align-items: center; justify-content: center;">' +
                    '<i class="fa fa-file-powerpoint" style="font-size: 64px; color: #fd7e14; margin-bottom: 20px;"></i>' +
                    '<p style="font-size: 18px; margin-bottom: 12px; font-weight: 600;">Preview not available</p>' +
                    '<p style="font-size: 14px; color: #999;">Click Download button above to view the full presentation</p>' +
                    '</div>';
            }
        }
    } else if (isDOCX) {
        // Handle DOCX files - show first image preview (same as view_course.php)
        if (iframe) {
            iframe.style.display = 'none';
            iframe.src = 'about:blank';
        }
        if (spreadsheetContainer) {
            spreadsheetContainer.hidden = false;
            if (previewUrl) {
                // Show preview image with proper styling (same as view_course.php)
                spreadsheetContainer.innerHTML = 
                    '<div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px; min-height: 500px; display: flex; flex-direction: column; align-items: center; justify-content: center;">' +
                    '<img src="' + escapeHtml(previewUrl) + '" alt="' + escapeHtml(title) + ' - First Page Preview" ' +
                    'style="max-width: 100%; max-height: 84vh; width: auto; height: auto; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); background: white; padding: 8px; object-fit: contain;" ' +
                    'onerror="this.style.display=\'none\'; this.nextElementSibling.style.display=\'block\';" />' +
                    '<div style="display: none; color: #666; padding: 40px;"><p style="font-size: 16px; margin-bottom: 12px;">Preview image failed to load</p><p style="font-size: 14px;">Click Download to view the full document</p></div>' +
                    '</div>' +
                    '<p style="text-align: center; color: #666; margin-top: 16px; font-size: 14px; padding: 0 20px;">First Page Preview - Click Download button above to view the full document</p>';
            } else {
                // No preview available - show sorry message (same as view_course.php)
                spreadsheetContainer.innerHTML = 
                    '<div style="text-align: center; padding: 60px 40px; color: #666; background: #f8f9fa; border-radius: 8px; min-height: 400px; display: flex; flex-direction: column; align-items: center; justify-content: center;">' +
                    '<i class="fa fa-file-word" style="font-size: 64px; color: #007bff; margin-bottom: 20px;"></i>' +
                    '<p style="font-size: 18px; margin-bottom: 12px; font-weight: 600;">Preview not available</p>' +
                    '<p style="font-size: 14px; color: #999;">Click Download button above to view the full document</p>' +
                    '</div>';
            }
        }
    } else if (isSpreadsheet) {
        if (iframe) {
            iframe.style.display = 'none';
            iframe.src = 'about:blank';
        }
        if (spreadsheetContainer) {
            spreadsheetContainer.hidden = false;
            spreadsheetContainer.innerHTML = '<p class="spreadsheet-loading">Loading spreadsheet preview…</p>';
            loadTeacherSpreadsheetPreview(url, spreadsheetContainer);
        }
    } else {
        if (iframe) {
            iframe.style.display = '';
        }
        if (spreadsheetContainer) {
            spreadsheetContainer.hidden = true;
            spreadsheetContainer.innerHTML = '';
        }
        if (TEACHER_OFFICE_EXTENSIONS.includes(extension) && OFFICE_VIEWER_ENABLED) {
            const absoluteUrl = makeAbsoluteUrl(url);
            viewerUrl = 'https://view.officeapps.live.com/op/embed.aspx?src=' + encodeURIComponent(absoluteUrl);
        }
    }

    if (!isSpreadsheet && !isPPT && !isDOCX && iframe) {
        iframe.src = viewerUrl;
    }

    if (titleElement) {
        titleElement.textContent = title;
    }

    if (modal) {
        modal.classList.add('active');
        modal.setAttribute('aria-hidden', 'false');
    }
    document.body.style.overflow = 'hidden';
}

async function loadTeacherSpreadsheetPreview(url, container) {
    if (!container) {
        return;
    }
    if (typeof XLSX === 'undefined') {
        container.innerHTML = '<p class="spreadsheet-error">Spreadsheet preview requires XLSX library. <a href="' + teacherResourceOriginalUrl + '" target="_blank" rel="noopener">Open the file in a new tab</a>.</p>';
        return;
    }

    try {
        const response = await fetch(url, { credentials: 'same-origin' });
        if (!response.ok) {
            throw new Error('HTTP ' + response.status);
        }
        const arrayBuffer = await response.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: 'array' });

        let html = '';
        workbook.SheetNames.forEach(sheetName => {
            const worksheet = workbook.Sheets[sheetName];
            const sheetHtml = XLSX.utils.sheet_to_html(worksheet, {
                header: '<h3>' + escapeHtml(sheetName) + '</h3>'
            });
            html += '<div class="sheet-block">' + sheetHtml + '</div>';
        });

        container.innerHTML = html;
    } catch (error) {
        container.innerHTML = '<p class="spreadsheet-error">Unable to preview this spreadsheet. <a href="' +
            teacherResourceOriginalUrl + '" target="_blank" rel="noopener">Open the file in a new tab</a>.</p>';
        console.error('Spreadsheet preview failed:', error);
    }
}

function closeTeacherResourcePreview() {
    const modal = document.getElementById('teacherResourcePreviewModal');
    const iframe = document.getElementById('teacherResourcePreviewIframe');
    const spreadsheetContainer = document.getElementById('teacherResourceSpreadsheetContainer');

    if (modal && modal.classList.contains('active')) {
        modal.classList.remove('active');
        modal.setAttribute('aria-hidden', 'true');
    }

    if (iframe) {
        iframe.src = '';
        iframe.style.display = '';
    }

    if (spreadsheetContainer) {
        spreadsheetContainer.hidden = true;
        spreadsheetContainer.innerHTML = '';
    }

    document.body.style.overflow = '';
}

function makeAbsoluteUrl(url) {
    try {
        return new URL(url, window.location.origin).toString();
    } catch (error) {
        return url;
    }
}

function escapeHtml(value) {
    return (value || '').replace(/[&<>"']/g, function(match) {
        switch (match) {
            case '&': return '&amp;';
            case '<': return '&lt;';
            case '>': return '&gt;';
            case '"': return '&quot;';
            case '\'': return '&#39;';
            default: return match;
        }
    });
}

// Real-time statistics update functions
function refreshCourseCount() {
    const refreshIcon = document.getElementById('courses-refresh-icon');
    const coursesCount = document.getElementById('total-courses-count');
    
    if (!refreshIcon || !coursesCount) return;
    
    // Show loading state
    refreshIcon.classList.add('fa-spin');
    
    // Simulate API call (replace with actual API endpoint)
    setTimeout(() => {
        // Update the count (this would come from API)
        const currentValue = parseInt(coursesCount.textContent) || 0;
        coursesCount.textContent = currentValue;
        
        // Remove loading state
        refreshIcon.classList.remove('fa-spin');
        
        // Show success feedback
        showUpdateFeedback('courses-card', 'success');
    }, 1000);
}

function refreshStudentCount() {
    const refreshIcon = document.getElementById('students-refresh-icon');
    const studentsCount = document.getElementById('total-students-count');
    
    if (!refreshIcon || !studentsCount) return;
    
    // Show loading state
    refreshIcon.classList.add('fa-spin');
    
    // Simulate API call
    setTimeout(() => {
        const currentValue = parseInt(studentsCount.textContent) || 0;
        studentsCount.textContent = currentValue;
        
        refreshIcon.classList.remove('fa-spin');
        showUpdateFeedback('students-card', 'success');
    }, 1000);
}

function refreshAssignmentCount() {
    const refreshIcon = document.getElementById('assignments-refresh-icon');
    const assignmentsCount = document.getElementById('pending-assignments-count');
    
    if (!refreshIcon || !assignmentsCount) return;
    
    // Show loading state
    refreshIcon.classList.add('fa-spin');
    
    // Simulate API call
    setTimeout(() => {
        const currentValue = parseInt(assignmentsCount.textContent) || 0;
        assignmentsCount.textContent = currentValue;
        
        refreshIcon.classList.remove('fa-spin');
        showUpdateFeedback('assignments-card', 'success');
    }, 1000);
}

function refreshGradesCount() {
    const refreshIcon = document.getElementById('grades-refresh-icon');
    const gradesCount = document.getElementById('pending-grades-count');
    
    if (!refreshIcon || !gradesCount) return;
    
    // Show loading state
    refreshIcon.classList.add('fa-spin');
    
    // Simulate API call
    setTimeout(() => {
        const currentValue = parseInt(gradesCount.textContent) || 0;
        gradesCount.textContent = currentValue;
        
        refreshIcon.classList.remove('fa-spin');
        showUpdateFeedback('grades-card', 'success');
    }, 1000);
}

function showUpdateFeedback(cardId, type) {
    const card = document.getElementById(cardId);
    if (!card) return;
    
    const feedback = document.createElement('div');
    feedback.className = `update-feedback ${type}`;
    feedback.textContent = type === 'success' ? '✓ Updated' : '✗ Error';
    feedback.style.cssText = `
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: ${type === 'success' ? '#4CAF50' : '#f44336'};
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 12px;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s;
    `;
    
    card.style.position = 'relative';
    card.appendChild(feedback);
    
    // Fade in
    setTimeout(() => feedback.style.opacity = '1', 10);
    
    // Fade out and remove
    setTimeout(() => {
        feedback.style.opacity = '0';
        setTimeout(() => card.removeChild(feedback), 300);
    }, 2000);
}

// Initialize Charts
function initializeCharts() {
    // Performance Chart
    const performanceCtx = document.getElementById('performanceChart');
    if (performanceCtx) {
        // Try to use server-provided data
        let perfData = null;
        try {
            perfData = {{#performanceChart}}{{{performanceChart}}}{{/performanceChart}}{{^performanceChart}}null{{/performanceChart}};
            console.log('Performance Chart Data:', perfData);
        } catch (e) {
            console.log('Performance Chart Error:', e);
            perfData = null;
        }

        const labels = perfData && perfData.labels ? perfData.labels : ['Mathematics', 'Science', 'English', 'History', 'Art', 'Music'];
        const dataset = perfData && perfData.data ? perfData.data : [85, 78, 92, 88, 76, 82];
        const counts = perfData && perfData.counts ? perfData.counts : [30, 25, 28, 18, 20, 16];
        
        // Ensure we have meaningful data
        if (dataset.length === 0 || dataset.every(val => val === 0)) {
            dataset[0] = 85; dataset[1] = 78; dataset[2] = 92; dataset[3] = 88; dataset[4] = 76; dataset[5] = 82;
        }

        new Chart(performanceCtx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Completion Rate (%)',
                    data: dataset,
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const idx = context.dataIndex;
                                const rate = context.parsed.y;
                                const count = counts[idx] !== undefined ? counts[idx] : 'N/A';
                                return 'Completion: ' + rate + '% — ' + count + ' students';
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Completion Chart
    const completionCtx = document.getElementById('completionChart');
    if (completionCtx) {
        // Try to use server-provided completion summary
        let compSummary = null;
        try {
            compSummary = {{#completionSummary}}{{{completionSummary}}}{{/completionSummary}}{{^completionSummary}}null{{/completionSummary}};
            console.log('Completion Chart Data:', compSummary);
        } catch (e) {
            console.log('Completion Chart Error:', e);
            compSummary = null;
        }

        const labels = ['Completed', 'In Progress', 'Not Started'];
        const data = compSummary ? [compSummary.completed || 0, compSummary.inprogress || 0, compSummary.not_started || 0] : [65, 25, 10];
        
        // Ensure we have meaningful data
        const total = data.reduce((sum, val) => sum + val, 0);
        if (total === 0) {
            data[0] = 65; // Completed
            data[1] = 25; // In Progress  
            data[2] = 10;  // Not Started
        }

        new Chart(completionCtx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: [
                        'rgba(75, 192, 192, 0.5)',
                        'rgba(255, 206, 86, 0.5)',
                        'rgba(255, 99, 132, 0.5)'
                    ],
                    borderColor: [
                        'rgba(75, 192, 192, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(255, 99, 132, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }
}

// Auto-refresh every 30 seconds (only if elements exist)
if (document.getElementById('courses-refresh-icon') && document.getElementById('total-courses-count')) {
    setInterval(refreshCourseCount, 30000);
}
if (document.getElementById('students-refresh-icon') && document.getElementById('total-students-count')) {
    setInterval(refreshStudentCount, 30000);
}
if (document.getElementById('assignments-refresh-icon') && document.getElementById('pending-assignments-count')) {
    setInterval(refreshAssignmentCount, 30000);
}
if (document.getElementById('grades-refresh-icon') && document.getElementById('pending-grades-count')) {
    setInterval(refreshGradesCount, 30000);
}

// Questions System Functions
function refreshQuestions() {
    // Refresh questions data
    console.log('Refreshing questions...');
    // Add AJAX call to refresh questions
}

function viewAllQuestions() {
    // Redirect to unified questions page
        window.location.href = '{{config.wwwroot}}/theme/remui_kids/pages/teacher_doubts.php';
}

function createNewQuestion() {
    // Redirect to unified questions page with create tab
        window.location.href = '{{config.wwwroot}}/theme/remui_kids/pages/teacher_doubts.php';
}

function filterQuestions() {
    const sortBy = document.getElementById('question-sort').value;
    const filter = document.getElementById('question-filter').value;
    
    console.log('Filtering questions:', { sortBy, filter });
    
    // Filter and sort questions
    const questionItems = document.querySelectorAll('.question-item');
    questionItems.forEach(item => {
        const grade = item.dataset.grade;
        const course = item.dataset.course;
        
        let show = true;
        
        if (filter !== 'all') {
            if (filter.startsWith('grade_')) {
                const filterGrade = filter.replace('grade_', 'Grade ');
                show = grade === filterGrade;
            } else {
                show = course.toLowerCase().includes(filter.toLowerCase());
            }
        }
        
        item.style.display = show ? 'block' : 'none';
    });
}

function answerQuestion(questionId) {
    // Open answer modal or redirect to answer page
    console.log('Answering question:', questionId);
    window.location.href = `{{config.wwwroot}}/theme/remui_kids/pages/answer_question.php?id=${questionId}`;
}

function startVideoCall(questionId) {
    // Start video call with student
    console.log('Starting video call for question:', questionId);
    // Implement video call functionality
    alert('Video call feature will be implemented');
}

function startAudioCall(questionId) {
    // Start audio call with student
    console.log('Starting audio call for question:', questionId);
    // Implement audio call functionality
    alert('Audio call feature will be implemented');
}

function startChat(questionId) {
    // Start chat with student
    console.log('Starting chat for question:', questionId);
    // Implement chat functionality
    window.location.href = `{{config.wwwroot}}/theme/remui_kids/pages/chat.php?question=${questionId}`;
}

function groupCall(questionId) {
    // Start group call for similar questions
    console.log('Starting group call for question:', questionId);
    // Implement group call functionality
    alert('Group call feature will be implemented');
}

// Moodle Integration Functions
function openMoodleMessaging() {
    // Navigate within the same tab
    window.location.href = '{{config.wwwroot}}/message/index.php';
}

function openMoodleForums() {
    // Navigate within the same tab
    window.location.href = '{{config.wwwroot}}/mod/forum/index.php';
}

function refreshIntegratedQuestions() {
    // Refresh questions from Moodle messaging and forums
    console.log('Refreshing integrated questions...');
    
    fetch('{{config.wwwroot}}/theme/remui_kids/ajax/student_questions.php?action=get_questions', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Loaded', data.questions.length, 'integrated questions');
            // Update the questions list with new data
            updateQuestionsList(data.questions);
        } else {
            console.error('Failed to load integrated questions:', data.message);
        }
    })
    .catch(error => {
        console.error('Error loading integrated questions:', error);
    });
}

function updateQuestionsList(questions) {
    // Update the questions list with new data from Moodle
    const questionsList = document.querySelector('.questions-list');
    if (!questionsList) return;
    
    // Clear existing questions
    questionsList.innerHTML = '';
    
    if (questions.length === 0) {
        questionsList.innerHTML = `
            <div class="empty-state">
                <i class="fa fa-question-circle"></i>
                <p>No questions available from Moodle systems</p>
            </div>
        `;
        return;
    }
    
    // Add new questions
    questions.forEach(question => {
        const questionElement = createQuestionElement(question);
        questionsList.appendChild(questionElement);
    });
}

function createQuestionElement(question) {
    const div = document.createElement('div');
    div.className = 'question-item';
    div.setAttribute('data-grade', question.grade || 'All Grades');
    div.setAttribute('data-course', question.course_name || 'General');
    
    const statusClass = question.status === 'MENTOR REPLIED' ? 'mentor-replied' : 
                      question.status === 'Clarified' ? 'clarified' : 'pending';
    
    div.innerHTML = `
        <div class="question-header">
            <h4 class="question-title">${question.title}</h4>
            <div class="question-meta">
                <span class="question-grade">${question.grade || 'All Grades'}</span>
                <span class="question-course">${question.course_name || 'General'}</span>
            </div>
        </div>
        <div class="question-content">
            <p class="question-text">${question.content}</p>
            <div class="question-student">
                <span class="student-name">${question.student_name}</span>
                <span class="question-date">${new Date(question.timestamp * 1000).toLocaleDateString()}</span>
            </div>
        </div>
        <div class="question-status">
            <span class="status-badge ${statusClass}">${question.status}</span>
            <div class="question-stats">
                <span class="upvotes">${question.upvotes || 0} UPVOTES</span>
                <span class="replies">${question.replies || 0} REPLIES</span>
            </div>
        </div>
        <div class="question-actions">
            <button class="btn-action" onclick="answerQuestion('${question.id}')" title="Answer">
                <i class="fa fa-reply"></i>
            </button>
            <button class="btn-action" onclick="startVideoCall('${question.id}')" title="Video Call">
                <i class="fa fa-video"></i>
            </button>
            <button class="btn-action" onclick="startAudioCall('${question.id}')" title="Audio Call">
                <i class="fa fa-phone"></i>
            </button>
            <button class="btn-action" onclick="startChat('${question.id}')" title="Chat">
                <i class="fa fa-comments"></i>
            </button>
            <button class="btn-action" onclick="groupCall('${question.id}')" title="Group Call">
                <i class="fa fa-users"></i>
            </button>
        </div>
    `;
    
    return div;
}

function refreshCharts() {
    // Reinitialize charts with fresh data
    // Charts removed - now using real activity feed and course overview
    // initializeCharts();
}

/* ========================================
   SCHEDULE AND CALENDAR NAVIGATION
   ======================================== */

// Track current week offset
let currentWeekOffset = 0;

// Navigate to previous/next week
function navigateWeek(direction) {
    currentWeekOffset += direction;
    loadSchedule(currentWeekOffset);
}

// Go to today
function goToToday() {
    currentWeekOffset = 0;
    loadSchedule(0);
}

// Load schedule for current week - List View Format
function loadSchedule(weekOffset) {
    // Show loading state
    const scheduleCalendar = document.querySelector('.schedule-calendar');
    if (!scheduleCalendar) return;
    
    scheduleCalendar.style.opacity = '0.5';
    scheduleCalendar.style.pointerEvents = 'none';
    
    // Make AJAX request to load schedule data for current week
    const url = '{{config.wwwroot}}/theme/remui_kids/ajax/teacher_schedule.php?view=list&weeks=1&week_offset=0';
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.events) {
                displayScheduleListView(data.events);
            } else {
                console.error('Failed to load schedule:', data.message);
            }
        })
        .catch(error => {
            console.error('Error loading schedule:', error);
        })
        .finally(() => {
            scheduleCalendar.style.opacity = '1';
            scheduleCalendar.style.pointerEvents = 'auto';
        });
}

// Truncate text to 7 words
function truncateToSevenWords(text) {
    if (!text) return '';
    const words = text.trim().split(/\s+/);
    if (words.length <= 7) {
        return text;
    }
    return words.slice(0, 7).join(' ') + '...';
}

// Convert color name to hex code or return hex if already hex
function convertColorNameToHex(color) {
    // Default lavender color
    const defaultColor = '#e9d5ff';
    
    // Handle null, undefined, empty string, or whitespace-only
    if (!color || (typeof color === 'string' && color.trim() === '')) {
        return defaultColor;
    }
    
    // Convert to string and trim
    const colorStr = String(color).trim();
    
    // If it's already a hex color, return it
    if (colorStr.startsWith('#')) {
        // Validate hex color format (basic check)
        if (/^#[0-9A-Fa-f]{6}$/.test(colorStr)) {
            return colorStr;
        }
        // If invalid hex, return default
        return defaultColor;
    }
    
    // Color name to hex mapping (matching School Admin dashboard)
    const colorMap = {
        'blue': '#3b82f6',
        'green': '#3b82f6',
        'red': '#f87171',  // Lighter red shade
        'orange': '#f59e0b',
        'purple': '#8b5cf6',
        'pink': '#ec4899',
        'yellow': '#eab308'
    };
    
    const colorLower = colorStr.toLowerCase();
    return colorMap[colorLower] || defaultColor;
}

// Display schedule in list view format
function displayScheduleListView(events) {
    const scheduleCalendar = document.querySelector('.schedule-calendar');
    if (!scheduleCalendar) return;
    
    const listContainer = scheduleCalendar.querySelector('.schedule-list-view-container');
    if (!listContainer) return;
    
    // Filter to only show lectures and admin events
    const filteredEvents = events.filter(event => {
        const isLectureSession = event.lecture_session || event.event_type === 'lecture';
        const isAdminEvent = event.admin_event || event.event_type === 'admin_event' || (event.name && event.name.includes('🏫'));
        return isLectureSession || isAdminEvent;
    });
    
    listContainer.innerHTML = '';
    
    if (filteredEvents.length === 0) {
        listContainer.innerHTML = `
            <div class="no-events-message">
                <i class="fa fa-calendar"></i>
                <p>No events scheduled</p>
            </div>
        `;
        return;
    }
    
    // Sort events by date and time
    filteredEvents.sort((a, b) => {
        const timeA = typeof a.timestart === 'string' ? parseInt(a.timestart) : (a.timestart || 0);
        const timeB = typeof b.timestart === 'string' ? parseInt(b.timestart) : (b.timestart || 0);
        return timeA - timeB;
    });
    
    // Limit to 5 events only
    const limitedEvents = filteredEvents.slice(0, 5);
    
    const lectureColors = ['#3b82f6', '#8b5cf6'];
    limitedEvents.forEach((event, index) => {
        const isLectureSession = event.lecture_session || event.event_type === 'lecture';
        const isAdminEvent = event.admin_event || event.event_type === 'admin_event' || (event.name && event.name.includes('🏫'));
        
        // Get event color from School Admin dashboard, default to lavender
        // Check multiple possible color property names
        const lectureColor = lectureColors[index % lectureColors.length];
        const colorValue = isLectureSession ? lectureColor : (event.color || event.event_color || event.color_name || '');
        let eventColor = convertColorNameToHex(colorValue);
        
        // Check if lecture is marked as not available - use light grey if so
        if (isLectureSession) {
            const isAvailable = event.teacher_available !== undefined ? event.teacher_available : 1;
            if (isAvailable == 0) {
                eventColor = '#d1d5db'; // Light grey for unavailable lectures
            }
        }
        
        const listItem = document.createElement('div');
        listItem.className = `schedule-list-item ${isLectureSession ? 'lecture-item' : 'admin-event-item'}`;
        // Use setProperty with important to ensure inline style takes precedence over CSS
        listItem.style.setProperty('border-left', `4px solid ${eventColor}`, 'important');
        
        // Format date - Day number and month/year
        let dayNumber = '';
        let monthYear = '';
        
        if (event.timestart) {
            const eventDate = new Date(event.timestart * 1000);
            const day = eventDate.getDate();
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const month = monthNames[eventDate.getMonth()];
            const year = eventDate.getFullYear();
            dayNumber = day.toString();
            monthYear = `${month}, ${year}`;
        } else if (event.date) {
            // Try to parse date string
            const dateParts = event.date.split(' ');
            if (dateParts.length >= 2) {
                dayNumber = dateParts[1] || dateParts[0];
                monthYear = dateParts[0] + (dateParts[2] ? ', ' + dateParts[2] : '');
            }
        }
        
        // Format time range
        let timeRange = '';
        if (event.time && event.time_end) {
            timeRange = `${event.time} to ${event.time_end}`;
        } else if (event.time) {
            timeRange = event.time;
        } else if (event.timestart) {
            const eventDate = new Date(event.timestart * 1000);
            const timeStr = eventDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
            if (event.timeduration && event.timeduration > 0) {
                const endTime = new Date((event.timestart + event.timeduration) * 1000);
                const endTimeStr = endTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                timeRange = `${timeStr} to ${endTimeStr}`;
            } else {
                timeRange = timeStr;
            }
        }
        
        // Get event type/title
        let eventTitle = '';
        let eventDescription = '';
        let eventType = '';
        
        if (isLectureSession) {
            eventTitle = event.coursename || event.name || 'Lecture';
            eventDescription = event.class_name || '';
            eventType = event.type || event.event_type || 'Lecture';
        } else if (isAdminEvent) {
            eventTitle = event.name || 'Event';
            eventDescription = event.description || '';
            eventType = event.type || event.event_type || 'Event';
        }
        
        // Truncate title and description to 7 words
        eventTitle = truncateToSevenWords(eventTitle);
        eventDescription = truncateToSevenWords(eventDescription);
        
        // Actions menu (far right)
        let actionsHTML = '';
        if (isLectureSession) {
            const sessionId = event.id || event.session_id || '';
            const isAvailable = event.teacher_available !== undefined ? event.teacher_available : 1;
            const availableCheckStyle = isAvailable == 1 ? 'display: inline;' : 'display: none;';
            const notAvailableCheckStyle = isAvailable == 0 ? 'display: inline;' : 'display: none;';
            
            actionsHTML = `
                <div class="schedule-item-actions">
                    <button class="lecture-menu-btn" onclick="toggleLectureMenu(event, '${sessionId}', ${isAvailable})" data-session-id="${sessionId}" data-available="${isAvailable}">
                        <span class="menu-dots">⋮</span>
                    </button>
                    <div class="lecture-menu-dropdown" id="lectureMenu_${sessionId}" style="display: none;" data-current-available="${isAvailable}">
                        <button class="lecture-menu-item" onclick="updateTeacherAvailability(${sessionId}, 1)" data-available="1">
                            <span class="menu-check" style="${availableCheckStyle}">✓</span> Available
                        </button>
                        <button class="lecture-menu-item" onclick="updateTeacherAvailability(${sessionId}, 0)" data-available="0">
                            <span class="menu-check" style="${notAvailableCheckStyle}">✓</span> Not Available
                        </button>
                    </div>
                </div>
            `;
        }
        
        listItem.innerHTML = `
            <div class="schedule-item-date">
                <div class="date-day">${dayNumber}</div>
                <div class="date-month-year">${monthYear}</div>
            </div>
            <div class="schedule-item-content-wrapper">
                <div class="schedule-item-header">
                    <div class="schedule-item-title">${eventTitle}</div>
                    <div class="schedule-event-type-badge" data-badge-color="${eventColor}">${eventType}</div>
                </div>
                ${eventDescription ? `<div class="schedule-item-description">${eventDescription}</div>` : ''}
                <div class="schedule-item-time-range">${timeRange}</div>
            </div>
            ${actionsHTML}
        `;
        
        // Apply badge background color using setProperty with important flag
        const badgeElement = listItem.querySelector('.schedule-event-type-badge');
        if (badgeElement) {
            badgeElement.style.setProperty('background', eventColor, 'important');
        }
        
        listContainer.appendChild(listItem);
    });
}

// Update the schedule display with new data
function updateScheduleDisplay(schedule) {
    // Update date range
    const dateRange = document.querySelector('.schedule-date-range');
    if (dateRange && schedule.week_start && schedule.week_end) {
        dateRange.textContent = schedule.week_start + ' - ' + schedule.week_end;
    }
    
    // Update calendar grid
    const calendarGrid = document.querySelector('.calendar-grid');
    if (!calendarGrid || !schedule.days) return;
    
    // Reset inline styles that may have been set by List or Month view
    calendarGrid.style.cssText = '';
    
    // Ensure it has the correct class for week view
    if (!calendarGrid.classList.contains('schedule-week-grid')) {
        calendarGrid.classList.add('schedule-week-grid');
    }
    
    // Clear existing content
    calendarGrid.innerHTML = '';
    
    // Create day elements matching schedule.php structure with fixed width and height
    schedule.days.forEach(day => {
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-day schedule-day-column';
        dayElement.style.cssText = 'height: 400px !important; min-height: 400px !important; max-height: 400px !important; width: 100%; box-sizing: border-box; display: flex; flex-direction: column; overflow: hidden;';
        if (day.is_today) {
            dayElement.classList.add('today');
        }
        
        // Create day header with exact schedule.php structure
        const dayHeader = document.createElement('div');
        dayHeader.className = 'day-header schedule-day-header';
        dayHeader.innerHTML = `
            <div class="day-name schedule-day-name">${day.day_name}</div>
            <div class="day-number schedule-day-number">${day.day_num}</div>
            <div class="month-name schedule-month-name">${day.month_name || 'NOVEMBER'}</div>
        `;
        
        // Create day events container with exact schedule.php structure
        const dayEvents = document.createElement('div');
        dayEvents.className = 'day-events schedule-events-container';
        dayEvents.style.cssText = 'display: flex; flex-direction: column; gap: 0.5rem; overflow-y: auto; overflow-x: hidden; flex: 1 1 auto; min-height: 0; max-height: calc(400px - 100px); width: 100%;';
        
        if (day.events && day.events.length > 0) {
            // Filter to only show lectures and admin events
            const filteredEvents = day.events.filter(event => {
                const isLectureSession = event.lecture_session || event.event_type === 'lecture';
                const isAdminEvent = event.admin_event || event.event_type === 'admin_event' || (event.name && event.name.includes('🏫'));
                return isLectureSession || isAdminEvent;
            });
            
            filteredEvents.forEach(event => {
                const eventElement = document.createElement('a');
                
                // Check if it's a lecture session
                const isLectureSession = event.lecture_session || event.event_type === 'lecture';
                // Check if it's an admin event
                const isAdminEvent = event.admin_event || event.event_type === 'admin_event' || (event.name && event.name.includes('🏫'));
                
                // For admin events, prevent default navigation and show modal
                if (isAdminEvent) {
                    eventElement.href = '#';
                    eventElement.addEventListener('click', function(e) {
                        e.preventDefault();
                        showSchoolEventModal(event);
                    });
                } else if (isLectureSession && event.courseid) {
                    // For lecture sessions, link to course page if courseid is available
                    eventElement.href = '{{config.wwwroot}}/course/view.php?id=' + event.courseid;
                } else {
                    eventElement.href = event.url || '#';
                }
                
                eventElement.className = 'calendar-event schedule-event-card';
                eventElement.style.borderLeft = '4px solid ' + event.color;
                
                if (isLectureSession) {
                    const sessionId = event.id || event.session_id || '';
                    const isAvailable = event.teacher_available !== undefined ? event.teacher_available : 1;
                    const wrapper = document.createElement('div');
                    wrapper.className = 'lecture-card-wrapper';
                    if (isAvailable == 0) {
                        wrapper.classList.add('lecture-unavailable');
                    }
                    wrapper.style.position = 'relative';
                    wrapper.setAttribute('data-session-id', sessionId);
                    wrapper.setAttribute('data-available', isAvailable);
                    
                    // Add lecture-card-link class to the event element
                    eventElement.classList.add('lecture-card-link');
                    
                    eventElement.innerHTML = `
                        <div class="event-time schedule-event-time">
                            <i class="fa ${event.icon || 'fa-chalkboard-teacher'}"></i>
                            ${event.time || event.time_range}
                        </div>
                        <div class="event-title schedule-event-title lecture-title">${event.coursename || event.name || 'Lecture'}</div>
                        <div class="event-type-badge">LECTURE</div>
                    `;
                    
                    // Add 3-dot menu button - Ensure proper positioning
                    const menuBtn = document.createElement('button');
                    menuBtn.className = 'lecture-menu-btn';
                    menuBtn.setAttribute('onclick', `toggleLectureMenu(event, '${sessionId}', ${isAvailable})`);
                    menuBtn.setAttribute('data-session-id', sessionId);
                    menuBtn.setAttribute('data-available', isAvailable);
                    menuBtn.style.cssText = 'position: absolute; top: 8px; right: 8px; z-index: 10;'; // Explicit positioning
                    menuBtn.innerHTML = '<span class="menu-dots">⋮</span>';
                    
                    // Add dropdown menu with correct checkmark visibility
                    const menuDropdown = document.createElement('div');
                    menuDropdown.className = 'lecture-menu-dropdown';
                    menuDropdown.id = `lectureMenu_${sessionId}`;
                    menuDropdown.style.display = 'none';
                    menuDropdown.setAttribute('data-current-available', isAvailable);
                    const availableCheckStyle = isAvailable == 1 ? 'display: inline;' : 'display: none;';
                    const notAvailableCheckStyle = isAvailable == 0 ? 'display: inline;' : 'display: none;';
                    menuDropdown.innerHTML = `
                        <button class="lecture-menu-item" onclick="updateTeacherAvailability(${sessionId}, 1)" data-available="1">
                            <span class="menu-check" style="${availableCheckStyle}">✓</span> Available
                        </button>
                        <button class="lecture-menu-item" onclick="updateTeacherAvailability(${sessionId}, 0)" data-available="0">
                            <span class="menu-check" style="${notAvailableCheckStyle}">✓</span> Not Available
                        </button>
                    `;
                    
                    wrapper.appendChild(eventElement);
                    wrapper.appendChild(menuBtn);
                    wrapper.appendChild(menuDropdown);
                    dayEvents.appendChild(wrapper);
                } else if (isAdminEvent) {
                    // Handle admin events that weren't caught in the first if block
                    eventElement.innerHTML = `
                        <div class="event-time schedule-event-time">
                            <i class="fa ${event.icon || 'fa-calendar'}"></i>
                            ${event.time || event.time_range}
                        </div>
                        <div class="event-title schedule-event-title">${event.name || event.title}</div>
                        <div class="event-course schedule-event-course">${event.coursename || 'General'}</div>
                    `;
                    dayEvents.appendChild(eventElement);
                }
                // Skip all other events (assignments, due dates, etc.)
            });
        } else {
            const noEvents = document.createElement('div');
            noEvents.className = 'no-events schedule-no-events';
            noEvents.textContent = 'No events';
            dayEvents.appendChild(noEvents);
        }
        
        dayElement.appendChild(dayHeader);
        dayElement.appendChild(dayEvents);
        calendarGrid.appendChild(dayElement);
    });
}

// Initialize schedule on page load - List View
document.addEventListener('DOMContentLoaded', function() {
    // Load schedule in list view format
    loadSchedule(0);
});

// Load Week View (default)
function loadWeekView() {
    // Reset calendar grid styles before loading week view
    const calendarGrid = document.querySelector('.calendar-grid');
    if (calendarGrid) {
        // Remove any inline styles that may have been set by List or Month view
        calendarGrid.style.cssText = '';
        // Ensure it has the correct class for week view
        if (!calendarGrid.classList.contains('schedule-week-grid')) {
            calendarGrid.classList.add('schedule-week-grid');
        }
    }
    
    loadSchedule(currentWeekOffset);
}

// Load Month View inline
function loadMonthView() {
    const scheduleCalendar = document.querySelector('.schedule-calendar');
    if (!scheduleCalendar) return;
    
    scheduleCalendar.style.opacity = '0.5';
    scheduleCalendar.style.pointerEvents = 'none';
    
    // Calculate current month based on week offset
    const today = new Date();
    today.setDate(today.getDate() + (currentWeekOffset * 7));
    const year = today.getFullYear();
    const month = today.getMonth();
    
    fetch('{{config.wwwroot}}/theme/remui_kids/ajax/teacher_schedule.php?view=month&year=' + year + '&month=' + month)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.events) {
                displayMonthView(data.events, year, month);
            } else {
                console.error('Failed to load month view:', data.message);
                // Fallback: show message in calendar
                scheduleCalendar.querySelector('.calendar-grid').innerHTML = 
                    '<div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #6c757d;">' +
                    '<i class="fa fa-calendar-alt" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>' +
                    '<p>Month view is currently under development.</p>' +
                    '<p style="margin-top: 10px;">Please use the <a href="{{config.wwwroot}}/calendar/view.php?view=month" target="_blank">full calendar page</a> for now.</p>' +
                    '</div>';
            }
        })
        .catch(error => {
            console.error('Error loading month view:', error);
            // Show fallback message
            scheduleCalendar.querySelector('.calendar-grid').innerHTML = 
                '<div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #6c757d;">' +
                '<i class="fa fa-calendar-alt" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>' +
                '<p>Unable to load month view.</p>' +
                '<p style="margin-top: 10px;">Please use the <a href="{{config.wwwroot}}/calendar/view.php?view=month" target="_blank">full calendar page</a> instead.</p>' +
                '</div>';
        })
        .finally(() => {
            scheduleCalendar.style.opacity = '1';
            scheduleCalendar.style.pointerEvents = 'auto';
        });
}

// Display Month View - Beautiful & Professional
function displayMonthView(events, year, month) {
    const calendarGrid = document.querySelector('.calendar-grid');
    if (!calendarGrid) return;

    const lectureColors = ['#3b82f6', '#8b5cf6'];
    
    // Get month name
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                       'July', 'August', 'September', 'October', 'November', 'December'];
    
    // Update date range to show month/year
    const dateRange = document.querySelector('.schedule-date-range');
    if (dateRange) {
        dateRange.textContent = monthNames[month] + ' ' + year;
    }
    
    // Get first and last day of month
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startingDayOfWeek = firstDay.getDay(); // 0 = Sunday
    
    // Clear and style grid
    calendarGrid.innerHTML = '';
    calendarGrid.style.cssText = 'display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #e2e8f0; border-radius: 12px; overflow: hidden;';
    
    // Add day headers with reduced styling
    const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    dayHeaders.forEach((day, index) => {
        const headerEl = document.createElement('div');
        headerEl.style.cssText = 'background: #b8a9d9; color: #ffffff; text-align: center; padding: 8px 4px; font-weight: 700; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em;';
        headerEl.textContent = day;
        calendarGrid.appendChild(headerEl);
    });
    
    // Add empty cells before first day
    for (let i = 0; i < startingDayOfWeek; i++) {
        const emptyCell = document.createElement('div');
        emptyCell.style.cssText = 'min-height: 80px; max-height: 80px; height: 80px; background: #f1f5f9; opacity: 0.5;';
        calendarGrid.appendChild(emptyCell);
    }
    
    // Add days of month
    const today = new Date();
    const todayDate = today.getDate();
    const todayMonth = today.getMonth();
    const todayYear = today.getFullYear();
    
    for (let day = 1; day <= daysInMonth; day++) {
        const dayCell = document.createElement('div');
        const isToday = (day === todayDate && month === todayMonth && year === todayYear);
        
        // Base styling - Fixed size for month view (reduced dimensions)
        dayCell.style.cssText = 'min-height: 80px; max-height: 80px; height: 80px; padding: 0.375rem; background: white; cursor: pointer; transition: all 0.2s ease; position: relative; overflow: hidden; display: flex; flex-direction: column; box-sizing: border-box;';
        
        if (isToday) {
            dayCell.style.background = 'linear-gradient(135deg, #faf8ff 0%, #f0f4ff 100%)';
        }
        
        // Add day number with reduced styling
        const dayNumber = document.createElement('div');
        dayNumber.style.cssText = 'font-size: 0.875rem; font-weight: 700; margin-bottom: 2px; flex-shrink: 0; ' + (isToday ? 'color: #8b7ab8;' : 'color: #1e293b;');
        dayNumber.textContent = day;
        dayCell.appendChild(dayNumber);
        
        // Add events for this day (if any) - filter to only show lectures and admin events
        const dayEvents = events.filter(e => {
            const eventDate = new Date(e.timestart * 1000);
            const eventDay = eventDate.getUTCDate();
            const eventMonth = eventDate.getUTCMonth();
            const eventYear = eventDate.getUTCFullYear();
            const isDateMatch = eventDay === day && eventMonth === month && eventYear === year;
            
            // Only show lectures and admin events
            const isLectureSession = e.lecture_session || e.eventtype === 'lecture';
            const isAdminEvent = e.admin_event || e.event_type === 'admin_event' || (e.name && e.name.includes('🏫'));
            
            return isDateMatch && (isLectureSession || isAdminEvent);
        });
        
        if (dayEvents.length > 0) {
            // Create events container with fixed height and scrollbar (reduced dimensions)
            const eventsContainer = document.createElement('div');
            eventsContainer.style.cssText = 'display: flex; flex-direction: column; gap: 2px; overflow-y: auto; overflow-x: hidden; flex: 1; max-height: calc(80px - 25px); min-height: 0;';
            eventsContainer.style.scrollbarWidth = 'thin';
            eventsContainer.style.scrollbarColor = '#cbd5e1 transparent';
            
            // Add all events (will scroll if more than 3)
            dayEvents.forEach((event, index) => {
                const isLectureSession = event.lecture_session || event.eventtype === 'lecture';
                // Use event.color if available (for lecture sessions and admin events), otherwise use getEventColorByType
                const lectureColor = lectureColors[index % lectureColors.length];
                const colorValue = isLectureSession ? lectureColor : (event.color || event.event_color || event.color_name || '');
                const eventColor = colorValue ? convertColorNameToHex(colorValue) : getEventColorByType(event.eventtype);
                
                const eventDot = document.createElement('div');
                eventDot.style.cssText = `
                    display: flex;
                    align-items: center;
                    gap: 3px;
                    padding: 2px 4px;
                    background: ${eventColor}15;
                    border-left: 2px solid ${eventColor};
                    border-radius: 3px;
                    font-size: 0.6rem;
                    color: #475569;
                    font-weight: 500;
                    overflow: hidden;
                    text-overflow: ellipsis;
                    white-space: nowrap;
                    flex-shrink: 0;
                    line-height: 1.2;
                `;
                
                const eventName = isLectureSession ? (event.coursename || event.name || 'Lecture') : event.name;
                const eventIcon = event.icon || (isLectureSession ? 'fa-chalkboard-teacher' : 'fa-circle');
                eventDot.innerHTML = `<i class="fa ${eventIcon}" style="font-size: 0.55rem; color: ${eventColor};"></i><span style="overflow: hidden; text-overflow: ellipsis;">${eventName}</span>`;
                eventsContainer.appendChild(eventDot);
            });
            
            dayCell.appendChild(eventsContainer);
        }
        
        // Hover effects
        dayCell.addEventListener('mouseenter', function() {
            if (!isToday) {
                this.style.background = '#f8fafc';
                this.style.transform = 'translateY(-2px)';
                this.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.08)';
            }
        });
        
        dayCell.addEventListener('mouseleave', function() {
            if (!isToday) {
                this.style.background = 'white';
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = 'none';
            }
        });
        
        calendarGrid.appendChild(dayCell);
    }
}

// Helper function to get event color by event type (for legacy/fallback use)
function getEventColorByType(eventType) {
    const colors = {
        'due': '#f4a6a6',
        'close': '#f5d0a9',
        'open': '#a9d9c9',
        'course': '#b8a9d9',
        'user': '#d9b8d9',
        'group': '#f5b7d1',
        'lecture': '#a9d9c9',
        'meeting': '#b8a9d9',
        'exam': '#f4a6a6',
        'activity': '#f5d0a9'
    };
    return colors[eventType] || '#b8a9d9';
}

// Load List View inline
function loadListView() {
    const scheduleCalendar = document.querySelector('.schedule-calendar');
    if (!scheduleCalendar) return;
    
    scheduleCalendar.style.opacity = '0.5';
    scheduleCalendar.style.pointerEvents = 'none';
    
    fetch('{{config.wwwroot}}/theme/remui_kids/ajax/teacher_schedule.php?view=list&weeks=4')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.events) {
                displayListView(data.events);
            } else {
                console.error('Failed to load list view:', data.message);
                // Fallback: show message
                scheduleCalendar.querySelector('.calendar-grid').innerHTML = 
                    '<div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #6c757d;">' +
                    '<i class="fa fa-list" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>' +
                    '<p>List view is currently under development.</p>' +
                    '<p style="margin-top: 10px;">Please use the <a href="{{config.wwwroot}}/calendar/view.php?view=upcoming" target="_blank">full calendar page</a> for now.</p>' +
                    '</div>';
            }
        })
        .catch(error => {
            console.error('Error loading list view:', error);
            // Show fallback message
            scheduleCalendar.querySelector('.calendar-grid').innerHTML = 
                '<div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #6c757d;">' +
                '<i class="fa fa-list" style="font-size: 48px; margin-bottom: 15px; display: block;"></i>' +
                '<p>Unable to load list view.</p>' +
                '<p style="margin-top: 10px;">Please use the <a href="{{config.wwwroot}}/calendar/view.php?view=upcoming" target="_blank">full calendar page</a> instead.</p>' +
                '</div>';
        })
        .finally(() => {
            scheduleCalendar.style.opacity = '1';
            scheduleCalendar.style.pointerEvents = 'auto';
        });
}

// Display List View - Professional & Clean
function displayListView(events) {
    const calendarGrid = document.querySelector('.calendar-grid');
    if (!calendarGrid) return;
    
    // Update date range
    const dateRange = document.querySelector('.schedule-date-range');
    if (dateRange) {
        dateRange.textContent = 'Upcoming Events';
    }
    
    // Filter to only show lectures and admin events
    const filteredEvents = events.filter(event => {
        const isLectureSession = event.lecture_session || event.event_type === 'lecture';
        const isAdminEvent = event.admin_event || event.event_type === 'admin_event' || (event.name && event.name.includes('🏫'));
        return isLectureSession || isAdminEvent;
    });
    
    // Clear and reconfigure grid for list view with fixed size container
    calendarGrid.innerHTML = '';
    calendarGrid.style.cssText = 'display: block; background: white; border-radius: 12px; padding: 0;';
    
    if (filteredEvents.length === 0) {
        calendarGrid.innerHTML = '<div style="text-align: center; padding: 60px 20px; color: #94a3b8;"><i class="fa fa-calendar-check" style="font-size: 3.5rem; margin-bottom: 1.25rem; display: block; color: #cbd5e1;"></i><p style="font-size: 1.125rem; font-weight: 600; margin-bottom: 0.5rem; color: #64748b;">No upcoming events</p><p style="font-size: 0.875rem; color: #94a3b8;">Your schedule is clear for the upcoming weeks</p></div>';
        return;
    }
    
    // Group events by date using UTC to avoid timezone issues
    const groupedEvents = {};
    filteredEvents.forEach(event => {
        const eventDate = new Date(event.timestart * 1000);
        const dateKey = eventDate.toLocaleDateString('en-US', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric',
            timeZone: 'UTC'
        });
        
        if (!groupedEvents[dateKey]) {
            groupedEvents[dateKey] = [];
        }
        groupedEvents[dateKey].push(event);
    });
    
    // Create a container for list items with fixed height and scrollbar (matching month view size)
    const listContainer = document.createElement('div');
    listContainer.className = 'schedule-list-container';
    listContainer.style.cssText = 'max-height: 480px; overflow-y: auto; overflow-x: hidden; padding: 0.5rem;';
    
    // Display grouped events with compact styling (matching month view)
    Object.keys(groupedEvents).forEach((dateKey, groupIndex) => {
        // Date header with reduced styling using pastel lavender color
        const dateHeader = document.createElement('div');
        dateHeader.style.cssText = `
            background: linear-gradient(135deg, #faf8ff 0%, #f0f4ff 100%);
            padding: 8px 12px;
            border-radius: 8px;
            margin: ${groupIndex > 0 ? '12px' : '0'} 0 6px 0;
            border-left: 3px solid #b8a9d9;
            box-shadow: 0 1px 2px rgba(184, 169, 217, 0.04);
        `;
        
        const dateText = document.createElement('div');
        dateText.style.cssText = 'font-weight: 700; font-size: 0.875rem; color: #1e293b; display: flex; align-items: center; gap: 6px;';
        dateText.innerHTML = `<i class="fa fa-calendar-day" style="color: #b8a9d9; font-size: 0.75rem;"></i>${dateKey}`;
        
        const eventCount = document.createElement('span');
        eventCount.style.cssText = 'margin-left: auto; background: #b8a9d9; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.6875rem; font-weight: 600;';
        eventCount.textContent = groupedEvents[dateKey].length + ' event' + (groupedEvents[dateKey].length > 1 ? 's' : '');
        
        dateText.appendChild(eventCount);
        dateHeader.appendChild(dateText);
        listContainer.appendChild(dateHeader);
        
        // Events for this date - show all (scrollbar will handle if more than 5 per date)
        groupedEvents[dateKey].forEach((event, eventIndex) => {
            const eventItem = document.createElement('a');
            
            // Check if it's a lecture session
            const isLectureSession = event.lecture_session || event.event_type === 'lecture';
            
            // For lecture sessions, link to course page if courseid is available
            if (isLectureSession && event.courseid) {
                eventItem.href = '{{config.wwwroot}}/course/view.php?id=' + event.courseid;
            } else {
                eventItem.href = event.url || '#';
            }
            
            // Get color from event.color property first, then fallback to event type
            const lectureColor = lectureColors[index % lectureColors.length];
            const colorValue = isLectureSession ? lectureColor : (event.color || event.event_color || event.color_name || '');
            const eventColor = colorValue ? convertColorNameToHex(colorValue) : getEventColorByType(event.eventtype);
            eventItem.style.cssText = `
                display: flex;
                align-items: center;
                padding: 8px 12px;
                margin-bottom: 4px;
                background: white;
                border: 1px solid #e5e7eb;
                border-left: 3px solid ${eventColor};
                border-radius: 6px;
                cursor: pointer;
                transition: all 0.2s ease;
                text-decoration: none;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
            `;
            
            // Use pre-formatted time from backend (already in 12-hour format, server timezone)
            // This ensures consistency between school admin and teacher views
            let timeStr = '';
            if (event.time) {
                // Pre-formatted time from backend (most reliable - uses server timezone)
                timeStr = event.time;
            } else if (event.timestart) {
                // Fallback: format from timestamp (only if time not provided)
                // Note: This may show different time if browser timezone differs from server
                const eventTime = new Date(event.timestart * 1000);
                timeStr = eventTime.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: true
                });
            }
            
            if (isLectureSession) {
                // For lecture sessions: show course name once with LECTURE badge (compact styling)
                eventItem.innerHTML = `
                    <div style="flex: 0 0 70px; display: flex; align-items: center; gap: 4px;">
                        <i class="fa ${event.icon || 'fa-chalkboard-teacher'}" style="color: ${eventColor}; font-size: 0.875rem;"></i>
                        <span style="font-weight: 700; color: #8b7ab8; font-size: 0.75rem;">${timeStr}</span>
                    </div>
                    <div style="flex: 1; padding: 0 8px; text-align: center;">
                        <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px; font-size: 0.8125rem; line-height: 1.2;">${event.coursename || event.name || 'Lecture'}</div>
                        <div style="display: inline-block; padding: 3px 10px; background: linear-gradient(135deg, #a9d9c9, #c4e4d6); color: #2d5a4a; border-radius: 6px; font-size: 0.625rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.6px;">LECTURE</div>
                    </div>
                `;
            } else {
                // Check if it's an admin event
                const isAdminEvent = event.admin_event || event.event_type === 'admin_event' || (event.name && event.name.includes('🏫'));
                
                // For admin events, prevent default navigation and show modal
                if (isAdminEvent) {
                    eventItem.href = '#';
                    eventItem.addEventListener('click', function(e) {
                        e.preventDefault();
                        showSchoolEventModal(event);
                    });
                }
                
                // For regular events: show name and course name separately (compact styling)
                eventItem.innerHTML = `
                    <div style="flex: 0 0 70px; display: flex; align-items: center; gap: 4px;">
                        <i class="fa ${event.icon || 'fa-calendar'}" style="color: ${eventColor}; font-size: 0.875rem;"></i>
                        <span style="font-weight: 700; color: #8b7ab8; font-size: 0.75rem;">${timeStr}</span>
                    </div>
                    <div style="flex: 1; padding: 0 8px;">
                        <div style="font-weight: 600; color: #1e293b; margin-bottom: 2px; font-size: 0.8125rem; line-height: 1.2;">${event.name}</div>
                        <div style="font-size: 0.75rem; color: #000000; font-weight: 500;">${event.coursename || 'General'}</div>
                    </div>
                    <div style="padding: 4px 10px; background: ${eventColor}15; color: ${eventColor}; border-radius: 6px; font-size: 0.6875rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.2px;">${event.eventtype || 'Event'}</div>
                `;
            }
            
            eventItem.addEventListener('mouseenter', function() {
                this.style.background = '#f8fafc';
                this.style.borderLeftWidth = '4px';
                this.style.transform = 'translateX(2px)';
                this.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.08)';
            });
            
            eventItem.addEventListener('mouseleave', function() {
                this.style.background = 'white';
                this.style.borderLeftWidth = '3px';
                this.style.transform = 'translateX(0)';
                this.style.boxShadow = '0 1px 2px rgba(0, 0, 0, 0.03)';
            });
            
            listContainer.appendChild(eventItem);
        });
    });
    
    // Append the list container to calendar grid
    calendarGrid.appendChild(listContainer);
}

// Load Competency Analytics by Course
function loadCompetencyAnalytics(courseId) {
    const competencySection = document.querySelector('.competency-analytics-section');
    if (!competencySection) return;
    
    // Show loading state
    const competencyGrids = document.querySelector('.competency-grids');
    if (competencyGrids) {
        competencyGrids.style.opacity = '0.5';
        competencyGrids.style.pointerEvents = 'none';
    }
    
    // Fetch competency data for selected course
    fetch('{{config.wwwroot}}/theme/remui_kids/ajax/competency_analytics.php?courseid=' + courseId)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.analytics) {
                updateCompetencyDisplay(data.analytics);
            } else {
                console.error('Failed to load competency analytics:', data.message);
            }
        })
        .catch(error => {
            console.error('Error loading competency analytics:', error);
        })
        .finally(() => {
            if (competencyGrids) {
                competencyGrids.style.opacity = '1';
                competencyGrids.style.pointerEvents = 'auto';
            }
        });
}

// Update competency display with new data
function updateCompetencyDisplay(analytics) {
    // Update Top 3 Competencies
    const topGrid = document.querySelector('.top-competencies-card .competency-chart-grid');
    if (topGrid && analytics.top_competencies) {
        topGrid.innerHTML = '';
        
        if (analytics.top_competencies.length === 0) {
            topGrid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: #94a3b8;"><i class="fa fa-info-circle" style="font-size: 2rem; margin-bottom: 0.5rem; display: block;"></i><p>No competency data available for this course</p></div>';
        } else {
            analytics.top_competencies.forEach(comp => {
                const item = createCompetencyItem(comp, 'success');
                topGrid.appendChild(item);
            });
        }
    }
    
    // Update Bottom 3 Competencies
    const bottomGrid = document.querySelector('.bottom-competencies-card .competency-chart-grid');
    if (bottomGrid && analytics.bottom_competencies) {
        bottomGrid.innerHTML = '';
        
        if (analytics.bottom_competencies.length === 0) {
            bottomGrid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: #94a3b8;"><i class="fa fa-info-circle" style="font-size: 2rem; margin-bottom: 0.5rem; display: block;"></i><p>No competency data available for this course</p></div>';
        } else {
            analytics.bottom_competencies.forEach(comp => {
                const item = createCompetencyItem(comp, 'danger');
                bottomGrid.appendChild(item);
            });
        }
    }
    
    // Truncate newly loaded competency names
    truncateExistingCompetencyNames();
}

// Truncate competency name to 20 characters
function truncateCompetencyName(name) {
    if (!name) return '';
    if (name.length <= 20) return name;
    return name.substring(0, 20) + '...';
}

// Create a competency item element
function createCompetencyItem(comp, type) {
    const item = document.createElement('div');
    item.className = 'competency-item';
    
    const color = type === 'success' ? '#10b981' : '#ef4444';
    const circumference = 339.292;
    const offset = circumference - (circumference * comp.percentage / 100);
    const truncatedName = truncateCompetencyName(comp.shortname || '');
    const truncatedCode = truncateCompetencyName(comp.idnumber || '');
    
    item.innerHTML = `
        <div class="competency-chart">
            <svg viewBox="0 0 120 120" class="donut-chart">
                <circle cx="60" cy="60" r="54" fill="none" stroke="#e5e7eb" stroke-width="8"></circle>
                <circle cx="60" cy="60" r="54" fill="none" stroke="${color}" stroke-width="8" 
                        stroke-dasharray="${circumference}" 
                        stroke-dashoffset="${offset}"
                        class="donut-segment donut-${type}"></circle>
                <text x="60" y="65" text-anchor="middle" class="donut-percentage">${comp.percentage}%</text>
            </svg>
        </div>
        <div class="competency-info">
            <div class="competency-code" title="${comp.idnumber || ''}">${truncatedCode}</div>
            <div class="competency-name" title="${comp.shortname || ''}">${truncatedName}</div>
            <div class="competency-stats">${comp.proficient_students}/${comp.total_students} proficient</div>
        </div>
    `;
    
    return item;
}

// Load Best Performing Students by Course
function loadBestStudents(courseId) {
    const studentsGrid = document.getElementById('bestStudentsGrid');
    if (!studentsGrid) return;
    
    // Show loading state
    studentsGrid.style.opacity = '0.5';
    studentsGrid.style.pointerEvents = 'none';
    
    // Fetch student data for selected course (top 5)
    fetch('{{config.wwwroot}}/theme/remui_kids/ajax/best_students.php?courseid=' + courseId + '&limit=5')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.data && data.data.students) {
                updateBestStudentsDisplay(data.data.students);
            } else {
                console.error('Failed to load best students:', data.message);
                studentsGrid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: #94a3b8;"><i class="fa fa-user-graduate" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i><p>No student data available for this course</p></div>';
            }
        })
        .catch(error => {
            console.error('Error loading best students:', error);
            studentsGrid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: #94a3b8;"><i class="fa fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i><p>Error loading student data</p></div>';
        })
        .finally(() => {
            studentsGrid.style.opacity = '1';
            studentsGrid.style.pointerEvents = 'auto';
        });
}

// Update best students display with new data
function updateBestStudentsDisplay(students) {
    const studentsGrid = document.getElementById('bestStudentsGrid');
    if (!studentsGrid) return;
    
    studentsGrid.innerHTML = '';
    
    if (students.length === 0) {
        studentsGrid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: #94a3b8;"><i class="fa fa-user-graduate" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i><p>No student performance data available</p></div>';
        return;
    }
    
    students.forEach(student => {
        const card = createStudentCard(student);
        studentsGrid.appendChild(card);
    });
}

// Create a student performance row element matching static layout
function createStudentCard(student) {
    const row = document.createElement('a');
    row.href = student.profile_url || '#';
    row.className = 'student-performance-row' + (student.rank === 1 ? ' leader-row' : '');
    
    row.innerHTML = `
        <div class="rank-badge">${student.rank}</div>
        <div class="student-info-compact">
            <div class="student-avatar-small">
                <img src="${student.avatar_url}" alt="${student.fullname}" onerror="this.src='{{config.wwwroot}}/user/pix.php/1/f1.jpg'">
            </div>
            <div class="student-details-compact">
                <h3 class="student-name-compact">${student.fullname}</h3>
                <div class="student-email-compact">${student.email}</div>
            </div>
        </div>
        <div class="student-metrics-simple">
            <div class="metric-simple">
                <span class="metric-simple-label">Grade</span>
                <span class="metric-simple-value">${student.grade_average}%</span>
            </div>
            <div class="metric-simple">
                <span class="metric-simple-label">Competency</span>
                <span class="metric-simple-value">${student.competency_rate}%</span>
            </div>
            <div class="metric-simple">
                <span class="metric-simple-label">Assignments</span>
                <span class="metric-simple-value">${student.assignment_rate}%</span>
            </div>
            <div class="metric-simple">
                <span class="metric-simple-label">Quizzes</span>
                <span class="metric-simple-value">${student.quiz_average}%</span>
            </div>
        </div>
        <div class="score-pill">
            <span class="score-pill-value">${student.performance_score}</span>
            <span class="score-pill-label">Score</span>
        </div>
    `;
    
    return row;
}

// Truncate competency names and codes on page load
function truncateExistingCompetencyNames() {
    // Truncate competency names
    const competencyNames = document.querySelectorAll('.competency-name');
    competencyNames.forEach(element => {
        const originalName = element.textContent.trim();
        if (originalName && originalName.length > 20) {
            const truncated = truncateCompetencyName(originalName);
            element.textContent = truncated;
            element.setAttribute('title', originalName); // Add full name as tooltip
        }
    });
    
    // Truncate competency codes (idnumber) as well
    const competencyCodes = document.querySelectorAll('.competency-code');
    competencyCodes.forEach(element => {
        const originalCode = element.textContent.trim();
        if (originalCode && originalCode.length > 20) {
            const truncated = truncateCompetencyName(originalCode);
            element.textContent = truncated;
            element.setAttribute('title', originalCode); // Add full code as tooltip
        }
    });
}

// Initialize Course Statistics Charts
document.addEventListener('DOMContentLoaded', function() {
    // Truncate competency names and codes immediately
    truncateExistingCompetencyNames();
    
    // Also truncate after a short delay to catch any dynamically loaded content
    setTimeout(truncateExistingCompetencyNames, 100);
    setTimeout(truncateExistingCompetencyNames, 500);
    
    // Wait for Chart.js to load
    if (typeof Chart === 'undefined') {
        console.error('Chart.js not loaded');
        return;
    }

    const chartData = {{{course_statistics_json}}};
    
    if (!chartData || !chartData.submission_rate) {
        console.log('No chart data available');
        return;
    }

    // Chart.js global configuration
    Chart.defaults.font.family = "'Inter', 'Segoe UI', sans-serif";
    Chart.defaults.color = '#64748b';

    // Assignment Statistics Doughnut Chart
    const assignmentStatsCtx = document.getElementById('assignmentStatsChart');
    if (assignmentStatsCtx) {
        // Get data from inline elements or use defaults
        const submittedCount = parseInt(document.getElementById('submittedCount')?.textContent) || 0;
        const pendingCount = parseInt(document.getElementById('pendingCount')?.textContent) || 0;
        const overdueCount = parseInt(document.getElementById('overdueCount')?.textContent) || 0;
        const gradedCount = parseInt(document.getElementById('gradedCount')?.textContent) || 0;
        
        new Chart(assignmentStatsCtx, {
            type: 'doughnut',
            data: {
                labels: ['Submitted', 'Pending', 'Overdue', 'Graded'],
                datasets: [{
                    data: [submittedCount, pendingCount, overdueCount, gradedCount],
                    backgroundColor: [
                        '#a78bfa',  // Purple - Submitted
                        '#60a5fa',  // Blue - Pending
                        '#fbbf24',  // Yellow/Orange - Overdue
                        '#c084fc'   // Light Purple - Graded
                    ],
                    borderColor: '#ffffff',
                    borderWidth: 3,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                cutout: '70%',
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(30, 41, 59, 0.95)',
                        padding: 12,
                        cornerRadius: 8,
                        titleFont: {
                            size: 13,
                            weight: '600'
                        },
                        bodyFont: {
                            size: 12
                        },
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return label + ': ' + value + ' (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });
    }

    // Assignment Submission Rate by Course Chart (Horizontal Bar Chart)
    const submissionCtx = document.getElementById('submissionRateChart');
    if (submissionCtx) {
        new Chart(submissionCtx, {
            type: 'bar',
            data: {
                labels: chartData.submission_rate.labels,
                datasets: [{
                    label: 'Submission Rate (%)',
                    data: chartData.submission_rate.data,
                    backgroundColor: function(context) {
                        const value = context.parsed.x;
                        if (value >= 80) return 'rgba(169, 217, 201, 0.85)';
                        if (value >= 60) return 'rgba(245, 208, 169, 0.85)';
                        return 'rgba(244, 166, 166, 0.85)';
                    },
                    borderColor: function(context) {
                        const value = context.parsed.x;
                        if (value >= 80) return 'rgba(169, 217, 201, 1)';
                        if (value >= 60) return 'rgba(245, 208, 169, 1)';
                        return 'rgba(244, 166, 166, 1)';
                    },
                    borderWidth: 0,
                    borderRadius: 8,
                    barThickness: 32,
                    maxBarThickness: 40
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(30, 41, 59, 0.95)',
                        padding: 12,
                        cornerRadius: 8,
                        titleFont: {
                            size: 13,
                            weight: '600'
                        },
                        bodyFont: {
                            size: 12
                        },
                        callbacks: {
                            title: function(context) {
                                return context[0].label;
                            },
                            label: function(context) {
                                return 'Submission Rate: ' + context.parsed.x + '%';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            },
                            font: {
                                size: 11
                            },
                            color: '#64748b'
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.04)',
                            drawBorder: false
                        }
                    },
                    y: {
                        ticks: {
                            font: {
                                size: 12,
                                weight: '500'
                            },
                            color: '#475569',
                            autoSkip: false
                        },
                        grid: {
                            display: false,
                            drawBorder: false
                        }
                    }
                },
                layout: {
                    padding: {
                        left: 10,
                        right: 20,
                        top: 10,
                        bottom: 10
                    }
                }
            }
        });
    }

    // Quiz Statistics Chart (Grouped Bar Chart)
    const quizStatsCtx = document.getElementById('quizStatsChart');
    if (quizStatsCtx && chartData.quiz_stats) {
        new Chart(quizStatsCtx, {
            type: 'bar',
            data: {
                labels: chartData.quiz_stats.labels,
                datasets: [
                    {
                        label: 'Completion Rate',
                        data: chartData.quiz_stats.completion_rate,
                        backgroundColor: 'rgba(184, 169, 217, 0.85)',
                        borderColor: 'rgba(184, 169, 217, 1)',
                        borderWidth: 0,
                        borderRadius: 8,
                        barThickness: 18,
                        maxBarThickness: 22
                    },
                    {
                        label: 'Average Grade',
                        data: chartData.quiz_stats.avg_grade,
                        backgroundColor: 'rgba(169, 217, 201, 0.85)',
                        borderColor: 'rgba(169, 217, 201, 1)',
                        borderWidth: 0,
                        borderRadius: 8,
                        barThickness: 18,
                        maxBarThickness: 22
                    }
                ]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        align: 'start',
                        labels: {
                            boxWidth: 14,
                            boxHeight: 14,
                            padding: 12,
                            font: {
                                size: 12,
                                weight: '500'
                            },
                            color: '#475569',
                            usePointStyle: true,
                            pointStyle: 'circle'
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(30, 41, 59, 0.95)',
                        padding: 12,
                        cornerRadius: 8,
                        titleFont: {
                            size: 13,
                            weight: '600'
                        },
                        bodyFont: {
                            size: 12
                        },
                        callbacks: {
                            title: function(context) {
                                return context[0].label;
                            },
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.x + '%';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            },
                            font: {
                                size: 11
                            },
                            color: '#64748b'
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.04)',
                            drawBorder: false
                        }
                    },
                    y: {
                        ticks: {
                            font: {
                                size: 12,
                                weight: '500'
                            },
                            color: '#475569',
                            autoSkip: false
                        },
                        grid: {
                            display: false,
                            drawBorder: false
                        }
                    }
                },
                layout: {
                    padding: {
                        left: 10,
                        right: 20,
                        top: 5,
                        bottom: 10
                    }
                }
            }
        });
    }

    // Average Grade by Course Chart (Bar Chart with gradient)
    const gradeCtx = document.getElementById('averageGradeChart');
    if (gradeCtx) {
        new Chart(gradeCtx, {
            type: 'bar',
            data: {
                labels: chartData.average_grade.labels,
                datasets: [{
                    label: 'Average Grade (%)',
                    data: chartData.average_grade.data,
                    backgroundColor: function(context) {
                        const value = context.parsed.y;
                        if (value >= 80) return 'rgba(169, 217, 201, 0.85)';
                        if (value >= 60) return 'rgba(184, 169, 217, 0.85)';
                        if (value >= 40) return 'rgba(245, 208, 169, 0.85)';
                        return 'rgba(244, 166, 166, 0.85)';
                    },
                    borderColor: 'transparent',
                    borderWidth: 0,
                    borderRadius: 8,
                    barPercentage: 0.7,
                    categoryPercentage: 0.8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(30, 41, 59, 0.95)',
                        padding: 12,
                        cornerRadius: 8,
                        titleFont: {
                            size: 13,
                            weight: '600'
                        },
                        bodyFont: {
                            size: 12
                        },
                        callbacks: {
                            title: function(context) {
                                return context[0].label;
                            },
                            label: function(context) {
                                return 'Average Grade: ' + context.parsed.y + '%';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            },
                            font: {
                                size: 11
                            },
                            color: '#64748b'
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.04)',
                            drawBorder: false
                        }
                    },
                    x: {
                        ticks: {
                            font: {
                                size: 12,
                                weight: '500'
                            },
                            color: '#475569',
                            autoSkip: false,
                            maxRotation: 45,
                            minRotation: 0
                        },
                        grid: {
                            display: false,
                            drawBorder: false
                        }
                    }
                },
                layout: {
                    padding: {
                        left: 10,
                        right: 10,
                        top: 10,
                        bottom: 10
                    }
                }
            }
        });
    }

    // Assignment Status Overview Chart (Doughnut Chart)
    const assignmentStatusCtx = document.getElementById('assignmentStatusChart');
    if (assignmentStatusCtx && chartData.assignment_status) {
        new Chart(assignmentStatusCtx, {
            type: 'doughnut',
            data: {
                labels: ['Graded', 'Pending Grading', 'Not Submitted', 'Overdue'],
                datasets: [{
                    data: [
                        chartData.assignment_status.graded || 0,
                        chartData.assignment_status.pending || 0,
                        chartData.assignment_status.not_submitted || 0,
                        chartData.assignment_status.overdue || 0
                    ],
                    backgroundColor: [
                        'rgba(169, 217, 201, 0.9)',   // Soft mint - Graded
                        'rgba(245, 208, 169, 0.9)',   // Soft peach - Pending
                        'rgba(220, 215, 235, 0.75)', // Soft lavender - Not Submitted
                        'rgba(244, 166, 166, 0.9)'     // Soft coral - Overdue
                    ],
                    borderColor: '#ffffff',
                    borderWidth: 3,
                    hoverOffset: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '65%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            font: {
                                size: 12,
                                weight: '500'
                            },
                            color: '#475569',
                            usePointStyle: true,
                            pointStyle: 'circle',
                            boxWidth: 12,
                            boxHeight: 12,
                            generateLabels: function(chart) {
                                const data = chart.data;
                                if (data.labels.length && data.datasets.length) {
                                    return data.labels.map((label, i) => {
                                        const value = data.datasets[0].data[i];
                                        const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return {
                                            text: label + ': ' + value + ' (' + percentage + '%)',
                                            fillStyle: data.datasets[0].backgroundColor[i],
                                            strokeStyle: 'transparent',
                                            lineWidth: 0,
                                            hidden: false,
                                            index: i
                                        };
                                    });
                                }
                                return [];
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(30, 41, 59, 0.95)',
                        padding: 12,
                        cornerRadius: 8,
                        titleFont: {
                            size: 13,
                            weight: '600'
                        },
                        bodyFont: {
                            size: 12
                        },
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return label + ': ' + value + ' (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });
    }
});

// Tier Cards Navigation Functionality - Expand/Collapse Subsections
document.addEventListener('DOMContentLoaded', function() {
    const tierCards = document.querySelectorAll('.tier-card');
    
    // Handle tier card clicks to expand/collapse subsections
    tierCards.forEach(card => {
        card.addEventListener('click', function(e) {
            // Don't toggle if clicking on a subsection link
            if (e.target.closest('.subsection-link')) {
                return;
            }
            
            // Toggle active class on this card
            const isActive = card.classList.contains('active');
            
            // Close all other cards
            tierCards.forEach(otherCard => {
                if (otherCard !== card) {
                    otherCard.classList.remove('active');
                }
            });
            
            // Toggle this card
            if (isActive) {
                card.classList.remove('active');
            } else {
                card.classList.add('active');
                // Center the subsection relative to the container
                setTimeout(() => {
                    const subsection = card.querySelector('.tier-card-subsection');
                    const container = document.querySelector('.tier-cards-container');
                    if (subsection && container) {
                        const containerRect = container.getBoundingClientRect();
                        const containerCenter = containerRect.left + (containerRect.width / 2);
                        const cardRect = card.getBoundingClientRect();
                        const cardLeft = cardRect.left;
                        const offsetFromCard = containerCenter - cardLeft;
                        subsection.style.left = offsetFromCard + 'px';
                        subsection.style.transform = 'translateX(-50%) translateY(0)';
                    }
                }, 10);
            }
        });
    });
    
    // Close card when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.tier-card')) {
            tierCards.forEach(card => {
                card.classList.remove('active');
            });
        }
    });
});

// School Event Modal Functions
function showSchoolEventModal(event) {
    const modal = document.getElementById('schoolEventModal');
    const titleEl = document.getElementById('schoolEventTitle');
    const contentEl = document.getElementById('schoolEventContent');
    
    if (!modal || !titleEl || !contentEl) {
        console.error('Modal elements not found');
        return;
    }
    
    // Extract event data
    const eventName = event.name || event.title || 'School Event';
    const eventType = event.type || event.event_type || 'Event';
    const eventDate = event.date || (event.timestart ? new Date(event.timestart * 1000).toISOString().split('T')[0] : '');
    // Use 12-hour format for time display
    const eventTime = event.time || (event.timestart ? new Date(event.timestart * 1000).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true }) : '');
    const eventTimeEnd = event.time_end || (event.timeduration && event.timestart ? new Date((event.timestart + event.timeduration) * 1000).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true }) : '');
    const eventDescription = event.description || '';
    const eventColor = event.color || '#3b82f6';
    
    // Format date
    let formattedDate = '';
    if (eventDate) {
        const dateObj = new Date(eventDate + 'T00:00:00');
        formattedDate = dateObj.toLocaleDateString('en-US', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
    }
    
    // Format time range
    let timeRange = eventTime;
    if (eventTimeEnd) {
        timeRange = eventTime + ' - ' + eventTimeEnd;
    }
    
    // Set title
    titleEl.textContent = eventName;
    
    // Get type color - red for exam, use event color for others
    const typeColor = (eventType.toUpperCase() === 'EXAM') ? '#ef4444' : eventColor;
    
    // Build content HTML with improved styling
    let contentHTML = `
        <div class="event-detail-item">
            <label class="event-detail-label">TYPE:</label>
            <span class="event-type-badge-modal" style="color: ${typeColor}; font-weight: 600; text-transform: uppercase; font-size: 0.875rem;">${eventType.toUpperCase()}</span>
        </div>
        <div class="event-detail-item">
            <label class="event-detail-label">DATE:</label>
            <span class="event-detail-value">${formattedDate || eventDate || 'N/A'}</span>
        </div>
        <div class="event-detail-item">
            <label class="event-detail-label">TIME:</label>
            <span class="event-detail-value">${timeRange || 'N/A'}</span>
        </div>
        <div class="event-detail-item">
            <label class="event-detail-label">DESCRIPTION:</label>
            <textarea class="event-description-text" readonly>${eventDescription || 'No description available'}</textarea>
        </div>
    `;
    
    contentEl.innerHTML = contentHTML;
    modal.style.display = 'flex';
}

function closeSchoolEventModal() {
    const modal = document.getElementById('schoolEventModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

// Toggle lecture menu dropdown
window.toggleLectureMenu = function(event, sessionId, currentAvailable) {
    event.stopPropagation();
    const menu = document.getElementById('lectureMenu_' + sessionId);
    
    // Close all other menus
    document.querySelectorAll('.lecture-menu-dropdown').forEach(m => {
        if (m !== menu) {
            m.style.display = 'none';
        }
    });
    
    // Toggle current menu
    if (menu) {
        const isVisible = menu.style.display !== 'none';
        menu.style.display = isVisible ? 'none' : 'block';
        
        // Update checkmarks based on current availability when opening
        if (!isVisible) {
            // Get current availability from menu data attribute or parameter
            const menuAvailable = menu.getAttribute('data-current-available') !== null ? parseInt(menu.getAttribute('data-current-available')) : currentAvailable;
            const availableBtn = menu.querySelector('button[data-available="1"]');
            const notAvailableBtn = menu.querySelector('button[data-available="0"]');
            
            if (availableBtn && notAvailableBtn) {
                const availableCheck = availableBtn.querySelector('.menu-check');
                const notAvailableCheck = notAvailableBtn.querySelector('.menu-check');
                
                if (menuAvailable == 1) {
                    if (availableCheck) availableCheck.style.display = 'inline';
                    if (notAvailableCheck) notAvailableCheck.style.display = 'none';
                } else {
                    if (availableCheck) availableCheck.style.display = 'none';
                    if (notAvailableCheck) notAvailableCheck.style.display = 'inline';
                }
            }
        }
    }
};

// Close lecture menu when clicking outside
document.addEventListener('click', function(event) {
    if (!event.target.closest('.lecture-card-wrapper')) {
        document.querySelectorAll('.lecture-menu-dropdown').forEach(menu => {
            menu.style.display = 'none';
        });
    }
});

// Update teacher availability
window.updateTeacherAvailability = function(sessionId, available) {
    // Close the menu
    const menu = document.getElementById('lectureMenu_' + sessionId);
    if (menu) {
        menu.style.display = 'none';
    }
    
    // Use the correct path - construct from current location
    const currentPath = window.location.pathname;
    let API_BASE;
    
    // Check if we're in IOMAD context
    if (currentPath.includes('/iomad/')) {
        // Extract the base path up to /iomad/
        const pathMatch = currentPath.match(/^(.+?\/iomad)\//);
        if (pathMatch) {
            API_BASE = pathMatch[1] + '/theme/remui_kids/school_manager/calendar_management.php';
        } else {
            // Fallback: try to construct from wwwroot
            const wwwroot = '{{config.wwwroot}}';
            API_BASE = wwwroot + '/theme/remui_kids/school_manager/calendar_management.php';
        }
    } else {
        // Not in IOMAD context, use standard path
        const wwwroot = '{{config.wwwroot}}';
        API_BASE = wwwroot + '/theme/remui_kids/school_manager/calendar_management.php';
    }
    
    console.log('API_BASE:', API_BASE); // Debug log
    
    const SESSKEY = '{{sesskey}}';
    
    const formData = new FormData();
    formData.append('action', 'update_teacher_availability');
    formData.append('sesskey', SESSKEY);
    formData.append('session_id', sessionId);
    formData.append('available', available);
    
    fetch(API_BASE, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        // Check if response is OK
        if (!response.ok) {
            throw new Error('HTTP error! status: ' + response.status);
        }
        // Check content type
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            return response.text().then(text => {
                console.error('Non-JSON response:', text.substring(0, 200));
                throw new Error('Server returned HTML instead of JSON. Check if the file path is correct.');
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.status === 'success') {
            // Find the lecture card wrapper (for week/month view)
            const cardWrapper = document.querySelector(`.lecture-card-wrapper[data-session-id="${sessionId}"]`);
            
            // Find the list item (for list view)
            const listItem = document.querySelector(`.schedule-list-item .lecture-menu-btn[data-session-id="${sessionId}"]`)?.closest('.schedule-list-item');
            
            // Update the wrapper's data attribute and class (for week/month view)
            if (cardWrapper) {
                cardWrapper.setAttribute('data-available', available);
                
                // Ensure wrapper maintains positioning context
                if (!cardWrapper.style.position || cardWrapper.style.position === '') {
                    cardWrapper.style.position = 'relative';
                }
                
                // Toggle the unavailable class
                if (available == 1) {
                    cardWrapper.classList.remove('lecture-unavailable');
                } else {
                    cardWrapper.classList.add('lecture-unavailable');
                }
            }
            
            // Update list item border and badge colors (for list view)
            if (listItem) {
                const badgeElement = listItem.querySelector('.schedule-event-type-badge');
                const originalColor = badgeElement?.getAttribute('data-badge-color') || '#e9d5ff';
                const displayColor = available == 1 ? originalColor : '#d1d5db'; // Light grey if unavailable
                
                // Update border color
                listItem.style.setProperty('border-left', `4px solid ${displayColor}`, 'important');
                
                // Update badge background color
                if (badgeElement) {
                    badgeElement.style.setProperty('background', displayColor, 'important');
                }
            }
            
            // Update the button's data attribute and ensure it maintains position
            const menuBtn = document.querySelector(`.lecture-menu-btn[data-session-id="${sessionId}"]`);
            if (menuBtn) {
                menuBtn.setAttribute('data-available', available);
                // Explicitly maintain button position
                menuBtn.style.position = 'absolute';
                menuBtn.style.top = '8px';
                menuBtn.style.right = '8px';
                menuBtn.style.zIndex = '10';
            }
            
            // Update the menu's data attribute
            if (menu) {
                menu.setAttribute('data-current-available', available);
            }
            
            // Update the checkmark in the menu dropdown
            const availableBtn = menu.querySelector('button[data-available="1"]');
            const notAvailableBtn = menu.querySelector('button[data-available="0"]');
            if (availableBtn && notAvailableBtn) {
                const availableCheck = availableBtn.querySelector('.menu-check');
                const notAvailableCheck = notAvailableBtn.querySelector('.menu-check');
                if (available == 1) {
                    if (availableCheck) availableCheck.style.display = 'inline';
                    if (notAvailableCheck) notAvailableCheck.style.display = 'none';
                } else {
                    if (availableCheck) availableCheck.style.display = 'none';
                    if (notAvailableCheck) notAvailableCheck.style.display = 'inline';
                }
            }
            
            // Reload schedule to reflect changes
            loadSchedule(0);
        } else {
            alert('Error: ' + (data.message || 'Failed to update availability'));
        }
    })
    .catch(error => {
        console.error('Error updating availability:', error);
        alert('Error updating availability: ' + error.message);
    });
};

// Initialize lecture card availability states on page load
function initializeLectureCardStates() {
    const lectureCards = document.querySelectorAll('.lecture-card-wrapper');
    lectureCards.forEach(card => {
        const available = card.getAttribute('data-available');
        
        // Ensure wrapper has proper positioning
        if (!card.style.position || card.style.position === '') {
            card.style.position = 'relative';
        }
        
        if (available == '0') {
            card.classList.add('lecture-unavailable');
        } else {
            card.classList.remove('lecture-unavailable');
        }
        
        // Ensure menu button maintains position
        const menuBtn = card.querySelector('.lecture-menu-btn');
        if (menuBtn) {
            menuBtn.style.position = 'absolute';
            menuBtn.style.top = '8px';
            menuBtn.style.right = '8px';
            menuBtn.style.zIndex = '10';
        }
    });
}

// Add click handlers for server-rendered admin events
document.addEventListener('DOMContentLoaded', function() {
    // Initialize lecture card states on page load
    initializeLectureCardStates();
    
    // Handle clicks on server-rendered admin events
    document.addEventListener('click', function(e) {
        const eventCard = e.target.closest('.school-event-clickable');
        if (eventCard) {
            e.preventDefault();
            const eventData = {
                id: eventCard.getAttribute('data-event-id'),
                name: eventCard.getAttribute('data-event-name'),
                type: eventCard.getAttribute('data-event-type'),
                date: eventCard.getAttribute('data-event-date'),
                time: eventCard.getAttribute('data-event-time'),
                time_end: eventCard.getAttribute('data-event-time-end'),
                description: eventCard.getAttribute('data-event-description'),
                color: eventCard.getAttribute('data-event-color')
            };
            showSchoolEventModal(eventData);
        }
    });
    
    // Close modal when clicking outside
    const modal = document.getElementById('schoolEventModal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeSchoolEventModal();
            }
        });
    }
});
</script>

<!-- School Event Details Modal -->
<div id="schoolEventModal" class="school-event-modal" style="display: none;">
    <div class="school-event-modal-content">
        <div class="school-event-modal-header">
            <h3 id="schoolEventTitle">Event Details</h3>
            <button class="school-event-modal-close" onclick="closeSchoolEventModal()">&times;</button>
        </div>
        <div class="school-event-modal-body">
            <div id="schoolEventContent">
                <!-- Event details will be inserted here -->
            </div>
        </div>
    </div>
</div>

<style>
/* School Event Modal Styles */
.school-event-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    animation: fadeIn 0.2s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.school-event-modal-content {
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: slideUp 0.3s ease;
}

@keyframes slideUp {
    from {
        transform: translateY(20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.school-event-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 24px 28px;
    border-bottom: 1px solid #f1f5f9;
    background: linear-gradient(to bottom, #ffffff, #fafbfc);
}

.school-event-modal-header h3 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 700;
    color: #1e293b;
    letter-spacing: -0.02em;
}

.school-event-modal-close {
    background: none;
    border: none;
    font-size: 28px;
    color: #64748b;
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    transition: all 0.2s ease;
}

.school-event-modal-close:hover {
    background: #f1f5f9;
    color: #1e293b;
}

.school-event-modal-body {
    padding: 28px;
}

.event-detail-item {
    margin-bottom: 24px;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.event-detail-item:last-child {
    margin-bottom: 0;
}

.event-detail-label {
    font-size: 0.8125rem;
    font-weight: 600;
    color: #64748b;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
}

.event-detail-value {
    font-size: 1rem;
    color: #1e293b;
    font-weight: 500;
    line-height: 1.5;
}

.event-type-badge-modal {
    display: inline-block;
    font-size: 0.9375rem;
    font-weight: 700;
    letter-spacing: 0.3px;
}

/* Lecture Card 3-Dot Menu Styles */
.lecture-card-wrapper {
    position: relative !important; /* Ensure wrapper maintains positioning context */
    display: block; /* Ensure it's a block element */
}

/* Disabled/Unavailable Lecture Card Styles - No Blur, Just Disabled State */
.lecture-card-wrapper.lecture-unavailable .lecture-card-link {
    opacity: 0.6;
    filter: none; /* Remove blur */
    pointer-events: none;
    cursor: not-allowed;
    position: relative;
    background-color: #faf8ff !important; /* Soft lavender background for disabled state */
    border-left-color: #e8e5f3 !important; /* Soft lavender border instead of colored */
}

.lecture-card-wrapper.lecture-unavailable .lecture-card-link .event-time,
.lecture-card-wrapper.lecture-unavailable .lecture-card-link .schedule-event-time {
    color: #b8a9d9 !important; /* Soft lavender text */
}

.lecture-card-wrapper.lecture-unavailable .lecture-card-link .event-title,
.lecture-card-wrapper.lecture-unavailable .lecture-card-link .schedule-event-title {
    color: #9d8bb5 !important; /* Soft lavender text */
}

.lecture-card-wrapper.lecture-unavailable .lecture-card-link .event-type-badge {
    background: #e8e5f3 !important; /* Soft lavender badge */
    color: #9d8bb5 !important;
    opacity: 0.7;
}

/* Ensure menu button remains functional when card is disabled - Keep same position */
.lecture-card-wrapper.lecture-unavailable .lecture-menu-btn {
    opacity: 1 !important;
    filter: none !important;
    pointer-events: auto !important;
    cursor: pointer !important;
    z-index: 10 !important;
    position: absolute !important; /* Keep absolute positioning */
    top: 8px !important; /* Same position as normal state */
    right: 8px !important; /* Same position as normal state */
    background: transparent !important;
    border: none !important;
    padding: 4px 8px !important;
    border-radius: 4px !important;
    color: #9d8bb5 !important;
    font-size: 1.25rem !important;
    line-height: 1 !important;
    transition: all 0.2s ease !important;
}

.lecture-card-wrapper.lecture-unavailable .lecture-menu-dropdown {
    z-index: 1001;
}

.lecture-menu-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 4px;
    color: #9d8bb5;
    font-size: 1.25rem;
    line-height: 1;
    z-index: 10;
    transition: all 0.2s ease;
}

.lecture-menu-btn:hover {
    background: rgba(184, 169, 217, 0.05);
    color: #8b7ab8;
}

.menu-dots {
    display: inline-block;
    transform: rotate(90deg);
    font-weight: bold;
}

.lecture-menu-dropdown {
    position: absolute;
    top: 100%;
    right: 0;
    background: white;
    border: 1px solid #f0e8f7;
    border-radius: 6px;
    box-shadow: 0 2px 8px rgba(184, 169, 217, 0.12);
    z-index: 1000;
    min-width: 120px;
    margin-top: 4px;
    overflow: hidden;
    padding: 4px 0;
}

.lecture-menu-item {
    width: 100%;
    text-align: center;
    padding: 6px 12px;
    border: none;
    background: white;
    cursor: pointer;
    font-size: 0.75rem;
    color: #6b5b95;
    transition: background-color 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    line-height: 1.4;
}

.lecture-menu-item:hover {
    background: #faf8ff;
}

.lecture-menu-item:not(:last-child) {
    border-bottom: 1px solid #f0e8f7;
}

.menu-check {
    display: inline-block;
    color: #a9d9c9;
    font-weight: bold;
    font-size: 0.875rem;
}

.menu-check[style*="display: none"] {
    display: none !important;
}

.event-description-text {
    margin-top: 4px;
    padding: 12px 14px;
    background: #ffffff;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 0.9375rem;
    color: #1e293b;
    line-height: 1.6;
    min-height: 50px;
    font-family: inherit;
    resize: none;
    width: 100%;
    box-sizing: border-box;
    cursor: default;
    transition: border-color 0.2s ease;
}

.event-description-text:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}
</style>

<script>
// Activity Line Chart
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('activityLineChart');
    if (ctx) {
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                datasets: [
                    {
                        label: 'Assignments',
                        data: [12, 19, 15, 25, 22, 30, 28],
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Quizzes',
                        data: [8, 12, 18, 14, 20, 25, 22],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        display: false // Hide default legend, using custom one
                    },
                    tooltip: {
                        backgroundColor: 'rgba(255, 255, 255, 0.9)',
                        titleColor: '#1f2937',
                        bodyColor: '#4b5563',
                        borderColor: '#e5e7eb',
                        borderWidth: 1,
                        padding: 12,
                        displayColors: true,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y;
                                    if (context.dataset.label === 'Attendance') {
                                        label += '%';
                                    }
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            color: '#6b7280',
                            font: {
                                size: 11
                            }
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        grid: {
                            color: '#f3f4f6'
                        },
                        ticks: {
                            color: '#6b7280',
                            font: {
                                size: 11
                            }
                        }
                    }
                }
            }
        });
    }
});

// Community Post Functions - Integrated from community.php
function toggleLike(postId, replyId) {
    fetch('{{config.wwwroot}}/local/communityhub/ajax.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `action=toggle_like&postid=${postId}&replyid=${replyId}&sesskey={{sesskey}}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (replyId && replyId > 0) {
                updateReplyLikeUI(replyId, data.data.liked, data.data.likecount);
            } else {
                const btn = document.getElementById(`likeBtn-${postId}`);
                const icon = btn.querySelector('i');
                
                if (btn && icon) {
                    if (data.data.liked) {
                        btn.classList.add('liked');
                        icon.classList.remove('far');
                        icon.classList.add('fas');
                    } else {
                        btn.classList.remove('liked');
                        icon.classList.remove('fas');
                        icon.classList.add('far');
                    }
                }
            }
        }
    })
    .catch(error => console.error('Error toggling like:', error));
}

function toggleSavePost(postId) {
    fetch('{{config.wwwroot}}/local/communityhub/ajax.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `action=toggle_save_post&postid=${postId}&sesskey={{sesskey}}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const btn = document.getElementById(`saveBtn-${postId}`);
            if (btn) {
                const icon = btn.querySelector('i');
                if (data.data.saved) {
                    btn.classList.add('saved');
                    icon.classList.remove('far');
                    icon.classList.add('fas');
                } else {
                    btn.classList.remove('saved');
                    icon.classList.remove('fas');
                    icon.classList.add('far');
                }
            }
        }
    })
    .catch(error => console.error('Error toggling save:', error));
}

function openCommentModal(postId) {
    // Open comment modal for the specific post
    const modal = document.getElementById('commentModal');
    const postIdInput = document.getElementById('commentPostId');
    const postTitle = document.getElementById('commentPostTitle');
    
    if (modal && postIdInput && postTitle) {
        postIdInput.value = postId;
        
        // Get post title from the post card
        const postCard = document.querySelector(`[data-post-id="${postId}"]`);
        const titleElement = postCard ? postCard.querySelector('.post-title') : null;
        const titleText = titleElement ? titleElement.textContent : 'Post ' + postId;
        
        postTitle.textContent = titleText;
        modal.style.display = 'flex';
        
        // Focus on the textarea
        setTimeout(() => {
            const textarea = document.getElementById('commentMessage');
            if (textarea) {
                textarea.focus();
            }
        }, 100);
    }
}

function closeCommentModal() {
    const modal = document.getElementById('commentModal');
    const textarea = document.getElementById('commentMessage');
    
    if (modal) {
        modal.style.display = 'none';
        if (textarea) {
            textarea.value = '';
        }
    }
}

function submitComment() {
    const postId = document.getElementById('commentPostId').value;
    const message = document.getElementById('commentMessage').value.trim();
    
    if (!message) {
        alert('Please enter a comment');
        return;
    }
    
    fetch('{{config.wwwroot}}/local/communityhub/ajax.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `action=create_reply&postid=${postId}&message=${encodeURIComponent(message)}&sesskey={{sesskey}}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Comment posted successfully!');
            closeCommentModal();
        } else {
            alert('Error posting comment: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error posting comment:', error);
        alert('Error posting comment. Please try again.');
    });
}

function updateReplyLikeUI(replyId, liked, likeCount) {
    const links = document.querySelectorAll(`[data-reply-like="${replyId}"]`);
    links.forEach(link => {
        if (!link) {
            return;
        }
        if (liked) {
            link.classList.add('liked');
        } else {
            link.classList.remove('liked');
        }
    });
}
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Find all resource category panels in all tier card subsections
    const resourcePanels = document.querySelectorAll('.resource-category-panel');
    
    console.log('Found resource panels:', resourcePanels.length);
    
    if (resourcePanels.length === 0) {
        console.warn('No resource category panels found in the page!');
        return;
    }
    
    // Prevent clicks inside panels from closing the card
    resourcePanels.forEach(resourcePanel => {
        resourcePanel.addEventListener('click', function(event) {
            event.stopPropagation();
        });
    });

    // Initialize functionality for each resource panel independently
    resourcePanels.forEach((resourcePanel, index) => {
        console.log('Initializing resource panel', index);
        const courseItemsContainer = resourcePanel.querySelector('.resource-category-course-items');
        const categoryCheckboxes = resourcePanel.querySelectorAll('.resource-category-card-checkbox');
        const viewButton = resourcePanel.querySelector('.resource-category-view-all');
        const fallbackViewCourseUrl = '{{config.wwwroot}}/theme/remui_kids/teacher/view_course.php';
        const viewCourseBaseUrl = (viewButton && viewButton.getAttribute('data-view-url')) || fallbackViewCourseUrl;
        
        console.log('Panel', index, '- Categories found:', categoryCheckboxes.length, '- Container:', !!courseItemsContainer, '- View button:', !!viewButton);

        function renderSelectedCourses() {
            if (!courseItemsContainer) {
                return;
            }
            const selected = [];
            categoryCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    const label = checkbox.closest('.resource-category-card');
                    const name = label ? label.getAttribute('data-category-name') : '';
                    const coursesData = checkbox.getAttribute('data-courses');
                    let courses = [];
                    try {
                        courses = coursesData ? JSON.parse(coursesData) : [];
                    } catch (error) {
                        courses = [];
                    }
                    if (courses.length) {
                        selected.push({ name, courses });
                    }
                }
            });

            if (selected.length === 0) {
                courseItemsContainer.innerHTML = '<p class="resource-category-courses-empty">Select a category to preview its courses.</p>';
                return;
            }

            courseItemsContainer.innerHTML = '';
            selected.forEach(category => {
                const section = document.createElement('div');
                section.className = 'resource-category-course-section';

                const header = document.createElement('button');
                header.type = 'button';
                header.className = 'resource-category-course-section-header';
                header.textContent = category.name;
                header.addEventListener('click', () => {
                    section.classList.toggle('open');
                });
                section.appendChild(header);

                const dropdown = document.createElement('div');
                dropdown.className = 'resource-category-course-dropdown';
                category.courses.forEach(course => {
                    const label = document.createElement('label');
                    label.className = 'resource-course-select';
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.setAttribute('data-course-id', course.id);
                    const span = document.createElement('span');
                    span.textContent = course.name;
                    label.appendChild(checkbox);
                    label.appendChild(span);
                    dropdown.appendChild(label);
                });

                section.appendChild(dropdown);
                courseItemsContainer.appendChild(section);
            });
        }

        function collectSelectedCategoryIds() {
            const ids = new Set();
            categoryCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    const categoryId = checkbox.getAttribute('data-category-id');
                    if (categoryId) {
                        ids.add(categoryId);
                    }
                }
            });
            return Array.from(ids);
        }

        function collectSelectedCourseIds() {
            const ids = new Set();
            if (!resourcePanel) {
                return [];
            }
            const courseCheckboxes = resourcePanel.querySelectorAll('.resource-category-course-items input[type="checkbox"][data-course-id]');
            courseCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    const courseId = checkbox.getAttribute('data-course-id');
                    if (courseId) {
                        ids.add(courseId);
                    }
                }
            });
            return Array.from(ids);
        }

        // Set up View button handler
        if (viewButton) {
            viewButton.addEventListener('click', function() {
                const selectedCategoryIds = collectSelectedCategoryIds();
                const selectedCourseIds = collectSelectedCourseIds();
                const params = new URLSearchParams();
                selectedCategoryIds.forEach(id => params.append('categories[]', id));
                selectedCourseIds.forEach(id => params.append('courses[]', id));
                const query = params.toString();
                let targetUrl = viewCourseBaseUrl;
                if (query) {
                    targetUrl += (targetUrl.includes('?') ? '&' : '?') + query;
                }
                window.location.href = targetUrl;
            });
        }

        // Set up checkbox change handlers
        categoryCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', renderSelectedCourses);
        });

        // Initial render
        renderSelectedCourses();
    });
});
</script>

{{#footer}}
{{> theme_remui/footer }}
{{/footer}}
